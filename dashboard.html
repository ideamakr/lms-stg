<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Dashboard</title>
    

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- <script src="http://127.0.0.1:8000/static/sweetalert2.js"></script>
    <link rel="stylesheet" href="http://127.0.0.1:8000/static/css/all.min.css" /> -->
    
    <!-- <script src="static/sweetalert2.js"></script>
    <link rel="stylesheet" href="static/css/all.min.css" /> -->
<!-- 
    <script src="/static/sweetalert2.js"></script>
    <link rel="stylesheet" href="/static/css/all.min.css" /> -->
    
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" /> -->
    
    <style>
      /* Your CSS starts here... */
      :root {
        --primary: #2563eb;
        --sidebar-bg: #1e293b;
        --text: #334155;
        --bg: #f1f5f9;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        margin: 0;
        font-family: -apple-system, sans-serif;
        background: var(--bg);
        display: flex;
        height: 100vh;
        overflow: hidden; /* Prevent body scroll, handle inside .content */
      }
    
      /* --- SIDEBAR --- */
      .sidebar {
        width: 260px;
        background: var(--sidebar-bg);
        color: white;
        display: flex;
        flex-direction: column;
      }
      .sidebar h3 {
        padding: 25px;
        margin: 0;
        background: #0f172a;
        text-align: center;
        border-bottom: 1px solid #334155;
      }
      .menu {
        flex: 1;
        padding-top: 20px;
      }
      .menu-item {
        padding: 15px 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: 0.2s;
        color: #cbd5e1;
      }
      .menu-item:hover,
      .menu-item.active {
        background: var(--primary);
        color: white;
      }
    
      /* --- MAIN LAYOUT --- */
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100vh;
      }
      .topbar {
  background: white;
  padding: 15px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  
  /* üöÄ THE FIX IS HERE */
  position: relative; 
  z-index: 50; 
}
      .user-info {
        font-weight: bold;
        color: var(--text);
      }
      .logout-btn {
        color: #ef4444;
        cursor: pointer;
        font-weight: 600;
        border: none;
        background: none;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .logout-btn:hover {
        background: #fee2e2;
        padding: 5px 10px;
        border-radius: 6px;
      }
    
 /* --- CONTENT AREA --- */
 .content {
    padding: 30px;
    overflow-y: auto; /* Enable vertical scroll */
    flex: 1;
    background: var(--bg);
    width: 100%; /* üöÄ Ensure content fills space */
    box-sizing: border-box; /* üöÄ Include padding in width */
  }

  .section {
    display: none;
    min-height: min-content;
    width: 100%; /* üöÄ Prevent horizontal overflow */
    box-sizing: border-box; /* üöÄ Include padding in width */
  }

  .section.active {
    display: block;
    animation: fadeIn 0.3s;
  }

  /* --- CARDS & PANELS --- */
  .card {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    width: 100%; /* üöÄ Ensure card fits container */
    box-sizing: border-box; /* üöÄ Critical for preventing layout breaks */
  }

  h2 {
    margin-top: 0;
    color: var(--primary);
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 15px;
    margin-bottom: 25px;
    font-size: 1.25rem;
  }
    
/* --- FORMS & INPUTS --- */
.filter-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        background: #e0f2fe;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        align-items: end;
      }
      .filter-group label {
        display: block;
        font-size: 0.75rem;
        margin-bottom: 4px;
        color: #0369a1;
        font-weight: bold;
      }

      /* 1. Base shared styles */
      input, select, textarea {
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        width: 100%;
        box-sizing: border-box;
        font-size: 0.9rem;
        font-family: inherit;
      }

      /* 2. üöÄ SLIM DROPDOWN & INPUTS */
      input, select {
        height: 36px !important;     /* Fixed slim height */
        padding: 0 12px !important;  /* Tight padding for slim look */
        line-height: 36px;
      }

      /* 3. üöÄ SPACIOUS REMARKS BOX */
      textarea {
        padding: 12px 15px !important;
        min-height: 100px !important; /* Forces height for remarks */
        line-height: 1.5;
        display: block;              /* Textareas shouldn't be flex */
      }

      select option:disabled {
        color: #9ca3af;
      }

      .btn {
        background: var(--primary);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        height: 36px; /* Match input height for symmetry */
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .btn:hover {
        background: #1d4ed8;
      }
      .btn-secondary {
        background: #94a3b8;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .btn-secondary:hover {
        background: #64748b;
      }
    
      /* --- TABLES --- */
      .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 10px;
      }
      table {
        width: 100% !important;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: auto;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      th, td {
        padding: 12px 15px !important;
        text-align: left;
        vertical-align: middle;
        border-bottom: 1px solid #e2e8f0;
        white-space: nowrap;
      }
      th {
        background: #f8fafc;
        font-weight: 600;
        color: #475569;
        font-size: 0.9rem;
      }
    
      /* Table Column Helpers */
      .col-emp { width: 18%; }
      .col-hist-type { width: 85px !important; }
      .col-hist-cat { width: auto; min-width: 220px; padding-left: 15px !important; }
      .col-hist-amt, .col-hist-date, .col-hist-status { width: 125px !important; text-align: center !important; }
      .col-hist-actions { width: 110px !important; text-align: center !important; }
      td.col-reason { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
      /* --- STATUS BADGES --- */
      .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
      .status-pending { color: #854d0e !important; background: #fef9c3 !important; }
      .status-pending-l2-approval { color: #854d0e !important; background: #fef9c3 !important; border: 1px solid #fde047; }
      .status-approved { color: #166534; background: #dcfce7; }
      .status-rejected { color: #991b1b; background: #fee2e2; }
      .status-pending-cancel { color: #1e40af; background: #dbeafe; }
      .status-cancelled { color: #374151; background: #f3f4f6; }
      .status-withdrawn { color: #475569; background: #f1f5f9; border: 1px dashed #94a3b8; }
    
      /* --- BUTTONS & ICONS --- */
      .icon-btn {
        cursor: pointer; color: var(--primary); font-size: 0.75rem !important; font-weight: 600;
        padding: 0 10px !important; height: 26px !important;
        display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        transition: 0.2s; border: 1px solid #e2e8f0; border-radius: 4px; background: white; line-height: 1 !important;
      }
      .icon-btn:hover { background: #eff6ff; border-color: var(--primary); }
      
      /* --- PAGINATION --- */
      .pagination-controls {
        display: flex; justify-content: center; align-items: center; gap: 50px;
        padding-top: 15px; border-top: 1px solid #e2e8f0; margin-top: 10px;
      }
      .page-btn {
        padding: 8px 15px; border: 1px solid #cbd5e1; border-radius: 6px; background: #f8fafc; cursor: pointer; font-weight: 500;
      }
      .page-btn:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
    
      /* --- CALENDAR --- */
      .calendar-day {
        min-height: 100px; background: white; border: 1px solid #e2e8f0; padding: 8px;
        display: flex; flex-direction: column; gap: 4px; transition: background 0.2s;
      }
      .calendar-day:hover { background: #f1f5f9; }
      .calendar-day.today { background: #fffbeb; border: 2px solid #fbbf24 !important; }
      .leave-pill {
        background: #e0e7ff; color: #4338ca; font-size: 0.65rem; padding: 2px 6px;
        border-radius: 4px; font-weight: 600; white-space: nowrap; overflow: hidden;
        text-overflow: ellipsis; border-left: 3px solid #4338ca; cursor: default;
      }
      #team_calendar { min-height: 400px; background: #f8fafc; }
    
      /* --- MODERN SAAS UI (Blue Theme) --- */
      #apply.saas-canvas {
        background: linear-gradient(to bottom, #ffffff 0px, #ffffff 60px, #1e3a8a 60px, #1e3a8a 100%);
        min-height: 100vh; height: auto; display: none; flex-direction: column; align-items: center;
        padding: 80px 20px 40px 20px; margin: -30px; width: calc(100% + 60px); box-sizing: border-box;
        position: relative; z-index: 1;
      }
      #apply.saas-canvas.active { display: flex !important; }
      .content:has(#apply.active) { padding: 0 !important; overflow-x: hidden; }
    
      /* Tabs */
      .saas-tabs-container { display: flex; gap: 15px; margin-bottom: 20px; width: 100%; max-width: 800px; }
      .saas-tab-pill {
        background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.7);
        padding: 10px 24px; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.2);
        font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
      }
      .saas-tab-pill:hover { background: rgba(255, 255, 255, 0.2); color: white; border-color: rgba(255, 255, 255, 0.5); }
      .saas-tab-pill.active { background: white; color: #1e3a8a; border-color: white; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
    
      /* Floating Card */
      .saas-card { background: #ffffff; width: 100%; max-width: 800px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); overflow: hidden; }
      .saas-card-header { padding: 30px 40px 15px 40px; border-bottom: 1px solid #f1f5f9; }
      .saas-card-header h2 { font-size: 1.6rem; font-weight: 800; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 10px; }
      
      /* Form Inputs (SaaS Style) */
      .saas-card-body { padding: 30px 40px; max-height: 65vh; overflow-y: auto; overflow-x: hidden; }
      .saas-form-grid { display: grid; grid-template-columns: 1fr 1fr; column-gap: 30px; row-gap: 20px; }
      .grid-full-width { grid-column: 1 / -1; }
      .saas-form-group label { display: block; font-weight: 600; font-size: 0.85rem; color: #475569; margin-bottom: 8px; }
      .saas-form-control {
        width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
        font-size: 1rem; background: #f8fafc; transition: all 0.2s; box-sizing: border-box;
      }
      .saas-form-control:focus { border-color: #2563eb; background: white; outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
      .file-upload-wrapper {
        position: relative; padding: 12px; border: 1px dashed #cbd5e1; border-radius: 8px;
        background: #f8fafc; display: flex; align-items: center; gap: 12px; transition: all 0.2s; cursor: pointer;
      }
      .file-upload-wrapper:hover { border-color: #2563eb; background: #eff6ff; }
      .file-upload-wrapper input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    
      #globalModal { display: none; position: fixed; z-index: 20000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease-in-out; }
#globalModal.show { display: flex; opacity: 1; align-items: center; justify-content: center; }
.modal-card { background: white; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; position: relative; transform: scale(0.95); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
#globalModal.show .modal-card { transform: scale(1); }
.modal-header-banner { height: 6px; width: 100%; border-radius: 16px 16px 0 0; position: relative; z-index: 1; }
.modal-icon-wrapper { display: flex; justify-content: center; width: 100%; position: absolute; top: 0; left: 0; margin-top: -32.5px; z-index: 10; pointer-events: none; }
#modalIcon { width: 65px; height: 65px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border: 4px solid white; box-sizing: border-box; line-height: 1; pointer-events: auto; }
.modal-content-body { padding: 50px 30px 30px 30px; text-align: center; min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.modal-title { margin: 0 0 10px 0; color: #1e293b; font-size: 1.5rem; font-weight: 800; }
.modal-message { color: #64748b; font-size: 1rem; line-height: 1.6; margin-bottom: 25px; }
.modal-btn { width: 100%; max-width: 180px; padding: 12px; border: none; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; color: white; margin: 0 auto; display: block; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
.modal-btn:hover { filter: brightness(95%); transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }

      /* Status Colors for Modals */
      .bg-success { background: #10b981; }
      .bg-error { background: #ef4444; }
      .bg-warning { background: #f59e0b; }
      .bg-info { background: #2563eb; }
    
      /* --- HR POLICY CARDS --- */
      .policy-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
      .policy-header { padding: 25px 30px; border-bottom: 1px solid #f1f5f9; background: white; }
      .policy-tabs { display: flex; gap: 10px; margin-top: 20px; background: #f8fafc; padding: 4px; border-radius: 8px; width: fit-content; border: 1px solid #e2e8f0; }
      .policy-tab-btn { padding: 8px 20px; border: none; background: transparent; color: #64748b; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all 0.2s; font-size: 0.9rem; }
      .policy-tab-btn.active { background: white; color: #2563eb; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .policy-content { padding: 30px; min-height: 400px; background: #fdfdfd; }
      .quota-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
      .quota-box { background: white; padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; position: relative; }
      .quota-input { width: 100%; padding: 10px 10px 10px 35px; font-size: 1.2rem; font-weight: bold; border: 1px solid #cbd5e1; border-radius: 8px; color: #1e293b; }
      .quota-icon { position: absolute; left: 30px; top: 52px; color: #64748b; } 

.user-search-container {
    position: relative;
    max-width: 600px;
    margin-bottom: 30px;
}

/* This targets the icon */
.user-search-container i.fa-search {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    z-index: 10;
}

/* This targets the input field to add breathing room */
#policy_user_search, #proxy_user_search {
    padding-left: 40px !important; 
    transition: all 0.2s ease;
}
    
      /* --- CARRY FORWARD TOGGLES & TILES --- */
      #l2_workflow_toggle:checked + #toggleBg,
      #cf_workflow_toggle:checked + #cfToggleBg { background-color: #22c55e !important; }
      #l2_workflow_toggle:checked + #toggleBg #toggleCircle,
      #cf_workflow_toggle:checked + #cfToggleBg #cfToggleCircle { transform: translateX(28px); }
    
      /* Split Tile Logic (Available vs Banked) */
      .tile-split-container { display: flex; flex-direction: column; height: 100%; justify-content: space-between; }
      .tile-header { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
      .tile-split-body { display: flex; align-items: center; background: rgba(255, 255, 255, 0.15); border-radius: 6px; margin-top: 5px; padding: 5px 0; }
      .split-section { flex: 1; text-align: center; }
      .split-divider { width: 1px; background: rgba(255, 255, 255, 0.4); height: 35px; }
      .split-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; margin-bottom: 0px; color: #e0f2fe; }
      .split-value { font-size: 1.35rem; font-weight: 800; line-height: 1.2; color: white; }
      .banked-highlight { color: #bae6fd; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
    
      /* --- MISC --- */
      .text-center { text-align: center !important; }
      .text-left { text-align: left !important; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      
      /* Scrollbar Polish */
      div::-webkit-scrollbar { width: 6px; }
      div::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
      div::-webkit-scrollbar-track { background: #f1f5f9; }

/* =========================================
     MISSING FORM ACTION BUTTONS
     (Paste this into your <style> block)
     ========================================= */
     .form-actions {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
  }
  
  .btn-submit {
    background-color: #2563eb; /* Royal Blue */
    color: white;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .btn-submit:hover {
    background-color: #1e40af; /* Darker Blue on Hover */
  }
  
  .btn-cancel {
    background: transparent;
    color: #64748b; /* Slate Gray */
    padding: 12px 20px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: color 0.2s;
  }
  
  .btn-cancel:hover {
    color: #1e293b; /* Darker text on hover */
    background-color: #f1f5f9; /* Subtle background */
    border-radius: 6px;
  }

/* Container to handle centering and spacing */
.modal-footer {
  display: flex;
  justify-content: center; 
  gap: 12px;               /* Space between buttons if you add more */
  width: 100%;
  margin-top: 10px;
}

.modal-btn {
  width: 100%;
  max-width: 160px;        /* üöÄ Standardized Width */
  height: 44px;           /* üöÄ Standardized Height */
  padding: 0 20px;
  border: none;
  border-radius: 10px;
  font-weight: 700;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.2s ease;
  color: white;
  display: flex;           /* Ensures text stays centered inside button */
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Secondary Style (for 'Back' or 'Cancel' buttons) */
.modal-btn-secondary {
  background: #f8fafc !important;
  color: #64748b !important;
  border: 1px solid #e2e8f0 !important;
}

.modal-btn:hover {
  filter: brightness(95%);
  transform: translateY(-1px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(4px);
    display: flex;         /* üöÄ Essential for centering */
    align-items: center;     /* üöÄ Centers vertically */
    justify-content: center; /* üöÄ Centers horizontally */
    z-index: 20000;
}

/* üöÄ Sticky Table Header Logic */
#historyTable thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #f8fafc; /* Matches your current header bg */
    border-bottom: 2px solid #e2e8f0;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.05); /* Optional: adds a tiny shadow when scrolling */
}

/* Ensure the table container handles the overflow */
.table-scroll-container {
    max-height: 600px; /* Adjust this based on your dashboard height */
    overflow-y: auto;
}

/* --- BUTTON STANDARDS (Add to your <style>) --- */
  .saas-btn-base {
    height: 42px; /* üìè Fixed height for alignment */
    padding: 0 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease;
    border: 1px solid transparent; /* Prevents layout shift */
}

/* ‚ö™ Secondary (Cancel) */
.saas-btn-secondary {
    background-color: #ffffff;
    color: #64748b;
    border-color: #cbd5e1;
}
.saas-btn-secondary:hover {
    background-color: #f8fafc;
    border-color: #94a3b8;
    color: #334155;
}

/* üî¥ Danger Soft (Reset) */
.saas-btn-danger-soft {
    background-color: #ffffff;
    color: #ef4444;
    border-color: #fca5a5;
}
.saas-btn-danger-soft:hover {
    background-color: #fef2f2;
    border-color: #ef4444;
}

/* üîµ Primary (Submit) */
.saas-btn-primary {
    background-color: #2563eb;
    color: white;
    border: none; /* Solid color needs no border */
    box-shadow: 0 1px 2px rgba(37, 99, 235, 0.1);
}
.saas-btn-primary:hover {
    background-color: #1d4ed8;
    box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
    transform: translateY(-1px);
}
.saas-btn-primary:active {
    transform: translateY(0);
}

/* üöÄ Button Shake Animation & Status Messages */
@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
}

.shake-animation {
  animation: shake 0.3s ease-in-out;
  background-color: #ef4444 !important; /* Temporarily turn red */
  border-color: #ef4444 !important;
  color: white !important;
}

/* üöÄ CRITICAL FIX: Force SweetAlerts above all other modals */
div.swal2-container {
    z-index: 30000 !important;
}

/* Ensure the generic 'universalModal' (if used elsewhere) is also high */
#universalModal {
    z-index: 30000 !important;
}

/* üöÄ Timeline Remark Bubble (Speech Bubble Style) */
.timeline-remark {
  background: #f1f5f9; 
  padding: 10px 12px; 
  border-radius: 6px; 
  margin-top: 6px; 
  font-size: 0.85rem; 
  color: #334155;
  border-left: 3px solid #cbd5e1; /* Default gray border */
  
  /* üöÄ CRITICAL: Handles long text wrapping */
  white-space: pre-wrap;      /* Preserves line breaks */
  word-wrap: break-word;      /* Breaks long words if needed */
  overflow-wrap: break-word;  /* Modern standard for wrapping */
  max-width: 100%;            /* Ensures it stays inside container */
}

/* Color variants for the border */
.remark-approved { border-left-color: #10b981; } /* Green */
.remark-rejected { border-left-color: #ef4444; } /* Red */
.remark-info { border-left-color: #3b82f6; }     /* Blue */

/* =========================================
   üöÄ STANDARDIZED FORM CONTROLS (ZERO-BUG)
   ========================================= */

/* 1. Input Standard */
.saas-form-control {
    width: 100% !important;
    height: 48px !important;
    padding: 0 12px !important;
    border: 1px solid #cbd5e1 !important;
    border-radius: 8px !important;
    background-color: #ffffff !important;
    color: #1e293b !important;
    font-size: 0.85rem !important;
    box-sizing: border-box !important; /* üöÄ The Magic Pillar of Alignment */
    transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
}

/* 2. Focus State (The blue glow when clicking) */
.saas-form-control:focus {
    outline: none !important;
    border-color: #2563eb !important;
    background-color: #ffffff !important;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15) !important;
}

/* 3. Label Standard */
.reg-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: #475569;
    margin-bottom: 4px;
    display: block;
}

/* 4. Error Text Standard */
.error-text {
    color: #ef4444;
    display: none;
    font-weight: bold;
    font-size: 0.7rem;
    margin-top: 4px;
    line-height: 1.2;
}

/* =========================================
   üì± PREMIUM MOBILE RESPONSIVENESS
   ========================================= */
   @media (max-width: 768px) {
  /* 1. Hide Sidebar & Make it a sliding drawer */
  .sidebar {
    position: fixed;
    left: -260px;
    height: 100vh;
    z-index: 100000;
    transition: left 0.3s ease;
    box-shadow: 4px 0 15px rgba(0,0,0,0.1);
  }
  
  .sidebar.mobile-open {
    left: 0;
  }

  /* 2. Show Hamburger Menu Button (Hidden by default on Desktop) */
  .mobile-toggle-btn {
    display: flex !important; 
  }

  /* 3. Auto-Stack all Grids (Filters, Forms, Analytics) */
  .filter-bar, 
  .saas-form-grid, 
  div[style*="grid-template-columns"] {
    grid-template-columns: 1fr !important; /* Forces 1 column */
    gap: 15px !important;
  }

  /* 4. Fix Padding for smaller screens */
  .content { padding: 15px !important; }
  .card { padding: 15px !important; }
  .topbar { padding: 15px !important; }

  /* 5. Calendar Modal Adjustments */
  #modal_calendar_grid {
    grid-template-columns: repeat(7, 1fr) !important; /* Keep calendar 7 days wide */
    gap: 2px !important;
  }
  .calendar-day { min-height: 60px !important; }
}

/* Hidden by default on Desktop */
.mobile-toggle-btn {
  display: none;
  background: transparent;
  border: none;
  font-size: 1.5rem;
  color: #1e293b;
  cursor: pointer;
  padding: 0;
  margin-right: 15px;
}

/* Dark overlay when mobile menu is open */
#mobile-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(15, 23, 42, 0.6);
  z-index: 99999;
  backdrop-filter: blur(2px);
  opacity: 0;
  transition: opacity 0.3s;
}

.sidebar {
    display: flex;          /* üöÄ Enable Flexbox */
    flex-direction: column;  /* üöÄ Stack items vertically */
    height: 100vh;          /* üöÄ Ensure it takes full screen height */
    /* ... keep your existing background, width, etc. ... */
}

/* üöÄ THE ICON OVERLAP FIX */
#password .saas-form-group div[style*="position: relative"] {
    display: flex;
    align-items: center;
}

#password .saas-form-control {
    height: 48px !important;
    padding-left: 45px !important;  /* ‚¨ÖÔ∏è Creates room for the LOCK icon */
    padding-right: 45px !important; /* ‚û°Ô∏è Creates room for the EYE icon */
    background: #f8fafc;
    width: 100%;
    box-sizing: border-box;
}

#password .saas-form-group i.fa-lock,
#password .saas-form-group i.fa-key,
#password .saas-form-group i.fa-check-double {
    position: absolute;
    left: 16px;            /* Precise left alignment */
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    pointer-events: none;  /* Ensures clicking icon clicks the input */
    z-index: 5;
}

#password .saas-form-group i.fa-eye,
#password .saas-form-group i.fa-eye-slash {
    position: absolute;
    right: 16px;           /* Precise right alignment */
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #94a3b8;
    z-index: 10;           /* Keep above lock for clicking */
}

.logout-item-sidebar:hover {
      background: rgba(251, 113, 133, 0.1) !important; /* Subtle soft red background */
      color: #ff4d6d !important; /* Brightens the red on hover */
      padding-left: 25px; /* Slight slide effect */
  }

  /* Makes the mini-scrollbars inside calendar days very thin and clean */
.calendar-day div::-webkit-scrollbar {
    width: 4px;
}
.calendar-day div::-webkit-scrollbar-thumb {
    background-color: #cbd5e1; /* Light gray */
    border-radius: 10px;
}

/* üöÄ NUCLEAR OPTION: Force the Confirmation Modal to the absolute top layer */
#universalModal, .modal-overlay, .swal2-container {
    z-index: 2147483647 !important; /* Max integer value */
}

/* Ensure the white card content is also at the max layer */
#universalModal .modal-content {
    position: relative;
    z-index: 2147483647 !important;
}

/* Standardizes SweetAlert buttons to be the same width */
.swal-btn-standard {
    width: 140px !important; /* Adjust width as needed */
    padding: 10px 0 !important;
    font-weight: 600 !important;
    border-radius: 8px !important;
}

/* High-Density Team Pulse Styles */
.pulse-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    margin-bottom: 4px;
    background: #f8fafc;
    border-radius: 6px;
    border: 1px solid #f1f5f9;
    cursor: pointer;
    transition: all 0.2s ease;
}
.pulse-row:hover {
    background: #f1f5f9;
    transform: translateX(3px);
}
.pulse-name {
    font-size: 0.85rem;
    font-weight: 700;
    color: #1e293b;
}
.pulse-sub {
    font-size: 0.7rem;
    color: #94a3b8;
}
.pulse-label {
    font-size: 0.65rem;
    font-weight: 800;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
}
.pulse-section-title {
    font-size: 0.65rem;
    font-weight: 800;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 15px 0 8px 5px;
}

#home_away_list {
    max-height: 350px;
    overflow-y: auto;
    padding-right: 5px;
}

/* Custom Scrollbar for a clean look */
#home_away_list::-webkit-scrollbar {
    width: 4px;
}
#home_away_list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}


/* 1. Define the Scrollable Containers */
#home_away_list, 
#tile_leave_inbox, 
#tile_ot_inbox {
    max-height: 200px; /* Limits height so it doesn't stretch the page */
    overflow-y: auto;  /* Adds the scrollbar when list is long */
    overflow-x: hidden;
    padding-right: 5px; /* Prevents text from hitting the scrollbar */
}

/* 2. Make the scrollbar look slim (Optional but recommended) */
#home_away_list::-webkit-scrollbar,
#tile_leave_inbox::-webkit-scrollbar,
#tile_ot_inbox::-webkit-scrollbar {
    width: 6px;
}
#home_away_list::-webkit-scrollbar-track,
#tile_leave_inbox::-webkit-scrollbar-track,
#tile_ot_inbox::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}
#home_away_list::-webkit-scrollbar-thumb,
#tile_leave_inbox::-webkit-scrollbar-thumb,
#tile_ot_inbox::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}
#home_away_list::-webkit-scrollbar-thumb:hover,
#tile_leave_inbox::-webkit-scrollbar-thumb:hover,
#tile_ot_inbox::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}


    </style>
  </head>
            <!-- ==========================================
                                SIDEB BAR
            ========================================== -->

   <body>
    <div class="sidebar">
      <div style="padding: 10px 20px; display: flex; align-items: center; gap: 12px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
        <div style="width: 38px; height: 38px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;">
          <i id="sidebar_default_icon" class="fas fa-building" style="color: #6366f1; font-size: 1.1rem;"></i>
          <img id="sidebar_logo_img" src="" style="width: 100%; height: 100%; object-fit: contain; display: none;" />
        </div>
        
        <div style="display: flex; flex-direction: column; line-height: 1.2; justify-content: center; max-width: 140px;">
          <span id="sidebar_company_name" style="font-weight: 800; font-size: 0.95rem; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">IdeaMakr</span>
          
          <span id="sidebar_sub_info" style="
              font-weight: 600; 
              font-size: 0.65rem; 
              color: #cbd5e1; 
              text-transform: uppercase; 
              letter-spacing: 0.5px;
              display: -webkit-box;
              -webkit-line-clamp: 2; /* üöÄ This pushes text to the 2nd line! */
              -webkit-box-orient: vertical;
              overflow: hidden;
              word-break: break-word;
              line-height: 1.3;
          ">Software Studio</span>
      </div>
      </div>
      <div class="menu">
        <div class="menu-item active" onclick="showSection('home')">
          <i class="fas fa-home"></i> Home
        </div>
        <div class="menu-item" onclick="showSection('apply')">
          <i class="fas fa-plus-circle"></i> Apply Leave
        </div>
        <div class="menu-item" onclick="showSection('history')">
          <i class="fas fa-history"></i> Leave History
        </div>
        <div class="menu-item" onclick="showSection('holidays')">
          <i class="fas fa-calendar-check"></i> Public Holidays
        </div>
        <div class="menu-item" onclick="showSection('profile')">
          <i class="fas fa-user-circle"></i> My Profile
        </div>
        
        

            <!-- ==========================================
             MANAGER DASHBOARD - id="managerMenu"
            ========================================== -->

            <div id="managerMenu" style="display: none; border-top: 1px solid #334155; margin-top: 10px">
              <div class="menu-item" onclick="toggleManagerMenu()" style="justify-content: space-between">
                <span><i class="fas fa-user-shield"></i> Manager Dashboard</span>
                <i id="managerChevron" class="fas fa-chevron-down" style="font-size: 0.8rem; transition: 0.3s"></i>
              </div>
              <div id="managerSubMenu" style="display: none; background: #0f172a; padding-left: 15px">
                <div class="menu-item" onclick="showSection('manager_requests')" style="font-size: 0.9rem; justify-content: space-between">
                  <span><i class="fas fa-tasks"></i> Leave Requests</span>
                  <span id="badge_mgr_leave" class="status-badge status-pending" style="display: none; padding: 2px 6px; font-size: 0.7rem">0</span>
                </div>
                <div class="menu-item" onclick="showSection('manager_ot_requests')" style="font-size: 0.9rem; justify-content: space-between">
                  <span><i class="fas fa-stopwatch"></i> Overtime Requests</span>
                  <span id="badge_mgr_ot" class="status-badge status-rejected" style="display: none; padding: 2px 6px; font-size: 0.7rem">0</span>
                </div>
                <div class="menu-item" onclick="showSection('manager_history')" style="font-size: 0.9rem">
                  <i class="fas fa-archive"></i> Leave History
                </div>
                <div class="menu-item" onclick="showSection('manager_entitlements')" style="font-size: 0.9rem">
                  <i class="fas fa-users"></i> Leave Entitlements
                </div>
              </div>
            </div>


            <!-- ==========================================
             HR ADMIN DASHBOARD - id="hrAdminMenu"
            ========================================== -->

            <div id="hrAdminMenu" style="display: none; border-top: 1px solid #334155; margin-top: 10px">
              <div class="menu-item" onclick="toggleAdminMenu()" style="justify-content: space-between; color: #818cf8">
                <span><i class="fas fa-shield-alt"></i> Admin Dashboard</span>
                <i id="adminChevron" class="fas fa-chevron-down" style="font-size: 0.8rem; transition: 0.3s"></i>
              </div>
              <div id="adminSubMenu" style="display: none; background: #0f172a; padding-left: 15px">
                <div class="menu-item" onclick="showSection('hr_users')" style="font-size: 0.9rem">
                  <i class="fas fa-users-cog"></i> User Management
                </div>
                <div class="menu-item" onclick="showSection('manager_entitlements')" style="font-size: 0.9rem">
                  <i class="fas fa-chart-pie"></i> Company Leave Balances
                </div>
                <div class="menu-item" onclick="showSection('hr_policy')" style="font-size: 0.9rem">
                  <i class="fas fa-file-contract"></i> Global Leave Policy
                </div>
                <div class="menu-item" onclick="showSection('hr_holidays')" style="font-size: 0.9rem">
                  <i class="fas fa-calendar-plus"></i> Company Calendar
                </div>
                <div class="menu-item" onclick="showSection('hr_reporting')" style="font-size: 0.9rem">
                  <i class="fas fa-chart-line"></i> System Reporting
                </div>
                <div class="menu-item" onclick="showSection('hr_audit')" style="font-size: 0.9rem">
                  <i class="fas fa-clipboard-list"></i> System Audit Log
                </div>
                <div id="nav_hr_settings" class="menu-item" onclick="showSection('hr_settings')" style="display: none;">
                  <i class="fas fa-cog"></i> System Settings
              </div>
              </div>
            </div>


            <div class="menu-item" onclick="showSection('password')" style="margin-top: 20px; border-top: 1px solid #334155; padding-top: 15px;">
              <i class="fas fa-lock"></i> Change Password
            </div>
  
            <div class="menu-item logout-item-sidebar" onclick="logout()" style="color: #fb7185; transition: all 0.2s; cursor: pointer;">
              <i class="fas fa-sign-out-alt"></i> Logout
            </div>
  
          </div> <div style="margin-top: auto; padding: 25px 20px; border-top: 1px solid rgba(255,255,255,0.05); text-align: center;">
            <div style="font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 4px; opacity: 0.8;">
                Version <span id="app_version_display">Loading...</span>
            </div>
            <div style="font-size: 0.85rem; color: #cbd5e1; font-weight: 600;">
                Built by <span style="color: #3b82f6;">IdeaMakr</span>
            </div>
          </div>
  
      </div> <div class="main">
          
          <div id="mobile-overlay" onclick="toggleMobileMenu()"></div>

          <div class="topbar">
            <div style="display: flex; align-items: center;">
              <button class="mobile-toggle-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
              </button>
              <div class="user-info">Logged in as: <span id="topbarName">...</span></div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout <i class="fas fa-sign-out-alt"></i></button>
          </div>


          

        <!-- HR Admin Control Panel Ends here -->

        <!-- ==========================================
             HOME SCREEN - id="HOME"
            ========================================== -->

            <div class="content">            

        <div id="home" class="section active">
            <div class="card" style="
                    padding: 40px;
                    background: #fdfdfd;
                    border-radius: 16px;
                    border: none;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
                  ">
                <div style="
                      display: flex;
                      align-items: center;
                      gap: 20px;
                      margin-bottom: 35px;
                    ">
                    <div style="
                        background: #fffbeb;
                        padding: 18px;
                        border-radius: 50%;
                        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
                      ">
                        <i class="fas fa-sun" style="font-size: 2.5rem; color: #fbbf24"></i>
                    </div>
                    <div>
                        <h1 style="
                          color: #334155;
                          margin: 0;
                          font-size: 2rem;
                          font-weight: 700;
                        ">
                            Hello, <span id="welcomeName">Employee</span>! üëã
                        </h1>
                        <p style="font-size: 1.1rem; color: #64748b; margin-top: 5px">
                            Leave Balance Overview -
                            <span class="current-year-display"></span> Cycle.
                        </p>
                    </div>
                </div>

                <div style="
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      margin-bottom: 35px;
                    ">
                    <div style="
                        background: #5ea1d7;
                        padding: 25px;
                        border-radius: 10px;
                        color: white;
                        box-shadow: 0 4px 12px rgba(94, 161, 215, 0.3);
                      ">
                        <div style="
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                        ">
                            <span style="font-weight: 700; font-size: 0.9rem">Annual Leave</span>
                            <i class="fas fa-calendar-alt" style="opacity: 0.7"></i>
                        </div>
                        <div id="card_annual" style="font-size: 2.2rem; font-weight: 800; margin-top: 10px">
                            --
                        </div>
                        <small style="opacity: 0.9">Days Available</small>
                    </div>

                    <div style="
                        background: #63b39d;
                        padding: 25px;
                        border-radius: 10px;
                        color: white;
                        box-shadow: 0 4px 12px rgba(99, 179, 157, 0.3);
                      ">
                        <div style="
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                        ">
                            <span style="font-weight: 700; font-size: 0.9rem">Medical</span>
                            <i class="fas fa-briefcase-medical" style="opacity: 0.7"></i>
                        </div>
                        <div id="card_medical" style="font-size: 2.2rem; font-weight: 800; margin-top: 10px">
                            --
                        </div>
                        <small style="opacity: 0.9">Days Available</small>
                    </div>

                    <div style="
                        background: #e57d70;
                        padding: 25px;
                        border-radius: 10px;
                        color: white;
                        box-shadow: 0 4px 12px rgba(229, 125, 112, 0.3);
                      ">
                        <div style="
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                        ">
                            <span style="font-weight: 700; font-size: 0.9rem">Emergency</span>
                            <i class="fas fa-exclamation-triangle" style="opacity: 0.7"></i>
                        </div>
                        <div id="card_emergency" style="font-size: 2.2rem; font-weight: 800; margin-top: 10px">
                            --
                        </div>
                        <small style="opacity: 0.9">Days Available</small>
                    </div>

                    <div style="
                        background: #f0b85b;
                        padding: 25px;
                        border-radius: 10px;
                        color: white;
                        box-shadow: 0 4px 12px rgba(240, 184, 91, 0.3);
                      ">
                        <div style="
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                        ">
                            <span style="font-weight: 700; font-size: 0.9rem">Compassionate</span>
                            <i class="fas fa-hand-holding-heart" style="opacity: 0.7"></i>
                        </div>
                        <div id="card_compassionate" style="font-size: 2.2rem; font-weight: 800; margin-top: 10px">
                            --
                        </div>
                        <small style="opacity: 0.9">Days Available</small>
                    </div>

                    <div id="wrapper_unpaid" style="
                        display: none;
                        background: #64748b;
                        padding: 25px;
                        border-radius: 10px;
                        color: white;
                        box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
                      ">
                        <div style="
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                        ">
                            <span style="font-weight: 700; font-size: 0.9rem">Unpaid Leave</span>
                            <i class="fas fa-hand-holding-usd" style="opacity: 0.7"></i>
                        </div>
                        <div id="card_unpaid" style="font-size: 2.2rem; font-weight: 800; margin-top: 10px">
                            0
                        </div>
                        <small style="opacity: 0.9">Total Days Taken</small>
                    </div>
                </div>
                <div id="leadership_panel" style="display: none">
                    <div style="
                        background: white;
                        border-radius: 16px;
                        border: 1px solid #f1f5f9;
                        padding: 25px;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
                        margin-bottom: 25px;
                        display: grid;
                        grid-template-columns: 3fr 1.2fr;
                        gap: 25px;
                        align-items: start;
                      ">
                        <div>
                            <div style="
                            display: flex;
                            justify-content: flex-start; /* üöÄ Aligns items to the left */
                            align-items: center;
                            gap: 12px; /* üöÄ Gap between label and icon */
                            margin-bottom: 15px;
                          ">
                                <h3 style="
                              font-size: 0.85rem;
                              color: #64748b;
                              text-transform: uppercase;
                              margin: 0;
                              font-weight: 700;
                              letter-spacing: 0.5px;
                            ">
                                    Upcoming Schedule
                                </h3>

                                <div onclick="openCalendarModal()" title="View Full Team Calendar" style="
                              cursor: pointer;
                              background: #ffffff;
                              width: 28px;
                              height: 28px;
                              border-radius: 6px;
                              border: 1px solid #e2e8f0;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                              transition: 0.2s;
                              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                            " onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'; this.style.color='#2563eb';" onmouseout="this.style.background='#ffffff'; this.style.borderColor='#e2e8f0'; this.style.color='inherit';">
                                    <i class="fas fa-calendar-alt" style="font-size: 0.8rem"></i>
                                </div>
                            </div>
                            <div style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                          ">
                                <div style="
                              background: #dbeefd;
                              border-radius: 12px;
                              padding: 20px;
                              display: flex;
                              align-items: center;
                              gap: 15px;
                              min-height: 120px;
                            ">
                                    <div style="
                                background: white;
                                width: 45px;
                                height: 45px;
                                border-radius: 10px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                                flex-shrink: 0;
                              ">
                                        <i class="fas fa-umbrella-beach" style="font-size: 1.4rem; color: #334155"></i>
                                    </div>
                                    <div id="home_next_holiday"></div>
                                </div>
                                <div style="
                              background: #e2f2e9;
                              border-radius: 12px;
                              padding: 20px;
                              display: flex;
                              align-items: center;
                              gap: 15px;
                              min-height: 120px;
                            ">
                                    <div style="
                                background: white;
                                width: 45px;
                                height: 45px;
                                border-radius: 10px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                                flex-shrink: 0;
                              ">
                                        <i class="fas fa-plane" style="font-size: 1.4rem; color: #334155"></i>
                                    </div>
                                    <div id="home_my_next_leave"></div>
                                </div>
                            </div>
                        </div>

                        <div id="leadership_mini_stats" style="display: flex; flex-direction: column">
                            <h3 style="
                            font-size: 0.85rem;
                            color: #64748b;
                            text-transform: uppercase;
                            margin-bottom: 15px;
                            font-weight: 700;
                            letter-spacing: 0.5px;
                          ">
                                Mini Stats
                            </h3>
                            <div style="
                            background: #fef3c7;
                            border-radius: 12px;
                            padding: 20px;
                            color: #92400e;
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            min-height: 120px;
                          ">
                                <div style="margin-bottom: 10px">
                                    <small style="
                                font-weight: 700;
                                font-size: 0.65rem;
                                text-transform: uppercase;
                                opacity: 0.8;
                              ">Total Apps</small>
                                    <div style="display: flex; align-items: baseline; gap: 8px">
                                        <span id="home_stat_total" style="font-size: 1.5rem; font-weight: 800">0</span>
                                        <span id="home_stat_medical" style="
                                  font-size: 0.9rem;
                                  font-weight: 700;
                                  opacity: 0.9;
                                ">0%</span>
                                    </div>
                                </div>
                                <div style="
                              border-top: 1px solid rgba(146, 64, 14, 0.15);
                              padding-top: 10px;
                            ">
                                    <small style="
                                font-weight: 700;
                                font-size: 0.65rem;
                                text-transform: uppercase;
                                opacity: 0.8;
                              ">Approved</small>
                                    <div id="home_stat_approved" style="font-size: 1.5rem; font-weight: 800">
                                        0
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="manager_action_center" style="display: none">
                  <div style="display: grid; grid-template-columns: 1.8fr 2fr; gap: 25px; margin-bottom: 30px;">
                      
                      <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                              <i class="fas fa-users" style="color: #94a3b8;"></i>
                              <small id="away_today_title" style="font-weight: 700; color: #64748b; font-size: 0.65rem; text-transform: uppercase;">Who's Away Today</small>
                          </div>
                          <div id="home_away_list"></div> </div>
              
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
                          
                          <div onclick="showSection('manager_requests')" style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 15px; cursor: pointer;">
                              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                  <small style="font-weight: 700; color: #1e40af; font-size: 0.6rem; text-transform: uppercase;">Pending Leaves</small>
                                  <div id="home_leave_count" style="font-size: 1.5rem; font-weight: 800; color: #1e3a8a;">0</div>
                              </div>
                              <div id="tile_leave_inbox" style="margin-top: 10px; border-top: 1px solid rgba(30, 64, 175, 0.1); padding-top: 8px;"></div>
                          </div>
              
                          <div onclick="showSection('manager_ot_requests')" style="background: #fff7ed; border: 1px solid #ffedd5; border-radius: 12px; padding: 15px; cursor: pointer;">
                              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                  <small style="font-weight: 700; color: #9a3412; font-size: 0.6rem; text-transform: uppercase;">Pending OT</small>
                                  <div id="home_ot_count" style="font-size: 1.5rem; font-weight: 800; color: #7c2d12;">0</div>
                              </div>
                              <div id="tile_ot_inbox" style="margin-top: 10px; border-top: 1px solid rgba(154, 52, 18, 0.1); padding-top: 8px;"></div>
                          </div>
              
                      </div>
                  </div>
              </div>

                <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 50px; text-align: center; opacity: 0.8;">
                  ¬© 2026 <span style="color: #236ee7; font-weight: 600;">IdeaMakr</span> 
                  All rights reserved.
              </p>
            </div>
        </div>



        <!-- ==========================================
             LEAVE REQUEST- id="apply"
            ========================================== -->

        <!-- APPLY LEAVE | APPLY OVERTIME | APPLY CARRY FORWARD -->

        <section id="apply" class="section saas-canvas">
          <div class="saas-tabs-container">
              <button id="tab_leave" class="saas-tab-pill active" onclick="switchApplyMode('leave')">
                  <i class="fas fa-paper-plane"></i> Apply Leave
              </button>
              <button id="tab_ot" class="saas-tab-pill" onclick="switchApplyMode('ot')">
                  <i class="fas fa-clock"></i> Apply Overtime
              </button>
              <button id="tab_unpaid" class="saas-tab-pill" onclick="switchApplyMode('unpaid')">
                  <i class="fas fa-exchange-alt"></i> Request Carry Forward
              </button>
          </div>



            <!-- ==========================================
             LEAVE APPLICATION FORM- id="apply_form_title"
            ========================================== -->

            <div class="saas-card">
              <div class="saas-card-header">
                  <h2 id="apply_form_title" style="margin: 0; color: #1e293b; display: flex; gap: 10px; align-items: center;">
                      <i class="fas fa-calendar-plus" style="color: #2563eb"></i> New Leave Request
                  </h2>
              </div>
            
              <div id="hr_proxy_banner" style="display: none; background: #fffbeb; border-bottom: 1px solid #fde68a; padding: 15px 40px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <div style="color: #b45309; font-weight: 800; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">
                          <i class="fas fa-shield-alt" style="margin-right: 5px;"></i> Admin Override: Apply on Behalf
                      </div>
                      <button type="button" id="btn_reset_proxy" onclick="resetProxyUser()" style="display: none; background: white; color: #b45309; border: 1px solid #fcd34d; border-radius: 6px; padding: 4px 12px; font-size: 0.75rem; font-weight: bold; cursor: pointer; transition: 0.2s;">
                          <i class="fas fa-undo"></i> Revert to Myself
                      </button>
                  </div>
            
                  <div style="position: relative; width: 100%;">
                    <i class="fas fa-search" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #b45309; z-index: 10; pointer-events: none;"></i>
                    
                    <input type="text" id="proxy_user_search" placeholder="Search employee name..."
                        oninput="handleProxySearch(this.value)" autocomplete="off"
                        style="width: 100%; height: 40px; padding-left: 45px !important; border: 1px solid #fcd34d; border-radius: 8px; font-size: 0.9rem; background: white; color: #b45309; box-sizing: border-box;" />
                
                    <div id="proxy_suggestions_box" style="display: none; position: absolute; top: 45px; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 100; max-height: 200px; overflow-y: auto;">
                    </div>
                </div>
            
                  <div id="proxy_active_status" style="display: none; margin-top: 12px; font-size: 0.85rem; color: #b45309; font-weight: 600; align-items: center; gap: 8px;">
                      <i class="fas fa-user-check" style="color: #d97706;"></i> Currently applying for: <strong id="proxy_target_name" style="color: #92400e; font-size: 1rem; border-bottom: 1px dashed #b45309;">---</strong>
                  </div>
              </div>
              <div class="saas-card-body">
                  <div id="form_leave_container">
                      <form id="applyLeaveForm" onsubmit="return false;">
                          
                          <div id="carry_forward_ui" style="display: none; background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                              <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px 15px; border-radius: 4px; margin-bottom: 20px; font-size: 0.85rem; color: #1e3a8a; display: flex; justify-content: space-between; align-items: center;">
                                  <div>
                                      <i class="fas fa-info-circle" style="margin-right: 6px"></i>
                                      <strong>Policy Limit:</strong> Max <span id="cf_display_limit" style="font-weight: 800">--</span> Days
                                  </div>
                                  <div>
                                      <strong>Expires:</strong> <span id="cf_display_date" style="font-weight: 800">--</span>
                                  </div>
                              </div>
          
                              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                  <span style="color: #64748b; font-weight: bold">Current Annual Balance</span>
                                  <strong id="cf_current" style="color: #1e293b">Checking...</strong>
                              </div>
          
                              <div class="saas-form-group">
                                  <label>How many days to carry forward?</label>
                                  <input type="number" id="cf_days_input" class="saas-form-control" step="0.5" min="0.5" oninput="updateCarryForwardMath()" placeholder="e.g. 5.0" />
                              </div>
          
                              <div style="margin-top: 10px; display: flex; justify-content: space-between; border-top: 1px dashed #cbd5e1; padding-top: 10px;">
                                  <span style="color: #64748b">Remaining after request</span>
                                  <strong id="cf_result" style="color: #15803d">-</strong>
                              </div>
          
                              <div class="saas-form-group" style="margin-top: 20px">
                                  <label style="color: #1e293b; font-weight: bold; font-size: 0.85rem;">Assign Approver</label>
                                  <select id="dash_approver_cf" class="saas-form-control">
                                      <option value="" disabled selected hidden>-- Select Manager --</option>
                                  </select>
                              </div>
          
                              <div class="saas-form-group" style="margin-top: 20px">
                                  <div style="display: flex; justify-content: space-between">
                                      <label>Reason for Carry Forward</label>
                                      <span id="char_count_cf" style="font-size: 0.75rem; color: #94a3b8">0/200</span>
                                  </div>
                                  <textarea id="cf_reason" class="saas-form-control" rows="3" placeholder="Explain why you are carrying days forward..." oninput="updateCharCountGeneric('cf_reason', 'char_count_cf')" maxlength="200"></textarea>
                              </div>
                          </div>
          
                          <div id="standard_leave_ui">
                              <div class="saas-form-grid">
                                  <div class="saas-form-group">
                                      <label>Leave Type</label>
                                      <select id="dash_leave_type" class="saas-form-control" required onchange="showEntitlementInfo(); updateLiveSummary()">
                                          <option value="" disabled selected hidden>Select Leave Type...</option>
                                          <option value="Annual Leave">Annual Leave</option>
                                          <option value="Medical Leave">Medical Leave</option>
                                          <option value="Emergency Leave">Emergency Leave</option>
                                          <option value="Compassionate Leave">Compassionate Leave</option>
                                          <option value="Unpaid Leave">Unpaid Leave</option>
                                      </select>
                                      <div id="dash_entitlement_info" style="font-size: 0.8rem; color: #64748b; margin-top: 4px;"></div>
                                  </div>
          
                                  <div class="saas-form-group">
                                      <label>Select Approver</label>
                                      <select id="dash_approver" class="saas-form-control">
                                          <option value="" disabled selected hidden>-- Select Manager --</option>
                                      </select>
                                  </div>
          
                                  <div class="saas-form-group">
                                      <label>Start Date</label>
                                      <input type="date" id="dash_start" class="saas-form-control" onchange="handleDateChange(); updateLiveSummary()" />
                                  </div>
          
                                  <div class="saas-form-group">
                                      <label>End Date</label>
                                      <input type="date" id="dash_end" class="saas-form-control" onchange="updateLiveSummary()" />
                                  </div>
                              </div>
          
                              <div class="saas-form-group" style="display: flex; align-items: center; padding-top: 10px;">
                                  <input type="checkbox" id="dash_half_day" onchange="toggleHalfDay(); updateLiveSummary()" style="width: 18px; height: 18px; margin-right: 10px" />
                                  <label for="dash_half_day" style="margin: 0; cursor: pointer">Taking half day leave?</label>
                              </div>
          
                              <div class="saas-form-group" style="margin-top: 20px">
                                  <div style="display: flex; justify-content: space-between">
                                      <label>Reason for Leave</label>
                                      <span id="char_count" style="font-size: 0.75rem; color: #94a3b8">0/200</span>
                                  </div>
                                  <textarea id="dash_reason" class="saas-form-control" rows="3" placeholder="e.g. Family Vacation..." oninput="updateCharCountGeneric('dash_reason', 'char_count')" maxlength="200"></textarea>
                              </div>
                          </div>
          
                          <div class="saas-form-group" style="margin-top: 20px">
                              <label>Supporting Document (Optional)</label>
                              <div class="file-upload-wrapper" style="position: relative;">
                                  <div style="background: #e2e8f0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                      <i class="fas fa-cloud-upload-alt" style="color: #64748b"></i>
                                  </div>
          
                                  <div style="flex: 1; margin-left: 12px;">
                                      <div style="font-size: 0.9rem; font-weight: 600; color: #334155;" id="leave_file_label">Click to attach file</div>
                                      <div style="font-size: 0.75rem; color: #94a3b8">Max 2MB (Images or PDF)</div>
                                  </div>
          
                                  <div id="leave_remove_btn" onclick="removeAttachment('leave_attachment', 'leave_file_label', 'leave_remove_btn'); event.stopPropagation();"
                                       style="display: none; cursor: pointer; z-index: 20; position: relative; padding: 8px; color: #ef4444; transition: transform 0.2s;"
                                       onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="Remove file">
                                      <i class="fas fa-times-circle" style="font-size: 1.2rem;"></i>
                                  </div>
          
                                  <input type="file" id="leave_attachment" accept="image/*,.pdf" onchange="updateFileLabel(this, 'leave_file_label', 'leave_remove_btn'); validateFileSize(this)" style="z-index: 1;" />
                              </div>
                              <span id="leave_file_error" style="color: #ef4444; font-size: 0.75rem; display: none; margin-top: 5px;">File too large</span>
                          </div>
          
                          <div id="apply_summary_box" style="display: none; background: #f0f9ff; border: 1px dashed #0ea5e9; padding: 15px; border-radius: 8px; margin-top: 20px;">
                              <div style="display: flex; justify-content: space-between">
                                  <span>Total Days Requested:</span>
                                  <strong id="summary_total_days">0 Day(s)</strong>
                              </div>
                              <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                  <span>New Balance (Estimate):</span>
                                  <strong id="summary_new_balance">0 Day(s)</strong>
                              </div>
                          </div>
          
                          <div class="form-actions">
                              <button type="button" class="btn-cancel" onclick="showSection('home')">Cancel</button>
                              <button type="button" class="btn-cancel" onclick="resetApplyForm()">Reset</button>
                              <button id="dash_submit_btn"type="button" class="btn-submit"onclick="submitLeaveInDashboard(event); return false;">Submit Application</button>
                          </div>
                      </form>
                  </div>


                    <!-- ==========================================
             OVERTIME APPLICATION FORM- id="form_ot_container"
            ========================================== -->

                    <div id="form_ot_container" style="display: none">
                      <form id="applyOTForm" onsubmit="return false;">
                            <div class="saas-form-grid" style="margin-bottom: 20px">
                                <div class="saas-form-group">
                                    <label>Overtime Category</label>
                                    <select id="ot_type_selector" class="saas-form-control" required onchange="updateOTFields()">
                                        <option value="" disabled selected hidden>
                                            Select Category...
                                        </option>
                                        <option value="Regular">Regular OT (1.5x)</option>
                                        <option value="Weekend">Weekend OT (2.0x)</option>
                                        <option value="Holiday">Holiday OT (3.0x)</option>
                                    </select>
                                </div>
                                <div class="saas-form-group">
                                    <label>Approver</label>
                                    <select id="dash_approver_ot" class="saas-form-control" required>
                                        <option value="" disabled selected hidden>
                                            -- Select Manager --
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="saas-form-grid">
                                <div class="saas-form-group">
                                    <label>Date</label>
                                    <input type="date" id="ot_date" class="saas-form-control" required onchange="autoSelectOTType()" />
                                </div>
                                <div class="saas-form-group">
                                    <label>Calculation Unit</label>
                                    <select id="ot_unit" class="saas-form-control" onchange="updateOTFields()">
                                        <option value="hours">Hourly Based</option>
                                        <option value="days">Day Based</option>
                                    </select>
                                </div>
                            </div>

                            <div id="ot_time_fields" class="saas-form-grid" style="margin-top: 20px">
                                <div class="saas-form-group">
                                    <label>Start Time</label>
                                    <select id="ot_start" class="saas-form-control" onchange="calculateOTDuration()"></select>
                                </div>
                                <div class="saas-form-group">
                                    <label>End Time</label>
                                    <select id="ot_end" class="saas-form-control" onchange="calculateOTDuration()"></select>
                                </div>
                            </div>

                            <div id="ot_summary_box" style="
                      display: none;
                      background: #eff6ff;
                      border: 1px solid #bfdbfe;
                      border-radius: 8px;
                      padding: 20px;
                      margin-top: 25px;
                      align-items: center;
                      justify-content: space-between;
                    ">
                                <div>
                                    <div style="
                          font-size: 0.75rem;
                          color: #1e40af;
                          font-weight: bold;
                          text-transform: uppercase;
                          letter-spacing: 0.5px;
                        ">
                                        Total Claimable
                                    </div>
                                    <div style="
                          font-size: 0.85rem;
                          color: #64748b;
                          margin-top: 2px;
                        ">
                                        Based on selected times
                                    </div>
                                </div>
                                <div style="text-align: right">
                                    <div style="  
                          font-size: 2rem;
                          font-weight: 800;
                          color: #1e3a8a;
                          line-height: 1;
                        ">
                                        <span id="ot_duration_display">0.0</span>
                                        <span style="
                            font-size: 1rem;
                            font-weight: 600;
                            color: #3b82f6;
                          ">HRS</span>
                                    </div>
                                </div>
                            </div>

                            <div class="saas-form-group" style="margin-top: 25px">
                              <div style="display: flex; justify-content: space-between">
                                  <label>Justification</label>
                                  <span id="char_count_ot" style="font-size: 0.75rem; color: #94a3b8">0/200</span>
                              </div>
                              <textarea id="ot_reason" class="saas-form-control" rows="3" placeholder="Explain the work done..." required oninput="updateCharCountGeneric('ot_reason', 'char_count_ot')" maxlength="200"></textarea>
                          </div>

                            <div class="saas-form-group" style="margin-top: 20px">
                              <label>Supporting Document (Optional)</label>
                              <div class="file-upload-wrapper" style="position: relative;">
                                  <div style="
                                      background: #e2e8f0;
                                      width: 40px;
                                      height: 40px;
                                      border-radius: 50%;
                                      display: flex;
                                      align-items: center;
                                      justify-content: center;
                                  ">
                                      <i class="fas fa-cloud-upload-alt" style="color: #64748b"></i>
                                  </div>
                          
                                  <div style="flex: 1; margin-left: 12px;">
                                      <div style="font-size: 0.9rem; font-weight: 600; color: #334155;" id="ot_file_label">
                                          Click to attach file
                                      </div>
                                      <div style="font-size: 0.75rem; color: #94a3b8">
                                          Max 2MB (Images or PDF)
                                      </div>
                                  </div>
                          
                                  <div id="ot_remove_btn"
                                       onclick="removeAttachment('ot_attachment', 'ot_file_label', 'ot_remove_btn'); event.stopPropagation();"
                                       style="
                                          display: none;
                                          cursor: pointer;
                                          z-index: 20;
                                          position: relative;
                                          padding: 8px;
                                          color: #ef4444;
                                          transition: transform 0.2s;
                                       "
                                       onmouseover="this.style.transform='scale(1.2)'"
                                       onmouseout="this.style.transform='scale(1)'"
                                       title="Remove file">
                                      <i class="fas fa-times-circle" style="font-size: 1.2rem;"></i>
                                  </div>
                          
                                  <input type="file" id="ot_attachment" accept="image/*,.pdf"
                                         onchange="updateFileLabel(this, 'ot_file_label', 'ot_remove_btn'); validateFileSize(this)"
                                         style="z-index: 1;" />
                              </div>
                              <span id="ot_file_error" style="color: #ef4444; font-size: 0.75rem; display: none; margin-top: 5px;">File too large</span>
                          </div>

                          <div class="form-actions">
                            <button type="button" class="btn-cancel" onclick="showSection('home')">
                                Cancel
                            </button>
                            <button type="button" class="btn-cancel" onclick="resetOTForm()">
                                Reset
                            </button>
                            
                            <button 
                                id="dash_ot_submit_btn" 
                                type="button" 
                                class="btn-submit" 
                                onclick="submitOTInDashboard(event)"
                            >
                                Submit OT Claim
                            </button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- ==========================================
             MY LEAVE HISTORY - id="history"
            ========================================== -->
            <div id="history" class="section">
              <div class="card">
                  <h2 style="display: flex; align-items: center; gap: 10px;">
                      <i class="fas fa-history"></i> My Leave History
                  </h2>
          
                  <div class="filter-bar" style="background: #f8fafc; margin-bottom: 20px; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px;">
                      <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Leave Type</label>
                              <select id="filter_type" onchange="loadHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 130px; background: white;">
                                  <option value="">Any</option>
                                  <option>Annual Leave</option>
                                  <option>Medical Leave</option>
                                  <option>Emergency Leave</option>
                                  <option>Compassionate Leave</option>
                                  <option value="Overtime">Overtime</option>
                              </select>
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Duration</label>
                              <input type="number" id="filter_duration" placeholder="Days" oninput="loadHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 80px;">
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Start Date</label>
                              <input type="date" id="filter_date" onchange="loadHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 145px;">
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">End Date</label>
                              <input type="date" id="filter_end_date" onchange="loadHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 145px;">
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Status</label>
                              <select id="filter_status" onchange="loadHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 140px; background: white;">
                                  <option value="">All Status</option>
                                  <option>Approved</option>
                                  <option>Rejected</option>
                                  <option>Cancelled</option>
                                  <option>Pending</option>
                                  <option>Pending Cancel</option>
                                  <option>Withdrawn</option>
                              </select>
                          </div>
          
                          <div style="display: flex; gap: 8px; align-items: center;">
    
                            <button type="button" onclick="resetHistoryFilters()" title="Reset Filters" 
                                style="background: white; color: #64748b; border: 1px solid #cbd5e1; width: 36px; height: 36px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                                onmouseover="this.style.background='#f1f5f9'" 
                                onmouseout="this.style.background='white'">
                                <i class="fas fa-undo"></i>
                            </button>
                        
                            <button type="button" id="refreshBtn" onclick="loadHistory(1)" 
                                style="background: #2563eb; color: white; border: none; padding: 0 18px; height: 36px; border-radius: 6px; font-weight: 700; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh
                            </button>
                        </div>
                      </div>
                  </div>
          
                  <div style="border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white;">
                    <div class="table-scroll-container" style="max-height: 500px; overflow-y: auto;">
                        <table id="historyTable" style="width: 100%; border-collapse: separate; border-spacing: 0;">
                          <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                
                              <th onclick="sortHistoryTable('type')" style="width: 12%; padding: 12px 15px; text-align: left; color: #475569; cursor: pointer; user-select: none;">
                                Type <i id="hist-sort-type" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                            </th>
                                <th onclick="sortHistoryTable('leave_type')" style="width: 22%; padding: 12px 15px; text-align: left; color: #475569; cursor: pointer; user-select: none;">
                                    Category <i id="hist-sort-leave_type" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortHistoryTable('days_taken')" style="width: 12%; padding: 12px 15px; text-align: center; color: #475569; cursor: pointer; user-select: none;">
                                    Duration <i id="hist-sort-days_taken" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortHistoryTable('start_date')" style="width: 30%; padding: 12px 15px; text-align: center; color: #475569; cursor: pointer; user-select: none;">
                                    Date Range (Start | End) <i id="hist-sort-start_date" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortHistoryTable('status')" style="width: 12%; padding: 12px 15px; text-align: center; color: #475569; cursor: pointer; user-select: none;">
                                    Status <i id="hist-sort-status" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                                </th>
                
                                <th style="width: 16%; padding: 12px 15px; text-align: center; color: #475569;">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                              <tbody id="historyTableBody"></tbody>
                          </table>
                      </div>
          
                      <div id="paginationControls" style="display: none; justify-content: space-between; align-items: center; padding: 15px 25px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                          <button id="prevPageBtn" onclick="changePage(-1)" class="btn-secondary" style="padding: 8px 18px; border-radius: 6px; font-weight: bold;">
                              <i class="fas fa-chevron-left"></i> Previous
                          </button>
                          
                          <div style="text-align: center;">
                              <div id="pageLabelInfo" style="font-weight: 800; color: #1e293b; font-size: 0.9rem;">Page 1 of 1</div>
                              <div style="font-size: 0.75rem; color: #64748b; margin-top: 2px;">
                                  Records Found: <span id="totalRecordsSpan" style="font-weight: bold; color: #2563eb;">0</span>
                              </div>
                          </div>
          
                          <button id="nextPageBtn" onclick="changePage(1)" class="btn-secondary" style="padding: 8px 18px; border-radius: 6px; font-weight: bold;">
                              Next <i class="fas fa-chevron-right"></i>
                          </button>
                      </div>
                  </div>
              </div>
          </div>
        <!-- ==========================================
             PUBLIC HOLIDAYS - id="holidays"
            ========================================== -->

        <div id="holidays" class="section">
            <div class="card" style="
                    padding: 0;
                    overflow: hidden;
                    border-radius: 16px;
                    border: 1px solid #e2e8f0;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                  ">
                <div style="
                      padding: 25px 30px;
                      border-bottom: 1px solid #f1f5f9;
                      background: #ffffff;
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                    ">
                    <div>
                        <h2 style="
                          margin: 0;
                          font-size: 1.4rem;
                          color: #1e293b;
                          display: flex;
                          align-items: center;
                          gap: 10px;
                          border: none;
                          padding: 0;
                        ">
                            <i class="fas fa-umbrella-beach" style="color: #0ea5e9"></i>
                            Public Holidays
                        </h2>
                        <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.9rem">
                            Official office closures for the
                            <span class="current-year-display">2026</span> calendar year.
                        </p>
                    </div>
                    <button onclick="loadPublicHolidays()" style="
                    height: 38px;
                    padding: 0 15px;
                    font-size: 0.85rem;
                    font-weight: 600;
                    color: #475569;
                    background: white;
                    border: 1px solid #cbd5e1;
                    border-radius: 6px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.2s;
                  " onmouseover="this.style.background='#f8fafc'; this.style.color='#1e293b';" onmouseout="this.style.background='white'; this.style.color='#475569';">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                </div>

                <div id="holidayTimelineContainer" style="
                      padding: 30px;
                      background: #fdfdfd;
                      max-height: 60vh;
                      overflow-y: auto;
                    ">
                    <div class="text-center" style="padding: 40px; color: #94a3b8; text-align: center">
                        <i class="fas fa-circle-notch fa-spin fa-2x"></i>
                        <p style="margin-top: 15px; font-weight: 600">
                            Loading office calendar...
                        </p>
                    </div>
                </div>

                <div style="
                      padding: 15px 30px;
                      background: #f8fafc;
                      border-top: 1px solid #f1f5f9;
                      color: #94a3b8;
                      font-size: 0.75rem;
                      font-style: italic;
                    ">
                    <i class="fas fa-info-circle"></i> Note: These dates are
                    automatically excluded from leave duration calculations.
                </div>
            </div>
        </div>

        <!-- ==========================================
             MY PROFILE - id="profile"
            ========================================== -->
        <div id="profile" class="section">
            <div class="card" style="
                    padding: 0;
                    overflow: hidden;
                    border-radius: 16px;
                    border: 1px solid #e2e8f0;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                  ">
                <div style="
                      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                      padding: 40px 30px;
                      display: flex;
                      align-items: center;
                      gap: 25px;
                    ">
                    <div id="prof_avatar" style="
                        width: 80px;
                        height: 80px;
                        background: #3b82f6;
                        color: white;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 2rem;
                        font-weight: 800;
                        border: 4px solid rgba(255, 255, 255, 0.2);
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                      ">
                        --
                    </div>

                    <div>
                        <h1 id="profileName" style="
                          margin: 0;
                          color: white;
                          font-size: 1.8rem;
                          font-weight: 800;
                          letter-spacing: -0.5px;
                        ">
                            Loading...
                        </h1>
                        <div style="
                          display: flex;
                          align-items: center;
                          gap: 10px;
                          margin-top: 8px;
                        ">
                            <span id="prof_username" style="
                            color: #94a3b8;
                            font-family: monospace;
                            font-size: 0.9rem;
                          ">@username</span>
                            <div id="prof_role_badge"></div>
                        </div>
                    </div>
                </div>

                <div style="padding: 30px; background: #ffffff">
                    <h3 style="
                        font-size: 0.75rem;
                        color: #64748b;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        border-bottom: 1px solid #e2e8f0;
                        padding-bottom: 10px;
                        margin-top: 0;
                        font-weight: 800;
                      ">
                        <i class="fas fa-id-card" style="margin-right: 8px"></i>
                        Employment Details
                    </h3>

                    <div style="
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 20px;
                        margin-bottom: 40px;
                      ">
                        <div style="
                          background: #f8fafc;
                          padding: 15px;
                          border-radius: 8px;
                          border: 1px solid #f1f5f9;
                        ">
                            <label style="
                            display: block;
                            font-size: 0.65rem;
                            font-weight: 700;
                            color: #64748b;
                            margin-bottom: 4px;
                            text-transform: uppercase;
                          ">EMPLOYEE ID</label>
                            <div id="prof_id" style="
                            font-weight: 700;
                            color: #1e293b;
                            font-size: 1.1rem;
                            font-family: monospace;
                          ">
                                ---
                            </div>
                        </div>
                        <div style="
                          background: #f8fafc;
                          padding: 15px;
                          border-radius: 8px;
                          border: 1px solid #f1f5f9;
                        ">
                            <label style="
                            display: block;
                            font-size: 0.65rem;
                            font-weight: 700;
                            color: #64748b;
                            margin-bottom: 4px;
                            text-transform: uppercase;
                          ">JOB TITLE</label>
                            <div id="prof_job" style="font-weight: 700; color: #1e293b; font-size: 1rem">
                                ---
                            </div>
                        </div>
                        <div style="
                          background: #f8fafc;
                          padding: 15px;
                          border-radius: 8px;
                          border: 1px solid #f1f5f9;
                        ">
                            <label style="
                            display: block;
                            font-size: 0.65rem;
                            font-weight: 700;
                            color: #64748b;
                            margin-bottom: 4px;
                            text-transform: uppercase;
                          ">JOINED DATE</label>
                            <div id="prof_joined" style="font-weight: 700; color: #1e293b; font-size: 1rem">
                                ---
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px">
                      <div>
                          <h3 style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; font-weight: 800;">
                              <i class="fas fa-sitemap" style="margin-right: 8px"></i>
                              Organization
                          </h3>
                          <div style="display: grid; gap: 15px">
                              <div style="display: flex; justify-content: flex-start; align-items: center; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;">
                                  <span style="color: #64748b; font-size: 0.9rem; min-width: 140px;">Department</span>
                                  <span id="prof_dept" style="font-weight: 600; color: #334155">---</span>
                              </div>
                              <div style="display: flex; justify-content: flex-start; align-items: center; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;">
                                  <span style="color: #64748b; font-size: 0.9rem; min-width: 140px;">Business Unit</span>
                                  <span id="prof_unit" style="font-weight: 600; color: #334155">---</span>
                              </div>
                              <div style="display: flex; justify-content: flex-start; align-items: center; padding-bottom: 8px;">
                                  <span style="color: #64748b; font-size: 0.9rem; min-width: 140px;">Line Manager</span>
                                  <span id="prof_manager" style="font-weight: 600; color: #2563eb">---</span>
                              </div>
                          </div>
                      </div>
                  
                      <div>
                          <h3 style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; font-weight: 800;">
                              <i class="fas fa-address-book" style="margin-right: 8px"></i>
                              Personal Info
                          </h3>
                          <div style="display: grid; gap: 15px">
                              <div style="display: flex; justify-content: flex-start; align-items: center; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;">
                                  <span style="color: #64748b; font-size: 0.9rem; min-width: 140px;">Email</span>
                                  <span id="prof_email" style="font-weight: 600; color: #334155">---</span>
                              </div>
                              <div style="display: flex; justify-content: flex-start; align-items: center; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;">
                                  <span style="color: #64748b; font-size: 0.9rem; min-width: 140px;">Mobile</span>
                                  <span id="prof_mobile" style="font-weight: 600; color: #334155">---</span>
                              </div>
                              <div style="display: flex; justify-content: flex-start; align-items: center; padding-bottom: 8px;">
                                  <span style="color: #64748b; font-size: 0.9rem; min-width: 140px;">Status</span>
                                  <span id="prof_marital" style="font-weight: 600; color: #334155">---</span>
                              </div>
                          </div>
                      </div>
                  </div>
                </div>
            </div>
        </div>


        <!-- ==========================================
             PASSWORD - id="password"
            ========================================== -->
        <div id="password" class="section saas-canvas">
            <div style="
                    width: 100%;
                    display: flex;
                    justify-content: center;
                    align-items: flex-start;
                    padding-top: 20px;
                  ">
                <div class="saas-card" style="
                      width: 100%;
                      max-width: 480px;
                      margin: 0 auto;
                      overflow: hidden;
                      border: 1px solid #e2e8f0;
                      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                    ">
                    <div style="
                        background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
                        padding: 35px 30px;
                        text-align: center;
                        color: white;
                      ">
                        <div style="
                          width: 55px;
                          height: 55px;
                          background: rgba(255, 255, 255, 0.1);
                          border-radius: 50%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          margin: 0 auto 15px auto;
                          border: 1px solid rgba(255, 255, 255, 0.3);
                        ">
                            <i class="fas fa-shield-alt fa-2x"></i>
                        </div>
                        <h2 style="
                          margin: 0;
                          color: white;
                          border: none;
                          font-size: 1.3rem;
                          font-weight: 800;
                          letter-spacing: -0.5px;
                        ">
                            Security Credentials
                        </h2>
                        <p style="
                          margin: 8px 0 0 0;
                          opacity: 0.7;
                          font-size: 0.85rem;
                          line-height: 1.4;
                        ">
                            Protect your account by using a unique and strong password.
                        </p>
                    </div>

                    <div class="saas-card-body" style="padding: 30px; background: white">
                      <form id="changePasswordForm">
                        <style>
                            /* This prevents Edge/Chrome from adding a second eye icon over ours */
                            #changePasswordForm input::-ms-reveal,
                            #changePasswordForm input::-ms-clear {
                                display: none;
                            }
                        </style>
                    
                        <div class="saas-form-group" style="margin-bottom: 20px">
                            <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Current Password</label>
                            <div style="position: relative; margin-top: 5px; display: flex; align-items: center;">
                                <input type="password" id="p1" class="saas-form-control" oninput="clearError('p1_error')" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                    style="height: 48px; width: 100%; padding-left: 45px; padding-right: 45px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;" />
                                <i class="fas fa-lock" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #cbd5e1; pointer-events: none;"></i>
                                <i class="fas fa-eye" onclick="togglePass('p1')" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8; z-index: 10;"></i>
                            </div>
                            <small id="p1_error" style="color: #ef4444; display: none; font-size: 0.7rem; font-weight: bold; margin-top: 6px;"></small>
                        </div>
                    
                        <div style="height: 1px; background: #f1f5f9; margin: 25px 0"></div>
                    
                        <div class="saas-form-group" style="margin-bottom: 20px">
                            <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">New Password</label>
                            <div style="position: relative; margin-top: 5px; display: flex; align-items: center;">
                                <input type="password" id="p2" class="saas-form-control" oninput="clearError('p2_error')" placeholder="Min. 6 characters" 
                                    style="height: 48px; width: 100%; padding-left: 45px; padding-right: 45px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;" />
                                <i class="fas fa-key" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #cbd5e1; pointer-events: none;"></i>
                                <i class="fas fa-eye" onclick="togglePass('p2')" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8; z-index: 10;"></i>
                            </div>
                            <small id="p2_error" style="color: #ef4444; display: none; font-size: 0.7rem; font-weight: bold; margin-top: 6px;"></small>
                        </div>
                    
                        <div class="saas-form-group" style="margin-bottom: 30px">
                            <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Confirm New Password</label>
                            <div style="position: relative; margin-top: 5px; display: flex; align-items: center;">
                                <input type="password" id="p3" class="saas-form-control" oninput="clearError('p3_error')" placeholder="Repeat new password" 
                                    style="height: 48px; width: 100%; padding-left: 45px; padding-right: 45px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;" />
                                <i class="fas fa-check-double" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #cbd5e1; pointer-events: none;"></i>
                                <i class="fas fa-eye" onclick="togglePass('p3')" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8; z-index: 10;"></i>
                            </div>
                            <small id="p3_error" style="color: #ef4444; display: none; font-size: 0.7rem; font-weight: bold; margin-top: 6px;"></small>
                        </div>
                    
                        <div style="display: flex; gap: 12px; margin-top: 10px; width: 100%;">
                          <button type="button" class="btn-submit" onclick="submitPasswordChange()" 
                              style="
                                  flex: 1; 
                                  height: 48px; 
                                  display: flex; 
                                  align-items: center; 
                                  justify-content: center; 
                                  gap: 8px; 
                                  font-weight: 700; 
                                  font-size: 0.9rem;
                                  border-radius: 8px; 
                                  border: none;
                                  cursor: pointer;
                                  padding: 0; /* Reset padding to rely on height for consistency */
                              ">
                              <i class="fas fa-save"></i> Update Password
                          </button>
                      
                          <button type="button" onclick="showSection('home')" 
                              style="
                                  flex: 1; 
                                  height: 48px; 
                                  display: flex; 
                                  align-items: center; 
                                  justify-content: center; 
                                  border: 1px solid #cbd5e1; 
                                  background: white; 
                                  color: #64748b; 
                                  font-weight: 700; 
                                  font-size: 0.9rem;
                                  border-radius: 8px; 
                                  cursor: pointer;
                                  padding: 0;
                                  transition: all 0.2s;
                              "
                              onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#94a3b8';"
                              onmouseout="this.style.background='white'; this.style.borderColor='#cbd5e1';">
                              Cancel
                          </button>
                      </div>
                    </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==========================================
             MANAGER APPROVAL- id="manager_requests"
            ========================================== -->

        <div id="manager_requests" class="section">
            <div class="card">
                <h2><i class="fas fa-tasks"></i> Pending Approval Queue</h2>

                <div class="filter-container" style="
                      display: grid;
                      grid-template-columns: 1fr 1fr 1fr 1fr 1fr 140px;
                      gap: 15px;
                      margin-bottom: 20px;
                      background: #eef6ff;
                      padding: 20px;
                      border-radius: 8px;
                      align-items: end;
                      border: 1px solid #dbeafe; /* Added subtle border for definition */
                    ">
                    <div>
                        <label style="
                          font-size: 0.8rem;
                          font-weight: bold;
                          color: #1e40af;
                          display: block;
                          margin-bottom: 5px;
                        ">Employee Name</label>
                        <input type="text" id="mgr_search_name" placeholder="e.g. Neil" oninput="loadManagerRequests()" style="
                          width: 100%;
                          padding: 8px;
                          border: 1px solid #cbd5e1;
                          border-radius: 4px;
                        " />
                    </div>
                    <div>
                        <label style="
                          font-size: 0.8rem;
                          font-weight: bold;
                          color: #1e40af;
                          display: block;
                          margin-bottom: 5px;
                        ">Leave Type</label>
                        <select id="mgr_search_type" onchange="loadManagerRequests()" style="
                          width: 100%;
                          padding: 8px;
                          border: 1px solid #cbd5e1;
                          border-radius: 4px;
                        ">
                            <option value="">All Types</option>
                            <option value="Annual Leave">Annual Leave</option>
                            <option value="Medical Leave">Medical Leave</option>
                            <option value="Emergency Leave">Emergency Leave</option>
                            <option value="Compassionate Leave">Compassionate Leave</option>
                            <option value="Unpaid Leave">Unpaid Leave</option>
                        </select>
                    </div>
                    <div>
                        <label style="
                          font-size: 0.8rem;
                          font-weight: bold;
                          color: #1e40af;
                          display: block;
                          margin-bottom: 5px;
                        ">Start Date</label>
                        <input type="date" id="mgr_search_date" onchange="loadManagerRequests()" style="
                          width: 100%;
                          padding: 8px;
                          border: 1px solid #cbd5e1;
                          border-radius: 4px;
                        " />
                    </div>
                    <div>
                        <label style="
                          font-size: 0.8rem;
                          font-weight: bold;
                          color: #1e40af;
                          display: block;
                          margin-bottom: 5px;
                        ">End Date</label>
                        <input type="date" id="mgr_search_end_date" onchange="loadManagerRequests()" style="
                          width: 100%;
                          padding: 8px;
                          border: 1px solid #cbd5e1;
                          border-radius: 4px;
                        " />
                    </div>
                    <div>
                        <label style="
                          font-size: 0.8rem;
                          font-weight: bold;
                          color: #1e40af;
                          display: block;
                          margin-bottom: 5px;
                        ">Status</label>
                        <select id="mgr_search_status" onchange="loadManagerRequests()" style="
                          width: 100%;
                          padding: 8px;
                          border: 1px solid #cbd5e1;
                          border-radius: 4px;
                        ">
                            <option value="">All Active</option>
                            <option value="Pending">L1 Pending (Manager)</option>

                            <option id="opt_l2_pending" value="Pending L2 Approval">
                                L2 Pending (Dept Head)
                            </option>

                            <option value="Pending Cancel">Cancellation Requests</option>
                        </select>
                    </div>
                   
<div style="display: flex; gap: 8px;">
                        
                        <button type="button" onclick="resetManagerLeaveFilters()" title="Reset Filters" 
                                style="height: 38px; width: 38px; background: white; border: 1px solid #cbd5e1; border-radius: 4px; color: #64748b; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s;"
                                onmouseover="this.style.background='#f1f5f9'" 
                                onmouseout="this.style.background='white'">
                            <i class="fas fa-undo"></i>
                        </button>

                        <button class="btn-primary" onclick="loadManagerRequests()" style="
                          height: 38px;
                          flex: 1; /* üöÄ Fills remaining space */
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          gap: 8px;
                          background-color: #2563eb;
                          color: white;
                          border: none;
                          border-radius: 4px;
                          cursor: pointer;
                          font-weight: 600;
                          transition: background 0.2s;
                        " onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>

                    </div>
                    </div>

                <table style="width: 100%; border-collapse: separate; border-spacing: 0">
                  <thead id="managerLeaveThead">
                    <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0">
                        <th onclick="sortManagerQueue('employee_name')" style="width: 35%; padding: 12px 15px; text-align: left; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; cursor: pointer; user-select: none;">
                            Employee Details <i id="mgr-sort-employee_name" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                        </th>
                
                        <th onclick="sortManagerQueue('days_taken')" style="width: 15%; padding: 12px 15px; text-align: left; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; cursor: pointer; user-select: none;">
                            Duration <i id="mgr-sort-days_taken" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                        </th>
                
                        <th onclick="sortManagerQueue('start_date')" style="width: 20%; padding: 12px 15px; text-align: left; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; cursor: pointer; user-select: none;">
                            Dates <i id="mgr-sort-start_date" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                        </th>
                
                        <th style="display: none"></th>
                
                        <th onclick="sortManagerQueue('status')" style="width: 15%; padding: 12px 15px; text-align: center; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; cursor: pointer; user-select: none;">
                            Status <i id="mgr-sort-status" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                        </th>
                
                        <th style="width: 15%; padding: 12px 15px; text-align: center; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700;">
                            Actions
                        </th>
                    </tr>
                </thead>

                    <tbody id="managerRequestsTableBody"></tbody>
                </table>

                <div class="pagination-footer" style="
                      margin-top: 20px;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      gap: 20px;
                    ">
                    <button class="btn-secondary" id="mgrPrevBtn" onclick="mgrChangePage(-1)" style="font-size: 0.85rem">
                        Previous
                    </button>
                    <span id="mgrPageInfo" style="font-size: 0.9rem; font-weight: bold; color: #1e293b">Records Found: 0</span>
                    <button class="btn-secondary" id="mgrNextBtn" onclick="mgrChangePage(1)" style="font-size: 0.85rem">
                        Next
                    </button>
                </div>
            </div>
        </div>

        <!-- ==========================================
             Pending Overtime Claims - id="manager_ot_requests"
            ========================================== -->


            <div id="manager_ot_requests" class="section">
              <div class="card">
                  <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 25px;">
                      <h2 style="display: flex; align-items: center; gap: 10px; margin: 0; border: none;">
                          <i class="fas fa-stopwatch"></i> Pending Overtime Claims
                      </h2>
                  </div>
          
                  <div class="filter-bar" style="background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 20px; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr auto auto; gap: 10px; align-items: end;">
                      <div class="filter-group">
                          <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Employee</label>
                          <input type="text" id="mgr_ot_filter_name" placeholder="Search name..." oninput="loadManagerOTRequests()" style="padding: 8px 12px; width: 100%; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; font-size: 0.85rem;">
                      </div>
                      <div class="filter-group">
                          <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Category</label>
                          <select id="mgr_ot_filter_type" onchange="loadManagerOTRequests()" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem;">
                              <option value="">Any</option>
                              <option>Regular</option>
                              <option>Weekend</option>
                              <option>Holiday</option>
                          </select>
                      </div>
                      <div class="filter-group">
                          <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Date</label>
                          <input type="date" id="mgr_ot_filter_date" onchange="loadManagerOTRequests()" style="padding: 7px 10px; width: 100%; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem;">
                      </div>
                      <div class="filter-group">
                          <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Duration</label>
                          <input type="number" id="mgr_ot_filter_duration" placeholder="Hrs" oninput="loadManagerOTRequests()" style="padding: 8px 12px; width: 100%; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; font-size: 0.85rem;">
                      </div>
                      <div class="filter-group">
                          <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Status</label>
                          <select id="mgr_ot_filter_status" onchange="loadManagerOTRequests()" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem;">
                              <option value="">All Status</option>
                              <option>Pending</option>
                              <option id="opt_ot_l2_pending">Pending L2 Approval</option>
                              <option>Pending Cancel</option>
                          </select>
                      </div>
                      <button class="btn-secondary" onclick="resetManagerOTFilters()" style="height: 38px; width: 40px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Reset Filters">
                          <i class="fas fa-undo"></i>
                      </button>
                      <button class="btn" onclick="loadManagerOTRequests()" style="height: 38px; background: #2563eb; color: white; border: none; padding: 0 15px; font-weight: bold; border-radius: 6px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px;">
                          <i class="fas fa-sync-alt" id="mgrOTRefreshIcon"></i> REFRESH
                      </button>
                  </div>
          
                  <div class="table-container" style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                      <table style="width: 100%; border-collapse: collapse">
                          <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 10; border-bottom: 2px solid #e2e8f0;">
                              <tr>
                                  <th onclick="sortManagerOTQueue('employee_name')" style="width: 30%; padding: 12px 15px; text-align: left; color: #64748b; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; user-select: none;">
                                      Employee <i id="mgr-ot-sort-employee_name" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                                  </th>
                                  <th style="width: 15%; padding: 12px 15px; text-align: left; color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Category</th>
                                  <th onclick="sortManagerOTQueue('ot_date')" style="width: 15%; padding: 12px 15px; text-align: left; color: #64748b; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; user-select: none;">
                                      Date <i id="mgr-ot-sort-ot_date" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                                  </th>
                                  <th onclick="sortManagerOTQueue('total_value')" style="width: 15%; padding: 12px 15px; text-align: center; color: #64748b; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; user-select: none;">
                                      Claimed <i id="mgr-ot-sort-total_value" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                                  </th>
                                  <th onclick="sortManagerOTQueue('status')" style="width: 10%; padding: 12px 15px; text-align: center; color: #64748b; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; user-select: none;">
                                      Status <i id="mgr-ot-sort-status" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i>
                                  </th>
                                  <th style="width: 15%; padding: 12px 15px; text-align: center; color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Actions</th>
                              </tr>
                          </thead>
                          <tbody id="managerOTTableBody"></tbody>
                      </table>
                  </div>
          
                  <div class="pagination-footer" style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 20px;">
                      <button class="btn-secondary" id="otPrevBtn" onclick="otChangePage(-1)" style="font-size: 0.85rem">
                          <i class="fas fa-chevron-left"></i> Previous
                      </button>
                      <span id="otPageInfo" style="font-size: 0.9rem; font-weight: bold; color: #1e293b">Records Found: 0</span>
                      <button class="btn-secondary" id="otNextBtn" onclick="otChangePage(1)" style="font-size: 0.85rem">
                          Next <i class="fas fa-chevron-right"></i>
                      </button>
                  </div>
              </div>
          </div>

        <!-- ==========================================
             TEAM LEAVE HISTORY - id="manager_history"
            ========================================== -->

            <div id="manager_history" class="section">
              <div class="card">
                  <h2 style="display: flex; align-items: center; gap: 10px;">
                      <i class="fas fa-archive"></i> Team Leave History
                  </h2>
          
                  <div class="filter-bar" style="background: #f8fafc; margin-bottom: 20px; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px;">
                      <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Employee Name</label>
                              <input type="text" id="mgr_hist_name" placeholder="Search name..." oninput="loadTeamHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 160px;">
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Type</label>
                              <select id="mgr_hist_type" onchange="loadTeamHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100px; background: white; cursor: pointer;">
                                  <option value="Any">Any</option>
                                  <option value="Leave">Leave</option>
                                  <option value="OT">Overtime</option>
                              </select>
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Duration</label>
                              <input type="number" id="mgr_hist_duration" placeholder="Days" oninput="loadTeamHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 70px;">
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Start Date</label>
                              <input type="date" id="mgr_hist_start" onchange="loadTeamHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 135px;">
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">End Date</label>
                              <input type="date" id="mgr_hist_end" onchange="loadTeamHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 135px;">
                          </div>
          
                          <div class="filter-group">
                              <label style="font-size: 0.65rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Status</label>
                              <select id="mgr_hist_status" onchange="loadTeamHistory(1)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 130px; background: white; cursor: pointer;">
                                  <option value="">All Status</option>
                                  <option value="Approved">Approved</option>
                                  <option value="Pending">Pending</option>
                                  <option value="Rejected">Rejected</option>
                                  <option value="Cancelled">Cancelled</option>
                                  <option value="Withdrawn">Withdrawn</option>
                              </select>
                          </div>
          
                          <div style="display: flex; gap: 8px; align-items: center;">
                            <button type="button" onclick="resetTeamHistoryFilters()" title="Reset Filters" 
                                style="background: white; color: #64748b; border: 1px solid #cbd5e1; width: 42px; height: 42px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                                <i class="fas fa-undo"></i>
                            </button>
                        
                            <button type="button" id="mgrHistRefreshBtn" onclick="loadTeamHistory(mgrHistCurrentPage)" 
                                style="background: #2563eb; color: white; border: none; padding: 0 18px; height: 42px; border-radius: 8px; font-weight: 700; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: background 0.2s;">
                                <i class="fas fa-sync-alt" id="mgrRefreshIcon"></i> Refresh
                            </button>
                        
                            <button type="button" onclick="exportTeamHistoryCSV()" title="Export Current View" 
                                style="background: #10b981; color: white; border: none; padding: 0 18px; height: 42px; border-radius: 8px; font-weight: 700; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: background 0.2s;">
                                <i class="fas fa-file-csv"></i> Export
                            </button>
                        </div>
                      </div>
                  </div>
          
                  <div style="border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white;">
                      <div style="max-height: 550px; overflow-y: auto;">
                          <table class="modern-table" style="margin-top: 0;">
                              <thead style="position: sticky; top: 0; z-index: 10; background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                  <tr>
                                      <th style="width: 10%; padding: 15px;">ID</th>
                                      <th style="width: 20%; padding: 15px;">Employee</th>
                                      <th style="width: 15%; padding: 15px;">Category</th>
                                      <th style="width: 12%; text-align: center; padding: 15px;">Duration</th>
                                      <th style="width: 15%; text-align: center; padding: 15px;">Date(s)</th>
                                      <th style="width: 12%; padding: 15px;">Manager</th>
                                      <th style="width: 10%; text-align: center; padding: 15px;">Status</th>
                                      <th style="width: 6%; text-align: center; padding: 15px;">Action</th>
                                  </tr>
                              </thead>
                              <tbody id="mgrHistoryTableBody">
                                  <tr>
                                      <td colspan="8" class="text-center" style="padding: 60px; color: #64748b;">
                                          <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 10px;"></i><br>
                                          Synchronizing company records...
                                      </td>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
          
                      <div id="mgrPaginationControls" style="display: none; justify-content: space-between; align-items: center; padding: 15px 25px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                          <button id="mgrPrevPageBtn" onclick="changeMgrHistoryPage(-1)" class="btn-secondary" style="padding: 8px 18px; border-radius: 6px; font-weight: bold;">
                              <i class="fas fa-chevron-left"></i> Previous
                          </button>
                          
                          <div style="text-align: center;">
                              <div id="mgrHistoryPageInfo" style="font-weight: 800; color: #1e293b; font-size: 0.9rem;">Page 1 of 1</div>
                              <div style="font-size: 0.75rem; color: #64748b; margin-top: 2px;">
                                  Records Found: <span id="mgrTotalRecordsSpan" style="font-weight: bold; color: #2563eb;">0</span>
                              </div>
                          </div>
          
                          <button id="mgrNextPageBtn" onclick="changeMgrHistoryPage(1)" class="btn-secondary" style="padding: 8px 18px; border-radius: 6px; font-weight: bold;">
                              Next <i class="fas fa-chevron-right"></i>
                          </button>
                      </div>
                  </div>
              </div>
          </div>
        <!-- ==========================================
             TEAM LEAVE BALANCES  - id="manager_entitlements"
            ========================================== -->
            <div id="manager_entitlements" class="section">
              <div class="card">
                  <h2>
                      <i class="fas fa-users"></i> Team Leave Balances (<span class="current-year-display"></span>)
                  </h2>
          
                  <div class="filter-bar" style="
                        background: #f8fafc; 
                        border: 1px solid #e2e8f0; 
                        padding: 20px; 
                        border-radius: 12px; 
                        margin-bottom: 25px;
                        display: flex; 
                        gap: 20px; 
                        align-items: flex-end; 
                        flex-wrap: wrap;
                      ">
                      
                      <div style="flex: 1; min-width: 220px;">
                          <label style="
                              display: block; 
                              font-size: 0.7rem; 
                              color: #64748b; 
                              font-weight: 800; 
                              text-transform: uppercase; 
                              margin-bottom: 6px; 
                              letter-spacing: 0.5px;
                          ">Employee Name</label>
                          <input type="text" id="mgr_ent_search_name" placeholder="Search employee..." 
                                 onkeyup="loadTeamEntitlements()" 
                                 style="
                              width: 100%; 
                              height: 40px; 
                              padding: 0 12px; 
                              border: 1px solid #cbd5e1; 
                              border-radius: 6px; 
                              font-size: 0.9rem; 
                              color: #334155; 
                              box-sizing: border-box;
                              transition: border-color 0.2s;
                          " onfocus="this.style.borderColor='#2563eb'" onblur="this.style.borderColor='#cbd5e1'">
                      </div>
          
                      <div style="width: 180px;">
                          <label style="
                              display: block; 
                              font-size: 0.7rem; 
                              color: #64748b; 
                              font-weight: 800; 
                              text-transform: uppercase; 
                              margin-bottom: 6px; 
                              letter-spacing: 0.5px;
                          ">Status</label>
 <select id="mgr_ent_status_filter" onchange="loadTeamEntitlements()" 
 style="
width: 100%; 
height: 40px; 
padding: 0 12px; 
border: 1px solid #cbd5e1; 
border-radius: 6px; 
font-size: 0.9rem; 
color: #334155; 
background-color: white; 
cursor: pointer; 
box-sizing: border-box;
" onfocus="this.style.borderColor='#2563eb'" onblur="this.style.borderColor='#cbd5e1'">
<option value="All" selected>All Status</option>
<option value="Active">Active Only</option>
<option value="Inactive">Inactive</option>
</select>
                      </div>
          
                      <div style="display: flex; gap: 10px;">
                          
                          <button onclick="resetBalanceFilters()" title="Reset Filters" style="
                              height: 40px; 
                              width: 40px; 
                              display: flex; 
                              align-items: center; 
                              justify-content: center; 
                              background: white; 
                              border: 1px solid #cbd5e1; 
                              border-radius: 6px; 
                              color: #64748b; 
                              cursor: pointer; 
                              transition: all 0.2s;
                          " onmouseover="this.style.background='#f1f5f9'; this.style.color='#334155'" 
                            onmouseout="this.style.background='white'; this.style.color='#64748b'">
                              <i class="fas fa-undo-alt"></i>
                          </button>
          
                          <button onclick="loadTeamEntitlements()" style="
                              height: 40px; 
                              padding: 0 20px; 
                              background: #2563eb; 
                              color: white; 
                              border: none; 
                              border-radius: 6px; 
                              font-weight: 600; 
                              font-size: 0.9rem; 
                              display: flex; 
                              align-items: center; 
                              gap: 8px; 
                              cursor: pointer; 
                              transition: background 0.2s;
                          " onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">
                              <i class="fas fa-sync-alt"></i> Refresh
                          </button>
          
                          <button onclick="exportEntitlementsCSV()" style="
                              height: 40px; 
                              padding: 0 20px; 
                              background: white; 
                              color: #10b981; 
                              border: 1px solid #10b981; 
                              border-radius: 6px; 
                              font-weight: 600; 
                              font-size: 0.9rem; 
                              display: flex; 
                              align-items: center; 
                              gap: 8px; 
                              cursor: pointer; 
                              transition: all 0.2s;
                          " onmouseover="this.style.background='#ecfdf5'" onmouseout="this.style.background='white'">
                              <i class="fas fa-file-csv"></i> Export
                          </button>
                      </div>
                  </div>
          
                  <div class="table-container" style="max-height: 600px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            <tr>
                                <th onclick="sortTeamTable('name')" style="padding: 12px 15px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Employee <i id="sort-icon-name" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortTeamTable('annual_remaining')" style="padding: 12px 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Annual <i id="sort-icon-annual_remaining" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortTeamTable('medical_remaining')" style="padding: 12px 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Medical <i id="sort-icon-medical_remaining" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortTeamTable('emergency_remaining')" style="padding: 12px 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Emergency <i id="sort-icon-emergency_remaining" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortTeamTable('compassionate_remaining')" style="padding: 12px 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Compassionate <i id="sort-icon-compassionate_remaining" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortTeamTable('overtime_bank')" style="padding: 12px 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Overtime (Hrs) <i id="sort-icon-overtime_bank" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortTeamTable('unpaid_taken')" style="padding: 12px 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Unpaid <i id="sort-icon-unpaid_taken" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortTeamTable('carry_forward_total')" style="padding: 12px 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Carry Fwd <i id="sort-icon-carry_forward_total" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th onclick="sortTeamTable('status')" style="padding: 12px 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; cursor: pointer; user-select: none;">
                                    Status <i id="sort-icon-status" class="fas fa-sort" style="margin-left:5px; color:#cbd5e1;"></i>
                                </th>
                
                                <th class="text-center" style="padding: 12px 15px; border-bottom: 2px solid #e2e8f0; color: #475569;">
                                    Details
                                </th>
                            </tr>
                        </thead>
                        <tbody id="mgrEntitlementTableBody">
                            </tbody>
                    </table>
                </div>
                  
                  <div id="entitlementLoader" style="display: none; text-align: center; padding: 30px; color: #64748b;">
                      <i class="fas fa-spinner fa-spin fa-2x"></i><br><span style="margin-top: 10px; display: block;">Loading team balances...</span>
                  </div>
              </div>
          </div>

        <!-- ==========================================
             USER MANAGEMENT - id="hr_users"
            ========================================== -->

        <div id="hr_users" class="section">
            <div class="card">
                <div style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 20px;
                      border-bottom: 2px solid #e2e8f0;
                      padding-bottom: 15px;
                    ">
                    <h2 style="margin: 0; border: none; padding: 0">
                        <i class="fas fa-users-cog"></i> User Management
                    </h2>
                    <button class="btn" onclick="openRegisterModal()" style="
                        background: #10b981;
                        color: white;
                        border: none;
                        padding: 10px 24px;
                        border-radius: 50px; /* Pill Shape */
                        font-weight: 700;
                        font-size: 0.9rem;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4); /* Glow effect */
                        transition: all 0.2s ease;
                        cursor: pointer;
                      " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 8px -1px rgba(16, 185, 129, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(16, 185, 129, 0.4)'">
                        <div style="
                          background: rgba(255, 255, 255, 0.2);
                          width: 20px;
                          height: 20px;
                          border-radius: 50%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        ">
                            <i class="fas fa-plus" style="font-size: 0.7rem"></i>
                        </div>
                        <span>Add Employee</span>
                    </button>
                </div>

                <div style="
                      display: grid;
                      grid-template-columns: repeat(3, 1fr);
                      gap: 15px;
                      margin-bottom: 25px;
                    ">
                    <div style="
                        background: #f8fafc;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #e2e8f0;
                        text-align: center;
                      ">
                        <label style="
                          font-size: 0.7rem;
                          font-weight: bold;
                          color: #64748b;
                          text-transform: uppercase;
                        ">Total Employees</label>
                        <div id="summary_total_users" style="font-size: 1.5rem; font-weight: 800; color: #1e293b">
                            0
                        </div>
                    </div>
                    <div style="
                        background: #f0fdf4;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #bbf7d0;
                        text-align: center;
                      ">
                        <label style="
                          font-size: 0.7rem;
                          font-weight: bold;
                          color: #166534;
                          text-transform: uppercase;
                        ">Active</label>
                        <div id="summary_active_users" style="font-size: 1.5rem; font-weight: 800; color: #15803d">
                            0
                        </div>
                    </div>
                    <div style="
                        background: #fef2f2;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #fecaca;
                        text-align: center;
                      ">
                        <label style="
                          font-size: 0.7rem;
                          font-weight: bold;
                          color: #991b1b;
                          text-transform: uppercase;
                        ">Inactive</label>
                        <div id="summary_inactive_users" style="font-size: 1.5rem; font-weight: 800; color: #b91c1c">
                            0
                        </div>
                    </div>
                </div>

                <div class="filter-bar" style="
                      background: #f8fafc;
                      border: 1px solid #e2e8f0;
                      margin-bottom: 25px;
                      padding: 15px;
                      border-radius: 8px;
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                      gap: 12px;
                      align-items: end;
                    ">
                    <div class="filter-group">
                        <label style="
                          color: #64748b;
                          font-size: 0.75rem;
                          font-weight: bold;
                          display: block;
                          margin-bottom: 4px;
                        ">Search User</label>
                        <input type="text" id="hr_user_search" placeholder="Name or Username..." oninput="loadAllUsers()" />
                    </div>
                    <div class="filter-group">
                        <label style="
                          color: #64748b;
                          font-size: 0.75rem;
                          font-weight: bold;
                          display: block;
                          margin-bottom: 4px;
                        ">Role Filter</label>
                        <select id="hr_role_filter" onchange="loadAllUsers()">
                            <option value="">All Staff</option>
                            <option value="employee">Employee</option>
                            <option value="manager">Manager</option>
                            <option value="hr_admin">HR Admin</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label style="
                          color: #64748b;
                          font-size: 0.75rem;
                          font-weight: bold;
                          display: block;
                          margin-bottom: 4px;
                        ">Status Filter</label>
                        <select id="hr_status_filter" onchange="loadAllUsers()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button type="button" class="btn-secondary" onclick="resetUserFilters()" style="
                          height: 38px;
                          width: 100%;
                          background: #64748b;
                          color: white;
                          border-radius: 6px;
                          border: none;
                          cursor: pointer;
                          font-weight: 600;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          gap: 8px;
                        ">
                            <i class="fas fa-undo"></i> Clear
                        </button>
                    </div>
                </div>

                <div style="
                      overflow-x: auto;
                      overflow-y: auto;
                      max-height: 500px;
                      border: 1px solid #e2e8f0;
                      border-radius: 8px;
                      background: #ffffff;
                    ">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0">
                        <thead>
                            <tr>
                                <th style="
                              width: 25%;
                              padding: 12px 15px;
                              text-align: left;
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 20;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              border-bottom: 2px solid #e2e8f0;
                              border-right: 1px solid #f1f5f9;
                            ">
                                    Full Name
                                </th>

                                <th style="
                              width: 20%;
                              padding: 12px 15px;
                              text-align: left;
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 20;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              border-bottom: 2px solid #e2e8f0;
                              border-right: 1px solid #f1f5f9;
                            ">
                                    Username
                                </th>

                                <th style="
                              width: 15%;
                              padding: 12px 15px;
                              text-align: center;
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 20;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              border-bottom: 2px solid #e2e8f0;
                              border-right: 1px solid #f1f5f9;
                            ">
                                    Status
                                </th>

                                <th style="
                              width: 25%;
                              padding: 12px 15px;
                              text-align: center;
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 20;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              border-bottom: 2px solid #e2e8f0;
                              border-right: 1px solid #f1f5f9;
                            ">
                                    System Role
                                </th>

                                <th style="
                              width: 15%;
                              padding: 12px 15px;
                              text-align: center;
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 20;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              border-bottom: 2px solid #e2e8f0;
                            ">
                                    Action
                                </th>
                            </tr>
                        </thead>
                        <tbody id="hrUserTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==========================================
             LEAVE - id="hr_policy"
            ========================================== -->

        <!-- Need to revisit and refine the codes as the html is merged with javascripts code.  -->

        <div id="hr_policy" class="section">
            <div class="card">
                <h2>Global Leave Policy Settings</h2>
            </div>
        </div>


        <!-- ==========================================
             COMPANY CALENDAR - id="hr_holidays"
            ========================================== -->
        <div id="hr_holidays" class="section">
            <div class="card" style="
                    padding: 0;
                    overflow: hidden;
                    border-radius: 16px;
                    border: 1px solid #e2e8f0;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                  ">
                <div style="
                      padding: 25px 30px;
                      border-bottom: 1px solid #e2e8f0;
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      background: #ffffff;
                    ">
                    <div>
                        <h2 style="
                          margin: 0;
                          font-size: 1.4rem;
                          color: #1e293b;
                          display: flex;
                          align-items: center;
                          gap: 10px;
                        ">
                            <i class="fas fa-calendar-alt" style="color: #f59e0b"></i>
                            Company Calendar
                        </h2>
                        <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.9rem">
                            Manage public holidays and non-working days.
                        </p>
                    </div>
                    <div style="
                        background: #fffbeb;
                        color: #b45309;
                        padding: 6px 15px;
                        border-radius: 20px;
                        font-weight: 800;
                        font-size: 0.9rem;
                        border: 1px solid #fcd34d;
                      ">
                        <span class="current-year-display">2026</span>
                    </div>
                </div>

                <div style="
                      background: #f8fafc;
                      padding: 20px 30px;
                      border-bottom: 1px solid #e2e8f0;
                    ">
                    <label style="
                        font-size: 0.7rem;
                        font-weight: 800;
                        color: #475569;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                        display: block;
                      ">
                        <i class="fas fa-plus-circle"></i> Add New Event
                    </label>

                    <form onsubmit="addCompanyHoliday(event); return false;" style="
                        display: flex;
                        gap: 15px;
                        align-items: flex-end;
                        flex-wrap: wrap;
                      ">
                        <div style="flex: 1; min-width: 140px">
                            <label style="
                            font-size: 0.7rem;
                            font-weight: 700;
                            color: #64748b;
                            display: block;
                            margin-bottom: 4px;
                          ">START DATE</label>
                            <input type="date" id="new_holiday_date" required style="
                            width: 100%;
                            height: 42px;
                            padding: 8px 12px;
                            border: 1px solid #cbd5e1;
                            border-radius: 6px;
                            font-size: 0.9rem;
                            box-sizing: border-box;
                            background: white;
                          " />
                        </div>

                        <div style="flex: 1; min-width: 140px">
                            <label style="
                            font-size: 0.7rem;
                            font-weight: 700;
                            color: #64748b;
                            display: block;
                            margin-bottom: 4px;
                          ">END DATE (OPTIONAL)</label>
                            <input type="date" id="new_holiday_end_date" style="
                            width: 100%;
                            height: 42px;
                            padding: 8px 12px;
                            border: 1px solid #cbd5e1;
                            border-radius: 6px;
                            font-size: 0.9rem;
                            box-sizing: border-box;
                            background: white;
                          " />
                        </div>

                        <div style="flex: 2; min-width: 220px">
                            <label style="
                            font-size: 0.7rem;
                            font-weight: 700;
                            color: #64748b;
                            display: block;
                            margin-bottom: 4px;
                          ">HOLIDAY NAME</label>
                            <input type="text" id="new_holiday_name" placeholder="e.g. National Day" required style="
                            width: 100%;
                            height: 42px;
                            padding: 8px 12px;
                            border: 1px solid #cbd5e1;
                            border-radius: 6px;
                            font-size: 0.9rem;
                            box-sizing: border-box;
                          " />
                        </div>

                        <div style="flex: 1; min-width: 140px">
                            <label style="
                            font-size: 0.7rem;
                            font-weight: 700;
                            color: #64748b;
                            display: block;
                            margin-bottom: 4px;
                          ">STATES</label>
                            <input type="text" id="new_holiday_states" placeholder="e.g. All States" style="
                            width: 100%;
                            height: 42px;
                            padding: 8px 12px;
                            border: 1px solid #cbd5e1;
                            border-radius: 6px;
                            font-size: 0.9rem;
                            box-sizing: border-box;
                          " />
                        </div>

                        <button type="submit" class="btn" onclick="addCompanyHoliday(event)" style="
                          height: 42px;
                          background: #0f172a;
                          color: white;
                          padding: 0 25px;
                          border-radius: 6px;
                          font-weight: 600;
                          border: none;
                          cursor: pointer;
                          display: flex;
                          align-items: center;
                          gap: 8px;
                        ">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </form>
                </div>

                <div class="table-container" style="max-height: 500px; overflow-y: auto; background: white">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0">
                        <thead>
                            <tr>
                                <th style="
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 10;
                              padding: 15px 30px;
                              text-align: left;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              font-weight: 700;
                              border-bottom: 2px solid #e2e8f0;
                              width: 25%;
                            ">
                                    Date
                                </th>
                                <th style="
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 10;
                              padding: 15px;
                              text-align: left;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              font-weight: 700;
                              border-bottom: 2px solid #e2e8f0;
                              width: 45%;
                            ">
                                    Holiday Name
                                </th>
                                <th style="
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 10;
                              padding: 15px;
                              text-align: center;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              font-weight: 700;
                              border-bottom: 2px solid #e2e8f0;
                              width: 15%;
                            ">
                                    Status
                                </th>
                                <th style="
                              position: sticky;
                              top: 0;
                              background: #f8fafc;
                              z-index: 10;
                              padding: 15px;
                              text-align: center;
                              color: #64748b;
                              font-size: 0.75rem;
                              text-transform: uppercase;
                              font-weight: 700;
                              border-bottom: 2px solid #e2e8f0;
                              width: 15%;
                            ">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="adminHolidayTableBody"></tbody>
                    </table>
                </div>
                <!-- Footer to be use as a reference -->
                <div style="
                padding: 15px
                  30px;
                background: #f8fafc;
                border-top: 1px
                  solid
                  #f1f5f9;
                color: #94a3b8;
                font-size: 0.75rem;
                font-style: italic;
              ">
                    <i class="fas fa-info-circle"></i>
                    Note:
                    These
                    dates
                    are
                    automatically
                    excluded
                    from
                    leave
                    duration
                    calculations.
                </div>
            </div>
        </div>

        <!-- ==========================================
             SYSTEM ANALYTICS AND PLANNING - id="hr_reporting"
            ========================================== -->

        <div class="content">
            <div id="hr_reporting" class="section">
                <div class="card" style="padding: 20px">
                    <h2 style="margin-bottom: 20px">
                        <i class="fas fa-chart-pie"></i> System Analytics & Planning
                        (<span class="current-year-display"></span>)
                    </h2>

                    <div style="
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 15px;
                        margin-bottom: 20px;
                      ">
                        <div style="
                          background: #f8fafc;
                          border: 1px solid #e2e8f0;
                          padding: 15px;
                          border-radius: 10px;
                          text-align: center;
                        ">
                            <span style="
                            color: #64748b;
                            font-size: 0.75rem;
                            font-weight: bold;
                            text-transform: uppercase;
                          ">Total Apps</span>
                            <div id="stat_total_apps" style="font-size: 1.8rem; font-weight: 800; color: #0f172a">
                                0
                            </div>
                        </div>
                        <div style="
                          background: #f0fdf4;
                          border: 1px solid #bbf7d0;
                          padding: 15px;
                          border-radius: 10px;
                          text-align: center;
                        ">
                            <span style="
                            color: #166534;
                            font-size: 0.75rem;
                            font-weight: bold;
                            text-transform: uppercase;
                          ">Pending</span>
                            <div id="stat_pending" style="font-size: 1.8rem; font-weight: 800; color: #14532d">
                                0
                            </div>
                        </div>
                        <div id="medical_rate_wrapper">
                            <div id="medical_tile_wrapper" style="
                            background: #fef2f2;
                            border: 1px solid #fecaca;
                            padding: 15px;
                            border-radius: 10px;
                            text-align: center;
                          ">
                                <span style="
                              color: #991b1b;
                              font-size: 0.75rem;
                              font-weight: bold;
                              text-transform: uppercase;
                            ">
                                    Medical Rate
                                </span>
                                <div id="stat_medical_rate" style="
                              font-size: 1.8rem;
                              font-weight: 800;
                              color: #7f1d1d;
                              line-height: 1.2;
                            ">
                                    0%
                                </div>
                                <div id="medical_formula_label" style="
                              font-size: 0.65rem;
                              color: #991b1b;
                              opacity: 0.8;
                              margin-top: 5px;
                              font-weight: 500;
                            ">
                                    No. of Approved Medical / No. Total Staff
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="
                        display: grid;
                        grid-template-columns: 1fr 300px;
                        gap: 20px;
                        align-items: start;
                      ">
                        <div style="
                          border: 1px solid #e2e8f0;
                          border-radius: 12px;
                          padding: 15px;
                          background: white;
                        ">
                            <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 10px;
                          ">
                                <h3 style="font-size: 0.9rem; margin: 0">
                                    <i class="fas fa-calendar-alt"></i> Attendance Calendar
                                </h3>
                                <div id="calendar_controls" style="display: flex; align-items: center; gap: 10px">
                                    <button type="button" class="icon-btn" onclick="changeMonth(-1)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>

                                    <button type="button" class="icon-btn" onclick="resetToToday()" style="
                                font-size: 0.65rem;
                                font-weight: 800;
                                padding: 0 12px;
                                background: #f8fafc;
                                color: #475569;
                                letter-spacing: 0.5px;
                              ">
                                        TODAY
                                    </button>

                                    <h4 id="calendar_month_year" style="
                                margin: 0;
                                min-width: 120px;
                                text-align: center;
                                color: var(--primary);
                                font-size: 0.9rem;
                              ">
                                        Month Year
                                    </h4>
                                    <button type="button" class="icon-btn" onclick="changeMonth(1)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>

                            <div style="
                            display: grid;
                            grid-template-columns: repeat(7, 1fr);
                            gap: 5px;
                            text-align: center;
                            font-weight: bold;
                            font-size: 0.7rem;
                            color: #64748b;
                            margin-bottom: 5px;
                          ">
                                <div>SUN</div>
                                <div>MON</div>
                                <div>TUE</div>
                                <div>WED</div>
                                <div>THU</div>
                                <div>FRI</div>
                                <div>SAT</div>
                            </div>
                            <div id="team_calendar" style="
                            display: grid;
                            grid-template-columns: repeat(7, 1fr);
                            gap: 5px;
                            border: 1px solid #e2e8f0;
                            padding: 8px;
                            border-radius: 8px;
                            background: #fafafa;
                            min-height: 400px;
                          "></div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 20px">
                            <div style="
                            border: 1px solid #e2e8f0;
                            border-radius: 10px;
                            padding: 15px;
                            background: #fff;
                          ">
                                <h3 style="font-size: 0.85rem; margin-top: 0">
                                    <i class="fas fa-user-clock"></i> Who's Away Today?
                                </h3>
                                <ul id="reporting_away_list" style="
                              list-style: none;
                              padding: 0;
                              color: #475569;
                              font-size: 0.8rem;
                              max-height: 150px;
                              overflow-y: auto;
                            ">
                                    <li style="padding: 5px">Loading...</li>
                                </ul>
                            </div>

                            <div style="
                            border: 1px solid #e2e8f0;
                            border-radius: 10px;
                            padding: 15px;
                            background: #fafafa;
                          ">
                                <h3 style="font-size: 0.85rem; margin-top: 0">
                                    <i class="fas fa-history"></i> Recent Activity Log
                                </h3>
                                <div id="reporting_recent_activity" style="display: flex; flex-direction: column; gap: 8px">
                                    <p style="color: #94a3b8; font-size: 0.75rem">
                                        Waiting for updates...
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
 

    <!-- ==========================================
             SYSTEM AUDIT LOG - id="hr_audit"
            ========================================== -->

            <div id="hr_audit" class="section">
        
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px;">
                  <div class="card" style="margin: 0; padding: 20px; border-left: 5px solid #3b82f6; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                      <div style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Away Today</div>
                      <div id="stat_away_today" style="font-size: 2.2rem; font-weight: 800; color: #1e293b; margin-top: 8px; line-height: 1;">0</div>
                      <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
                          <i class="fas fa-info-circle"></i> Approved active leaves
                      </div>
                  </div>
                  <div class="card" style="margin: 0; padding: 20px; border-left: 5px solid #f59e0b; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                      <div style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Pending Actions</div>
                      <div id="stat_pending_all" style="font-size: 2.2rem; font-weight: 800; color: #1e293b; margin-top: 8px; line-height: 1;">0</div>
                      <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
                          <i class="fas fa-clock"></i> Awaiting L1/L2 review
                      </div>
                  </div>
                  <div class="card" style="margin: 0; padding: 20px; border-left: 5px solid #ef4444; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                      <div style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Monthly Unpaid</div>
                      <div id="stat_monthly_unpaid" style="font-size: 2.2rem; font-weight: 800; color: #1e293b; margin-top: 8px; line-height: 1;">0d</div>
                      <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
                          <i class="fas fa-calendar-alt"></i> Unpaid days in <span class="current-month-name">this month</span>
                      </div>
                  </div>
              </div>
      
              <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <h2 style="margin: 0; border: none; padding: 0"><i class="fas fa-clipboard-list"></i> System Audit Log</h2>
                  <button class="btn-secondary" onclick="exportAuditLogCSV()" style="font-size: 0.8rem">
                    <i class="fas fa-file-download"></i> Export CSV
                  </button>
                </div>
      
                <div class="filter-bar" style="background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 20px; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
                  <div class="filter-group">
                    <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Search Employee</label>
                    <input type="text" id="audit_search_name" placeholder="Name..." oninput="applyAuditFilters()" style="padding: 10px; width: 100%; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box;" />
                  </div>
      
                  <div class="filter-group">
                    <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Type</label>
                    <select id="audit_filter_type" onchange="applyAuditFilters()" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                      <option value="">All Types</option>
                      <option>Annual Leave</option><option>Medical Leave</option><option>Unpaid Leave</option><option value="OT">Overtime</option>
                    </select>
                  </div>
      
                  <div class="filter-group">
                    <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Status</label>
                    <select id="audit_filter_status" onchange="applyAuditFilters()" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                      <option value="">All Status</option>
                      <option>Approved</option><option>Pending</option><option>Rejected</option><option>Cancelled</option><option>Pending Cancel</option><option>Withdrawn</option>
                    </select>
                  </div>
      
                  <div class="filter-group">
                    <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Year</label>
                    <select id="audit_filter_year" onchange="applyAuditFilters()" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                      <option value="">All Time</option>
                    </select>
                  </div>
      
                  <div style="display: flex; gap: 8px">
                    <button class="btn" onclick="event.preventDefault(); loadGlobalAuditLogs();" style="height: 38px; width: 40px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Refresh Data">
                      <i class="fas fa-sync"></i>
                    </button>
                    <button class="btn-secondary" onclick="resetAuditFilters()" style="height: 38px; background: #64748b; color: white; border: none; padding: 0 15px; font-weight: bold; border-radius: 6px; font-size: 0.8rem;" title="Clear All Filters">
                      CLEAR
                    </button>
                  </div>
                </div>
      
                <div class="table-scroll-container" style="max-height: 600px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px 8px 0 0; background: #ffffff; margin-bottom: 0;">
                  <table style="width: 100%; border-collapse: separate; border-spacing: 0">
                    <thead style="position: sticky; top: 0; z-index: 10">
                      <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0">
                        <th onclick="sortAuditTable('id')" style="width: 10%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: left; border-bottom: 2px solid #e2e8f0; cursor: pointer; user-select: none;">Ref ID</th>
                        <th onclick="sortAuditTable('employee_name')" style="width: 22%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: left; border-bottom: 2px solid #e2e8f0; cursor: pointer; user-select: none;">Employee</th>
                        <th onclick="sortAuditTable('leave_type')" style="width: 15%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: left; border-bottom: 2px solid #e2e8f0; cursor: pointer; user-select: none;">Type</th>
                        <th onclick="sortAuditTable('days_taken')" style="width: 8%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: center; border-bottom: 2px solid #e2e8f0; cursor: pointer; user-select: none;">Duration</th>
                        <th onclick="sortAuditTable('start_date')" style="width: 15%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: center; border-bottom: 2px solid #e2e8f0; cursor: pointer; user-select: none;">Dates</th>
                        <th onclick="sortAuditTable('approver_name')" style="width: 15%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: left; border-bottom: 2px solid #e2e8f0; cursor: pointer; user-select: none;">Current Owner</th>
                        <th onclick="sortAuditTable('status')" style="width: 10%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: center; border-bottom: 2px solid #e2e8f0; cursor: pointer; user-select: none;">Status</th>
                        <th style="width: 5%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: center; border-bottom: 2px solid #e2e8f0;">Action</th>
                      </tr>
                    </thead>
                    <tbody id="globalAuditTableBody">
                      <tr><td colspan="8" class="text-center" style="padding: 50px; color: #94a3b8"><i class="fas fa-circle-notch fa-spin" style="font-size: 1.5rem"></i><br /><br />Loading system logs...</td></tr>
                    </tbody>
                  </table>
                </div>
      
                <div class="pagination-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; margin-bottom: 20px;">
                  <button class="btn-secondary" id="auditPrevBtn" onclick="changeAuditPage(-1)" disabled style="font-size: 0.8rem; padding: 6px 15px; height: 32px"><i class="fas fa-chevron-left"></i> Previous</button>
                  <span id="auditPageInfo" style="font-size: 0.85rem; font-weight: 600; color: #64748b">Page 1</span>
                  <button class="btn-secondary" id="auditNextBtn" onclick="changeAuditPage(1)" style="font-size: 0.8rem; padding: 6px 15px; height: 32px">Next <i class="fas fa-chevron-right"></i></button>
                </div>
              </div>
            </div>



    <!-- ==========================================
             SYSTEM CONFIGURATION - id="hr_settings"
            ========================================== -->
            <div id="hr_settings" class="section">
              <div class="card" style="padding: 0; overflow: hidden; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                  
                  <div style="padding: 25px 30px; border-bottom: 1px solid #f1f5f9; background: #ffffff;">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                          <div>
                              <h2 style="margin: 0; font-size: 1.4rem; color: #1e293b; display: flex; align-items: center; gap: 10px; border: none; padding: 0;">
                                  <i class="fas fa-sliders-h" style="color: #6366f1;"></i> System Configuration
                              </h2>
                              <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.9rem;">Manage workflows and company branding.</p>
                          </div>
                      </div>
          
                      <div style="display: inline-flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-top: 20px; border: 1px solid #e2e8f0;">
                          <button id="btnSettingsWorkflow" onclick="toggleSettingsMode('workflow')" style="padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: 0.2s; background: white; color: #1e293b; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #cbd5e1;">
                              <i class="fas fa-project-diagram" style="margin-right: 6px;"></i> Workflows
                          </button>
                          <button id="btnSettingsBranding" onclick="toggleSettingsMode('branding')" style="padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: 0.2s; color: #64748b; background: transparent;">
                              <i class="fas fa-paint-brush" style="margin-right: 6px;"></i> Branding
                          </button>
                      </div>
                  </div>
          
                  <div style="padding: 30px; background: #fdfdfd; min-height: 400px;">
                      
                      <div id="settings_workflow_view">
                          <div style="display: grid; gap: 15px; max-width: 600px;">
                              
                              <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                                  <div style="display: flex; gap: 15px; align-items: center;">
                                      <div style="width: 38px; height: 38px; background: #eff6ff; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #2563eb; flex-shrink: 0;">
                                          <i class="fas fa-sitemap"></i>
                                      </div>
                                      <div>
                                          <h3 style="margin: 0; font-size: 0.95rem; color: #1e293b;">Two-Level Approval</h3>
                                          <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #64748b;">Requires Line Manager (L1) & Dept Head (L2).</p>
                                      </div>
                                  </div>
                                  <label class="switch-container" style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer; flex-shrink: 0;">
                                      <input type="checkbox" id="l2_workflow_toggle" style="opacity: 0; width: 0; height: 0;" onchange="handleL2Toggle()" />
                                      <span id="toggleBg" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: 0.4s; border-radius: 34px;">
                                          <span id="toggleCircle" style="position: absolute; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%;"></span>
                                      </span>
                                  </label>
                              </div>
          
                              <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px 20px;">
                                  <div style="display: flex; justify-content: space-between; align-items: center;">
                                      <div style="display: flex; gap: 15px; align-items: center;">
                                          <div style="width: 38px; height: 38px; background: #f5f3ff; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #8b5cf6; flex-shrink: 0;">
                                              <i class="fas fa-history"></i>
                                          </div>
                                          <div>
                                              <h3 style="margin: 0; font-size: 0.95rem; color: #1e293b;">Carry Forward Requests</h3>
                                              <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #64748b;">Allow employees to bank unused leave.</p>
                                          </div>
                                      </div>
                                      <label class="switch-container" style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer; flex-shrink: 0;">
                                          <input type="checkbox" id="cf_workflow_toggle" style="opacity: 0; width: 0; height: 0;" onchange="handleCFToggle()" />
                                          <span id="cfToggleBg" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: 0.4s; border-radius: 34px;">
                                              <span id="cfToggleCircle" style="position: absolute; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%;"></span>
                                          </span>
                                      </label>
                                  </div>
                                  <div id="cf_config_panel" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #e2e8f0;">
                                      <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                                          <div style="width: 100px;">
                                              <label style="font-size: 0.65rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 4px; text-transform: uppercase;">Max Days</label>
                                              <input type="number" id="cf_limit_days" class="saas-form-control" style="background: white; height: 36px !important;" />
                                          </div>
                                          <div style="width: 150px;">
                                              <label style="font-size: 0.65rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 4px; text-transform: uppercase;">Expiry Date</label>
                                              <input type="date" id="cf_expiry_date" class="saas-form-control" style="background: white; height: 36px !important;" />
                                          </div>
                                          <button onclick="saveCFConfig()" class="btn" style="background: #8b5cf6; height: 36px; padding: 0 15px; font-weight: 700; border-radius: 6px; color: white; border: none; cursor: pointer; font-size: 0.8rem;">
                                              <i class="fas fa-save"></i> Save Rules
                                          </button>
                                      </div>
                                  </div>
                              </div>
          
                              <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px 20px;">
                                  <div style="display: flex; justify-content: space-between; align-items: center;">
                                      <div style="display: flex; gap: 15px; align-items: center;">
                                          <div style="width: 38px; height: 38px; background: #fff7ed; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #f59e0b; flex-shrink: 0;">
                                              <i class="fas fa-bullhorn"></i>
                                          </div>
                                          <div>
                                              <h4 style="margin: 0; color: #1e293b; font-size: 0.95rem;">System Broadcast</h4>
                                              <p style="margin: 2px 0 0 0; color: #64748b; font-size: 0.75rem;">Global banner or maintenance lock.</p>
                                          </div>
                                      </div>
                                      <label class="switch-container" style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer; flex-shrink: 0;">
                                          <input type="checkbox" id="broadcast_workflow_toggle" style="opacity: 0; width: 0; height: 0;" onchange="handleBroadcastToggle()">
                                          <span id="bcToggleBg" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: 0.4s; border-radius: 34px;">
                                              <span id="bcToggleCircle" style="position: absolute; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%;"></span>
                                          </span>
                                      </label>
                                  </div>
                                  
                                  <div id="broadcast_config_panel" style="display:none; margin-top:15px; padding-top:15px; border-top: 1px dashed #e2e8f0;">
                                      
                                    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                                      <label style="font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; display: block;">Announcement Message</label>
                                      <span style="font-size: 0.65rem; color: #94a3b8;"><span id="bc_count">0</span>/150</span>
                                  </div>
                                  <textarea id="bc_message" maxlength="150" oninput="updateCounter('bc_count', this, 150)" placeholder="e.g. System down for maintenance..." class="saas-form-control" style="width: 100%; border-radius: 8px; resize: none; min-height: 50px !important; padding: 10px !important;" rows="2"></textarea>
                                      
                                      <div style="display: flex; align-items: center; gap: 8px; padding: 10px 0 5px 0;">
                                          <input type="checkbox" id="bc_maintenance_mode" style="width: 16px; height: 16px; cursor: pointer; accent-color: #ef4444;">
                                          <label for="bc_maintenance_mode" style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                              <strong style="color: #991b1b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.3px;">Enable Login Lock</strong>
                                              <span style="color: #ef4444; font-size: 0.7rem; font-weight: 600; opacity: 0.8;">(Admins Only)</span>
                                          </label>
                                      </div>
                                      
                                      <div style="display: flex; gap: 10px; margin-top: 15px; align-items: flex-end; flex-wrap: wrap;">
                                        <div style="width: 220px;"> <label style="font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block;">Start</label>
                                            <input type="datetime-local" id="bc_start" class="saas-form-control" style="background: white; height: 36px !important; font-size: 0.8rem;">
                                        </div>
                                        <div style="width: 220px;"> <label style="font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block;">End</label>
                                            <input type="datetime-local" id="bc_end" class="saas-form-control" style="background: white; height: 36px !important; font-size: 0.8rem;">
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn" onclick="saveBroadcastConfig()" style="background: #334155; height: 36px; padding: 0 15px; font-weight: 700; border-radius: 6px; color: white; font-size: 0.8rem;">Update</button>
                                            <button class="btn" onclick="terminateBroadcast()" style="background: #ef4444; height: 36px; padding: 0 15px; font-weight: 700; border-radius: 6px; color: white; font-size: 0.8rem;">Terminate</button>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
          
                      <div id="settings_branding_view" style="display: none; animation: fadeIn 0.3s;">
                          <div style="max-width: 600px;">
                              
                              <div class="saas-form-group" style="margin-bottom: 20px;">
                                  <label style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase;">Company Display Name</label>
                                  <input type="text" id="config_company_name" class="saas-form-control" maxlength="20" oninput="updateCounter('name_count', this, 20)" style="height: 38px !important; margin-top: 8px;" />
                                  <div style="text-align: right; font-size: 0.65rem; color: #94a3b8; margin-top: 4px;"><span id="name_count">0</span>/20</div>
                              </div>
                              
                              <div class="saas-form-group" style="margin-bottom: 20px;">
                                  <label style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase;">Vision / Tagline</label>
                                  <input type="text" id="config_sub_info" class="saas-form-control" maxlength="35" oninput="updateCounter('sub_count', this, 35)" style="height: 38px !important; margin-top: 8px;" />
                                  <div style="text-align: right; font-size: 0.65rem; color: #94a3b8; margin-top: 4px;"><span id="sub_count">0</span>/35</div>
                              </div>
          
                              <div class="saas-form-group" style="margin-bottom: 30px;">
                                  <label style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase;">Company Logo</label>
                                  
                                  <div style="display: flex; gap: 15px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
                                      
                                      <div id="branding_preview" style="width: 50px; height: 50px; background: #f1f5f9; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                          <i class="fas fa-image" style="color: #cbd5e1;"></i>
                                      </div>
                                      
                                      <input type="hidden" id="config_company_logo" />
                                      
                                      <div style="display: flex; gap: 8px;">
                                          <button type="button" onclick="document.getElementById('logo_upload_input').click()" 
                                                  style="height: 36px; padding: 0 12px; font-size: 0.75rem; font-weight: 700; background: white; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; color: #475569;">
                                              <i class="fas fa-upload"></i> Upload
                                          </button>
                                          
                                          <button type="button" onclick="clearBrandingLogo()" 
                                                  style="height: 36px; padding: 0 12px; font-size: 0.75rem; font-weight: 700; background: #fff1f2; border: 1px solid #fecaca; border-radius: 6px; cursor: pointer; color: #ef4444;">
                                              <i class="fas fa-trash-alt"></i>
                                          </button>
          
                                          <button type="button" onclick="saveBrandingConfig()" 
                                                  style="height: 36px; padding: 0 15px; font-size: 0.75rem; font-weight: 800; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(37,99,235,0.2);">
                                              <i class="fas fa-check"></i> Save Changes
                                          </button>
                                      </div>
                                      
                                      <input type="file" id="logo_upload_input" style="display: none;" accept="image/*" onchange="handleLogoUpload(this)" />
                                      <span id="upload_status" style="font-size: 0.7rem; font-weight: 700; display: none;"></span>
                                  </div>
                                  <small style="color: #94a3b8; font-size: 0.65rem; display: block; margin-top: 10px;">Recommended: PNG or SVG (Max 2MB)</small>
                              </div>
                              
                          </div>
                      </div>
          
                  </div> </div>
          </div>


                <!-- ==========================================
             COMPANY LOGO - id="settings_branding_view"
            ========================================== -->


                <div id="settings_branding_view" style="
                          display: none;
                          animation: fadeIn
                            0.3s;
                        ">
                    <div style="
                            max-width: 500px;
                          ">
                        <div class="saas-form-group" style="
                              margin-bottom: 25px;
                            ">
                            <label style="
                                font-size: 0.75rem;
                                font-weight: 800;
                                color: #64748b;
                                text-transform: uppercase;
                              ">Company
                                Display
                                Name</label>
                            <input type="text" id="config_company_name" class="saas-form-control" placeholder="e.g. Acme Corp" style="
                                height: 45px;
                                margin-top: 8px;
                              " />
                        </div>

                        <div class="saas-form-group" style="
                              margin-bottom: 30px;
                            ">
                            <label style="
                                font-size: 0.75rem;
                                font-weight: 800;
                                color: #64748b;
                                text-transform: uppercase;
                              ">Company
                                Logo
                                (Image
                                URL)</label>
                            <div style="
                                display: flex;
                                gap: 15px;
                                align-items: center;
                                margin-top: 8px;
                              ">
                                <div id="branding_preview" style="
                                  width: 50px;
                                  height: 50px;
                                  background: #f1f5f9;
                                  border-radius: 8px;
                                  border: 1px
                                    solid
                                    #e2e8f0;
                                  display: flex;
                                  align-items: center;
                                  justify-content: center;
                                  overflow: hidden;
                                ">
                                    <i class="fas fa-image" style="
                                    color: #cbd5e1;
                                  "></i>
                                </div>
                                <input type="text" id="config_company_logo" class="saas-form-control" placeholder="Paste URL here..." style="
                                  flex: 1;
                                  height: 45px;
                                " oninput="updateBrandingPreview(this.value)" />
                            </div>
                            <small style="
                                color: #94a3b8;
                                font-size: 0.7rem;
                              ">Paste
                                a
                                direct
                                link
                                to
                                a
                                PNG/JPG
                                image
                                (approx
                                200x50px).</small>
                        </div>

                        <button onclick="saveBrandingConfig()" class="btn" style="
                              background: #3b82f6;
                              width: 100%;
                              height: 45px;
                              font-weight: 700;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                              gap: 8px;
                            ">
                            <i class="fas fa-check-circle"></i>
                            Save
                            Branding
                            Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>


    <!-- ==========================================
             LEAVE DETAILS P.WINDOW - id="leaveDetailModal"
            ========================================== -->

    <div id="leaveDetailModal" class="modal" style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.6);
              z-index: 9999;
              align-items: center;
              justify-content: center;
              backdrop-filter: blur(2px);
            ">
        <div style="
                background: white;
                border-radius: 16px;
                width: 95%;
                max-width: 600px; /* üìè Standardized Width to match Permission Modal */
                overflow: hidden;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border: none;
                animation: fadeIn 0.3s ease;
                display: flex;
                flex-direction: column;
                max-height: 90vh; /* Prevents modal from being taller than screen */
              ">
            <div style="
                  background: #1e293b;
                  color: white;
                  padding: 20px 25px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin: 0;
                ">
                <div>
                    <h3 style="
                      margin: 0;
                      font-size: 1.25rem;
                      font-weight: 700;
                      background: transparent !important;
                      border: none !important;
                      display: flex;
                      align-items: center;
                      gap: 10px;
                    ">
                        <i class="fas fa-info-circle"></i> Leave Details
                    </h3>
                </div>
                <i class="fas fa-times" onclick="closeLeaveModal()" style="
                    cursor: pointer;
                    font-size: 1.2rem;
                    opacity: 0.7;
                    transition: 0.2s;
                  " onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7"></i>
            </div>

            <div id="modalContent" style="
                  padding: 25px;
                  color: #334155;
                  line-height: 1.6;
                  overflow-y: auto; /* Internal scrollbar if content is long */
                "></div>

            <div style="
                  padding: 20px 25px;
                  background: #f8fafc;
                  border-top: 1px solid #f1f5f9;
                  display: flex;
                  justify-content: flex-end;
                ">
                <button class="btn-secondary" onclick="closeLeaveModal()" style="
                    width: 120px; /* Fixed width for a neat look */
                    height: 48px;
                    border-radius: 8px;
                    font-weight: 700;
                    font-size: 0.9rem;
                    background: white;
                    color: #64748b;
                    border: 1px solid #cbd5e1;
                    transition: 0.2s;
                    cursor: pointer;
                  " onmouseover="this.style.background='#f1f5f9'; this.style.color='#475569'" onmouseout="this.style.background='white'; this.style.color='#64748b'">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ==========================================
             AUDIT TRAILS - id="balanceLogsModal"
            ========================================== -->


    <div id="balanceLogsModal" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
          ">
        <div style="
              background: white;
              border-radius: 12px;
              width: 90%;
              max-width: 600px;
              max-height: 80vh;
              overflow-y: auto;
              box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
              overflow: hidden;
            ">
            <div style="
                background: #166534;
                color: white;
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
              ">
                <h3 style="
                  margin: 0;
                  font-size: 1.1rem;
                  background: transparent !important;
                  border: none !important;
                ">
                    <i class="fas fa-history"></i> Audit Trail:
                    <span id="logEmployeeName"></span>
                </h3>
                <i class="fas fa-times" onclick="closeLogsModal()" style="cursor: pointer"></i>
            </div>
            <div id="logsModalContent" style="padding: 20px; color: var(--text); min-height: 100px"></div>
            <div style="padding: 0 20px 20px; text-align: right">
                <button class="btn-secondary" onclick="closeLogsModal()">
                    Close
                </button>
            </div>
        </div>
    </div>


    <!-- ==========================================
             REVIEW REQUEST - id="reviewModal"
            ========================================== -->

            <div id="reviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
              <div style="background: #ffffff !important; border-radius: 16px; width: 95%; max-width: 600px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; border: 1px solid #e2e8f0;">
                  
                  <div style="padding: 20px 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #ffffff !important;">
                      <h3 style="margin: 0 !important; padding: 0 !important; background: transparent !important; border: none !important; color: #1e293b !important; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                          <div style="width: 36px; height: 36px; background-color: #eff6ff !important; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-gavel" style="color: #2563eb; font-size: 1rem"></i>
                          </div>
                          Review Request
                      </h3>
          
                      <button onclick="closeReviewModal()" style="background: transparent; border: none; cursor: pointer; color: #94a3b8; font-size: 1.2rem; padding: 8px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#94a3b8'">
                          <i class="fas fa-times"></i>
                      </button>
                  </div>
          
                  <div style="padding: 25px; overflow-y: auto; max-height: 80vh; background: #ffffff !important;">
                      <div id="reviewSummary"></div>
          
                      <div id="l2SelectorContainer" style="display: none; margin-top: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                          <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase;">L2 Routing Required</span>
                          <p style="margin: 10px 0; font-size: 0.85rem; color: #1e40af;">Please select a Level 2 Approver to proceed with this request.</p>
                          <select id="l2_manager_select" class="saas-form-control" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #bfdbfe;">
                              <option value="">-- Loading Managers... --</option>
                          </select>
                      </div>
          
                      <div style="margin-top: 20px; margin-bottom: 25px">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <label style="font-weight: 700; color: #475569; font-size: 0.85rem;">Manager Remarks (Optional)</label>
                            <span id="mgr_char_count" style="font-size: 0.7rem; color: #94a3b8">0/200</span>
                        </div>
                        <textarea id="mgr_review_remarks" rows="3" class="saas-form-control" placeholder="Add a note for the employee..." oninput="updateMgrCharCount()" maxlength="200" style="width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 15px; border-top: 1px solid #f1f5f9; padding-top: 20px;">
                        <button id="modalRejectBtn" style="flex: 1; border: 1px solid #fee2e2; background: #fff1f2; color: #dc2626; height: 45px; font-weight: 600; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-times-circle"></i> Reject
                        </button>
                        <button id="modalApproveBtn" style="flex: 1; background: #16a34a; color: white; border: none; height: 45px; font-weight: 600; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-check-circle"></i> Approve
                        </button>
                    </div>
                  </div>
              </div>
          </div>


    <!-- ==========================================
             !!!USER MANAGEMENT > MANAGER PERMISSION - id="userEditModal"
            ========================================== -->

            <div id="userEditModal" class="modal" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10006;
            align-items: center;
            justify-content: center;
          ">
  <div style="
              background: white;
              border-radius: 16px;
              width: 95%;
              max-width: 600px;
              overflow: hidden; 
              box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
              border: none;
            ">
      
      <div style="
                background: #1e293b;
                color: white;
                padding: 20px 25px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0;
              ">
          <div>
              <h3 id="userEditModalTitle" style="
                    margin: 0;
                    font-size: 1.25rem;
                    font-weight: 700;
                    background: transparent !important;
                    border: none !important;
                  ">
                  Manage Permissions
              </h3>
              <p style="
                    margin: 4px 0 0 0;
                    font-size: 0.75rem;
                    color: #94a3b8;
                    letter-spacing: 0.3px;
                  ">
                  Configure system access levels and security
              </p>
          </div>
          <i class="fas fa-times" onclick="closeUserEditModal()" style="
                  cursor: pointer;
                  font-size: 1.2rem;
                  opacity: 0.7;
                  transition: 0.2s;
                " onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7"></i>
      </div>

      <div style="padding: 25px">
          <label style="
                  font-weight: 800;
                  display: block;
                  margin-bottom: 15px;
                  font-size: 0.75rem;
                  color: #64748b;
                  text-transform: uppercase;
                  letter-spacing: 1px;
                ">
              <i class="fas fa-user-shield" style="margin-right: 8px"></i>
              Access Roles
          </label>

          <div style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 15px;
                  background: #f8fafc;
                  padding: 20px;
                  border-radius: 12px;
                  border: 1px solid #e2e8f0;
                  margin-bottom: 30px;
                ">
              <label style="
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    cursor: not-allowed;
                    padding: 12px;
                    border-radius: 10px;
                    background: #f1f5f9;
                    border: 1px solid #e2e8f0;
                  ">
                  <input type="checkbox" id="edit_role_employee" checked disabled style="width: 20px; height: 20px" />
                  <div>
                      <div style="
                        font-size: 0.9rem;
                        font-weight: 700;
                        color: #64748b;
                      ">
                          Employee
                      </div>
                      <div style="font-size: 0.7rem; color: #94a3b8">
                          Base System Access
                      </div>
                  </div>
              </label>

              <label style="
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    cursor: pointer;
                    padding: 12px;
                    border-radius: 10px;
                    background: white;
                    border: 1px solid #e2e8f0;
                    transition: 0.2s;
                  " onmouseover="this.style.borderColor='#2563eb'; this.style.boxShadow='0 4px 6px -1px rgba(0,0,0,0.05)'">
                  <input type="checkbox" id="edit_role_hr" value="hr_admin" style="width: 20px; height: 20px" />
                  <div>
                      <div style="
                        font-size: 0.9rem;
                        font-weight: 700;
                        color: #1e293b;
                      ">
                          HR Admin
                      </div>
                      <div style="font-size: 0.7rem; color: #64748b">
                          Full System Control
                      </div>
                  </div>
              </label>

              <label style="
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    cursor: pointer;
                    padding: 12px;
                    border-radius: 10px;
                    background: white;
                    border: 1px solid #e2e8f0;
                    transition: 0.2s;
                  " onmouseover="this.style.borderColor='#2563eb'; this.style.boxShadow='0 4px 6px -1px rgba(0,0,0,0.05)'">
                  <input type="checkbox" id="edit_role_manager" value="manager" style="width: 20px; height: 20px" />
                  <div>
                      <div style="
                        font-size: 0.9rem;
                        font-weight: 700;
                        color: #1e293b;
                      ">
                          Manager
                      </div>
                      <div style="font-size: 0.7rem; color: #64748b">
                          Approval Authority
                      </div>
                  </div>
              </label>

              <label id="senior_manager_wrapper" style="
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    cursor: pointer;
                    padding: 12px;
                    border-radius: 10px;
                    background: #eff6ff;
                    border: 1px solid #bfdbfe;
                    transition: 0.2s;
                  " onmouseover="this.style.background='#dbeafe'">
                  <input type="checkbox" id="edit_is_senior" style="width: 20px; height: 20px" />
                  <div>
                      <div style="
                        font-size: 0.9rem;
                        font-weight: 700;
                        color: #1e40af;
                      ">
                          <i class="fas fa-award"></i> L2 Power
                      </div>
                      <div style="font-size: 0.7rem; color: #1e40af; opacity: 0.8">
                          Dept Head Level
                      </div>
                  </div>
              </label>
          </div>

          <div style="
                  margin-top: 25px;
                  padding-top: 20px;
                  border-top: 1px dashed #e2e8f0;
                ">
              <label style="
                    font-weight: 800;
                    display: block;
                    margin-bottom: 15px;
                    font-size: 0.75rem;
                    color: #64748b;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                  ">
                  <i class="fas fa-key" style="margin-right: 6px"></i> Account
                  Security
              </label>

              <div style="
                    display: grid;
                    grid-template-columns: 1.5fr 1fr;
                    gap: 15px;
                    align-items: center;
                    background: white;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #e2e8f0;
                  ">
                  <div style="position: relative">
                      <label style="
                        font-size: 0.65rem;
                        color: #94a3b8;
                        position: absolute;
                        top: -8px;
                        left: 12px;
                        background: white;
                        padding: 0 5px;
                        font-weight: 800;
                        z-index: 1;
                      ">NEW PASSWORD</label>
                      <input type="password" id="admin_reset_pass_input" placeholder="Leave empty for 'password123'" style="
                        width: 100%;
                        height: 48px; 
                        padding: 0 40px 0 15px;
                        border: 2px solid #f1f5f9;
                        border-radius: 8px;
                        font-size: 0.9rem;
                        background: #fdfdfd;
                        transition: 0.2s;
                        box-sizing: border-box;
                      " onfocus="this.style.borderColor='#2563eb'; this.style.background='#fff';" />
                      <i class="fas fa-eye" onclick="togglePass('admin_reset_pass_input')" style="
                        position: absolute;
                        right: 15px;
                        top: 16px; 
                        cursor: pointer;
                        color: #94a3b8;
                      "></i>
                  </div>

                  <button class="btn-secondary" style="
                      width: 100%;
                      height: 48px; 
                      background: white;
                      color: #e11d48;
                      border: 1px solid #e11d48;
                      border-radius: 8px;
                      font-weight: 700;
                      font-size: 0.85rem;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      gap: 8px;
                      transition: all 0.2s;
                      cursor: pointer;
                    " onmouseover="this.style.background='#fff1f2'" onmouseout="this.style.background='white'" onclick="resetUserPassword(window.editingUserId)">
                      <i class="fas fa-unlock-alt"></i> Reset Key
                  </button>
              </div>
          </div>
      </div>

      <div style="
              padding: 20px 25px;
              background: #f8fafc;
              border-top: 1px solid #f1f5f9;
              display: flex;
              flex-direction: column; /* Stack message above buttons */
              gap: 10px;
            ">
          
          <div id="noChangeMsg" style="
              display: none; 
              text-align: center; 
              font-size: 0.75rem; 
              color: #f59e0b; 
              font-weight: bold;
          ">
              <i class="fas fa-exclamation-circle"></i> No changes detected.
          </div>

          <div style="display: flex; gap: 15px;">
              <button id="btnUpdatePermissions" class="btn" style="
                  flex: 1; 
                  height: 48px;
                  border-radius: 8px;
                  font-weight: 800;
                  font-size: 0.95rem;
                  background: #2563eb;
                  color: white;
                  border: none;
                  box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
                  transition: 0.2s;
                  cursor: pointer;
                " onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'" onclick="saveUserRoles()">
                  Update Permissions
              </button>

              <button class="btn-secondary" style="
                  flex: 1; 
                  height: 48px;
                  border-radius: 8px;
                  font-weight: 700;
                  font-size: 0.95rem;
                  background: white;
                  color: #64748b;
                  border: 1px solid #cbd5e1;
                  transition: 0.2s;
                  cursor: pointer;
                " onmouseover="this.style.background='#f1f5f9'; this.style.color='#475569'" onmouseout="this.style.background='white'; this.style.color='#64748b'" onclick="closeUserEditModal()">
                  Cancel
              </button>
          </div>
      </div>
  </div>
</div>


    <!-- ==========================================
             REGISTER NEW EMPLOYEE - id="registerUserModal"
            ========================================== -->
            <div id="registerUserModal" class="modal" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10005;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        ">
            <div style="
                background: white;
                border-radius: 16px;
                width: 95%;
                max-width: 750px;
                overflow: hidden;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border: none;
                animation: fadeIn 0.3s ease;
            ">
                <div style="
                    background: #1e293b;
                    color: white;
                    padding: 20px 25px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">Register New Employee</h3>
                        <p style="margin: 4px 0 0 0; font-size: 0.75rem; color: #94a3b8; letter-spacing: 0.3px;">
                            Create system identity and assign employment profile
                        </p>
                    </div>
                    <i class="fas fa-times" onclick="closeRegisterModal()" style="cursor: pointer; opacity: 0.7; font-size: 1.2rem; transition: 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7"></i>
                </div>
        
                <div style="padding: 25px; max-height: 75vh; overflow-y: auto;">
                    <form onsubmit="submitNewUser(event); return false;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            
                            <div>
                                <label style="font-weight: 800; display: block; margin-bottom: 15px; font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">
                                    <i class="fas fa-id-card" style="margin-right: 6px;"></i> Identity & Login
                                </label>
        
                                <div style="margin-bottom: 15px;">
                                    <label class="reg-label">Full Name <span style="color: #ef4444;">*</span></label>
                                    <input type="text" id="reg_full_name" class="saas-form-control" placeholder="e.g. Sarah Connor" required 
                                           oninput="clearError('name_error'); suggestUsername(this.value)" />
                                    <small id="name_error" class="error-text"></small>
                                </div>
        
                                <div style="margin-bottom: 15px">
                                  <label style="
                                      font-size: 0.75rem;
                                      font-weight: 700;
                                      color: #475569;
                                      margin-bottom: 4px;
                                      display: block;
                                  ">Employee ID (Auto)</label>
                                  <div style="position: relative">
                                      <input type="text" id="reg_emp_id" disabled style="
                                          width: 100%;
                                          height: 48px;
                                          background: #f1f5f9;
                                          border: 1px solid #e2e8f0;
                                          border-radius: 8px;
                                          color: #64748b;
                                          font-family: monospace;
                                          font-weight: 700;
                                          cursor: not-allowed;
                                          padding-left: 42px !important; /* üöÄ THE FIX IS HERE */
                                          box-sizing: border-box;
                                      " placeholder="Generating..." />
                                      
                                      <i class="fas fa-lock" style="
                                          position: absolute;
                                          left: 14px;
                                          top: 50%;
                                          transform: translateY(-50%);
                                          color: #94a3b8;
                                          z-index: 10;
                                      "></i>
                                  </div>
                              </div>
        
                                <div style="margin-bottom: 15px;">
                                    <label class="reg-label">Username (Auto) <span style="color: #ef4444;">*</span></label>
                                    <input type="text" id="reg_username" class="saas-form-control" placeholder="e.g. sconnor" required 
                                           oninput="this.value = this.value.toLowerCase().trim(); checkUsernameAvailability(); clearError('user_error')" />
                                    <small id="username_feedback" style="display: none; font-weight: bold; margin-top: 4px; font-size: 0.7rem;"></small>
                                    <small id="user_error" class="error-text"></small>
                                </div>
        
                                <div style="margin-bottom: 15px;">
                                    <label class="reg-label">Initial Password <span style="color: #ef4444;">*</span></label>
                                    <div style="position: relative;">
                                        <input type="password" id="reg_password" class="saas-form-control" style="padding-right: 40px;" value="password123" required 
                                               oninput="clearError('pass_error')" />
                                        <i class="fas fa-eye" id="eye_reg_password" onclick="togglePass('reg_password')" style="position: absolute; right: 15px; top: 16px; cursor: pointer; color: #94a3b8;"></i>
                                    </div>
                                    <small style="color: #94a3b8; font-size: 0.7rem;">Default: password123</small>
                                    <small id="pass_error" class="error-text"></small>
                                </div>
        
                                <div style="margin-bottom: 0;"> <label class="reg-label">Business Email <span style="color: #ef4444;">*</span></label>
                                    <input type="email" id="reg_email" class="saas-form-control" placeholder="employee@company.com" required 
                                           oninput="this.value = this.value.toLowerCase().trim(); clearError('email_error')" />
                                    <small id="email_error" class="error-text"></small>
                                </div>
                            </div> <div>
                                <label style="font-weight: 800; display: block; margin-bottom: 15px; font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">
                                    <i class="fas fa-briefcase" style="margin-right: 6px;"></i> Job Details
                                </label>
        
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label class="reg-label">Gender</label>
                                        <select id="reg_gender" class="saas-form-control">
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="reg-label">Mobile <span style="color: #ef4444;">*</span></label>
                                        <input type="text" id="reg_mobile" class="saas-form-control" placeholder="+60..." required oninput="clearError('mobile_error')" />
                                        <small id="mobile_error" class="error-text"></small>
                                    </div>
                                </div>
        
                                <div style="margin-bottom: 15px;">
                                    <label class="reg-label">Job Title</label>
                                    <input type="text" id="reg_job_title" class="saas-form-control" placeholder="e.g. Senior Analyst" />
                                </div>
        
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label class="reg-label">Department</label>
                                        <input type="text" id="reg_dept" class="saas-form-control" placeholder="e.g. Engineering" />
                                    </div>
                                    <div>
                                        <label class="reg-label">Business Unit</label>
                                        <input type="text" id="reg_unit" class="saas-form-control" placeholder="e.g. Consumer Services" />
                                    </div>
                                </div>
        
                                <div style="margin-bottom: 15px;">
                                    <label class="reg-label">Line Manager <span style="color: #ef4444;">*</span></label>
                                    <select id="reg_manager" class="saas-form-control" required onchange="clearError('manager_error')">
                                        <option value="" disabled selected>Loading managers...</option>
                                    </select>
                                    <small id="manager_error" class="error-text"></small>
                                </div>
        
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 0;">
                                    <div>
                                        <label class="reg-label">Joined Date <span style="color: #ef4444;">*</span></label>
                                        <input type="date" id="reg_joined" class="saas-form-control" required oninput="clearError('date_error')" />
                                        <small id="date_error" class="error-text"></small>
                                    </div>
                                    <div>
                                        <label class="reg-label">Marital Status</label>
                                        <select id="reg_marital" class="saas-form-control">
                                            <option value="Single">Single</option>
                                            <option value="Married">Married</option>
                                            <option value="Divorced">Divorced</option>
                                        </select>
                                    </div>
                                </div>
                            </div> </div>
                    </form>
                </div>
        
                <div style="padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-top: 1px solid #f1f5f9;">
            
                  <div>
                      <button id="reg_reset_btn" class="saas-btn-danger-soft" type="button" onclick="resetRegistrationForm()" style="
                          height: 48px; padding: 0 20px; border-radius: 8px; font-weight: 700; font-size: 0.95rem; cursor: pointer; 
                          transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid #fca5a5; background: #fff; color: #ef4444;
                      " onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='#fff'">
                          <i class="fas fa-undo"></i> Reset
                      </button>
                  </div>
      
                  <div style="display: flex; gap: 12px;">
                      <button class="btn-secondary" type="button" onclick="closeRegisterModal()" style="
                          height: 48px; min-width: 110px; border-radius: 8px; font-weight: 700; font-size: 0.95rem;
                          background: white; color: #64748b; border: 1px solid #cbd5e1; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
                      " onmouseover="this.style.background='#f1f5f9'; this.style.color='#475569'" onmouseout="this.style.background='white'; this.style.color='#64748b'">
                          Cancel
                      </button>
      
                      <button id="reg_main_submit_btn" class="btn" type="button" onclick="submitNewUser(event)" style="
                          height: 48px; min-width: 130px; border-radius: 8px; font-weight: 800; font-size: 0.95rem;
                          background: #10b981; color: white; border: none; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
                          cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
                      " onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                          <i class="fas fa-check"></i> Proceed
                      </button>
                  </div>
              </div>
        </div>


    <!-- ==========================================
             SOMETHING WENT WRONG - id="errorModal"
            ========================================== -->

    <div id="errorModal" class="modal" style="
              display: none;
              position: fixed;
              z-index: 20000;
              left: 0;
              top: 0;
              width: 100%;
              height: 100%;
              overflow: auto;
              background-color: rgba(15, 23, 42, 0.6);
              align-items: center;
              justify-content: center;
              backdrop-filter: blur(4px);
            ">
        <div class="modal-content" style="
                background-color: #fefefe;
                margin: auto;
                padding: 30px;
                border: 1px solid #888;
                width: 90%;
                max-width: 400px;
                border-radius: 12px;
                text-align: center;
                position: relative;
                animation: fadeIn 0.3s;
              ">
            <div style="
                  width: 70px;
                  height: 70px;
                  background: #fee2e2;
                  color: #ef4444;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 35px;
                  margin: 0 auto 20px auto;
                ">
                <i class="fas fa-times"></i>
            </div>

            <h2 style="color: #ef4444; margin-top: 0; margin-bottom: 10px">
                Error
            </h2>
            <p id="errorMessage" style="
                  color: #555;
                  font-size: 16px;
                  margin-bottom: 25px;
                  line-height: 1.5;
                ">
                Something went wrong.
            </p>

            <button class="btn" onclick="closeErrorModal()" style="
                  width: 100%;
                  font-size: 16px;
                  padding: 12px;
                  background-color: #ef4444;
                ">
                Try Again
            </button>
        </div>
    </div>



    
    <!-- ==========================================
             REQUEST CANCELATION - id="cancelReasonModal"
            ========================================== -->


            <div id="cancelReasonModal" class="modal-overlay" style="display: none;">
              <div class="modal-card">
                  <div class="modal-header-banner bg-error"></div>
                  
                  <div class="modal-content-body">
                      <h3 class="modal-title">Request Cancellation</h3>
                      <p class="modal-message">Please explain why you need to cancel this approved leave.</p>
          
                      <div style="width: 100%; position: relative;">
                        <textarea 
                        id="cancel_reason_input" 
                        rows="3" 
                        class="saas-form-control" 
                        style="width: 100%; box-sizing: border-box;" 
                        placeholder="e.g. Trip postponed..."
                        maxlength="200"
                        oninput="updateCharCount(this)">
                    </textarea>
                          
                          <div style="text-align: right; font-size: 0.75rem; color: #94a3b8; margin-top: 5px;">
                              <span id="char_count">0</span>/200 characters
                          </div>
                      </div>
          
                      <div class="modal-footer" style="margin-top: 20px;">
                          <button onclick="document.getElementById('cancelReasonModal').style.display='none'" 
                                  class="modal-btn modal-btn-secondary">
                              Back
                          </button>
                          <button onclick="submitCancellation()" 
                                  class="modal-btn bg-error">
                              Confirm Cancel
                          </button>
                      </div>
                  </div>
              </div>
          </div>




    <!-- ==========================================
             VERSION 1. EDIT HOLIDAY  - id="editHolidayModal"
            ========================================== -->

            <div id="editHolidayModal" class="modal" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10002;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
          ">
        <div style="
              background: white;
              border-radius: 16px;
              width: 95%;
              max-width: 450px;
              overflow: hidden;
              box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
              border: none;
              animation: fadeIn 0.2s ease-out;
            ">
            <div style="
                background: #2563eb; 
                color: white;
                padding: 20px 25px;
                display: flex;
                justify-content: space-between;
                align-items: center;
              ">
                <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; background: transparent !important; border: none !important;">
                    <i class="fas fa-calendar-alt"></i> Edit Holiday
                </h3>
                <i class="fas fa-times" onclick="closeEditHolidayModal()" style="cursor: pointer; opacity: 0.8; font-size: 1.2rem;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.8"></i>
            </div>

            <div style="padding: 25px;">
                <input type="hidden" id="edit_holiday_id" />

                <div class="saas-form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 700; font-size: 0.75rem; display: block; margin-bottom: 6px; color: #475569; text-transform: uppercase;">Holiday Date</label>
                    <input type="date" id="edit_holiday_date" class="saas-form-control" style="width: 100%; box-sizing: border-box;" />
                </div>

                <div class="saas-form-group" style="margin-bottom: 10px;">
                    <label style="font-weight: 700; font-size: 0.75rem; display: block; margin-bottom: 6px; color: #475569; text-transform: uppercase;">Holiday Name</label>
                    <input type="text" id="edit_holiday_name" maxlength="50" class="saas-form-control" style="width: 100%; box-sizing: border-box;" placeholder="e.g. National Day" />
                </div>
            </div>

            <div style="padding: 0 25px 25px; display: flex; gap: 15px;">
                <button class="btn" style="flex: 1; background: #2563eb; height: 45px; border-radius: 8px; font-weight: 700;" onclick="submitHolidayEdit()">
                    Save Changes
                </button>
                <button class="btn-secondary" style="flex: 1; height: 45px; border-radius: 8px; font-weight: 700;" onclick="closeEditHolidayModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- ==========================================
        1     PENDING L2 REQUEST  - id="l2WarningModal"
            ========================================== -->

            <div id="l2WarningModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 9999; align-items: center; justify-content: center;">
              <div style="background: white; border-radius: 16px; width: 90%; max-width: 450px; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); font-family: sans-serif;">
                <div style="text-align: center; color: #dc2626; margin-bottom: 15px">
                  <i class="fas fa-exclamation-triangle fa-3x"></i>
                </div>
                <h3 style="font-size: 1.2rem; font-weight: bold; text-align: center; color: #1e293b; margin-bottom: 10px;">
                  Pending Level 2 Requests Found
                </h3>
                <p style="text-align: center; color: #64748b; font-size: 0.85rem; margin-bottom: 20px; line-height: 1.4;">
                  <strong>Action Blocked:</strong> There are active requests currently pending Level 2 approval. You must resolve (Approve or Reject) these requests before you can disable this workflow.
                </p>
        
                <div style="background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; max-height: 120px; overflow-y: auto; margin-bottom: 20px;">
                  <ul id="pendingL2List" style="list-style: none; padding: 10px; margin: 0; font-size: 0.8rem; color: #334155;"></ul>
                </div>
        
                <div style="text-align: center">
                  <button onclick="closeL2Modal()" style="width: 100%; padding: 12px; border-radius: 6px; border: none; background: #334155; color: white; cursor: pointer; font-weight: bold; font-size: 0.9rem;">
                    <i class="fas fa-check"></i> Okay, I will clear these first
                  </button>
                </div>
              </div>
            </div>

    <!-- ==========================================
             TEAM AVAILABILITY - id="calendarModal"
            ========================================== -->
            <div id="calendarModal" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(
              15,
              23,
              42,
              0.8
            );
            z-index: 99999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(
              4px
            );
          ">
        <div style="
              background: white;
              width: 95%;
              max-width: 1000px;
              max-height: 90vh;
              border-radius: 16px;
              overflow: hidden;
              display: flex;
              flex-direction: column;
            ">
          <div style="
                padding: 20px
                  25px;
                border-bottom: 1px
                  solid
                  #e2e8f0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #f8fafc;
              ">
            <div>
              <h2 style="
                    margin: 0;
                    font-size: 1.2rem;
                    color: #1e293b;
                  ">
                <i class="fas fa-users" style="
                      color: #2563eb;
                    "></i>
                Team
                Availability
              </h2>
            </div>
            <div style="
                  display: flex;
                  align-items: center;
                  gap: 15px;
                ">
              <button class="icon-btn" onclick="changeMonth(-1)">
                <i class="fas fa-chevron-left"></i>
              </button>
              <h3 id="modal_month_year" style="
                    margin: 0;
                    min-width: 140px;
                    text-align: center;
                    font-size: 0.95rem;
                    color: #2563eb;
                  "></h3>
              <button class="icon-btn" onclick="changeMonth(1)">
                <i class="fas fa-chevron-right"></i></button><i class="fas fa-times" onclick="closeCalendarModal()" style="
                    cursor: pointer;
                    font-size: 1.5rem;
                    color: #94a3b8;
                  "></i>
            </div>
          </div>
          <div style="
                flex: 1;
                padding: 25px;
                overflow-y: auto;
                background: white;
              ">
            <div style="
                  display: grid;
                  grid-template-columns: repeat(
                    7,
                    1fr
                  );
                  gap: 5px;
                  text-align: center;
                  font-weight: bold;
                  font-size: 0.7rem;
                  color: #64748b;
                  margin-bottom: 10px;
                  text-transform: uppercase;
                ">
              <div>
                Sun
              </div>
              <div>
                Mon
              </div>
              <div>
                Tue
              </div>
              <div>
                Wed
              </div>
              <div>
                Thu
              </div>
              <div>
                Fri
              </div>
              <div>
                Sat
              </div>
            </div>
            <div id="modal_calendar_grid" style="
                  display: grid;
                  grid-template-columns: repeat(
                    7,
                    1fr
                  );
                  gap: 5px;
                  min-height: 400px;
                "></div>
          </div>
          <div style="
                padding: 15px
                  25px;
                background: #f8fafc;
                border-top: 1px
                  solid
                  #e2e8f0;
                display: flex;
                gap: 20px;
                font-size: 0.75rem;
                color: #64748b;
              ">
            <span><i class="fas fa-square" style="
                    color: #e2e8f0;
                  "></i>
              Public
              Holiday</span><span><i class="fas fa-square" style="
                    color: #e0e7ff;
                  "></i>
              Leave
              Request</span><span style="
                  margin-left: auto;
                  font-style: italic;
                ">Press
              <strong>ESC</strong>
              to
              close</span>
          </div>
        </div>
      </div>


    <!-- ==========================================
Used by the HR Admin Settings script. When you toggle "Carry Forward" or "L2 Approval" on/off
            ========================================== -->

            <div
            id="universalModal"
            class="modal"
            style="
              display: none;
              align-items: center;
              justify-content: center;
              position: fixed;
              z-index: 1000;
              left: 0;
              top: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(0, 0, 0, 0.5);
              backdrop-filter: blur(2px);
            "
          >
            <div
              class="modal-content"
              style="
                background: white;
                padding: 30px;
                border-radius: 12px;
                width: 90%;
                max-width: 450px;
                text-align: center;
                position: relative;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                border-top: 5px solid transparent; /* JS sets color: Green or Red */
              "
              id="uModalContent"
            >
              <div
                id="uModalIcon"
                style="font-size: 3rem; margin-bottom: 15px; transition: color 0.3s"
              >
                <i class="fas fa-question-circle"></i>
              </div>
          
              <h3
                id="uModalTitle"
                style="
                  margin-top: 0;
                  color: #1e293b;
                  margin-bottom: 10px;
                  font-size: 1.25rem;
                "
              >
                Confirm Action
              </h3>
          
              <p
                id="uModalDesc"
                style="
                  color: #475569;
                  line-height: 1.5;
                  margin-bottom: 20px;
                  font-size: 0.95rem;
                "
              >
                Are you sure?
              </p>
          
              <div
                id="uModalWarningBox"
                style="
                  display: none;
                  background: #fff1f2;
                  padding: 15px;
                  border-radius: 8px;
                  border: 1px solid #fecdd3;
                  text-align: left;
                  font-size: 0.9rem;
                  color: #991b1b;
                  margin-bottom: 25px;
                "
              >
                <strong><i class="fas fa-radiation"></i> System Action:</strong><br />
                Proceeding will automatically
                <span style="text-decoration: underline; font-weight: bold">CANCEL</span>
                all active requests and remove banked days.
              </div>
          
              <div style="display: flex; gap: 15px; justify-content: center">
                <button
                  type="button"
                  onclick="closeUniversalModal()"
                  style="
                    width: 150px;
                    padding: 10px;
                    border-radius: 6px;
                    border: 1px solid #cbd5e1;
                    background: white;
                    color: #334155;
                    font-weight: bold;
                    cursor: pointer;
                  "
                >
                  Cancel
                </button>
          
                <button
                  type="button"
                  id="uModalConfirmBtn"
                  style="
                    width: 150px;
                    padding: 10px;
                    border-radius: 6px;
                    border: none;
                    color: white;
                    font-weight: bold;
                    cursor: pointer;
                    transition: background 0.3s;
                  "
                >
                  Confirm
                </button>
              </div>
            </div>
          </div>

    <!-- ==========================================
        This is the Global Success Modal. It is a generic, 
        reusable pop-up that tells the user "Good job, 
        it worked!"
            ========================================== -->
            <div
            id="successModal"
            class="modal"
            style="
              display: none;
              position: fixed;
              z-index: 2000;
              left: 0;
              top: 0;
              width: 100%;
              height: 100%;
              overflow: auto;
              background-color: rgba(0, 0, 0, 0.5);
              align-items: center;
              justify-content: center;
            "
          >
            <div
              class="modal-content"
              style="
                background-color: #fefefe;
                margin: auto;
                padding: 30px;
                border: 1px solid #888;
                width: 90%;
                max-width: 400px;
                border-radius: 12px;
                text-align: center;
                position: relative;
                animation: fadeIn 0.3s;
              "
            >
              <div
                style="
                  width: 70px;
                  height: 70px;
                  background: #dcfce7;
                  color: #16a34a;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 35px;
                  margin: 0 auto 20px auto;
                "
              >
                <i class="fas fa-check"></i>
              </div>
    
              <h2 style="color: #16a34a; margin-top: 0; margin-bottom: 10px">
                Success!
              </h2>
              <p
                id="successMessage"
                style="
                  color: #555;
                  font-size: 16px;
                  margin-bottom: 25px;
                  line-height: 1.5;
                "
              >
                Action completed successfully.
              </p>
    
              <button
                class="btn"
                onclick="closeSuccessModal()"
                style="width: 100%; font-size: 16px; padding: 12px"
              >
                OK, Got it!
              </button>
            </div>
          </div>





          <script>
            const API_URL = "http://127.0.0.1:8000";
        
            // üåç 1. GLOBAL IDENTITY (FORCE SYNC)
            // üöÄ Leave Manager Pagination
            let mgrCurrentPage = 1;
            const mgrPageSize = 10;


            const processedActionIds = new Set();
        
            // üöÄ Overtime Manager Pagination
            let mgrOTCurrentPage = 1;
            const mgrOTPageSize = 10;
        
            let otCurrentPage = 1;
            const otPageSize = 10;
            let mgrHistCurrentPage = 1;
            const mgrHistPageSize = 10;
        
            // üöÄ GLOBAL CONFIG
            let ENABLE_CARRY_FORWARD = false;
            let lastFetchedAuditLogs = [];
            let SESSION_ID = localStorage.getItem("sessionId");
            let CURRENT_USER = localStorage.getItem("currentUser");
            let USER_ROLES = JSON.parse(
                localStorage.getItem("userRoles") || '["employee"]'
            );
            let teamEntitlementCache = [];
            let historyCache = [];
            let currentSort = { key: null, direction: 'asc' }
            let historySort = { key: 'start_date', direction: 'desc' };
            let rawHistoryData = []; // Stores the current list (filtered)
            let historySortState = { key: 'id', direction: 'desc' }; // Default: Newest First
            let mgrOTSortState = { key: 'ot_date', direction: 'desc' };
            let historyPageSize = 10;
            let historyCurrentPage = 1;


            var masterAuditData = [];      // Holds ALL fetched data (Leaves + OT)
            var filteredAuditData = [];    // Holds data after Search/Filter is applied
            var auditSortState = { key: 'id', direction: 'desc' }; 
            var auditCurrentPage = 1;
            var auditPageSize = 10;

            // UI Aliases
            let currentUser = CURRENT_USER;
            let userRoles = USER_ROLES;
            let isKickedOut = false;
            let isRefreshing = false;
            let initialPermissionState = {};
        
            // ============================================================
            // üöÄ NEW INSERTION: GLOBAL INITIALIZERS (Must be here!)
            // ============================================================
        
            // 1. Fixes the "currentCalDate is not defined" error in the calendar
            let currentCalDate = new Date();
        
            // 2. Fixes the "saveLeaveDraft is not defined" error in the draft listeners
    window.saveLeaveDraft = function() {
    // 1. Detect Mode
    const isCF = document.getElementById("carry_forward_ui")?.style.display === "block";

    if (isCF) {
        // üü¢ CARRY FORWARD MODE
        // Saves to its own 'leave_draft_cf' bucket
        // üöÄ FIX: Reads from 'cf_reason' (Unique ID) so it doesn't conflict
        const draft = {
            days: document.getElementById("cf_days_input")?.value,
            reason: document.getElementById("cf_reason")?.value, // <--- CHANGED THIS
            approver: document.getElementById("dash_approver_cf")?.value,
            timestamp: new Date().getTime()
        };
        localStorage.setItem("leave_draft_cf", JSON.stringify(draft));
    } else {
        // üîµ STANDARD LEAVE MODE
        // Saves to 'leave_draft_std' bucket
        // Logic remains UNTOUCHED to ensure no regression
        const draft = {
            type: document.getElementById("dash_leave_type")?.value,
            start: document.getElementById("dash_start")?.value,
            end: document.getElementById("dash_end")?.value,
            reason: document.getElementById("dash_reason")?.value, // Standard ID
            approver: document.getElementById("dash_approver")?.value,
            half_day: document.getElementById("dash_half_day")?.checked,
            timestamp: new Date().getTime()
        };
        localStorage.setItem("leave_draft_std", JSON.stringify(draft));
    }
};
        
            // ============================================================
            // END NEW INSERTION
            // ============================================================
        
            // ‚å®Ô∏è ESCAPE KEY TO CLOSE
            document.addEventListener("keydown", function(event) {
                if (event.key === "Escape") {
                    const reviewModal = document.getElementById("reviewModal");
                    // Check if modal is visible (using display block or flex)
                    if (reviewModal && reviewModal.style.display !== "none") {
                        closeReviewModal();
                    }
                }
            });
        
            // üñ±Ô∏è CLICK OUTSIDE TO CLOSE
            window.addEventListener("click", function(event) {
                const reviewModal = document.getElementById("reviewModal");
                // If the click is on the darkened background, not the white box
                if (event.target === reviewModal) {
                    closeReviewModal();
                }
            });
        
            // üöÄ THE MASTER COUNTER: Universal Version
            window.updateCharCount = function(textarea) {
                // 1. IMPROVED LOGIC: Find the span by looking at the parent container
                // This works for ANY textarea that has a counter div nearby
                const parent = textarea.parentElement;
                const countSpan = parent.querySelector('span[id^="char_count"]');
        
                if (!countSpan) {
                    // Fallback: Try global ID search if parent search fails
                    const fallbackId = (textarea.id === 'ot_reason') ? 'char_count_ot' : 'char_count';
                    const fallbackSpan = document.getElementById(fallbackId);
                    if (!fallbackSpan) return;
                    updateUI(fallbackSpan, textarea.value.length);
                } else {
                    updateUI(countSpan, textarea.value.length);
                }
        
                function updateUI(el, len) {
                    // 2. Update ONLY the number (matching your <span>0</span> structure)
                    el.innerText = len;
        
                    // 3. Visual Feedback
                    if (len >= 200) {
                        el.style.color = "#ef4444"; // Red at limit
                    } else if (len >= 180) {
                        el.style.color = "#f59e0b"; // Orange warning
                    } else {
                        el.style.color = "#94a3b8"; // Normal slate
                    }
                }
            };


      // 4. SYNC UI LABELS
      document.getElementById("topbarName").innerText = currentUser;
      document.getElementById("welcomeName").innerText = currentUser;
      if (document.getElementById("profileName"))
        document.getElementById("profileName").innerText = currentUser;

// 4. Role-Based Access Control (RBAC)
// 4. Role-Based Access Control (RBAC)
function initializeAccess() {
    const mgrMenu = document.getElementById("managerMenu");
    const hrMenu = document.getElementById("hrAdminMenu");
    const navSettings = document.getElementById("nav_hr_settings"); 
    
    // üëë 1. BULLETPROOF SUPERUSER CHECK
    const masterRole = localStorage.getItem("userMasterRole");
    const loggedInUser = localStorage.getItem("username");
    const currentUserName = typeof currentUser !== 'undefined' ? currentUser : localStorage.getItem("currentUser");
    
    const isSuperuser = (masterRole === "superuser" || loggedInUser === "superuser" || currentUserName === "System Administrator");

    // üöÄ 2. Manager Menu
    if (mgrMenu) {
        const roles = typeof userRoles !== 'undefined' ? userRoles : JSON.parse(localStorage.getItem("userRoles") || '[]');
        const hasManagerPower = roles.includes("manager") || roles.includes("hr_admin") || isSuperuser;
        mgrMenu.style.display = hasManagerPower ? "block" : "none";
    }

    // üöÄ 3. HR Menu
    if (hrMenu) {
        const roles = typeof userRoles !== 'undefined' ? userRoles : JSON.parse(localStorage.getItem("userRoles") || '[]');
        const hasHRPower = roles.includes("hr_admin") || isSuperuser;
        hrMenu.style.display = hasHRPower ? "block" : "none";
    }

    // üöÄ 4. System Settings Gear
    if (navSettings) {
        navSettings.style.display = isSuperuser ? "flex" : "none";
    }

    // üöÄ 5. SAFE GHOST ADMIN CLEANUP
    if (isSuperuser) {
        // A. Safely hide the leave cards using their exact IDs, not text search
        const annualCard = document.getElementById("card_annual");
        if (annualCard) {
            // Goes up to the grid wrapper and hides it safely
            const cardGrid = annualCard.parentElement.parentElement;
            if (cardGrid) cardGrid.style.display = "none";
        }

        // B. Hide standard container classes if they exist
        const leaveSection = document.querySelector(".leave-balance-section") || 
                             document.querySelector(".leave-overview-container");
        if (leaveSection) leaveSection.style.display = "none";

        // C. Hide just the specific subtitle class
        const greetingSubtitle = document.querySelector(".greeting-subtitle");
        if (greetingSubtitle) greetingSubtitle.style.display = "none";
        
        // D. Hide the Upcoming Schedule box safely
        const nextHoliday = document.getElementById("home_next_holiday");
        if (nextHoliday) {
            const scheduleBox = nextHoliday.parentElement.parentElement;
            if (scheduleBox) scheduleBox.style.display = "none";
        }
        
        // üõë NOTE: NO REDIRECT HERE. We let window.onload handle the redirect to hr_audit.
    }
}

 // üõ°Ô∏è 5. THE BULLETPROOF AUTH FETCH (Updated for Superuser Security)
 async function fetchWithAuth(url, options = {}) {
    // 1. Sync High-speed RAM if empty
    if (!SESSION_ID || SESSION_ID === "null") {
        SESSION_ID = localStorage.getItem("sessionId");
        CURRENT_USER = localStorage.getItem("currentUser");
    }

    // 2. üõë HARD STOP: Prevent the "EMPTY ID" race condition
    if (!SESSION_ID || !CURRENT_USER || SESSION_ID === "null") {
        console.warn("üö´ Blocking request: No valid session in RAM for", url);
        return null;
    }

    // 3. Inject Security Headers
  // 3. Inject Security Headers
  options.headers = options.headers || {};
    options.headers["X-Session-ID"] = SESSION_ID;
    options.headers["X-Requester-Name"] = CURRENT_USER;
    
    // üöÄ FIXED: Send the immutable 'username' (e.g., "admin") instead of Full Name
    options.headers["x-username"] = localStorage.getItem("username"); // <--- ‚úÖ CORRECT

    // 4. Handle URL Parameters safely
    const separator = url.includes("?") ? "&" : "?";
    let finalUrl = url;

    const hasNameParam = [
        "employee_name=",
        "approver_name=",
        "full_name=",
        "username=",
    ].some((param) => url.includes(param));

    if (!hasNameParam) {
        finalUrl = `${url}${separator}employee_name=${encodeURIComponent(CURRENT_USER)}`;
    }

    try {
        const response = await fetch(finalUrl, options);

        // 5. Handle Global Kick-out (401) - üöÄ UPGRADED TO SWEETALERT
        if (response.status === 401) {
            if (!isKickedOut) {
                isKickedOut = true;
                
                // Use SweetAlert for a highly visible, blocking notification
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Session Expired',
                        html: 'Your session has ended or a new login was detected elsewhere.<br><br>Redirecting to secure login...',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        timer: 3500, // Wait 3.5 seconds so the user can read it
                        timerProgressBar: true,
                        didClose: () => {
                            // Safely wipe memory and redirect after the timer finishes
                            localStorage.clear();
                            sessionStorage.clear();
                            window.location.replace("login.html");
                        }
                    });
                } else {
                    // Fallback just in case Swal hasn't loaded
                    alert("Session Expired: You are being redirected to the login page.");
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.replace("login.html");
                }
            }
            return null;
        }
        
        // 6. üõ°Ô∏è Handle Access Denied (403) specifically for Superuser routes
        if (response.status === 403) {
            console.error("üö´ Access Denied: Insufficient Permissions for", url);
            // We return the response so the calling function (like saveBrandingConfig) 
            // can show a specific "Access Denied" SweetAlert.
            return response; 
        }

        return response;
    } catch (error) {
        console.error("Network Error in fetchWithAuth:", error);
        return null;
    }
}

  // üèÅ THE 401 KILLER: Orchestrated Dashboard Startup
  async function initializeDashboard() {
        console.log("üöÄ Initializing Secure Dashboard for:", currentUser);

        // 1. Setup UI (No network calls)
        initializeAccess();
        document.getElementById("topbarName").innerText = currentUser;
        document.getElementById("welcomeName").innerText = currentUser;

        // 2. Critical Identity Sync
        await loadUserProfile();

        // 3. üü¢ LOAD GLOBAL SETTINGS
        // This handles both Carry Forward AND Maintenance/Broadcast settings
        await loadCFSetting();
        await loadBroadcastSettings(); // üöÄ NEW: Syncs the toggle and timer

        // 4. Sequential Data Loading
        await refreshManagerBadges();
        await loadApproverList();
        await prefetchBalances();

        // 5. Role-Specific Advanced Data
        if (userRoles.includes("hr_admin")) {
            await loadSystemReporting();
        }

        // 6. Render heavy UI elements last
        renderCalendar();
        updateCurrentYearLabels();

        console.log(
            "‚úÖ Dashboard Fully Synchronized. Terminal should be 200 OK."
        );
    }

      function initDraftListeners() {
  const fields = ["dash_leave_type", "dash_start", "dash_end", "dash_reason", "dash_approver", "dash_half_day"];
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      // Use 'change' for selects/dates and 'input' for textareas
      const eventType = (el.tagName === 'INPUT' && el.type === 'checkbox') || el.tagName === 'SELECT' ? 'change' : 'input';
      el.addEventListener(eventType, saveLeaveDraft);
    }
  });
}


      /**
       * üîÑ Syncs the red notification badges for Pending Leaves and OT.
       * Updated to support both Managers and HR Admins for background heartbeats.
       */
      // üîí Single Global Lock for the Badge Refresh
      let isBadgeRefreshing = false;

      /**
       * üîÑ Syncs the red notification badges for Pending Leaves and OT.
       * Updated to support both Managers and HR Admins for background heartbeats.
       */
       async function refreshManagerBadges() {
    // üõ°Ô∏è 1. SECURITY UPDATE: Allow both Managers AND HR Admins to sync badges
    if (!userRoles.includes("manager") && !userRoles.includes("hr_admin"))
        return;

    // Prevent multiple simultaneous refresh calls
    if (isBadgeRefreshing) return;
    isBadgeRefreshing = true;

    try {
        // console.log("üîÑ Syncing Action Center Badges for:", currentUser);

        // üöÄ Request A: Fetch Pending Leave Count
        // (Note: Backend logic in 'leaves.py' must also return 'Pending Cancel' for this count to update)
        const leaveRes = await fetchWithAuth(
            `${API_URL}/leaves/manager/pending?approver_name=${encodeURIComponent(
                currentUser
            )}&page_size=1`
        );

        if (leaveRes && leaveRes.ok) {
            const data = await leaveRes.json();
            const count = data.total || 0;

            // Update Sidebar Badge
            const sidebarBadge = document.getElementById("badge_mgr_leave");
            if (sidebarBadge) {
                sidebarBadge.innerText = count;
                sidebarBadge.style.display = count > 0 ? "inline-block" : "none";
            }
            // Update Home Screen Action Tile
            if (document.getElementById("home_leave_count")) {
                document.getElementById("home_leave_count").innerText = count;
            }

            // Show/Hide New Badge on Tile
            const tileBadge = document.getElementById("home_leave_badge");
            if (tileBadge) {
                tileBadge.style.display = count > 0 ? "block" : "none";
            }
        }

        // üõë Small delay to prevent network congestion between rapid-fire calls
        await new Promise((resolve) => setTimeout(resolve, 800));

        // üöÄ Request B: Fetch Pending Overtime Count
        const otRes = await fetchWithAuth(
            `${API_URL}/overtime/manager-requests?approver_name=${encodeURIComponent(
                currentUser
            )}`
        );

        if (otRes && otRes.ok) {
            const otData = await otRes.json();

            // ‚úÖ THE FIX: Include "Pending Cancel" in the count
            const pendingOT = (Array.isArray(otData) ? otData : []).filter(
                (r) =>
                    r.status === "Pending" || 
                    r.status === "Pending L2 Approval" || 
                    r.status === "Pending Cancel" // üëà ADDED THIS LINE
            );

            const count = pendingOT.length;

            // Update Sidebar Badge
            const sidebarBadge = document.getElementById("badge_mgr_ot");
            if (sidebarBadge) {
                sidebarBadge.innerText = count;
                sidebarBadge.style.display = count > 0 ? "inline-block" : "none";
            }
            // Update Home Screen Action Tile
            if (document.getElementById("home_ot_count")) {
                document.getElementById("home_ot_count").innerText = count;
            }
            // Show/Hide Urgent Badge on Tile
            const tileBadge = document.getElementById("home_ot_badge");
            if (tileBadge) {
                tileBadge.style.display = count > 0 ? "block" : "none";
            }
        }

        // console.log("‚úÖ Action Center Synchronized.");
    } catch (e) {
        console.error("Badge Refresh Error:", e);
    } finally {
        isBadgeRefreshing = false; // üîì Release lock
    }
}

      // üöÄ Helper to update the text when a file is chosen
// üîÑ UPDATED: Updates label AND controls the "X" button visibility
function updateFileLabel(input, labelId, btnId) {
        const label = document.getElementById(labelId);
        const removeBtn = document.getElementById(btnId); // New: Get the X button

        if (input.files && input.files.length > 0) {
            // State: File Selected
            label.innerText = input.files[0].name;
            label.style.color = "#2563eb"; // Blue text
            
            // Show the remove button if it exists
            if (removeBtn) removeBtn.style.display = "block"; 
        } else {
            // State: No File (or Cancelled)
            label.innerText = "Click to attach file";
            label.style.color = "#334155"; // Default text
            
            // Hide the remove button
            if (removeBtn) removeBtn.style.display = "none"; 
        }
    }

    // üóëÔ∏è NEW: Clears the file input when "X" is clicked
    function removeAttachment(inputId, labelId, btnId) {
        const input = document.getElementById(inputId);
        const label = document.getElementById(labelId);
        const btn = document.getElementById(btnId);

        // 1. Clear the actual file input value
        if (input) input.value = "";

        // 2. Reset the text label to default
        if (label) {
            label.innerText = "Click to attach file";
            label.style.color = "#334155";
        }

        // 3. Hide the "X" button again
        if (btn) btn.style.display = "none";

        // 4. Also hide any size error messages if they were visible
        // Determine which error ID to look for based on the input ID
        const errorId = inputId === 'leave_attachment' ? 'leave_file_error' : 'ot_file_error';
        const errorSpan = document.getElementById(errorId);
        if (errorSpan) errorSpan.style.display = 'none';
    }
      /* =========================================
         GLOBAL MODAL CONTROLLER (Interaction Based)
         ========================================= */

      // üöÄ Global variable to store the "Next Action" (Callback)
      let onModalCloseCallback = null;

      // 1. Show the Modal (Now accepts a 'callback' function)
function showModal(title, message, type = "info", callback = null) {
const modal = document.getElementById("globalModal");
const banner = document.getElementById("modalBanner");
const icon = document.getElementById("modalIcon");
const btn = document.getElementById("modalBtn");
const titleEl = document.getElementById("modalTitle");
const msgEl = document.getElementById("modalMessage");
if (!modal) return;
onModalCloseCallback = callback;
const cleanMessage = message.replace(/[‚úÖ‚ùå‚ö†Ô∏è]/g, '').trim();
let themeColor = "#334155"; 
let iconClass = "fa-info-circle";
if (type === "success") { themeColor = "#10b981"; iconClass = "fa-check-circle"; }
else if (type === "error") { themeColor = "#ef4444"; iconClass = "fa-times-circle"; }
else if (type === "warning") { themeColor = "#f59e0b"; iconClass = "fa-exclamation-triangle"; }
banner.style.backgroundColor = themeColor;
btn.style.backgroundColor = themeColor;
icon.style.color = themeColor;
icon.className = `fas ${iconClass}`;
titleEl.innerText = title;
msgEl.innerHTML = cleanMessage;
modal.classList.add("show");
}
      // 2. Close the Modal & Execute the Callback
      function closeGlobalModal() {
        const modal = document.getElementById("globalModal");
        if (modal) modal.classList.remove("show");

        // üöÄ EXECUTE THE WAITING INSTRUCTION (If any)
        if (
          onModalCloseCallback &&
          typeof onModalCloseCallback === "function"
        ) {
          onModalCloseCallback();
          onModalCloseCallback = null; // Clear it after running
        }
      }

// 3. Event Listeners & System Initialization
  document.addEventListener("DOMContentLoaded", async () => {
        // --- Modal Behavior ---
        const modal = document.getElementById("globalModal");
        if (modal) {
          modal.addEventListener("click", (e) => {
            if (e.target.id === "globalModal") closeGlobalModal();
          });
        }

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeGlobalModal();
        });

        // --- üöÄ Initial Data Load ---
        // We load the profile and branding first so the UI looks correct immediately
        await loadUserProfile();
        await applySystemBranding();
        
        // Load other global data (Policy, Audit Logs, etc.)
        if (typeof loadGlobalPolicy === "function") loadGlobalPolicy();
      });

      async function showSection(sectionId) {
        // üõ°Ô∏è 1. IDENTITY SYNC: Ensure RAM is ready (Moved up to use immediately)
        if (!SESSION_ID || SESSION_ID === "null") {
          SESSION_ID = localStorage.getItem("sessionId");
          CURRENT_USER = localStorage.getItem("currentUser");
        }

        // üëë 2. BULLETPROOF SUPERUSER CHECK
        const masterRole = localStorage.getItem("userMasterRole");
        const loggedInUser = localStorage.getItem("username");
        const currentUserName = typeof currentUser !== 'undefined' ? currentUser : localStorage.getItem("currentUser");
        
        const isSuperuser = (masterRole === "superuser" || loggedInUser === "superuser" || currentUserName === "System Administrator");

        // üõ°Ô∏è 3. SECURITY SENTRY: Role-Based Access Control (RBAC)
        // üöÄ THE FIX: Allow Superuser to bypass the 'hr_admin' restriction
        if (sectionId.startsWith("hr_") && !userRoles.includes("hr_admin") && !isSuperuser) {
          console.warn("üö´ Security: Unauthorized access attempt to", sectionId);
          
          // üöÄ SAFE FALLBACK: Safely show Home without triggering an infinite redirect loop
          sessionStorage.setItem("activeTab", "home");
          document.querySelectorAll(".section, .menu-item").forEach((el) => el.classList.remove("active"));
          const homeTarget = document.getElementById("home");
          if(homeTarget) homeTarget.classList.add("active");
          return; 
        }

        sessionStorage.setItem("activeTab", sectionId);

        // 4. UI Reset
        document.querySelectorAll(".section, .menu-item").forEach((el) => {
          el.classList.remove("active");
        });

        // 5. Show the Target Section
        const target = document.getElementById(sectionId);
        if (target) {
          target.classList.add("active");
        }

        // 6. Highlight Sidebar
        const menuLink = document.querySelector(
          `.menu-item[onclick*="${sectionId}"]`
        );
        if (menuLink) {
          menuLink.classList.add("active");
        }

        // 7. Automatic Data Refresh
        try {
          if (!SESSION_ID || !CURRENT_USER) return;

          if (sectionId === "home") {
            isBadgeRefreshing = false;
            await Promise.all([
              prefetchBalances(),
              loadHomeLeadershipInsights(),
              refreshManagerBadges(),
            ]);
          } else if (sectionId === "hr_reporting") {
            await loadSystemReporting();
            await renderCalendar();
          } else if (sectionId === "hr_users") {
            await loadAllUsers();
          } else if (sectionId === "hr_policy") {
            // üöÄ RENDER POLICY UI
            renderGlobalPolicyUI();

            // üöÄ NEW: SYNC THE L2 TOGGLE STATE FROM DATABASE
            // This prevents the "reset to OFF" bug when navigating back
            try {
              const res = await fetchWithAuth(
                `${API_URL}/users/policy/current`
              );
              if (res && res.ok) {
                const data = await res.json();
                const toggle = document.getElementById("l2_workflow_toggle");
                if (toggle) {
                  toggle.checked = data.l2_approval_enabled;
                  console.log(
                    "L2 Toggle synced from DB:",
                    data.l2_approval_enabled
                  );
                }
              }
            } catch (err) {
              console.error("Failed to sync L2 toggle state:", err);
            }
          } else if (sectionId === "hr_holidays") {
            await loadAdminHolidays();
          } else if (sectionId === "holidays") {
            await loadPublicHolidays();
          } else if (sectionId === "hr_audit") {
            await loadGlobalAuditLogs();
            if (typeof resetAuditFilters === "function") resetAuditFilters();
          } else if (sectionId === "apply") {
            // 1. Fetch latest dropdown data and balances
            // We 'await' here to ensure the <select> options exist before we try to set their values
            await Promise.all([loadApproverList(), prefetchBalances()]);
            
            // üöÄ 2. NEW: SHOW PROXY BANNER ONLY TO HR ADMINS OR SUPERUSER
            const proxyBanner = document.getElementById("hr_proxy_banner");
            if (proxyBanner) {
                proxyBanner.style.display = (userRoles.includes("hr_admin") || isSuperuser) ? "block" : "none";
            }
            
            // üöÄ 3. THE FIX: Restore user's typing immediately after the lists load.
            // This ensures that even if a flicker occurs, the data is put back instantly.
            if (typeof restoreLeaveDraft === "function") {
                restoreLeaveDraft();
                console.log("üìù Draft restored for the Apply section.");
            }
          } else if (sectionId === "history") {
            await loadHistory(1, 10);
          } else if (sectionId === "manager_requests") {
            await loadManagerRequests();
          } else if (sectionId === "manager_ot_requests") {
            await loadManagerOTRequests();
          } else if (sectionId === "manager_history") {
            await loadTeamHistory();
          } else if (sectionId === "manager_entitlements") {
            const entSearch = document.getElementById("mgr_ent_search_name");
            if (entSearch) entSearch.value = "";
            await loadTeamEntitlements();
          } else if (sectionId === "profile") {
            await loadUserProfile();
          }
        } catch (err) {
          console.error(`Error loading data for ${sectionId}:`, err);
        }

        // 8. Scroll to top
        const contentArea = document.querySelector(".content");
        if (contentArea) contentArea.scrollTop = 0;
      }

      const leaveEntitlements = {};
      let annualRemainingGlobal = 0;

      // Toggle Gaurd listener
      // üöÄ THE TOGGLE GUARD: Handles the Yes/No prompt and saves to DB
      // We use a listener so we can "interrupt" the click before it happens
      // document.addEventListener("change", async function (e) {
      //   // 1. Check if the element being clicked is our L2 Toggle
      //   if (e.target && e.target.id === "l2_workflow_toggle") {
      //     const toggle = e.target;
      //     const isNowChecked = toggle.checked;
      //     const wasChecked = !isNowChecked; // What it was before the click

      //     // 2. Prepare the Informative Message
      //     let confirmMsg = "";
      //     if (isNowChecked) {
      //       confirmMsg =
      //         "üöÄ ENABLE L2 APPROVAL WORKFLOW?\n\n" +
      //         "‚Ä¢ EFFECT: All new leave requests will require a second sign-off.\n" +
      //         "‚Ä¢ EFFECT: Managers must select a Department Head (L2) when approving.\n" +
      //         "‚Ä¢ NOTE: Senior Managers (L2 Power) will still approve in one step.\n\n" +
      //         "Do you want to proceed?";
      //     } else {
      //       confirmMsg =
      //         "‚ö†Ô∏è DISABLE L2 APPROVAL WORKFLOW?\n\n" +
      //         "‚Ä¢ EFFECT: The system returns to standard 1-level approval.\n" +
      //         "‚Ä¢ EFFECT: Ongoing 'Pending L2' requests will be finalized by the next action.\n\n" +
      //         "Are you sure you want to turn this off?";
      //     }

      //     // 3. The YES/NO Prompt
      //     if (!confirm(confirmMsg)) {
      //       // User clicked NO -> Snap the toggle back to its previous state
      //       toggle.checked = wasChecked;
      //       return;
      //     }

      //     // 4. User clicked YES -> Save to Backend
      //     const formData = new FormData();
      //     formData.append("enabled", isNowChecked);

      //     try {
      //       const res = await fetchWithAuth(
      //         `${API_URL}/users/policy/update-l2`,
      //         {
      //           method: "PUT",
      //           body: formData,
      //         }
      //       );

      //       if (res && res.ok) {
      //         alert(
      //           `‚úÖ Success: L2 Workflow is now ${isNowChecked ? "ON" : "OFF"}.`
      //         );
      //       } else {
      //         throw new Error("Server failed to update policy.");
      //       }
      //     } catch (err) {
      //       console.error("L2 Toggle Error:", err);
      //       alert("‚ùå Error: Could not save settings. Reverting...");
      //       toggle.checked = wasChecked; // Revert visually if the database fails
      //     }
      //   }
      // });

      function resetToToday() {
        currentCalDate = new Date();
        renderCalendar();
      }

      async function initDashboard() {
        if (!SESSION_ID || !CURRENT_USER) {
          window.location.href = "index.html";
          return;
        }

        document.getElementById("user_display").innerText = CURRENT_USER;

        setupTabs();

        // üöÄ NEW: Fetch the real System Settings first!
        await fetchGlobalSettings();

        // Now fetch balances (The Tile Logic will now use the real ENABLE_CARRY_FORWARD value)
        await prefetchBalances();

        // ... rest of your init code ...
      }

      async function prefetchBalances() {
        const types = [
          "Annual Leave",
          "Medical Leave",
          "Emergency Leave",
          "Compassionate Leave",
          "Unpaid Leave",
        ];
        const select = document.getElementById("dash_leave_type");
        if (select) select.disabled = true;

        // üöÄ NEW: Determine if we are fetching for the Proxy User or the Logged-In User
        const targetUser = window.proxyUser ? window.proxyUser : currentUser;

        try {
          for (let type of types) {
            // üöÄ NEW: Appended &employee_name=... to the URL to fetch Steve's balances instead of Natasha's
            const res = await fetchWithAuth(
              `${API_URL}/leaves/balance?year=${new Date().getFullYear()}&leave_type=${encodeURIComponent(type)}&employee_name=${encodeURIComponent(targetUser)}`
            );

            if (!res) {
              console.warn(
                `‚ö†Ô∏è Prefetch for ${type} paused: Session initializing...`
              );
              continue;
            }

            if (res.ok) {
              const data = await res.json();
              leaveEntitlements[type] = data.entitlement;

              // 1. UPDATE DROPDOWN TEXT
              if (select) {
                for (let i = 0; i < select.options.length; i++) {
                  if (select.options[i].value === type) {
                    if (type === "Unpaid Leave") {
                      select.options[i].text = `${type} (${
                        data.taken || 0
                      } days taken)`;
                    } else {
                      select.options[
                        i
                      ].text = `${type} (${data.remaining} days remaining)`;
                    }
                  }
                }
              }

              // -------------------------------------------------------------
              // üöÄ ANNUAL LEAVE SPLIT TILE LOGIC (FIXED TARGETING)
              // -------------------------------------------------------------
              if (type === "Annual Leave") {
                const shortName = "annual";

                // 1. CALCULATION FIX: Capture TRUE remaining balance for the "Apply" form math
                annualRemainingGlobal = data.remaining || 0;

                // üéØ FIX: TARGET THE SPECIFIC TILE WRAPPER
                let tileContainer = document.getElementById(
                  "wrapper_" + shortName
                );
                if (!tileContainer) {
                  const valEl = document.getElementById("card_" + shortName);
                  if (valEl) tileContainer = valEl.parentElement;
                }

                if (tileContainer) {
                  const rem = data.remaining;

                  // 2. TILE FIX: Read the correct key (carry_forward_total) so the Blue Split Tile appears
                  const banked =
                    data.carry_forward_total || data.cf_banked || 0;
                  const entitlement = data.entitlement;

                  // üé® FORCE THE "HERO" BLUE STYLE
                  tileContainer.style.background = "#2563eb";
                  tileContainer.style.color = "white";
                  tileContainer.style.borderRadius = "8px";
                  tileContainer.style.padding = "25px";

                  // LOGIC: Check Global Toggle & Banked Amount
                  const isCFEnabled =
                    typeof ENABLE_CARRY_FORWARD !== "undefined"
                      ? ENABLE_CARRY_FORWARD
                      : false;

                  if (isCFEnabled && banked > 0) {
                    // üÖ∞Ô∏è RENDER SPLIT LAYOUT (Active CF)
                    tileContainer.innerHTML = `
                            <div class="tile-split-container">
                                <div class="tile-header" style="border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">
                                    <span>Annual Leave</span>
                                    <i class="fas fa-umbrella-beach"></i>
                                </div>
                                
                                <div class="tile-split-body">
                                    <div class="split-section">
                                        <div class="split-label">Available</div>
                                        <div class="split-value">${rem}</div>
                                    </div>
                                    
                                    <div class="split-divider"></div>
                                    
                                    <div class="split-section">
                                        <div class="split-label">CF Banked</div>
                                        <div class="split-value banked-highlight">${banked}</div>
                                    </div>
                                </div>
                                
                                <div style="font-size: 0.7rem; text-align: center; margin-top: 5px; opacity: 0.8;">
                                   Entitlement: ${entitlement}
                                </div>
                            </div>
                         `;
                  } else {
                    // üÖ±Ô∏è RENDER STANDARD LAYOUT (Default)
                    // Restore generic IDs so future updates work
                    tileContainer.innerHTML = `
                            <h3 style="margin-top:0; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom:15px; margin-bottom:25px; font-size: 1.25rem; color: white;">
                                Annual Leave <i class="fas fa-umbrella-beach" style="float:right; opacity:0.8;"></i>
                            </h3>
                            <h1 id="card_annual" style="font-size: 3rem; margin: 0; font-weight: 700;">${rem}</h1>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-top: 5px;">Entitlement: ${entitlement}</p>
                         `;
                  }
                }
                // STOP HERE for Annual Leave
                continue;
              }
              // -------------------------------------------------------------
              // END ANNUAL LEAVE LOGIC
              // -------------------------------------------------------------

              // 2. GENERIC UPDATE FOR OTHER TILES
              const shortName = type.toLowerCase().split(" ")[0]; // "medical", "unpaid"
              const cardEl = document.getElementById("card_" + shortName);
              const wrapper = document.getElementById("wrapper_" + shortName);

              if (cardEl) {
                const displayVal =
                  type === "Unpaid Leave" ? data.taken || 0 : data.remaining;
                cardEl.innerText = displayVal;

                if (type === "Unpaid Leave") {
                  // üöÄ FIX: Change color to WHITE so it shows against the dark gray background
                  cardEl.style.color = "#1e3a8a";
                } else {
                  cardEl.style.color =
                    data.remaining <= 0 ? "#ef4444" : "#1e3a8a";
                }
              }

              if (type === "Unpaid Leave" && wrapper) {
                wrapper.style.display = data.taken > 0 ? "block" : "none";
              }
            }
          }
        } catch (e) {
          console.error("Balance Load Error:", e);
        } finally {
          if (select) select.disabled = false;
          
          // üöÄ NEW: Instantly refresh UI summaries if the form is already active
          if (typeof showEntitlementInfo === "function") showEntitlementInfo();
          if (typeof updateLiveSummary === "function") updateLiveSummary();
        }
      }

      function showEntitlementInfo() {
        const type = document.getElementById("dash_leave_type").value;
        document.getElementById("dash_entitlement_info").innerHTML =
          leaveEntitlements[type]
            ? `<i class="fas fa-info-circle"></i> Total Entitlement: <strong>${leaveEntitlements[type]} days</strong>`
            : "";
      }


// 1. Function to open the Floating Calendar
function openCalendarModal() {
        const modal = document.getElementById("calendarModal");
        if (!modal) {
            Swal.fire("UI Error", "The Calendar Modal HTML is missing.", "error");
            return;
        }

        // üöÄ THE BREAKOUT FIX: Move the modal to the very end of the <body> 
        // This guarantees it escapes any hidden parent containers.
        document.body.appendChild(modal);

        // Force maximum visibility
        modal.style.display = "flex";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100vw";
        modal.style.height = "100vh";
        modal.style.backgroundColor = "rgba(15, 23, 42, 0.8)";
        modal.style.zIndex = "999999";

        renderCalendar(); // Trigger the high-performance fetch
      }

// 2. Function to close the Floating Calendar
function closeCalendarModal() {
        const modal = document.getElementById("calendarModal");
        if (modal) {
          modal.style.display = "none";
        }
      }

      function changePage(direction) {
        // 1. Calculate the target page
        const newPage = currentPage + direction;
        
        // 2. Safety check: Don't go below page 1
        if (newPage < 1) return;

    // 3. Prevent going past the last page
    // We pull the total from the UI span we updated in loadHistory
    const totalRecords = parseInt(document.getElementById("totalRecordsSpan").innerText) || 0;
    
    // Use the global pageSize (which is set to 10 by loadHistory)
    const maxPages = Math.ceil(totalRecords / pageSize);
    
    if (newPage > maxPages && direction === 1) return;

    // 4. Execute the load for the new slice of data
    loadHistory(newPage, pageSize);
}


// ==========================================
// üöÄ MY LEAVE HISTORY (Intelligent Merged Sorting)
// ==========================================

async function loadHistory(page = 1, size = 10) {
    historyPageSize = size;
    historyCurrentPage = page;

    const tbody = document.getElementById("historyTableBody");
    const refreshIcon = document.getElementById("refreshIcon");
    if (!tbody) return;

    // Loading State
    if (refreshIcon) refreshIcon.classList.add("fa-spin");
    tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:40px; color:#64748b;">
        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 10px;"></i><br>Refreshing your records...
    </td></tr>`;

    // Capture Filters
    const filterStatus = document.getElementById("filter_status").value;
    const filterType = document.getElementById("filter_type").value; 
    const filterDate = document.getElementById("filter_date").value; 
    const filterDuration = document.getElementById("filter_duration").value;

    const params = new URLSearchParams({
        employee_name: currentUser,
        page: 1, 
        page_size: 1000, // Fetch all for client-side sorting
        leave_type: filterType, 
        duration: filterDuration,
        start_date: filterDate, 
        status: filterStatus,
    });

    try {
        const [leaveRes, otRes] = await Promise.all([
            fetchWithAuth(`${API_URL}/leaves/history?${params.toString()}`),
            fetchWithAuth(`${API_URL}/overtime/my-requests?employee_name=${encodeURIComponent(currentUser)}&ot_date=${filterDate}`)
        ]);

        if (!leaveRes || !otRes) return;

        const leaveData = await leaveRes.json();
        const otData = await otRes.json();

        // üöÄ THE FIX: Extract exact timestamp from the history string to use as the ultimate sort key
        const extractTime = (histStr, fallbackDate) => {
            // Looks for the exact submission minute: e.g. "(2026-02-23 22:44)"
            const match = (histStr || "").match(/\((\d{4}-\d{2}-\d{2} \d{2}:\d{2})\)/);
            return match ? match[1] : fallbackDate;
        };

        // --- NORMALIZE LEAVES ---
        const formattedLeaves = (leaveData.leaves || []).map((l) => {
            if (!l || !l.id) return null;
            let displayAmt = (l.days_taken || "0") + " Days";
            let displayLabel = l.leave_type;
            
            const cfMatch = (l.reason || "").match(/\[CARRY FORWARD:\s*([\d\.]+)\s*DAYS\]/);
            if (cfMatch) {
                displayAmt = `<strong style="color:#0ea5e9;">${cfMatch[1]}</strong> Days (CF)`;
                displayLabel = `<span style="color:#0ea5e9; font-weight:bold;">Carry Forward</span>`;
            }
            return { 
                ...l, 
                record_type: "Leave", 
                display_amount: displayAmt, 
                display_label: displayLabel, 
                display_start: l.start_date || "1970-01-01", 
                display_end: l.end_date || "N/A", 
                sort_date: extractTime(l.status_history, l.start_date || "1970-01-01"), // üöÄ Universal Timestamp
                sort_val: parseFloat(l.days_taken || 0) 
            };
        });

        // --- NORMALIZE OT ---
        const formattedOT = (Array.isArray(otData) ? otData : []).map((o) => {
            if (!o || !o.id) return null;
            return { 
                ...o, 
                record_type: "OT", 
                leave_type: o.ot_type || "Overtime", 
                display_label: o.ot_type || "Overtime",
                display_amount: `${o.total_value || 0} ${o.ot_unit || 'Hours'}`, 
                display_start: o.ot_date || "1970-01-01", 
                display_end: o.ot_date || "N/A", 
                sort_date: extractTime(o.status_history, o.ot_date || "1970-01-01"), // üöÄ Universal Timestamp
                sort_val: parseFloat(o.total_value || 0) 
            };
        });

        // --- MERGE & FILTER ---
        let uniqueRecords = [];
        const seenIds = new Set();
        
        [...formattedLeaves, ...formattedOT].filter(r => r !== null).forEach(item => {
            const identifier = `${item.record_type}-${item.id}`;
            if (!seenIds.has(identifier)) {
                // Strict Date Filter
                if (filterDate && filterDate.trim() !== "") {
                    if (item.display_start !== filterDate) return;
                }
                seenIds.add(identifier);
                uniqueRecords.push(item);
            }
        });

        // Apply Status Filter
        if (filterStatus && filterStatus !== "" && filterStatus !== "All Status") {
            uniqueRecords = uniqueRecords.filter(item => item.status === filterStatus);
        }
        
        // Apply Type Filter
        if (filterType && filterType !== "" && filterType !== "Any") {
            uniqueRecords = uniqueRecords.filter(item => {
                if (filterType === "Overtime") return item.record_type === "OT";
                return item.leave_type === filterType || item.display_label === filterType;
            });
        }

        // SAVE TO GLOBAL CACHE
        rawHistoryData = uniqueRecords;

        // RENDER (This handles the sorting and HTML generation)
        sortAndRenderHistory();

    } catch (e) {
        console.error("History Load Error:", e);
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger" style="padding:40px;">Failed to load history.</td></tr>`;
    } finally {
        if (refreshIcon) setTimeout(() => refreshIcon.classList.remove("fa-spin"), 600);
    }
}

// üöÄ 3. RENDER FUNCTION (Focus: Type Badges & Unified Sorting)
function sortAndRenderHistory() {
    const tbody = document.getElementById("historyTableBody");
    if (!tbody) return;

    // A. SORT (Enhanced for Type Badges)
    rawHistoryData.sort((a, b) => {
        let valA, valB;

        // üü¢ NEW: Logic for sorting by the "Type" column
        if (historySortState.key === 'type') {
            valA = a.record_type; // "OT" or "Leave"
            valB = b.record_type;
        } 
        // Timestamp Sort (Default)
        else if (historySortState.key === 'id' || historySortState.key === 'sort_date') {
            valA = new Date(a.sort_date).getTime() || 0;
            valB = new Date(b.sort_date).getTime() || 0;
        } 
        else if (historySortState.key === 'days_taken') {
            valA = a.sort_val || 0; 
            valB = b.sort_val || 0;
        } 
        else if (historySortState.key === 'start_date') {
            valA = new Date(a.display_start).getTime() || 0; 
            valB = new Date(b.display_start).getTime() || 0;
        } 
        else {
            valA = (a[historySortState.key] || "").toString().toLowerCase();
            valB = (b[historySortState.key] || "").toString().toLowerCase();
        }

        if (valA < valB) return historySortState.direction === 'asc' ? -1 : 1;
        if (valA > valB) return historySortState.direction === 'asc' ? 1 : -1;
        
        return historySortState.direction === 'asc' ? (a.id - b.id) : (b.id - a.id);
    });

    // B. PAGINATE (Logic remains the same)
    const totalRecords = rawHistoryData.length;
    const totalPages = Math.ceil(totalRecords / historyPageSize) || 1;
    if (historyCurrentPage > totalPages) historyCurrentPage = 1;
    const startIndex = (historyCurrentPage - 1) * historyPageSize;
    const visibleRecords = rawHistoryData.slice(startIndex, startIndex + historyPageSize);

// C. DRAW HTML 
tbody.innerHTML = "";
    if (visibleRecords.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:40px; color:#64748b;">No records found.</td></tr>`;
        return; // Add return here to stop processing if empty
    }

    visibleRecords.forEach((item) => {
        // 1. Identify if it's OT or Leave
        const isOT = item.record_type === "OT";
        const rawStatus = item.status || "Pending";
        const statusClass = `status-${rawStatus.toLowerCase().replace(/\s+/g, "-")}`;
        const itemData = JSON.stringify(item).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
        
        // üé® 2. The New Type Badge logic
        const typeBadge = isOT 
            ? `<span style="background: rgba(37, 99, 235, 0.1); color: #2563eb; border: 1px solid rgba(37, 99, 235, 0.2); padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Overtime</span>`
            : `<span style="background: rgba(99, 102, 241, 0.1); color: #6366f1; border: 1px solid rgba(99, 102, 241, 0.2); padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Leave</span>`;

        // 3. Action Buttons logic
        let actionButtons = `<button class="icon-btn" onclick='${isOT ? "viewOTDetails" : "viewLeaveDetails"}(${itemData})' title="View"><i class="fas fa-eye"></i></button>`;
        
        if (rawStatus === "Pending") {
            actionButtons += ` <button class="icon-btn" style="color:#ef4444; border-color:#fee2e2;" onclick="${isOT ? `cancelOT(${item.id})` : `cancelLeave(${item.id}, 'Pending')`}" title="Delete"><i class="fas fa-trash-alt"></i></button>`;
        } else if (rawStatus === "Approved") {
            actionButtons += ` <button class="icon-btn" style="color:#f59e0b; border-color:#fef3c7;" onclick="${isOT ? `requestCancelOT(${item.id})` : `requestCancelLeave(${item.id})`}" title="Request Cancellation"><i class="fas fa-ban"></i></button>`;
        } else if (rawStatus === "Pending Cancel") {
            actionButtons += ` <span style="font-size:0.65rem; color:#f59e0b; font-style:italic; font-weight:700; margin-left:5px;">WAIT APPROVAL</span>`;
        }

        // 4. Build the Row
        tbody.innerHTML += `
            <tr style="border-bottom: 1px solid #f1f5f9; transition: all 0.2s ease;" onmouseover="this.style.background='#f8fafc';" onmouseout="this.style.background='transparent';">
                <td style="padding: 14px 15px; vertical-align: middle;">
                    ${typeBadge}
                </td>
                <td style="padding: 14px 15px; vertical-align: middle;">
                    <div style="display:flex; flex-direction:column; line-height: 1.3;">
                        <strong style="color: #1e293b; font-size: 0.9rem;">${item.display_label || item.leave_type}</strong>
                        <span style="color:#64748b; font-family: monospace; font-size: 0.7rem; font-weight:700;">${getDisplayID(item.id, item.leave_type)}</span>
                    </div>
                </td>
                <td class="text-center" style="padding: 14px 15px; vertical-align: middle;">
                    <span style="background: #f1f5f9; color: #1e293b; font-weight: 800; font-size: 0.8rem; padding: 5px 12px; border-radius: 8px; border: 1px solid #e2e8f0;">${item.display_amount}</span>
                </td>
                <td style="padding: 14px 15px; vertical-align: middle; color: #475569; font-size: 0.85rem;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div style="display: flex; align-items: center; min-width: 95px;">
                            <i class="far fa-calendar-alt" style="margin-right: 6px; opacity: 0.4;"></i>${item.display_start}
                        </div>
                        <div style="color: #cbd5e1; font-weight: 300;">-</div>
                        <div style="display: flex; align-items: center; min-width: 95px;">
                            <i class="far fa-calendar-alt" style="margin-right: 6px; opacity: 0.4;"></i>${item.display_end}
                        </div>
                    </div>
                </td>
                <td class="text-center" style="padding: 14px 15px; vertical-align: middle;">
                    <span class="status-badge ${statusClass}" style="font-size:0.7rem; padding: 5px 12px; font-weight: 800; border-radius: 20px; text-transform: uppercase;">${rawStatus}</span>
                </td>
                <td class="text-center" style="padding: 14px 15px; vertical-align: middle;">
                    <div style="display:flex; gap:8px; justify-content:center; align-items:center;">${actionButtons}</div>
                </td>
            </tr>`;
    });

    // D. UPDATE PAGINATION UI (Logic remains the same)
    const countSpan = document.getElementById("totalRecordsSpan");
    if (countSpan) countSpan.innerText = totalRecords;

    const paginationControls = document.getElementById("paginationControls");
    if (paginationControls) {
        paginationControls.style.display = totalRecords > 0 ? "flex" : "none";
        const prevBtn = document.getElementById("prevPageBtn");
        const nextBtn = document.getElementById("nextPageBtn");
        if (prevBtn) {
            prevBtn.disabled = (historyCurrentPage === 1);
            prevBtn.onclick = function() { changeHistoryPage(historyCurrentPage - 1); };
        }
        if (nextBtn) {
            nextBtn.disabled = (historyCurrentPage >= totalPages);
            nextBtn.onclick = function() { changeHistoryPage(historyCurrentPage + 1); };
        }
        const pageInfo = document.getElementById("pageLabelInfo");
        if (pageInfo) pageInfo.innerText = `Page ${historyCurrentPage} of ${totalPages}`;
    }
}

// üöÄ 4. SORTING HELPER (Handles header clicks and icon updates)
function sortHistoryTable(key) {
    // 1. Toggle direction if the same key is clicked, otherwise default to Ascending
    if (historySortState.key === key) {
        historySortState.direction = historySortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        historySortState.key = key;
        historySortState.direction = 'asc';
    }

    // 2. Reset ALL icons in the history table headers to neutral gray
    document.querySelectorAll('#historyTable thead i').forEach(i => {
        i.className = 'fas fa-sort';
        i.style.color = '#cbd5e1'; 
    });

    // 3. Highlight the ACTIVE column icon in Royal Blue
    const activeIcon = document.getElementById(`hist-sort-${key}`);
    if (activeIcon) {
        // Change icon shape based on direction
        activeIcon.className = historySortState.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
        activeIcon.style.color = '#2563eb';
    }

    // 4. Trigger the Render Function we just verified
    sortAndRenderHistory();
}


// üßπ RESET BUTTON LOGIC
function resetHistoryFilters() {
    // 1. Clear Dropdowns (Reset to first option)
    const typeSelect = document.getElementById("filter_type");
    const statusSelect = document.getElementById("filter_status");
    
    if (typeSelect) typeSelect.selectedIndex = 0;   // Resets to "Any"
    if (statusSelect) statusSelect.selectedIndex = 0; // Resets to "All Status"

    // 2. Clear Text Inputs (Duration and Dates)
    const durationInput = document.getElementById("filter_duration");
    const startInput = document.getElementById("filter_date");
    const endInput = document.getElementById("filter_end_date");

    if (durationInput) durationInput.value = "";
    if (startInput) startInput.value = "";
    if (endInput) endInput.value = "";

    // 3. Optional: Visual Feedback in Console
    console.log("üßπ Filters reset. Reloading full history...");

    // 4. Reload Data (Back to Page 1)
    loadHistory(1);
}

// üöÄ 4. CLIENT-SIDE PAGINATION HELPER
function changeHistoryPage(newPage) {
    const totalRecords = rawHistoryData.length;
    const totalPages = Math.ceil(totalRecords / historyPageSize) || 1;

    // Safety Bounds
    if (newPage < 1 || newPage > totalPages) return;

    // Update State & Re-Draw
    historyCurrentPage = newPage;
    sortAndRenderHistory();
}

      // 2. MATH LOGIC: Real-time calculation for the Carry Forward Blue Box
      function updateCarryForwardMath() {
        // üöÄ FIX: Use the captured 'Remaining Balance' variable instead of 'Entitlement'
        // This ensures the math starts from what is actually available (e.g. 8.5)
        const annualBal = annualRemainingGlobal;

        const inputVal = document.getElementById("cf_days_input").value;
        const reqDays = parseFloat(inputVal) || 0;

        // Display Current Balance
        const currEl = document.getElementById("cf_current");
        if (currEl) currEl.innerText = annualBal + " Days";

        // Calculate Result
        const remaining = annualBal - reqDays;
        const resultEl = document.getElementById("cf_result");

        if (resultEl) {
          // üöÄ UPDATE: Use toFixed(1) to handle half-days neatly (e.g. 3.5)
          resultEl.innerText = remaining.toFixed(1) + " Days";

          // Visual Feedback: Red if negative, Green if valid
          if (remaining < 0) {
            resultEl.style.color = "#ef4444"; // Red (Negative)
          } else {
            resultEl.style.color = "#15803d"; // Green (Valid)
          }
        }
      }

      /**
       * üíæ Step 2: Saves the updated roles to the database
       */
       async function saveUserRoles() {
    const userId = window.editingUserId;
    if (!userId) return;

    // 1. Capture Current Form State
    const currentManager = document.getElementById("edit_role_manager").checked;
    const currentHR = document.getElementById("edit_role_hr").checked;
    const currentSenior = document.getElementById("edit_is_senior").checked;
    const userName = document.getElementById("userEditModalTitle").innerText.replace("Manage Permissions: ", "");

    // 2. Snapshot Comparison (The "Shake" logic)
    const hasChanged = (
        currentManager !== initialPermissionState.manager ||
        currentHR !== initialPermissionState.hr ||
        currentSenior !== initialPermissionState.senior
    );

    if (!hasChanged) {
        const btn = document.getElementById("btnUpdatePermissions");
        const msg = document.getElementById("noChangeMsg");
        if (msg) msg.style.display = "block";
        if (btn) {
            btn.classList.remove("shake-animation"); 
            void btn.offsetWidth; 
            btn.classList.add("shake-animation");
        }
        return; 
    }

    // 3. User Confirmation
    Swal.fire({
        title: 'Update Permissions?',
        text: `Apply these access level changes to ${userName}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#2563eb',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Yes, Update User',
        cancelButtonText: 'Cancel'
    }).then(async (result) => {
        if (result.isConfirmed) {
            
            // üõ°Ô∏è GUARD C: THE "APPROVAL LIMBO" SAFETY NET
            // If Natasha is trying to UNCHECK 'Manager', we must check if Tony has work to do.
            if (initialPermissionState.manager === true && currentManager === false) {
                try {
                    // Check if user has Pending/Pending Cancel leaves as an assigned approver
                    const checkRes = await fetchWithAuth(`${API_URL}/leaves/manager/pending?approver_name=${encodeURIComponent(userName)}&page_size=1`);
                    if (checkRes && checkRes.ok) {
                        const checkData = await checkRes.json();
                        if (checkData.total > 0) {
                            // üõë HARD STOP: Prevent demotion while work is pending
                            await Swal.fire({
                                icon: 'warning',
                                title: 'Action Blocked',
                                html: `<strong>${userName}</strong> has <strong>${checkData.total} request(s)</strong> awaiting their approval.<br><br>Reassign or process these requests before removing the Manager role.`,
                                confirmButtonColor: '#f59e0b'
                            });
                            return; // Exit the function entirely
                        }
                    }
                } catch (e) { console.error("Guard C Check failed:", e); }
            }

            // üöÄ PROCEED: Show Loading Spinner
            Swal.fire({
                title: 'Updating Permissions...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            // üõ°Ô∏è GUARD B: THE FAIL-SAFE IDENTITY PROTECTION
            const selectedRoles = ["employee"];
            
            // Logic: Even if UI glitches, if Senior Power is true, Manager Role is forced.
            if (currentManager || currentSenior) {
                selectedRoles.push("manager");
            }
            
            if (currentHR) {
                selectedRoles.push("hr_admin");
            }

            const formData = new FormData();
            formData.append("roles", JSON.stringify(selectedRoles));
            formData.append("is_senior_manager", currentSenior);

            try {
                const res = await fetchWithAuth(`${API_URL}/users/${userId}/roles-update`, {
                    method: "PUT",
                    body: formData,
                });

                if (res && res.ok) {
                    const data = await res.json();
                    closeUserEditModal();
                    await loadAllUsers(); // Refresh background table

                    Swal.fire({
                        title: 'Updated!',
                        html: data.message,
                        icon: 'success',
                        confirmButtonColor: '#2563eb'
                    });
                } else {
                    const err = await res.json();
                    Swal.fire({
                        icon: 'error',
                        title: 'Update Failed',
                        text: err.detail || "Could not modify user roles.",
                        confirmButtonColor: '#ef4444'
                    });
                }
            } catch (e) {
                console.error("Role Update Error:", e);
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: "Connection lost. Please try again.",
                    confirmButtonColor: '#ef4444'
                });
            }
        }
    });
}

      // Run this immediately when the dashboard scripts load
      function initializeSidebarView() {
    const viewModeContainer = document.getElementById("viewModeContainer");
    const viewModeToggle = document.getElementById("viewModeToggle");

    const isHR = userRoles.includes("hr_admin");
    const isManager = userRoles.includes("manager");

    // üöÄ FIX: Show toggle if they are HR OR Manager
    if (isHR || isManager) {
        if (viewModeContainer) viewModeContainer.style.display = "block";
        
        // If they are ONLY HR (like Natasha), start them in HR mode (Toggle ON)
        if (isHR && !isManager && viewModeToggle) {
            viewModeToggle.checked = true; 
            toggleAdminView(); // Sync the UI immediately
        }
    } else {
        if (viewModeContainer) viewModeContainer.style.display = "none";
    }
}


function toggleAdminView() {
    const toggle = document.getElementById("viewModeToggle");
    const label = document.getElementById("viewModeLabel");
    
    if (!toggle || !label) return;

    const isHRMode = toggle.checked; 
    const hrMenu = document.getElementById("hrAdminMenu");
    const mgrMenu = document.getElementById("managerMenu");

    if (isHRMode) {
        // üîµ HR ADMIN MODE
        label.innerText = "HR Admin View";
        label.style.color = "#4f46e5"; 
        document.querySelectorAll('.menu-item.admin-only').forEach(el => el.style.display = 'block');
        if (hrMenu) hrMenu.style.display = "block";
        if (mgrMenu) mgrMenu.style.display = "none"; // Hide manager tools in HR view
    } else {
        // üü† MANAGER MODE
        label.innerText = "Manager View";
        label.style.color = "#c2410c"; 
        document.querySelectorAll('.menu-item.admin-only').forEach(el => el.style.display = 'none');
        if (hrMenu) hrMenu.style.display = "none";
        
        // üöÄ THE FIX: Show Manager Menu if user is HR Admin OR Manager
        if (mgrMenu) {
            const canSeeManager = userRoles.includes("manager") || userRoles.includes("hr_admin");
            mgrMenu.style.display = canSeeManager ? "block" : "none";
        }
        
        // Safety redirect to home if they were on an HR tab
        const currentSection = sessionStorage.getItem("activeTab");
        if (currentSection && currentSection.startsWith("hr_")) {
            showSection("home");
        }
    }
}



/**
 * üöÄ REQUEST CANCELLATION (Leave)
 * Standardized Button Sizes
 */
 async function requestCancelLeave(leaveId) {
    Swal.fire({
        title: 'Cancel Approved Leave',
        html: `
            <p style="color:#64748b; font-size:0.9rem; margin-bottom:15px;">
                Please provide a reason for cancelling this approved leave. Your manager will need to review this.
            </p>
            <div style="position: relative;">
                <textarea id="swal-cancel-reason" class="saas-form-control" rows="3" maxlength="200"
                    style="width: 100%; padding: 10px; font-family: inherit; resize: none; border: 1px solid #cbd5e1; border-radius: 6px;"
                    placeholder="e.g. Change of plans..."></textarea>
                <div style="text-align: right; font-size: 0.75rem; color: #94a3b8; margin-top: 5px;">
                    <span id="swal-char-count">0</span>/200
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Send for Approval',
        confirmButtonColor: '#ef4444', 
        cancelButtonText: 'Cancel',
        // üöÄ APPLY STANDARDIZED CLASS
        customClass: {
            confirmButton: 'swal-btn-custom',
            cancelButton: 'swal-btn-custom'
        },
        focusConfirm: false, 
        didOpen: () => {
            const input = document.getElementById('swal-cancel-reason');
            const counter = document.getElementById('swal-char-count');
            if(input) input.focus();
            if(input && counter) {
                input.oninput = () => {
                    const len = input.value.length;
                    counter.innerText = len;
                    counter.style.color = len >= 200 ? '#ef4444' : '#94a3b8';
                };
            }
        },
        preConfirm: () => {
            const val = document.getElementById('swal-cancel-reason')?.value.trim();
            if (!val || val.length < 5) {
                Swal.showValidationMessage('Please provide a reason (min 5 chars).');
                return false;
            }
            return val;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            executeCancellationSubmit(leaveId, "LEAVE", result.value);
        }
    });
}


function viewLeaveDetails(leave) {
    const modal = document.getElementById("leaveDetailModal");
    const content = document.getElementById("modalContent");

    // ---------------------------------------------------------
    // üöÄ 1. SMART DATA PREPARATION & CLEANING
    // ---------------------------------------------------------
    let displayType = leave.leave_type;
    let displayDuration = leave.days_taken + " Days";
    
    let originalReason = leave.reason || "No reason provided.";
    let cleanReasonForDisplay = originalReason; 

    // A. Detect Carry Forward Tags
    const cfRegex = /\[CARRY FORWARD:\s*([\d\.]+)\s*DAYS\]/i;
    const match = originalReason.match(cfRegex);
    let modalTitleText = "Leave Details";

    if (match) {
        const realDays = match[1]; 
        displayDuration = `${realDays} Days`; 
        cleanReasonForDisplay = originalReason.replace(match[0], "").trim();
        displayType = "Carry Forward";
        modalTitleText = "Carry Forward Request";
    }

    // B. Isolate Employee Reason (Remove any Manager Note artifacts)
    const parts = cleanReasonForDisplay.split("| Manager Note:");
    let employeeReason = parts[0] ? parts[0].trim() : "No reason provided.";
    if (!employeeReason) employeeReason = "No reason provided.";

    // C. UI Setup
    const isUnpaid = displayType === "Unpaid Leave";
    const leaveTypeDisplay = isUnpaid
      ? `<span style="color: #64748b; font-weight: bold;"><i class="fas fa-hand-holding-usd"></i> ${displayType}</span>`
      : `<strong>${displayType}</strong>`;

    modal.querySelector("h3").innerHTML = `<i class="fas fa-info-circle"></i> ${modalTitleText}`;

    let statusColor = "#f59e0b"; // Pending Orange
    if (leave.status === "Approved") statusColor = "#10b981"; // Green
    if (leave.status === "Rejected") statusColor = "#ef4444"; // Red
    if (leave.status === "Cancelled" || leave.status === "Withdrawn") statusColor = "#64748b"; // Grey

// D. Attachment Link
let attachmentHtml = "";
    if (leave.attachment_path) {
        
        // üöÄ FIX: Logic to handle Cloud URLs
        const rawPath = leave.attachment_path;
        let fileUrl = rawPath;

        // If the backend sent a filename (not a URL), fall back to local (rare case)
        if (!rawPath.startsWith("http")) {
            fileUrl = `${API_URL}/uploads/${rawPath.split("/").pop()}`;
        }
        
        // Just for display purposes, we grab the end of the name
        const displayName = rawPath.split("/").pop();

        attachmentHtml = `
        <div style="margin-top: 10px; padding: 12px; background: #f0f9ff; border: 1px dashed #0ea5e9; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-file-alt" style="color: #0ea5e9; font-size: 1.2rem;"></i>
            <div style="flex: 1;">
                <label style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: bold; display: block;">Attached Document</label>
                <a href="${fileUrl}" target="_blank" style="color: #2563eb; font-weight: 600; text-decoration: none; font-size: 0.85rem;">
                    <i class="fas fa-external-link-alt"></i> View Attachment
                </a>
            </div>
        </div>`;
    }
    // ---------------------------------------------------------
    // üìú 2. UNIVERSAL TIMELINE ENGINE
    // ---------------------------------------------------------
    const historySteps = (leave.status_history || "Pending").split(" > ");
    let timelineHtml = `<div style="position: relative; padding-left: 20px; border-left: 2px solid #e2e8f0; margin-left: 8px; margin-top: 10px;">`;

    historySteps.forEach((step, index) => {
        const isLast = index === historySteps.length - 1;
        const isFirst = index === 0;
        
        // Extract Date
        const dateRegex = /\((\d{4}-\d{2}-\d{2} \d{2}:\d{2})\)/;
        const timeMatch = step.match(dateRegex);
        let timeText = timeMatch ? timeMatch[1] : (isFirst ? leave.start_date : "");

        // üöÄ BULLETPROOF PARSING LOGIC
        let statusLabel = step.replace(dateRegex, "").trim();
        let stepRemark = "";

        if (isFirst) {
            stepRemark = employeeReason; // Inject employee's clean reason into step 1
        } else if (statusLabel.includes("| Note:")) {
            const splitParts = statusLabel.split("| Note:");
            statusLabel = splitParts[0].trim();
            stepRemark = splitParts[1].trim();
        } else {
            const noteMatch = statusLabel.match(/\{Note:\s*(.*?)\}/i);
            if (noteMatch) {
                stepRemark = noteMatch[1];
                statusLabel = statusLabel.replace(noteMatch[0], "").trim();
            } else {
                const reasonMatch = statusLabel.match(/\(Reason:\s*(.*?)\)/i);
                if (reasonMatch) {
                    stepRemark = reasonMatch[1];
                    statusLabel = statusLabel.replace(reasonMatch[0], "").trim();
                }
            }
        }

        // Clean up any empty parentheses left behind
        statusLabel = statusLabel.replace(/\(\s*\)/g, "").trim();

        // Dot Color Logic
        let dotColor = "#cbd5e1"; // Gray
        if (statusLabel.includes("Approved")) dotColor = "#10b981"; // Green
        else if (statusLabel.includes("Rejected")) dotColor = "#ef4444"; // Red
        else if (statusLabel.includes("Cancelled") || statusLabel.includes("Withdrawn")) dotColor = "#64748b"; // Dark Grey
        else if (isLast && leave.status.includes("Pending")) dotColor = "#f59e0b"; // Orange

        timelineHtml += `
        <div style="margin-bottom: 20px; position: relative;">
            <div style="position: absolute; left: -27px; top: 5px; width: 12px; height: 12px; background: white; border: 3px solid ${dotColor}; border-radius: 50%;"></div>
            <div style="font-weight: 600; font-size: 0.9rem; color: #1e293b;">${statusLabel}</div>
            <div style="font-size: 0.75rem; color: #94a3b8;">${timeText}</div>
            ${stepRemark ? `<div style="margin-top:4px; font-size:0.85rem; color:#475569; background:#f1f5f9; padding:6px 10px; border-radius:6px; border-left:3px solid ${dotColor};"><i class="fas fa-comment-dots" style="opacity:0.5; margin-right:4px;"></i> ${stepRemark}</div>` : ""}
        </div>`;
    });
    timelineHtml += `</div>`;

// ---------------------------------------------------------
// üñ•Ô∏è 3. RENDER FINAL HTML
// ---------------------------------------------------------

// üöÄ NEW: Simple Tag Proxy Check 
// Instead of checking leave.applied_by, we scan the text for our hidden marker
let proxyBannerHtml = "";
if (originalReason.includes("[HR_ADMIN_ACTION:")) {
    // 1. Extract the Admin's name from the brackets
    const adminMatch = originalReason.match(/\[HR_ADMIN_ACTION:\s*(.*?)\s*\]/);
    const adminName = adminMatch ? adminMatch[1] : "HR Administrator";

    // 2. We already cleaned 'employeeReason' earlier in your code, 
    // but let's make sure the tag itself doesn't show in the "Reason" field below.
    employeeReason = employeeReason.replace(/\[HR_ADMIN_ACTION:.*?\]/g, "").replace("Reason:", "").trim();

    proxyBannerHtml = `
    <div style="background: #fffbeb; border: 1px solid #fde68a; padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; border-left: 4px solid #f59e0b;">
        <div style="background: #f59e0b; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <i class="fas fa-user-shield" style="font-size: 0.85rem;"></i>
        </div>
        <div>
            <div style="font-size: 0.7rem; color: #b45309; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">Admin Override</div>
            <div style="font-size: 0.9rem; color: #92400e; margin-top: 2px;">Submitted on behalf of employee by <strong>${adminName}</strong></div>
        </div>
    </div>`;
}

// Insert into the modal content
content.innerHTML = `
${proxyBannerHtml}
<div style="margin-bottom: 20px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 12px;">
    <div style="background: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <i class="fas fa-user" style="color: var(--primary); font-size: 0.9rem;"></i>
    </div>
    <div>
        <label style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: bold; display: block;">Employee Name</label>
        <strong style="font-size: 1.05rem; color: #1e293b;">${leave.employee_name || "Staff Member"}</strong>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
    <div>
        <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Leave Type</label><br>
        ${leaveTypeDisplay}
    </div>
    <div>
        <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Duration</label><br>
        <strong style="font-size: 1rem;">${displayDuration}</strong>
    </div>
    <div style="grid-column: span 2;">
        <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Reason</label><br>
        <span style="font-size: 0.95rem; color: #334155; background: #fff; padding: 4px 0; display: block;">${employeeReason}</span>
    </div>
    <div>
        <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Status</label><br>
        <strong style="font-size: 1rem; color: ${statusColor};">${leave.status}</strong>
    </div>
    <div>
        <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Dates</label><br>
        <span>${leave.start_date} to ${leave.end_date}</span>
    </div>
</div>

<div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
    <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Assigned Approver</label><br>
    <span style="color: #2563eb; font-weight: 600;"><i class="fas fa-user-tie"></i> ${leave.approver_name || "Not Assigned"}</span>
</div>

${attachmentHtml ? `<div style="margin-bottom: 20px;">${attachmentHtml}</div>` : ""}

<div style="margin-top: 10px; border-top: 2px solid #f1f5f9; padding-top: 15px;">
    <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; display: block;">Activity Log</label>
    ${timelineHtml}
</div>`;

modal.style.display = "flex";
}

      function closeLeaveModal() {
        document.getElementById("leaveDetailModal").style.display = "none";
      }

      function toggleHalfDay() {
        const isHalf = document.getElementById("dash_half_day").checked;
        const startInput = document.getElementById("dash_start");
        const endInput = document.getElementById("dash_end");

        if (isHalf) {
          endInput.disabled = true;
          endInput.style.background = "#e2e8f0";
          if (startInput.value) endInput.value = startInput.value;
        } else {
          endInput.disabled = false;
          endInput.style.background = "white";
        }
        updateLiveSummary();
      }

      async function validateHolidaySelection(dateStr) {
        try {
          const res = await fetchWithAuth(`${API_URL}/leaves/public-holidays`);
          if (!res || !res.ok) return true;

          const holidays = await res.json();
          const holidayDates = holidays.map((h) => h.holiday_date);

          if (holidayDates.includes(dateStr)) {
            const hName = holidays.find((h) => h.holiday_date === dateStr).name;
            alert(
              `‚ö†Ô∏è Selection Error: ${dateStr} is a Public Holiday (${hName}).\nPlease choose a working day.`
            );
            return false;
          }
          return true;
        } catch (e) {
          console.error("Holiday validation error:", e);
          return true;
        }
      }

      async function handleDateChange() {
        const startInput = document.getElementById("dash_start");
        const endInput = document.getElementById("dash_end");
        const isHalf = document.getElementById("dash_half_day").checked;

        // 1. Validate Start Date
        if (startInput.value) {
          const isStartValid = await validateHolidaySelection(startInput.value);
          if (!isStartValid) {
            startInput.value = "";
            updateLiveSummary();
            return;
          }
        }

        // 2. Sync Logic (Standard)
        endInput.min = startInput.value;
        if (isHalf) {
          endInput.value = startInput.value;
        }

        // 3. Validate End Date (Crucial for multi-day selections)
        if (endInput.value) {
          const isEndValid = await validateHolidaySelection(endInput.value);
          if (!isEndValid) {
            endInput.value = "";
            updateLiveSummary();
            return;
          }
        }

        updateLiveSummary();
      }

      async function updateLiveSummary() {
    const type = document.getElementById("dash_leave_type").value;
    const start = document.getElementById("dash_start").value;
    const end = document.getElementById("dash_end").value;
    const isHalfDay = document.getElementById("dash_half_day").checked;
    const summaryBox = document.getElementById("apply_summary_box");
    const totalDaysSpan = document.getElementById("summary_total_days");
    const balanceEstimate = document.getElementById("summary_new_balance");
    const holidayNotice = document.getElementById("holiday_notice");

    if (!type || !start) {
        if (summaryBox) summaryBox.style.display = "none";
        return;
    }

    const d1 = new Date(start);
    if (isNaN(d1.getTime()) || (!isHalfDay && !end)) return;
    const d2 = new Date(isHalfDay ? start : end);
    if (isNaN(d2.getTime())) return;

    // ... (Keep your holiday and weekend validation logic here exactly as it is) ...
    // If errorMsg exists, return early with the Red Styling we discussed.

    // Calculate days requested
    let daysRequested = 0;
    if (isHalfDay) {
        daysRequested = 0.5;
    } else {
        if (d2 < d1) return;
        let count = 0;
        let cur = new Date(d1);
        while (cur <= d2) {
            const dateStr = cur.toISOString().split("T")[0];
            const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;
            // Note: Assume holidayDates is defined in your existing validation logic
            if (!isWeekend) count++; 
            cur.setDate(cur.getDate() + 1);
        }
        daysRequested = count;
    }

    if (daysRequested > 0) {
        summaryBox.style.display = "block";
        totalDaysSpan.innerText = `${daysRequested} Day(s)`;

        if (type === "Unpaid Leave") {
            balanceEstimate.innerHTML = `<div style="margin-top: 10px; color: #64748b; font-style: italic;">No deduction from paid balance</div>`;
            return;
        }

        try {
            const searchYear = d1.getFullYear();
            const targetUser = window.proxyUser ? window.proxyUser : currentUser;

            const res = await fetchWithAuth(
                `${API_URL}/leaves/balance?employee_name=${encodeURIComponent(targetUser)}&year=${searchYear}&leave_type=${encodeURIComponent(type)}`
            );

            if (res && res.ok) {
                const data = await res.json();
                
                // üìä 1. Math Correction
                // data.remaining is (Entitlement - Approved - Pending)
                const currentAvailable = data.remaining !== undefined ? data.remaining : 0;
                
                // üöÄ FIX: Use the specific pending_total we just added to the backend
                const awaitingApproval = data.pending_total || 0; 
                
                const estimatedRemaining = currentAvailable - daysRequested;

                // üé® 2. UI Layout Correction
                // Changed display to flex-direction: column to stop the squashing/overlap
// üé® ALIGNED VERSION: Removes white box and matches vertical alignment
balanceEstimate.innerHTML = `
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #bae6fd; display: flex; flex-direction: column; gap: 8px;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <span style="color: #64748b; font-size: 0.7rem; font-weight: 800; text-transform: uppercase;">Awaiting Approval:</span>
            <strong style="color: #f59e0b; font-size: 0.95rem; margin-left: 10px;">
                ${awaitingApproval.toString().replace(/\.0$/, '')} Day(s)
            </strong>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <span style="color: #64748b; font-size: 0.7rem; font-weight: 800; text-transform: uppercase;">Projected Balance:</span>
            <strong style="color: ${estimatedRemaining < 0 ? "#ef4444" : "#059669"}; font-size: 0.95rem; margin-left: 10px;">
                ${estimatedRemaining.toFixed(1).replace(/\.0$/, '')} Day(s)
            </strong>
        </div>

    </div>`;
            }
        } catch (e) {
            console.error("Balance calculation error:", e);
        }
    }
}

      function resetApplyForm() {
    // 1. Standard Form Reset (Clears all inputs, selects, and checkboxes)
    document.getElementById("applyLeaveForm").reset();

    // 2. Reset Textarea Height
    const textarea = document.getElementById("dash_reason");
    if (textarea) textarea.style.height = "";

    // 3. Reset Character Count
    const charCount = document.getElementById("char_count");
    if (charCount) {
        charCount.innerText = "0 / 200";
        charCount.style.color = "#94a3b8";
    }

    // 4. Hide Summary Box
    const summaryBox = document.getElementById("apply_summary_box");
    if (summaryBox) summaryBox.style.display = "none";

    // 5. Reset End Date Styling (Unlock it if it was locked by Half Day)
    const endInput = document.getElementById("dash_end");
    if (endInput) {
        endInput.disabled = false;
        endInput.style.background = "white";
    }

    // 6. Clear Entitlement Info Text
    const info = document.getElementById("dash_entitlement_info");
    if (info) info.innerHTML = "";

    // 7. Clean up the file UI (Including hiding the red X button)
    if (typeof removeAttachment === "function") {
        removeAttachment('leave_attachment', 'leave_file_label', 'leave_remove_btn');
    }

    // üöÄ CLEANUP FIX: Clear BOTH draft buckets
    // This ensures no old data reappears, regardless of which mode was active
    localStorage.removeItem("leave_draft_std");
    localStorage.removeItem("leave_draft_cf");
}

      // ==========================================
      // üöÄ HR PROXY LOGIC (Admin Override)
      // ==========================================
      window.proxyUser = null;

      async function handleProxySearch(query) {
        const box = document.getElementById("proxy_suggestions_box");
        if (query.trim().length < 2) {
            box.style.display = "none";
            return;
        }

        try {
            // Fetch all users
            const res = await fetchWithAuth(`${API_URL}/users/all`);
            if (!res) return;
            const users = await res.json();

            // Filter for active employees matching the name/username
            const filtered = users.filter(u => 
                u.is_active && 
                (u.full_name.toLowerCase().includes(query.toLowerCase()) || 
                 u.username.toLowerCase().includes(query.toLowerCase()))
            ).slice(0, 6); // Limit to top 6 results

            if (filtered.length > 0) {
                box.innerHTML = filtered.map(u => {
                    const initials = (u.full_name || "??").split(" ").map(n => n[0]).slice(0, 2).join("").toUpperCase();
                    return `
                    <div style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;"
                         onclick="selectProxyUser('${u.full_name.replace(/'/g, "\\'")}')"
                         onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='transparent'">
                        <div style="background:#e0f2fe; color:#0369a1; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.75rem;">
                            ${initials}
                        </div>
                        <div>
                            <div style="font-weight: 700; color: #1e293b; font-size: 0.9rem;">${u.full_name}</div>
                            <div style="font-size: 0.7rem; color: #64748b;">${u.job_title || 'Employee'}</div>
                        </div>
                    </div>`;
                }).join("");
                box.style.display = "block";
            } else {
                box.innerHTML = `<div style="padding: 15px; color: #94a3b8; font-size: 0.85rem;"><i class="fas fa-search"></i> No matching active users found.</div>`;
                box.style.display = "block";
            }
        } catch (e) {
            console.error("Proxy search error:", e);
        }
      }

      async function selectProxyUser(fullName) {
    // 1. Set the global memory
    window.proxyUser = fullName;

    // 2. Update the UI to "Locked In" state
    document.getElementById("proxy_suggestions_box").style.display = "none";
    document.getElementById("proxy_user_search").parentElement.style.display = "none";
    document.getElementById("proxy_active_status").style.display = "flex";
    document.getElementById("proxy_target_name").innerText = fullName;
    document.getElementById("btn_reset_proxy").style.display = "inline-flex";

    // üöÄ THE FIX: Use the special [HR_ADMIN_ACTION] tag
    const reasonBox = document.getElementById("dash_reason");
    if (reasonBox) {
        // This tag is the "secret key" our UI will look for to show the yellow banner
        reasonBox.value = `[HR_ADMIN_ACTION: ${currentUser}] \nApplied on behalf of ${fullName} by HR.\nReason: `;
        if (typeof updateCharCountGeneric === "function") updateCharCountGeneric('dash_reason', 'char_count');
    }

    // 4. Trigger Balances update
    if (typeof prefetchBalances === "function") await prefetchBalances();

    showModal("Override Active", `You are now applying on behalf of <strong>${fullName}</strong>.<br><br>The form will now act as this user.`, "info");
}

async function resetProxyUser(silent = false) {
    // 1. Clear memory
    window.proxyUser = null;

    // 2. Reset UI back to Search mode
    document.getElementById("proxy_active_status").style.display = "none";
    document.getElementById("btn_reset_proxy").style.display = "none";
    
    const searchInput = document.getElementById("proxy_user_search");
    if (searchInput && searchInput.parentElement) {
        searchInput.parentElement.style.display = "block";
        searchInput.value = "";
    }

    // 3. Clear the automated reason text including the new tag
    const reasonBox = document.getElementById("dash_reason");
    // üöÄ Updated check to include our new tag
    if (reasonBox && (reasonBox.value.includes("Applied on behalf of") || reasonBox.value.includes("[HR_ADMIN_ACTION:"))) {
        reasonBox.value = "";
        if (typeof updateCharCountGeneric === "function") updateCharCountGeneric('dash_reason', 'char_count');
    }

    // 4. Re-fetch Natasha's original balances
    if (typeof prefetchBalances === "function") await prefetchBalances();

    if (!silent) {
        showModal("Override Removed", "You are now applying for yourself.", "success");
    }
}


async function submitLeaveInDashboard(event) {
    // 1. üõë HARD STOP: Prevent default browser submission
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    console.log("üöÄ Starting Leave Submission...");

    // 2. SAFETY CHECK: Ensure Alert Library is loaded
    if (typeof Swal === 'undefined') {
        alert("System Error: SweetAlert2 not loaded. Please refresh.");
        return false;
    }

    const submitBtn = document.getElementById("dash_submit_btn");

    // --- A. INITIALIZE VARIABLES ---
    let type = "", startVal = "", endVal = "", finalReason = "", approverValue = "";
    let isHalfDay = false;
    
    // üöÄ GLOBAL FILE INPUT: Works for both modes
    const fileInput = document.getElementById("leave_attachment");

    // Detect Mode
    const carryForwardUI = document.getElementById("carry_forward_ui");
    const isCarryForward = carryForwardUI && carryForwardUI.style.display === "block";

    // --- B. VALIDATION LOGIC ---
    if (isCarryForward) {
        type = "Annual Leave"; 
        const cfDaysInput = document.getElementById("cf_days_input");
        const daysReq = cfDaysInput ? parseFloat(cfDaysInput.value) : 0;
        
        const cfAppEl = document.getElementById("dash_approver_cf");
        approverValue = cfAppEl ? cfAppEl.value : "";
        
        const cfReasonEl = document.getElementById("cf_reason");
        const cfReasonText = cfReasonEl ? cfReasonEl.value.trim() : "";

        if (!daysReq || daysReq <= 0) {
            Swal.fire("Input Required", "Please enter a valid number of days.", "warning");
            return false;
        }
        if (!approverValue) {
            Swal.fire("Input Required", "Select an approver.", "warning");
            return false;
        }
        if (!cfReasonText) {
            Swal.fire("Input Required", "Provide a reason for carry forward.", "warning");
            return false;
        }

        const currentYear = new Date().getFullYear();
        startVal = `${currentYear}-12-31`;
        endVal = `${currentYear}-12-31`;
        finalReason = `[CARRY FORWARD: ${daysReq} DAYS] ${cfReasonText}`;

    } else {
        const leaveTypeEl = document.getElementById("dash_leave_type");
        const startDateEl = document.getElementById("dash_start");
        const endDateEl = document.getElementById("dash_end");
        const reasonEl = document.getElementById("dash_reason");
        const stdAppEl = document.getElementById("dash_approver");
        const halfDayCheckbox = document.getElementById("dash_half_day");

        type = leaveTypeEl ? leaveTypeEl.value : "";
        startVal = startDateEl ? startDateEl.value : "";
        const rawEnd = endDateEl ? endDateEl.value : "";
        finalReason = reasonEl ? reasonEl.value.trim() : "";
        approverValue = stdAppEl ? stdAppEl.value : "";
        isHalfDay = halfDayCheckbox ? halfDayCheckbox.checked : false;
        endVal = isHalfDay ? startVal : rawEnd;

        if (!type || !startVal || !endVal || !approverValue || !finalReason) {
            Swal.fire("Missing Info", "Please fill in all fields (Type, Date, Approver, Reason).", "warning");
            return false;
        }
    }

    // --- C. PREPARE DATA ---
    const formData = new FormData();
    
    // üöÄ Proxy Check (If Natasha is applying for Steve)
    const applicantName = window.proxyUser ? window.proxyUser : currentUser;
    formData.append("employee_name", applicantName);
    
    if (window.proxyUser) {
        // Tag the record so the manager and Audit Log know HR forced it
        formData.append("applied_by", currentUser); 
    }

    formData.append("approver_name", approverValue);
    formData.append("leave_type", type);
    formData.append("start_date", startVal);
    formData.append("end_date", endVal);
    formData.append("is_half_day", isHalfDay);
    formData.append("reason", finalReason);

    // üìé ATTACH FILE (If present)
    if (fileInput && fileInput.files.length > 0) {
        console.log("üìé Attaching file:", fileInput.files[0].name);
        formData.append("file", fileInput.files[0]);
    }

    // --- D. UI LOCK ---
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    }

    try {
        // --- E. SEND REQUEST ---
        const response = await fetch(`${API_URL}/leaves/`, {
            method: "POST",
            body: formData
        });

        // üõ°Ô∏è SAFE PARSING: Check if response is actually JSON
        const contentType = response.headers.get("content-type");
        let result;
        
        if (contentType && contentType.indexOf("application/json") !== -1) {
            result = await response.json();
        } else {
            // Server returned HTML (likely 413 File Too Large or 500 Error)
            const text = await response.text();
            console.error("Non-JSON Response:", text);
            throw new Error(`Server Error (${response.status}): The file might be too large.`);
        }

        if (response.ok) {
            // ‚úÖ SUCCESS: POP-UP STAYS
            await Swal.fire({
                title: 'Success!',
                text: isCarryForward ? 'Carry Forward request sent.' : 'Leave request submitted.',
                icon: 'success',
                confirmButtonText: 'OK',
                confirmButtonColor: '#2563eb',
                allowOutsideClick: false,
                allowEscapeKey: false
              }).then((res) => {
                if (res.isConfirmed) {
                    // 1. Reset Form Wrapper
                    const form = document.getElementById("applyLeaveForm");
                    if (form) form.reset();
                    
                    // üöÄ 2. OPTIMIZED CLEAR: Wipe all manual text and numeric inputs
                    ["cf_days_input", "cf_reason", "dash_reason"].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = "";
                    });

                    // 3. Wipe Drafts
                    localStorage.removeItem("leave_draft_std");
                    localStorage.removeItem("leave_draft_cf");
                    
                    // 4. Cleanup File UI
                    if(typeof removeAttachment === 'function') {
                        removeAttachment('leave_attachment', 'leave_file_label', 'leave_remove_btn');
                    }

                    // üöÄ THE ENHANCEMENT: Force Newest First Sort
                    if (typeof historySortState !== 'undefined') {
                        historySortState.key = 'id';
                        historySortState.direction = 'desc';
                    }

                    // üöÄ 5. NAVIGATE (WITH PROXY REDIRECT FIX)
                    if (window.proxyUser) {
                        if (typeof showSection === 'function') showSection('manager_history');
                        if (typeof loadTeamHistory === 'function') loadTeamHistory();
                        if (typeof resetProxyUser === 'function') resetProxyUser(true); 
                    } else {
                        if (typeof showSection === 'function') {
                            showSection('history');
                            if (typeof loadHistory === 'function') loadHistory();
                        } else {
                            window.location.reload(); 
                        }
                    }

                    if (typeof prefetchBalances === "function") prefetchBalances();
                }
            });

        } else {
            // ‚ùå API ERROR (Validation, Logic, etc.)
            let msg = result.detail || "Unknown error.";
            if (Array.isArray(msg)) msg = msg.map(e => e.msg).join("<br>");
            Swal.fire("Submission Failed", msg, "error");
        }

    } catch (error) {
        console.error("Submission Crash:", error);
        Swal.fire("Error", error.message || "Connection failed.", "error");
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Submit Application';
        }
    }
    
    return false; // Final safeguard
}



function restoreLeaveDraft() {
    // 1. Identify which UI is currently active
    const carryForwardUI = document.getElementById("carry_forward_ui");
    const isCF = carryForwardUI && carryForwardUI.style.display === "block";

    if (isCF) {
        // üü¢ CARRY FORWARD RESTORE
        const draftStr = localStorage.getItem("leave_draft_cf");
        if (!draftStr) return;
        
        try {
            const draft = JSON.parse(draftStr);
            
            // Map to unique Carry Forward IDs
            if (document.getElementById("cf_days_input")) 
                document.getElementById("cf_days_input").value = draft.days || "";
            
            if (document.getElementById("cf_reason")) 
                document.getElementById("cf_reason").value = draft.reason || "";
            
            if (document.getElementById("dash_approver_cf")) 
                document.getElementById("dash_approver_cf").value = draft.approver || "";
                
            console.log("‚úÖ Carry Forward draft restored.");
        } catch (e) {
            console.error("Error parsing CF draft:", e);
        }

    } else {
        // üîµ STANDARD LEAVE RESTORE
        const draftStr = localStorage.getItem("leave_draft_std");
        if (!draftStr) return;
        
        try {
            const draft = JSON.parse(draftStr);

            // Map to standard Leave IDs
            if (document.getElementById("dash_leave_type")) 
                document.getElementById("dash_leave_type").value = draft.type || "";
            
            if (document.getElementById("dash_start")) 
                document.getElementById("dash_start").value = draft.start || "";
            
            if (document.getElementById("dash_end")) 
                document.getElementById("dash_end").value = draft.end || "";
            
            if (document.getElementById("dash_reason")) 
                document.getElementById("dash_reason").value = draft.reason || "";
            
            if (document.getElementById("dash_approver")) 
                document.getElementById("dash_approver").value = draft.approver || "";
            
            if (document.getElementById("dash_half_day")) 
                document.getElementById("dash_half_day").checked = draft.half_day || false;

            console.log("‚úÖ Standard Leave draft restored.");
        } catch (e) {
            console.error("Error parsing Standard draft:", e);
        }
    }
}

    


async function submitOTInDashboard(event) {
    // üõë STOP the browser from reloading the page
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // 1. Gather Data
    const otType = document.getElementById("ot_type_selector")?.value;
    const otDate = document.getElementById("ot_date")?.value;
    const otUnit = document.getElementById("ot_unit")?.value;
    const otReason = document.getElementById("ot_reason")?.value;
    const approverName = document.getElementById("dash_approver_ot")?.value;

    // 2. Validation Guard (Switched to Swal)
    if (!otType || !otDate || !otReason || !approverName) {
        Swal.fire({
            title: "Input Required",
            text: "Please fill in all required fields (Type, Date, Reason, and Approver).",
            icon: "warning",
            confirmButtonColor: "#2563eb"
        });
        return;
    }

    // 3. Time/Duration Logic
    let duration = 0;
    let startVal = "", endVal = "";

    if (otUnit === "hours") {
        const startEl = document.getElementById("ot_start");
        const endEl = document.getElementById("ot_end");
        startVal = startEl?.value;
        endVal = endEl?.value;

        if (!startVal || !endVal) {
            Swal.fire({
                title: "Time Required",
                text: "Please select start and end times for hourly OT.",
                icon: "warning",
                confirmButtonColor: "#2563eb"
            });
            return;
        }

        const [sH, sM] = startVal.split(":").map(Number);
        const [eH, eM] = endVal.split(":").map(Number);
        let diff = (eH * 60 + eM - (sH * 60 + sM)) / 60;
        if (diff <= 0) diff += 24; // Handle overnight logic
        duration = diff.toFixed(1);
    } else {
        duration = 1; // Day based
    }

    // 4. Prepare Payload
    const formData = new FormData();
    formData.append("employee_name", currentUser);
    formData.append("approver_name", approverName);
    formData.append("ot_type", otType);
    formData.append("ot_date", otDate);
    formData.append("ot_unit", otUnit);
    formData.append("reason", otReason);
    formData.append("total_value", duration);

    if (otUnit === "hours") {
        formData.append("start_time", startVal);
        formData.append("end_time", endVal);
    }

    const fileInput = document.getElementById("ot_attachment");
    if (fileInput && fileInput.files[0]) {
        formData.append("file", fileInput.files[0]);
    }

    // 5. Send to Server (with Visual Feedback)
    const submitBtn = document.getElementById("dash_ot_submit_btn") || document.querySelector("#applyOTForm .btn-submit");
    const originalBtnText = submitBtn ? submitBtn.innerText : "Submit OT Claim";
    
    if (submitBtn) {
         submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...'; 
         submitBtn.disabled = true;
    }

    try {
        const res = await fetchWithAuth(`${API_URL}/overtime/apply`, {
            method: "POST",
            body: formData,
        });

        // üõ°Ô∏è Safe JSON Parsing
        let result = {};
        try { result = await res.json(); } catch(e) { console.error("Parse Error", e); }

        if (res && res.ok) {
            // ‚úÖ SUCCESS: Optimized UX Flow
            localStorage.removeItem("ot_draft");

            await Swal.fire({
                title: 'Success!',
                text: 'Your overtime request has been sent for approval.',
                icon: 'success',
                confirmButtonText: 'OK',
                confirmButtonColor: '#2563eb',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then((swalRes) => {
                if (swalRes.isConfirmed) {
                    // 1. Cleanup Form
                    if (typeof resetOTForm === "function") resetOTForm();
                    
                    // 2. Sync Data in background
                    if (typeof refreshManagerBadges === "function") refreshManagerBadges();
                    
                    // 3. Redirect to History
                    if (typeof showSection === "function") {
                        showSection("history");
                        if (typeof loadHistory === "function") loadHistory();
                    } else {
                        window.location.reload();
                    }
                }
            });
        } else {
            // ‚ùå ERROR (Logic/Validation)
            Swal.fire({
                title: "Submission Failed",
                text: result.detail || "Could not save request.",
                icon: "error",
                confirmButtonColor: "#2563eb"
            });
        }
    } catch (e) {
        console.error("OT Submit Error:", e);
        Swal.fire({
            title: "Network Error",
            text: "Could not connect to the server. Please try again.",
            icon: "error",
            confirmButtonColor: "#2563eb"
        });
    } finally {
         if (submitBtn) { 
             submitBtn.disabled = false; 
             submitBtn.innerText = originalBtnText; 
         }
    }
}


// üíæ 1. Save OT Draft to Memory
function saveOTDraft() {
    // Only save if the OT tab is active
    const otTab = document.getElementById("tab_ot");
    if (!otTab || !otTab.classList.contains("active")) return;

    const draft = {
        type: document.getElementById("ot_type_selector")?.value,
        date: document.getElementById("ot_date")?.value,
        unit: document.getElementById("ot_unit")?.value,
        start: document.getElementById("ot_start")?.value,
        end: document.getElementById("ot_end")?.value,
        reason: document.getElementById("ot_reason")?.value,
        approver: document.getElementById("dash_approver_ot")?.value
    };

    localStorage.setItem("ot_draft", JSON.stringify(draft));
}

// ‚ôªÔ∏è 2. Restore OT Draft from Memory
function restoreOTDraft() {
    const draftStr = localStorage.getItem("ot_draft");
    if (!draftStr) return;

    const draft = JSON.parse(draftStr);

    // Helper to safely set values
    const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el && val) el.value = val;
    };

    setVal("ot_type_selector", draft.type);
    setVal("ot_date", draft.date);
    setVal("ot_unit", draft.unit);
    setVal("ot_start", draft.start);
    setVal("ot_end", draft.end);
    setVal("ot_reason", draft.reason);
    setVal("dash_approver_ot", draft.approver);

    // üöÄ Trigger UI updates so the form looks correct (hidden fields, character count)
    if (typeof updateOTFields === "function") updateOTFields();
    if (typeof calculateOTDuration === "function") calculateOTDuration();
    
    // Update char count manually if the function exists
    const charCount = document.getElementById("char_count_ot");
    const reason = document.getElementById("ot_reason");
    if (charCount && reason) {
        charCount.innerText = `${reason.value.length} / 200`;
    }
}

// üéß 3. Start the "Watcher" for OT
function initOTDraftListeners() {
    const fields = [
        "ot_type_selector", "ot_date", "ot_unit",
        "ot_start", "ot_end", "ot_reason", "dash_approver_ot"
    ];

    fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.removeEventListener("input", saveOTDraft); // Prevent duplicates
            el.removeEventListener("change", saveOTDraft);
            el.addEventListener("input", saveOTDraft);
            el.addEventListener("change", saveOTDraft);
        }
    });
    console.log("üìù OT Draft Listeners Activated.");
}

function resetOTForm() {
    // 1. Standard Reset
    document.getElementById("applyOTForm").reset();
    
    // 2. Hide Summary
    const summaryBox = document.getElementById("ot_summary_box");
    if (summaryBox) summaryBox.style.display = "none";

    // 3. Reset Defaults
    const unitEl = document.getElementById("ot_unit");
    if (unitEl) unitEl.value = "hours";
    if (typeof updateOTFields === "function") updateOTFields();

    // 4. Reset Character Count
    const charCount = document.getElementById("char_count_ot");
    if (charCount) {
        charCount.innerText = "0 / 200";
        charCount.style.color = "#94a3b8";
    }

    // 5. Clean up file UI
    if (typeof removeAttachment === "function") {
        removeAttachment('ot_attachment', 'ot_file_label', 'ot_remove_btn');
    }

    // üöÄ CRITICAL FIX: Delete the saved draft so it doesn't come back
    localStorage.removeItem("ot_draft");
}



async function cancelOT(id) {
        // üöÄ THE FIX: Use Swal.fire instead of openGenericConfirm to prevent UI freezing
        Swal.fire({
          title: 'Withdraw Claim?',
          text: "Are you sure you want to withdraw this pending overtime claim?",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#ef4444', // Red for destructive action
          cancelButtonColor: '#64748b',
          confirmButtonText: 'Yes, Withdraw'
        }).then(async (result) => {
          // This block runs ONLY if the user clicks "Yes"
          if (result.isConfirmed) {
            try {
              // Optional: Show a small loading spinner so user knows it's working
              Swal.fire({
                title: 'Processing...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
              });

              const res = await fetchWithAuth(`${API_URL}/overtime/${id}/cancel`, {
                method: "PUT",
              });

              if (!res) return;

              if (res.ok) {
                Swal.fire({
                  title: 'Claim Withdrawn',
                  text: "Overtime claim has been marked as 'Withdrawn'.",
                  icon: 'success',
                  confirmButtonColor: '#2563eb'
                }).then(() => {
                  // üîÑ Refresh the table data using your existing history logic
                  if (typeof loadHistory === "function") {
                    loadHistory(currentPage, pageSize);
                  }
                  if (typeof refreshManagerBadges === "function") {
                    refreshManagerBadges();
                  }
                });
              } else {
                const err = await res.json();
                Swal.fire("Error", err.detail || "Could not withdraw claim.", "error");
              }
            } catch (e) {
              console.error("OT Cancel Error:", e);
              Swal.fire("Network Error", "Check your connection.", "error");
            }
          }
        });
      }


/**
 * üöÄ REQUEST CANCELLATION (OT)
 * Standardized Button Sizes & Clear Labels
 */
 async function requestCancelOT(otId) {
    Swal.fire({
        title: 'Cancel Approved Overtime',
        html: `
            <p style="color:#64748b; font-size:0.9rem; margin-bottom:15px;">
                Please provide a reason for cancelling this approved overtime. Your manager will need to review this.
            </p>
            <div style="position: relative;">
                <textarea id="swal-ot-cancel-reason" class="saas-form-control" rows="3" maxlength="200"
                    style="width: 100%; padding: 10px; font-family: inherit; resize: none; border: 1px solid #cbd5e1; border-radius: 6px;"
                    placeholder="e.g. Calculation error / Plans changed..."></textarea>
                
                <div style="text-align: right; font-size: 0.75rem; color: #94a3b8; margin-top: 5px;">
                    <span id="swal-ot-char-count">0</span>/200
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Submit for Approval',
        confirmButtonColor: '#ef4444', 
        cancelButtonText: 'Cancel', // üöÄ Standardized Label
        // üöÄ APPLY STANDARDIZED CLASS
        customClass: {
            confirmButton: 'swal-btn-custom',
            cancelButton: 'swal-btn-custom'
        },
        focusConfirm: false, 
        didOpen: () => {
            // Live Character Counter
            const input = document.getElementById('swal-ot-cancel-reason');
            const counter = document.getElementById('swal-ot-char-count');
            
            if(input) input.focus();

            if(input && counter) {
                input.oninput = () => {
                    const len = input.value.length;
                    counter.innerText = len;
                    if(len >= 200) counter.style.color = '#ef4444';
                    else counter.style.color = '#94a3b8';
                };
            }
        },
        preConfirm: () => {
            const input = document.getElementById('swal-ot-cancel-reason');
            const value = input ? input.value.trim() : "";
            
            if (!value || value.length < 5) {
                Swal.showValidationMessage('Please provide a reason (at least 5 characters).');
                return false;
            }
            return value;
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            // üöÄ EXECUTION: Send to Backend using the worker function
            await executeCancellationSubmit(otId, "OT", result.value);
        }
    });
}


      // 1. Global variable to store the Leave ID
      let pendingCancelId = null;


      // 1. üöÄ ADD THIS AT THE VERY TOP OF YOUR SCRIPT (outside any function)
      // üöÄ MANAGER DASHBOARD: High-Fidelity Pending List
      let currentManagerRequests = [];
      // (Note: mgrCurrentPage and mgrPageSize variables are usually defined globally,
      // but ensure they exist or redeclare them here if needed)
      // let mgrCurrentPage = 1;
      // const mgrPageSize = 10;

// ==========================================
// üöÄ MANAGER QUEUE SORTING & RENDERING (LEAVES & CF)
// ==========================================

// 1. Global Sort State for Manager Queue
let mgrSortState = { key: 'start_date', direction: 'desc' };

// 2. Trigger Function (Called by clicking headers)
function sortManagerQueue(key) {
    if (mgrSortState.key === key) {
        // Toggle direction if clicking the same column
        mgrSortState.direction = mgrSortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        // Default to descending when switching to a new column
        mgrSortState.key = key;
        mgrSortState.direction = 'desc';
    }

    // Update Icons Visually
    document.querySelectorAll('#managerLeaveThead i[id^="mgr-sort-"]').forEach(i => {
        i.className = 'fas fa-sort'; 
        i.style.color = '#cbd5e1';
    });
    const activeIcon = document.getElementById(`mgr-sort-${key}`);
    if (activeIcon) {
        activeIcon.className = mgrSortState.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
        activeIcon.style.color = '#3b82f6';
    }

    // Re-render the table with sorted data
    renderManagerQueueTable();
}

// 3. Data Fetcher (Only fetches, does not render HTML)
async function loadManagerRequests() {
    const tbody = document.getElementById("managerRequestsTableBody");
    const pageInfo = document.getElementById("mgrPageInfo");
    if (!tbody) return;

    // Capture Filters
    const nameVal = document.getElementById("mgr_search_name")?.value || "";
    const typeVal = document.getElementById("mgr_search_type")?.value || "";
    const dateVal = document.getElementById("mgr_search_date")?.value || "";
    const endDateVal = document.getElementById("mgr_search_end_date")?.value || "";
    const statusVal = document.getElementById("mgr_search_status")?.value || "";

    // Visual Loading State (Matches 6 columns including hidden one)
    tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:40px; color:#94a3b8;">
        <i class="fas fa-circle-notch fa-spin" style="font-size:1.5rem; margin-bottom:10px;"></i><br>Refreshing queue...
    </td></tr>`;

    try {
        const params = new URLSearchParams({
            approver_name: currentUser,
            page: mgrCurrentPage,
            page_size: mgrPageSize,
            name: nameVal,
            leave_type: typeVal,
            date_str: dateVal,
            end_date: endDateVal,
            status: statusVal,
        });

        const res = await fetchWithAuth(`${API_URL}/leaves/manager/pending?${params.toString()}`);
        if (!res.ok) throw new Error("Server error");

        const data = await res.json();
        
        // Save to global array for local sorting
        currentManagerRequests = data.requests || [];

        // Update Pagination Controls
        if (pageInfo) pageInfo.innerText = `Records Found: ${data.total || 0}`;
        const prevBtn = document.getElementById("mgrPrevBtn");
        const nextBtn = document.getElementById("mgrNextBtn");
        if (prevBtn) prevBtn.disabled = mgrCurrentPage === 1;
        if (nextBtn) nextBtn.disabled = mgrCurrentPage * mgrPageSize >= (data.total || 0);

        // üöÄ Hand over to the Render Engine
        renderManagerQueueTable();

    } catch (e) {
        console.error("Manager Load Error:", e);
        tbody.innerHTML = "<tr><td colspan='6' style='color:#ef4444; text-align:center; padding:20px;'>Connection error. Please retry.</td></tr>";
    }
}

// 4. Render Engine (Sorts and draws HTML)
function renderManagerQueueTable() {
    const tbody = document.getElementById("managerRequestsTableBody");
    if (!tbody) return;

    // A. Apply Sorting
    currentManagerRequests.sort((a, b) => {
        let valA = a[mgrSortState.key] || "";
        let valB = b[mgrSortState.key] || "";

        // Custom numeric sort for duration
        if (mgrSortState.key === 'days_taken') {
            valA = parseFloat(a.days_taken) || 0;
            valB = parseFloat(b.days_taken) || 0;
        }

        if (typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
        }

        if (valA < valB) return mgrSortState.direction === 'asc' ? -1 : 1;
        if (valA > valB) return mgrSortState.direction === 'asc' ? 1 : -1;
        return 0;
    });

    // B. Clear Table
    tbody.innerHTML = "";

    // C. Empty State Check
    if (currentManagerRequests.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:40px; color:#64748b;">
            <i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px; opacity:0.5;"></i><br>
            All caught up! No pending requests.
        </td></tr>`;
        return;
    }

 // D. Render Rows
 currentManagerRequests.forEach((r) => {
        // üé® Avatar Initials
        const initials = (r.employee_name || "??").split(" ").map((n) => n[0]).slice(0, 2).join("").toUpperCase();

        // üü¢ NEW: Determine the Badge for the Manager View
        const isCF = (r.reason || "").includes("[CARRY FORWARD");
        
        // üé® The New Type Badge
        const typeBadge = isCF 
            ? `<span style="background: rgba(14, 165, 233, 0.1); color: #0ea5e9; border: 1px solid rgba(14, 165, 233, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase;">Carry Fwd</span>`
            : `<span style="background: rgba(99, 102, 241, 0.1); color: #6366f1; border: 1px solid rgba(99, 102, 241, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase;">Leave</span>`;

        // üé® Smart Duration Pill Logic
        let rawVal = parseFloat(r.days_taken) || 0;
        let durIcon = "fa-calendar-day";
        let durUnit = "DAYS";
        let durBg = "#f1f5f9";
        let durColor = "#334155";
        let displayVal = rawVal;

        // Handle Carry Forward Tag formatting
        if (isCF) {
            const match = r.reason.match(/\[CARRY FORWARD:\s*([\d\.]+)\s*DAYS\]/i); 
            if (match) displayVal = match[1];
            durIcon = "fa-piggy-bank";
            durBg = "#eff6ff";
            durColor = "#2563eb";
        }

        const durationPill = `
            <div style="display:inline-flex; align-items:center; gap:6px; background:${durBg}; border:1px solid #e2e8f0; padding:4px 10px; border-radius:6px;">
                <i class="fas ${durIcon}" style="font-size:0.7rem; color:${durColor}; opacity:0.7;"></i>
                <span style="font-weight:800; color:${durColor}; font-size:0.85rem;">${displayVal}</span>
                <span style="font-size:0.65rem; font-weight:700; color:${durColor}; opacity:0.7; margin-top:1px;">${durUnit}</span>
            </div>
        `;

        // üé® Stacked Dates (Uses Global formatDateNice)
        const dateDisplay = r.start_date === r.end_date
            ? `<span style="font-weight:600; color:#334155;">${formatDateNice(r.start_date)}</span>`
            : `<div style="display:flex; flex-direction:column; align-items:flex-start; font-size:0.8rem;">
                 <span style="color:#334155; font-weight:600;">${formatDateNice(r.start_date)}</span>
                 <span style="color:#94a3b8; font-size:0.7rem; padding-left:2px;">to ${formatDateNice(r.end_date)}</span>
               </div>`;

        // üé® Status Badge
        let statusClass = `status-${r.status.toLowerCase().replace(/\s+/g, "-")}`;
        let statusLabel = r.status;
        if (r.status === "Pending L2 Approval") {
            statusLabel = "Waiting L2";
            statusClass = "status-pending-l2-approval";
        }

// üöÄ PART 1 FIX: ADDED UNIQUE ID (mgr_row_${r.id}) TO THE TR TAG
const row = `
          <tr id="mgr_row_${r.id}" style="border-bottom: 1px solid #f1f5f9; transition: all 0.5s ease;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
              
              <td style="padding: 12px 15px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:36px; height:36px; background:#e0f2fe; color:#0369a1; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:800; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                        ${initials}
                    </div>
                    <div>
                        <div style="font-weight:700; color:#1e293b; font-size:0.9rem;">${r.employee_name}</div>
                        
                        <div style="margin-top: 4px; display: flex; align-items: center; gap: 6px;">
                            ${typeBadge}
                            <span style="font-size:0.7rem; color:#64748b; font-weight: 600;">${r.leave_type}</span>
                        </div>

                    </div>
                </div>
              </td>

              <td style="padding: 12px 15px; vertical-align:middle;">${durationPill}</td>
              <td style="padding: 12px 15px; vertical-align:middle;">${dateDisplay}</td>
              <td style="display:none;"></td> 
              <td class="text-center" style="padding: 12px 15px; vertical-align:middle;">
                  <span class="status-badge ${statusClass}" style="font-size:0.75rem; padding:4px 10px;">${statusLabel}</span>
              </td>

              <td class="text-center" style="padding: 12px 15px; vertical-align:middle;">
                  <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                      <button class="icon-btn" onclick="openLeaveModalFromId(${r.id})" title="Review Details" 
                        style="border:1px solid #cbd5e1; width:34px; height:34px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:white;">
                          <i class="fas fa-eye" style="color:#475569;"></i>
                      </button>
                      
                      <button class="icon-btn" onclick="processApproval(${r.id}, 'Approved', '${r.start_date}', '${r.end_date}', '${r.leave_type}', '${r.status}')" title="Approve"
                        style="border:1px solid #bbf7d0; width:34px; height:34px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:#f0fdf4;">
                          <i class="fas fa-check" style="color:#16a34a;"></i>
                      </button>

                      <button class="icon-btn" onclick="processApproval(${r.id}, 'Rejected', '${r.start_date}', '${r.end_date}', '${r.leave_type}', '${r.status}')" title="Reject"
                         style="border:1px solid #fecaca; width:34px; height:34px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:#fef2f2;">
                          <i class="fas fa-times" style="color:#dc2626;"></i>
                      </button>
                  </div>
              </td>
          </tr>`;

        tbody.insertAdjacentHTML("beforeend", row);
    });
}

      // üöÄ 4. ADD THIS BRIDGE FUNCTION
      function openLeaveModalFromId(leaveId) {
        const leave = currentManagerRequests.find(
          (item) => item.id === leaveId
        );
        if (leave) {
          // This calls your existing viewLeaveDetails(leave) function
          viewLeaveDetails(leave);
        } else {
          alert("‚ùå Error: Could not locate leave details.");
        }
      }

      // =======================================================================
      // üöÄ CARRY FORWARD LOGIC (Wizard Flow: Continue -> Yes, Disable All)
      // =======================================================================

      // 1. VISUAL HELPER
      function updateCFToggleVisuals() {
        const toggle = document.getElementById("cf_workflow_toggle");
        const bg = document.getElementById("cfToggleBg");
        const circle = document.getElementById("cfToggleCircle");

        if (toggle && bg && circle) {
          if (toggle.checked) {
            // üü¢ ON
            bg.style.setProperty("background-color", "#22c55e", "important");
            circle.style.transform = "translateX(28px)";
          } else {
            // ‚ö´ OFF
            bg.style.setProperty("background-color", "#cbd5e1", "important");
            circle.style.transform = "translateX(0px)";
          }
        }
      }

      // ‚ö° SMART TOGGLE: Instant ON, Confirmed OFF
      // ‚ö° SMART TOGGLE: Instant ON, Confirmed OFF
      // ‚ö° SMART TOGGLE: Instant ON (Success Msg), Confirmed OFF
      async function handleCFToggle() {
        const toggle = document.getElementById("cf_workflow_toggle");
        if (!toggle) return;
        
        const isTurningOn = toggle.checked;

        // üõë VISUAL STOP: Revert the switch immediately.
        // We only want the switch to stay flipped IF the database save succeeds.
        toggle.checked = !isTurningOn;

        if (isTurningOn) {
          // CASE A: Turning ON? Proceed to save immediately.
          await saveCFState(true);
        } 
        else {
          // CASE B: Turning OFF? Show the SweetAlert Warning.
          Swal.fire({
            title: 'Disable Carry Forward?',
            text: "This will hide the configuration rules and employee features. Are you sure?",
            icon: 'warning',
            iconColor: '#ef4444',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#cbd5e1',
            confirmButtonText: 'Yes, Disable Feature',
            cancelButtonText: 'Cancel'
          }).then(async (result) => {
            if (result.isConfirmed) {
              // User confirmed, proceed to save.
              await saveCFState(false);
            }
          });
        }
      }

      // üîß WORKER: Updates Backend & Slides the Panel
 // üîß WORKER: Updates Backend & Handles Cleanup Confirmation
 async function saveCFState(isEnabled, confirmCleanup = false) {
        const toggle = document.getElementById("cf_workflow_toggle");
        const panel = document.getElementById("cf_config_panel");

        try {
          // 1. Show a loading state so the Admin knows the server is thinking
          if (!confirmCleanup) {
              Swal.fire({ 
                  title: 'Saving Settings...', 
                  allowOutsideClick: false, 
                  didOpen: () => { Swal.showLoading(); } 
              });
          }

          const res = await fetchWithAuth(`${API_URL}/settings/carry-forward`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                enabled: isEnabled, 
                confirm_cleanup: confirmCleanup // üõ°Ô∏è New safety flag
            }),
          });

          if (!res) return;
          const data = await res.json();

          // ‚ö†Ô∏è CASE: Server detects active requests that would be "Orphaned"
          if (data.status === "warning_required") {
            // Revert toggle visually because we haven't actually saved yet
            if (toggle) toggle.checked = true; 

            Swal.fire({
                title: 'Active Requests Detected',
                html: `There are <strong style="color:#ef4444; font-size:1.2rem;">${data.count}</strong> active Carry Forward request(s).<br><br>Proceeding will <strong>CANCEL</strong> these requests and remove banked days from employee balances.`,
                icon: 'warning',
                iconColor: '#dc2626',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#cbd5e1',
                confirmButtonText: 'Yes, Disable & Cancel All',
                cancelButtonText: 'Stop, let me check first'
            }).then((result) => {
                if (result.isConfirmed) {
                    // üöÄ User gave the green light: Call save again with cleanup=true
                    saveCFState(false, true); 
                }
            });

          } else if (res.ok) {
            // ‚úÖ SUCCESS PATH
            ENABLE_CARRY_FORWARD = isEnabled;
            
            if (toggle) toggle.checked = isEnabled;
            if (panel) panel.style.display = isEnabled ? "block" : "none";
            
            // Sync the employee "Apply Leave" screen immediately
            applyFeatureToggles();

            // Premium Toast Notification
            Swal.fire({
                icon: 'success',
                title: isEnabled ? 'Carry Forward Enabled' : 'Carry Forward Disabled',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });

            console.log(`Carry Forward is now ${isEnabled ? "ON" : "OFF"}`);
          } else {
            throw new Error(data.detail || "Update failed");
          }
        } catch (e) {
          console.error("CF State Error", e);
          // Revert UI on error
          if (toggle) toggle.checked = !isEnabled;
          Swal.fire("Error", "Failed to update settings.", "error");
        }
      }

      // üßπ UTILITY: Clears the Carry Forward configuration inputs
      function resetCFConfig() {
        const daysInput = document.getElementById("cf_limit_days");
        const dateInput = document.getElementById("cf_expiry_date");

        if (daysInput) daysInput.value = "";
        if (dateInput) dateInput.value = "";
      }

      // 3. STEP 1: CONFIGURE MODAL (Green Enable vs Red Disable)

      // 4. ACTION HANDLER

      // 5. SERVER SYNC & STEP 2 TRIGGER

      // 6. INITIAL LOAD
      // üîÑ UPDATED: Loads State, Unlocks Toggle & Pre-fills Date Picker
      // 1. üåç DEFINE GLOBAL SETTINGS VARIABLE (Paste this at the top of your script)
      let SYSTEM_SETTINGS = {
        carry_forward: { max_days: 365, expiry_date: "N/A" },
      };

      // 2. üîÑ UPDATED LOAD FUNCTION
  // üöÄ PROD-READY: Carry Forward Settings Loader
  async function loadCFSetting() {
        try {
          const res = await fetchWithAuth(`${API_URL}/settings/carry-forward`);
          if (res.ok) {
            const data = await res.json();
            ENABLE_CARRY_FORWARD = data.enabled;

            // üíæ A. STORE DATA GLOBALLY
            SYSTEM_SETTINGS.carry_forward = {
              max_days: data.max_days || 365,
              expiry_date: data.expiry_date || "N/A",
            };

            // üëÅÔ∏è B. UPDATE THE BLUE INFO BOX (Employee View)
            const limitDisplay = document.getElementById("cf_display_limit");
            const dateDisplay = document.getElementById("cf_display_date");

            if (limitDisplay) {
              limitDisplay.innerText = data.max_days || "Unlimited";
            }
            if (dateDisplay) {
              if (data.expiry_date) {
                const d = new Date(data.expiry_date);
                dateDisplay.innerText = d.toLocaleDateString("en-GB", {
                  day: "numeric",
                  month: "short",
                  year: "numeric",
                });
              } else {
                dateDisplay.innerText = "No Expiry";
              }
            }

            // ‚öôÔ∏è C. SYNC ADMIN CONFIG PANEL
            const toggle = document.getElementById("cf_workflow_toggle");
            const panel = document.getElementById("cf_config_panel");

            if (toggle) {
              toggle.checked = data.enabled;
              // ‚ùå Removed updateCFToggleVisuals() to prevent JS crash
              toggle.disabled = false; // üîì Unlock the button safely
            }
            if (panel) {
              panel.style.display = data.enabled ? "block" : "none";

              // Pre-fill inputs for editing
              if (data.max_days)
                document.getElementById("cf_limit_days").value = data.max_days;
              if (data.expiry_date)
                document.getElementById("cf_expiry_date").value =
                  data.expiry_date;
            }

            applyFeatureToggles();
          }
        } catch (e) {
          console.error("CF Load Error:", e);
        }
      }

      // üöÄ PROD-READY: L2 State Sync Loader
      async function syncL2ToggleState() {
        try {
          const response = await fetchWithAuth(
            `${API_URL}/users/policy/current`
          );

          if (!response || !response.ok) return;

          const policy = await response.json();
          const toggle = document.getElementById("l2_workflow_toggle");
          const l2FilterOption = document.getElementById("opt_l2_pending");

          if (policy.l2_approval_enabled !== undefined) {
            // 1. Sync the Toggle Switch
            if (toggle) {
              toggle.checked = policy.l2_approval_enabled;
              // No need for toggle.disabled = false anymore, as the HTML is unlocked!
            }

            // 2. Sync the Filter Dropdown (Manager Dashboard)
            if (l2FilterOption) {
              if (policy.l2_approval_enabled) {
                l2FilterOption.style.display = "block"; // Show it
              } else {
                l2FilterOption.style.display = "none"; // Hide it

                // Safety: If the manager currently has "Pending L2" selected, reset them to "All"
                const parentSelect = document.getElementById("mgr_search_status");
                if (parentSelect && parentSelect.value === "Pending L2 Approval") {
                  parentSelect.value = "";
                  if (typeof loadManagerRequests === "function") loadManagerRequests();
                }
              }
            }

            console.log("üîÑ L2 State Synced:", policy.l2_approval_enabled);
          }
        } catch (err) {
          console.warn("Could not fetch current L2 policy state.");
        }
      }


      // üíæ NEW: Save Carry Forward Configuration
  // üíæ NEW: Save Carry Forward Configuration (Upgraded to SweetAlert for 100% visibility)
  async function saveCFConfig() {
        const days = document.getElementById("cf_limit_days").value;
        // üöÄ Target the new Date Picker ID
        const expiry = document.getElementById("cf_expiry_date").value;

        // 1. Validation: Check if inputs are empty
        if (!days || days < 1) {
          Swal.fire("Invalid Input", "Please enter a valid max day limit (e.g., 5).", "warning");
          return;
        }
        if (!expiry) {
          Swal.fire("Missing Date", "Please select an expiry deadline date.", "warning");
          return;
        }

        try {
          // ‚è≥ Show Loading Spinner so you know it's working
          Swal.fire({
              title: 'Saving Rules...',
              allowOutsideClick: false,
              didOpen: () => { Swal.showLoading(); }
          });

          // 2. Send to Backend
          const res = await fetchWithAuth(
            `${API_URL}/settings/carry-forward-rules`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                max_days: parseInt(days),
                expiry_date: expiry,
              }),
            }
          );

          // 3. Handle Response
          if (res && res.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Rules Saved',
                text: 'Carry Forward limits have been updated successfully.',
                confirmButtonColor: '#2563eb'
            });
          } else {
            Swal.fire("Error", "Could not save configuration.", "error");
          }
        } catch (e) {
          console.error("Save Rule Error", e);
          Swal.fire("Network Error", "Check server connection.", "error");
        }
      }

      // üöÄ HR ADMIN: High-Fidelity User List (Fixed Client-Side Filtering)
      async function loadAllUsers() {
        const tbody = document.getElementById("hrUserTableBody");
        if (!tbody) return;

        // Visual Loading State (Spans 5 columns)
        tbody.innerHTML = `<tr><td colspan="5" class="text-center" style="padding:40px; color:#94a3b8;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:1.5rem; margin-bottom:10px;"></i><br>Loading user directory...
        </td></tr>`;

        try {
          // 1. Fetch ALL users
          const res = await fetchWithAuth(`${API_URL}/users/all`);
          if (!res) return;

          const allUsers = await res.json();
          window.allUsersList = allUsers; // Store global copy for edit modals

          // 2. Get Filter Inputs
          const searchVal = document.getElementById("hr_user_search")?.value.toLowerCase().trim() || "";
          const roleVal = document.getElementById("hr_role_filter")?.value || "";
          const statusVal = document.getElementById("hr_status_filter")?.value || "";

          // 3. Apply Filtering Logic
          const filteredUsers = allUsers.filter((u) => {
            const nameMatch = (u.full_name || "").toLowerCase().includes(searchVal) || (u.username || "").toLowerCase().includes(searchVal);
            
            let roleMatch = true;
            if (roleVal) {
              const userRoles = (u.roles_list || []).map((r) => r.toLowerCase());
              if (u.role) userRoles.push(u.role.toLowerCase());
              roleMatch = userRoles.includes(roleVal.toLowerCase());
            }

            let statusMatch = true;
            if (statusVal === "active") statusMatch = u.is_active === true;
            if (statusVal === "inactive") statusMatch = u.is_active === false;

            return nameMatch && roleMatch && statusMatch;
          });

          // 4. Update Summary Tiles
          if (document.getElementById("summary_total_users"))
            document.getElementById("summary_total_users").innerText = allUsers.length;
          if (document.getElementById("summary_active_users"))
            document.getElementById("summary_active_users").innerText = allUsers.filter((u) => u.is_active).length;
          if (document.getElementById("summary_inactive_users"))
            document.getElementById("summary_inactive_users").innerText = allUsers.filter((u) => !u.is_active).length;

          // 5. Handle Empty Results
          if (filteredUsers.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center" style="padding:40px; color:#64748b;">
                <i class="fas fa-search" style="font-size:1.5rem; margin-bottom:10px; opacity:0.5;"></i><br>No matching users found.
            </td></tr>`;
            return;
          }

          // 6. Render Rows
 // 6. Render Rows
 tbody.innerHTML = filteredUsers.map((u) => {
              const rolesJson = JSON.stringify(u.roles_list || []);
              const isSelf = u.username === (currentUser ? currentUser.toLowerCase() : "");
              const safeName = (u.full_name || "").replace(/'/g, "\\'");
              const initials = (u.full_name || "??").split(" ").map((n) => n[0]).slice(0, 2).join("").toUpperCase();

              // Status Badge Logic
              const statusBadge = u.is_active
                ? `<span style="background: #f0fdf4; color: #15803d; padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: bold; border: 1px solid #bbf7d0; display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-check-circle" style="font-size:0.6rem;"></i> Active</span>`
                : `<span style="background: #fef2f2; color: #b91c1c; padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: bold; border: 1px solid #fecaca; display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-times-circle" style="font-size:0.6rem;"></i> Inactive</span>`;

              // Role Badge Logic
              let roleBadges = "";
              const roleColors = { hr_admin: { bg: "#faf5ff", text: "#7e22ce", icon: "fa-user-shield" }, manager: { bg: "#fff7ed", text: "#c2410c", icon: "fa-user-tie" }, employee: { bg: "#f1f5f9", text: "#475569", icon: "fa-user" } };
              
              if (u.roles_list && u.roles_list.length > 0) {
                roleBadges = u.roles_list.map((r) => {
                    const cfg = roleColors[r.toLowerCase()] || roleColors["employee"];
                    return `<span style="background:${cfg.bg}; color:${cfg.text}; padding:2px 8px; border-radius:4px; margin:2px; font-size:0.65rem; font-weight:bold; display:inline-flex; align-items:center; gap:3px; border:1px solid rgba(0,0,0,0.05);"><i class="fas ${cfg.icon}" style="font-size:0.6rem;"></i> ${r.toUpperCase()}</span>`;
                  }).join("");
              }
              if (u.is_senior_manager) {
                roleBadges += `<span style="font-size:0.65rem; padding:2px 8px; border-radius:4px; margin-left:4px; background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; font-weight:bold; display:inline-flex; align-items:center; gap:3px;"><i class="fas fa-award"></i> L2 POWER</span>`;
              }

              return `
                <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.1s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                    
                    <td style="padding: 12px 15px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:32px; height:32px; background:#e0f2fe; color:#0369a1; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:800; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                ${initials}
                            </div>
                            <div>
                                <div style="font-weight:700; color:#1e293b; font-size:0.9rem;">${u.full_name}</div>
                                <div style="font-size:0.7rem; color:#64748b;">${u.job_title || "No Title"}</div>
                            </div>
                        </div>
                    </td>

                    <td style="padding: 12px 15px; vertical-align:middle;">
                         <span style="font-family:monospace; color:#475569; background:#f1f5f9; padding:2px 6px; border-radius:4px;">${u.username}</span>
                    </td>

                    <td class="text-center" style="padding: 12px 15px; vertical-align:middle;">${statusBadge}</td>

                    <td class="text-center" style="padding: 12px 15px; vertical-align:middle;">
                        <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:4px;">${roleBadges}</div>
                    </td>

                    <td class="text-center" style="padding: 12px 15px; vertical-align:middle;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button class="icon-btn" onclick="event.stopPropagation(); openFullProfileEditModalById(${u.id})" title="Edit Profile" style="color: #3b82f6;">
                                <i class="fas fa-user-edit"></i>
                            </button>
                            
                            <button class="icon-btn" onclick='event.stopPropagation(); openUserEditModal(${u.id}, "${safeName}", ${rolesJson}, ${u.is_senior_manager})' 
                                    title="Permissions" style="color: #6366f1;">
                                <i class="fas fa-shield-alt"></i>
                            </button>
                            
                            <button class="icon-btn" 
                                style="color:${u.is_active ? "#ef4444" : "#10b981"}; border-color:transparent; background: ${u.is_active ? "#fef2f2" : "#f0fdf4"}; opacity: ${isSelf ? "0.3" : "1"}; cursor: ${isSelf ? "not-allowed" : "pointer"};" 
                                onclick="${isSelf ? "event.stopPropagation(); alert('üõ°Ô∏è Security: You cannot deactivate your own account while logged in.')" : `event.stopPropagation(); toggleUserStatus(${u.id})`}"
                                title="${isSelf ? "Self-protection active" : u.is_active ? "Deactivate User" : "Activate User"}">
                                <i class="fas ${u.is_active ? "fa-user-slash" : "fa-user-check"}"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join("");
            
        } catch (e) {
          console.error("User Load Error:", e);
          tbody.innerHTML = `<tr><td colspan='5' class='text-center' style='color:red;'>Failed to load users.</td></tr>`;
        }
      }

      // // --- CARRY FORWARD SETTINGS LOGIC --- [TO BE DELETED]

      // async function loadCFSetting() {
      //   try {
      //     const res = await fetchWithAuth(`${API_URL}/settings/carry-forward`);
      //     if (res.ok) {
      //       const data = await res.json();
      //       ENABLE_CARRY_FORWARD = data.enabled;
      //       const toggle = document.getElementById("cf_workflow_toggle");
      //       if (toggle) {
      //         toggle.checked = data.enabled;
      //         updateCFToggleVisuals();
      //       }
      //       applyFeatureToggles();
      //     }
      //   } catch (e) {
      //     console.error(e);
      //   }
      // }

      // IMPORTANT: Call loadCFSetting() when your Settings page/tab loads!
      // Example: inside your showSection('hr_settings') function

      function mgrChangePage(step) {
        mgrCurrentPage += step;
        loadManagerRequests();
      }

      // üöÄ APPLIES GLOBAL SETTINGS TO UI ELEMENTS
      function applyFeatureToggles() {
        // Target the "Request Carry Forward" button (ID: tab_unpaid)
        const cfButton = document.getElementById("tab_unpaid");

        if (cfButton) {
          if (ENABLE_CARRY_FORWARD) {
            cfButton.style.display = "inline-block";
          } else {
            cfButton.style.display = "none";

            // Safety: If the user was currently ON that tab, switch them back to Apply Leave
            const cfUI = document.getElementById("carry_forward_ui");
            if (cfUI && cfUI.style.display === "block") {
              switchApplyMode("leave");
            }
          }
        }
      }

      function resetTeamHistoryFilters() {
    document.getElementById("mgr_hist_name").value = "";
    document.getElementById("mgr_hist_type").value = "Any";
    document.getElementById("mgr_hist_status").value = "";
    document.getElementById("mgr_hist_duration").value = "";
    document.getElementById("mgr_hist_start").value = "";
    document.getElementById("mgr_hist_end").value = "";
    
    console.log("üßπ All team filters cleared.");
    loadTeamHistory(1);
}

// ==========================================
// TEAM LEAVE HISTORY
// ==========================================

async function loadTeamHistory(page = 1) {
    // 1. Sync global state with current call
    mgrHistCurrentPage = page;
    
    // üöÄ Target the unique IDs
    const tbody = document.getElementById("mgrHistoryTableBody");
    const refreshIcon = document.getElementById("mgrRefreshIcon");
    if (!tbody) return;

    // 2. Start Spin Animation & Readiness check
    if (refreshIcon) refreshIcon.classList.add("fa-spin");

    if (!currentUser || !userRoles) {
        setTimeout(() => loadTeamHistory(page), 50);
        return;
    }

    // 3. Initial Visual Loading State
    tbody.innerHTML = `<tr><td colspan="8" class="text-center" style="padding:40px; color: #64748b;">
            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 10px;"></i><br>
            Fetching All Company Records...
        </td></tr>`;

    // 4. CAPTURE FILTERS
    const nameFilter = document.getElementById("mgr_hist_name")?.value.trim().toLowerCase() || "";
    const typeFilter = document.getElementById("mgr_hist_type")?.value || "Any";
    let statusValue = document.getElementById("mgr_hist_status")?.value || "";
    if (statusValue === "All Decisions" || statusValue === "Any") statusValue = "";

    const durFilter = document.getElementById("mgr_hist_duration")?.value || "";
    const startFilter = document.getElementById("mgr_hist_start")?.value || "";
    const endFilter = document.getElementById("mgr_hist_end")?.value || "";

    try {
        // üöÄ Scope remains 'hr_admin' to ensure global visibility
        const roleString = "hr_admin";

        const leaveParams = new URLSearchParams({
            user_role: roleString,
            approver_name: currentUser, 
            name: nameFilter,
            status: statusValue,
            page_size: 1000 // Buffer for local filtering/pagination
        });

        // 5. PARALLEL FETCH
        const [leaveRes, otRes] = await Promise.all([
            fetchWithAuth(`${API_URL}/leaves/manager/all?${leaveParams.toString()}`),
            fetchWithAuth(`${API_URL}/overtime/all-requests`),
        ]);

        if (!leaveRes || !otRes) throw new Error("Network response failed"); 

        const leaveData = await leaveRes.json();
        const otData = await otRes.json();

        // 6. NORMALIZE LEAVE DATA
        const processedLeaves = (leaveData.requests || []).map((l) => {
            let displayAmt = l.days_taken + " Day(s)";
            let displayLabel = l.leave_type;
            const cfMatch = (l.reason || "").match(/\[CARRY FORWARD:\s*([\d\.]+)\s*DAYS\]/);
            if (cfMatch) {
                displayAmt = `<strong style="color:#0ea5e9;">${cfMatch[1]}</strong> (CF)`;
                displayLabel = `<span style="color:#0ea5e9; font-weight:bold;">Carry Forward</span>`;
            }
            return {
                ...l,
                record_type: "Leave",
                display_label: displayLabel,
                display_amount: displayAmt,
                display_start: l.start_date,
                display_end: l.end_date,
            };
        });

        // 7. NORMALIZE OT DATA
        const processedOTs = (otData || []).map((o) => ({
            ...o,
            record_type: "OT",
            leave_type: o.ot_type,
            display_label: o.ot_type,
            display_amount: `${o.total_value} ${o.ot_unit}`,
            display_start: o.ot_date,
            display_end: o.ot_date,
            employee_name: o.employee_name,
        }));

        // 8. COMBINE & ADVANCED FILTERING
        let combined = [...processedLeaves, ...processedOTs];

        if (nameFilter) combined = combined.filter(r => r.employee_name.toLowerCase().includes(nameFilter));
        if (typeFilter !== "Any") combined = combined.filter(r => r.record_type === typeFilter);
        if (statusValue) combined = combined.filter(r => r.status === statusValue);
        
        if (durFilter) {
            combined = combined.filter(r => {
                const val = parseFloat(r.days_taken || r.total_value || 0);
                return val == parseFloat(durFilter);
            });
        }

        if (startFilter) combined = combined.filter(r => r.display_start >= startFilter);
        if (endFilter) combined = combined.filter(r => (r.display_end || r.display_start) <= endFilter);

        // üíæ CACHE FOR EXPORT: Crucial for exportTeamHistoryCSV()
        window.lastFilteredTeamHistory = combined;

        // 9. SORT & PAGINATION MATH
        combined.sort((a, b) => b.id - a.id);
        
        const totalRecords = combined.length;
        const totalPages = Math.ceil(totalRecords / mgrHistPageSize) || 1;
        
        if (mgrHistCurrentPage > totalPages) mgrHistCurrentPage = totalPages;
        
        const startIndex = (mgrHistCurrentPage - 1) * mgrHistPageSize;
        const paginatedData = combined.slice(startIndex, startIndex + mgrHistPageSize);

        tbody.innerHTML = "";

        // 10. EMPTY STATE
        if (paginatedData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center" style="padding:60px; color: #64748b;">
                    <i class="fas fa-folder-open" style="font-size: 2.5rem; display: block; margin-bottom: 10px; color: #cbd5e1;"></i>
                    <strong>No records found.</strong>
                </td></tr>`;
            updateMgrHistFooter(0, 1);
            return;
        }

        // 11. RENDER ROWS
        paginatedData.forEach((r) => {
            const isOT = r.record_type === "OT";
            const itemData = JSON.stringify(r).replace(/'/g, "&apos;");
            const statusClass = `status-${r.status.toLowerCase().replace(/\s+/g, "-")}`;
            const typeTagColor = isOT ? "#818cf8" : "#38bdf8";

            tbody.innerHTML += `
                  <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc';" onmouseout="this.style.background='transparent';">
                      <td style="font-family: monospace; font-weight: bold; color: #64748b;">
                        ${getDisplayID(r.id, r.leave_type)}
                      </td>
                      <td class="col-emp">
                        <span style="font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; background: ${typeTagColor}; color: white; vertical-align: middle; margin-right: 5px; font-weight: 800; text-transform: uppercase;">
                          ${r.record_type}
                        </span>
                        <strong>${r.employee_name}</strong>
                      </td>
                      <td class="col-type">${r.display_label}</td>
                      <td class="col-days text-center">
                        <span style="background:#f1f5f9; padding: 4px 8px; border-radius: 6px; font-weight:700; font-size: 0.8rem;">${r.display_amount}</span>
                      </td>
                      <td class="col-date text-center" style="font-size: 0.85rem; color: #475569;">
                        <i class="far fa-calendar-alt" style="margin-right: 5px; opacity: 0.4;"></i>${r.display_start}
                      </td>
                      <td class="col-manager" style="font-size: 0.85rem;">${r.approver_name || "---"}</td>
                      <td class="col-status text-center">
                          <span class="status-badge ${statusClass}" style="font-size: 0.7rem; font-weight:800; padding: 5px 10px; border-radius: 20px;">${r.status.toUpperCase()}</span>
                      </td>
                      <td class="col-details text-center">
                          <button class="icon-btn" onclick='${isOT ? `viewOTDetails` : `viewLeaveDetails`}(${itemData})' title="View Details">
                              <i class="fas fa-eye"></i>
                          </button>
                      </td>
                  </tr>`;
        });

        updateMgrHistFooter(totalRecords, totalPages);

    } catch (e) {
        console.error("Consolidated History Error:", e);
        tbody.innerHTML = `<tr><td colspan="8" class="text-center" style="color: #ef4444; padding:20px;">
                <i class="fas fa-exclamation-circle"></i> Error loading team history.
              </td></tr>`;
    } finally {
        // üöÄ STOP SPIN: Remove animation after short delay for smoothness
        if (refreshIcon) {
            setTimeout(() => refreshIcon.classList.remove("fa-spin"), 600);
        }
    }
}



function changeMgrHistoryPage(direction) {
    const newPage = mgrHistCurrentPage + direction;
    // Basic safety: logic is handled inside loadTeamHistory, 
    // but we check for < 1 here.
    if (newPage < 1) return; 
    loadTeamHistory(newPage);
}

/**
 * üöÄ Internal helper to update Pagination Labels & Button States
 */
 function updateMgrHistFooter(total, maxPages) {
    // 1. Update the Total Records Count
    const countEl = document.getElementById("mgrTotalRecordsSpan");
    if (countEl) {
        countEl.innerText = total;
    }

    // 2. Update the "Page X of Y" text
    const pageInfo = document.getElementById("mgrHistoryPageInfo");
    if (pageInfo) {
        pageInfo.innerText = `Page ${mgrHistCurrentPage} of ${maxPages}`;
    }

    // 3. Handle the "Previous" Button
    const prevBtn = document.getElementById("mgrPrevPageBtn");
    if (prevBtn) {
        prevBtn.disabled = (mgrHistCurrentPage === 1);
    }

    // 4. Handle the "Next" Button
    const nextBtn = document.getElementById("mgrNextPageBtn");
    if (nextBtn) {
        nextBtn.disabled = (mgrHistCurrentPage >= maxPages);
    }
    
    // 5. Show or Hide the entire pagination bar
    const controls = document.getElementById("mgrPaginationControls");
    if (controls) {
        // We show the bar only if there is at least 1 record
        controls.style.display = (total > 0) ? "flex" : "none";
    }
}

/**
 * üìä Exports the CURRENT FILTERED view of Team History to a CSV file.
 * This respects the Name, Type, Status, and Date filters currently active.
 */
 function exportTeamHistoryCSV() {
    if (!window.lastFilteredTeamHistory || window.lastFilteredTeamHistory.length === 0) {
        showModal("Export Failed", "No records found to export. Try adjusting your filters.", "warning");
        return;
    }

    const headers = ["ID", "Employee Name", "Type", "Category", "Duration", "Start Date", "End Date", "Approver", "Status"];

    const csvRows = window.lastFilteredTeamHistory.map(r => {
        const displayId = getDisplayID(r.id, r.leave_type || r.ot_type);
        // Strip HTML from duration (remove strong tags from CF)
        const durationClean = r.display_amount.replace(/<[^>]*>/g, '');
        
        return [
            `"${displayId}"`,
            `"${r.employee_name}"`,
            `"${r.record_type}"`,
            `"${r.display_label.replace(/<[^>]*>/g, '')}"`,
            `"${durationClean}"`,
            `"${r.display_start}"`,
            `"${r.display_end || r.display_start}"`,
            `"${r.approver_name || '---'}"`,
            `"${r.status}"`
        ].join(",");
    });

    const csvContent = [headers.join(","), ...csvRows].join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const date = new Date().toISOString().split('T')[0];
    
    link.setAttribute("href", url);
    link.setAttribute("download", `Team_History_Report_${date}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


 
/**
 * ‚öñÔ∏è Step 1: Handle Leave Decisions (Approve/Reject)
 * üé® UPGRADE: Restores the "Pretty Timeline" with parsed remarks & colored dots.
 * üöÄ Covers: Standard Leave & Carry Forward Requests.
 */
/**
 * ‚öñÔ∏è Step 1: Handle Leave Decisions (Approve/Reject)
 * üé® ALIGNMENT: Mirrors the layout of Leave Details Modal for consistency.
 * üöÄ REVERTED: Original simple design for Admin Override banner.
 */
 async function processApproval(leaveId, actionType, startDate, endDate, leaveType, currentStatus) {
    
    // üõ°Ô∏è 1. GLOBAL SAFETY GUARD
    if (typeof processedActionIds !== 'undefined' && processedActionIds.has(leaveId)) {
         Swal.fire({ icon: 'warning', title: 'Processing...', text: 'Please wait.', timer: 1000, showConfirmButton: false });
        return;
    }

    const modal = document.getElementById("reviewModal");
    const l2Container = document.getElementById("l2SelectorContainer");
    const l2Select = document.getElementById("l2_manager_select");
    const errorId = "l2_validation_error";
    
    // --- 2. RESET UI ---
    document.getElementById("mgr_review_remarks").value = "";
    if (document.getElementById("mgr_char_count")) {
        document.getElementById("mgr_char_count").innerText = "0/200";
    }

    const existingErr = document.getElementById(errorId);
    if (existingErr) existingErr.remove(); 

    if (l2Container) l2Container.style.display = "none";
    if (l2Select) {
        l2Select.value = "";
        l2Select.style.borderColor = "#e2e8f0"; 
        l2Select.onchange = () => {
            if (l2Select.value) {
                const err = document.getElementById(errorId);
                if (err) err.remove();
                l2Select.style.borderColor = "#e2e8f0";
            }
        };
    }

    // --- 3. FETCH DATA ---
    const leaveRecord = currentManagerRequests.find(r => r.id == leaveId);
    const employeeName = leaveRecord ? leaveRecord.employee_name : "Staff Member";
    
    const isCancellationFlow = 
        currentStatus.includes("Cancel") || 
        (leaveRecord && leaveRecord.status_history && 
         (leaveRecord.status_history.includes("Cancellation Request") || 
          leaveRecord.status_history.includes("Request Cancellation")));

    // --- 4. RENDER BADGES (Labels & Colors) ---
    let statusText = (currentStatus || "PENDING").toUpperCase();
    let badgeClass = "status-pending";
    let statusColor = "#f59e0b"; // Orange

    if (statusText.includes("CANCEL")) {
        badgeClass = "status-pending-cancel";
        statusText = "WAITING FOR APPROVAL"; 
    }
    else if (statusText.includes("L2")) {
        badgeClass = "status-pending-l2-approval";
        statusText = "PENDING L2 APPROVAL"; 
    }
    else if (statusText.includes("REJECT")) {
        badgeClass = "status-rejected";
        statusColor = "#ef4444";
    }
    else if (statusText.includes("APPROVED")) {
        badgeClass = "status-approved";
        statusColor = "#10b981";
    }

    // --- 5. CLEAN DATA & PARSING ---
    let rawReason = leaveRecord ? (leaveRecord.reason || "No reason provided.") : "N/A";
    let cleanReason = rawReason;
    let adminNameFound = "";

    if (rawReason.includes("[HR_ADMIN_ACTION:")) {
        const adminMatch = rawReason.match(/\[HR_ADMIN_ACTION:\s*(.*?)\s*\]/);
        adminNameFound = adminMatch ? adminMatch[1] : "HR Admin";
        cleanReason = rawReason.replace(/\[HR_ADMIN_ACTION:.*?\]/g, "").replace("Reason:", "").trim();
    }
    const cfMatch = cleanReason.match(/\[CARRY FORWARD:\s*([\d\.]+)\s*DAYS\]/i);
    let displayDuration = (leaveRecord ? leaveRecord.days_taken : "0") + " Days";
    if (cfMatch) {
        displayDuration = `${cfMatch[1]} Days`;
        cleanReason = cleanReason.replace(cfMatch[0], "").trim();
        leaveType = "Carry Forward"; 
    }
    cleanReason = cleanReason.split("| Manager Note:")[0].trim();
    cleanReason = cleanReason.replace(/^"|"$/g, ''); 

    // Attachment
    let attachmentHtml = "";
    if (leaveRecord && leaveRecord.attachment_path) {
        const fileName = leaveRecord.attachment_path.split("/").pop();
        const fileUrl = `${API_URL}/uploads/${fileName}`;
        attachmentHtml = `
            <div style="margin-top: 10px; padding: 10px 12px; background: #f0f9ff; border: 1px dashed #0ea5e9; border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-paperclip" style="color: #0284c7;"></i>
                <a href="${fileUrl}" target="_blank" style="font-size: 0.85rem; color: #0284c7; font-weight: 600; text-decoration: none;">${fileName}</a>
            </div>`;
    }

    // üöÄ PRETTY TIMELINE GENERATOR
    let timelineHtml = "";
    if (leaveRecord && leaveRecord.status_history) {
        const historySteps = leaveRecord.status_history.split(" > ");
        timelineHtml = `
            <div style="margin-top: 25px; border-top: 2px solid #f1f5f9; padding-top: 15px;">
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 15px;">Decision History Log</label>
                <div style="position: relative; padding-left: 20px; border-left: 2px solid #e2e8f0; margin-left: 8px;">`;

        historySteps.forEach((step, index) => {
            const isLast = index === historySteps.length - 1;
            const isFirst = index === 0;
            const dateRegex = /\((\d{4}-\d{2}-\d{2} \d{2}:\d{2})\)/;
            const timeMatch = step.match(dateRegex);
            let timeText = timeMatch ? timeMatch[1] : (isFirst ? startDate : "N/A");

            let statusLabel = step.replace(dateRegex, "").trim();
            let stepRemark = "";
            if (isFirst) { stepRemark = cleanReason; }
            else if (statusLabel.includes("| Note:")) {
                const parts = statusLabel.split("| Note:");
                statusLabel = parts[0].trim();
                stepRemark = parts[1].trim();
            } else {
                const noteMatch = statusLabel.match(/\{Note:\s*(.*?)\}/i);
                if (noteMatch) {
                    stepRemark = noteMatch[1];
                    statusLabel = statusLabel.replace(noteMatch[0], "").trim();
                } else {
                    const reasonMatch = statusLabel.match(/\(Reason:\s*(.*?)\)/i);
                    if (reasonMatch) {
                        stepRemark = reasonMatch[1];
                        statusLabel = statusLabel.replace(reasonMatch[0], "").trim();
                    }
                }
            }
            statusLabel = statusLabel.replace(/\(\s*\)/g, "").trim();

            let dotColor = "#cbd5e1";
            if (statusLabel.includes("Approved")) dotColor = "#10b981";
            else if (statusLabel.includes("Rejected")) dotColor = "#ef4444";
            else if (statusLabel.includes("Cancelled") || statusLabel.includes("Withdrawn")) dotColor = "#64748b";
            else if (isLast && currentStatus.includes("Pending")) dotColor = "#f59e0b";

            timelineHtml += `
                <div style="margin-bottom: 20px; position: relative;">
                    <div style="position: absolute; left: -27px; top: 5px; width: 12px; height: 12px; background: white; border: 3px solid ${dotColor}; border-radius: 50%;"></div>
                    <div style="font-weight: 600; font-size: 0.9rem; color: #1e293b;">${statusLabel}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8;">${timeText}</div>
                    ${stepRemark ? `<div style="margin-top:4px; font-size:0.85rem; color:#475569; background:#f1f5f9; padding:6px 10px; border-radius:6px; border-left:3px solid ${dotColor};"><i class="fas fa-comment-dots" style="opacity:0.5; margin-right:4px;"></i> ${stepRemark}</div>` : ""}
                </div>`;
        });
        timelineHtml += `</div></div>`;
    }

    // --- 6. L2 LOGIC ---
    const isSenior = localStorage.getItem("is_senior_manager") === "true";
    if (actionType === "Approved" && currentStatus === "Pending" && !isSenior && !isCancellationFlow) {
        try {
            const res = await fetchWithAuth(`${API_URL}/users/policy/current`);
            if (res && res.ok) {
                const policy = await res.json();
                if (policy.l2_approval_enabled && l2Container) {
                    l2Container.style.display = "block";
                    await populateL2ManagerDropdown();
                }
            }
        } catch (e) { console.error("L2 Policy Check Error:", e); }
    }

    // --- 7. RENDER SUMMARY (Aligned with Leave Details) ---
    const currentApprover = (currentStatus === "Pending L2 Approval") 
        ? (leaveRecord.approver_l2 || "L2 Manager")
        : (leaveRecord.approver_name || "Line Manager");

    // üöÄ REVERTED: Original Simple Admin Override Banner
    let proxyBannerHtml = "";
    if (adminNameFound) {
        proxyBannerHtml = `
            <div style="background: #fffbeb; border: 1px solid #fde68a; padding: 10px 15px; border-radius: 6px; margin-bottom: 20px; color: #92400e; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; border-left: 4px solid #f59e0b;">
                <i class="fas fa-user-shield"></i>
                <span><strong>Admin Override:</strong> Submitted on behalf of employee by ${adminNameFound}</span>
            </div>`;
    }

    document.getElementById("reviewSummary").innerHTML = `
        ${proxyBannerHtml}
        
        <div style="margin-bottom: 20px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 12px;">
            <div style="background: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <i class="fas fa-user" style="color: var(--primary); font-size: 0.9rem;"></i>
            </div>
            <div>
                <label style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: bold; display: block;">Employee Name</label>
                <strong style="font-size: 1.05rem; color: #1e293b;">${employeeName}</strong>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Request Type</label><br>
                <strong style="color: #1e293b;">${leaveType}</strong>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Duration</label><br>
                <strong style="font-size: 1rem; color: #1e293b;">${displayDuration}</strong>
            </div>
            <div style="grid-column: span 2;">
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Reason</label><br>
                <span style="font-size: 0.9rem; color: #334155; font-style: italic;">"${cleanReason}"</span>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Status</label><br>
                <strong style="font-size: 1rem; color: ${statusColor};">${currentStatus}</strong>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Dates</label><br>
                <span>${startDate} to ${endDate}</span>
            </div>
        </div>

        <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Current Approver</label><br>
            <span style="color: #2563eb; font-weight: 600;"><i class="fas fa-user-tie"></i> ${currentApprover}</span>
        </div>

        ${attachmentHtml}
        ${timelineHtml}
    `;

    // --- 8. BUTTON LOGIC (Standard centering) ---
    const approveBtn = document.getElementById("modalApproveBtn");
    const rejectBtn = document.getElementById("modalRejectBtn");
    [approveBtn, rejectBtn].forEach(btn => {
        btn.style.display = "inline-flex"; btn.style.alignItems = "center";
        btn.style.justifyContent = "center"; btn.style.gap = "8px"; btn.className = "btn";
    });

    const setBackButtonStyle = (btn) => {
        btn.style.background = "white"; btn.style.color = "#64748b";
        btn.style.border = "1px solid #cbd5e1"; btn.innerHTML = 'Go Back';
        btn.onclick = () => closeReviewModal();
    };

    if (actionType === "Approved") {
        approveBtn.style.background = "#10b981"; approveBtn.style.color = "white";
        approveBtn.style.borderColor = "#10b981";
        if (isCancellationFlow) {
            approveBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Cancel';
            approveBtn.onclick = () => submitDecision(leaveId, "Approved");
        } else {
            approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
            approveBtn.onclick = () => {
                if (l2Container.style.display !== "none" && !l2Select.value) {
                    Swal.fire("Action Required", "Please select a Dept Head.", "warning");
                    return; 
                }
                submitDecision(leaveId, "Approved");
            };
        }
        setBackButtonStyle(rejectBtn);
    } else {
        rejectBtn.style.background = "#ef4444"; rejectBtn.style.color = "white";
        rejectBtn.style.borderColor = "#ef4444";
        if (isCancellationFlow) {
            rejectBtn.innerHTML = '<i class="fas fa-times-circle"></i> Deny Request';
            rejectBtn.onclick = () => submitDecision(leaveId, "Rejected");
        } else {
            rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
            rejectBtn.onclick = () => submitDecision(leaveId, "Rejected");
        }
        setBackButtonStyle(approveBtn);
    }

    if (modal) modal.style.display = "flex";
}

// üßπ RESET BUTTON LOGIC FOR MANAGER LEAVE QUEUE
function resetManagerLeaveFilters() {
    // 1. Clear Text and Date Inputs
    if (document.getElementById("mgr_search_name")) document.getElementById("mgr_search_name").value = "";
    if (document.getElementById("mgr_search_date")) document.getElementById("mgr_search_date").value = "";
    if (document.getElementById("mgr_search_end_date")) document.getElementById("mgr_search_end_date").value = "";

    // 2. Reset Dropdowns to default
    if (document.getElementById("mgr_search_type")) document.getElementById("mgr_search_type").selectedIndex = 0;
    if (document.getElementById("mgr_search_status")) document.getElementById("mgr_search_status").selectedIndex = 0;

    // 3. Reset Pagination and Reload Data
    mgrCurrentPage = 1;
    loadManagerRequests();
}

      /**
       * üöÄ NEW HELPER FUNCTION
       * Fills the L2 Dropdown with managers (excluding the current user)
       */
      async function populateL2ManagerDropdown() {
        const select = document.getElementById("l2_manager_select");
        if (!select) return;

        // Reset the dropdown
        select.innerHTML =
          '<option value="" disabled selected>-- Choose Level 2 Approver --</option>';

        try {
          // 1. üöÄ CHANGE: Use /users/all so we can see roles (Admin vs Manager)
          const res = await fetchWithAuth(`${API_URL}/users/all`);
          if (!res || !res.ok) throw new Error("Could not fetch managers");

          const users = await res.json();

          // 2. üöÄ THE FILTER LOGIC
          const eligibleManagers = users.filter((u) => {
            // Must be marked as Senior Manager
            const isSenior = u.is_senior_manager === true;

            // ‚õî Must NOT be HR Admin (Blocks Natasha)
            const isNotAdmin = u.role !== "hr_admin";

            // Must not be the person currently logged in (Sarah can't pick Sarah)
            const isNotSelf = u.username !== currentUser;

            return isSenior && isNotAdmin && isNotSelf;
          });

          if (eligibleManagers.length === 0) {
            select.innerHTML =
              '<option value="" disabled>No eligible L2 Managers found</option>';
            return;
          }

          // 3. Populate (Using Full Name to match your table display preference)
          eligibleManagers.forEach((mgr) => {
            select.innerHTML += `<option value="${mgr.full_name}">${mgr.full_name}</option>`;
          });
        } catch (e) {
          console.error("L2 Dropdown error:", e);
          select.innerHTML = '<option value="">Error loading managers</option>';
        }
      }

      // 2. CLOSE MODAL
      function closeReviewModal() {
        document.getElementById("reviewModal").style.display = "none";
      }

      /**
       * ‚öñÔ∏è Step 1: Handle Leave Decisions (Approve/Reject)
       * This function is called by the modal buttons in processApproval()
       */
      /**
       * ‚öñÔ∏è Step 1: Handle Leave Decisions (Approve/Reject)
       * This function is called by the modal buttons in processApproval()
       */
       async function submitDecision(leaveId, status) {
    const remarks = document.getElementById("mgr_review_remarks").value;
    const l2Container = document.getElementById("l2SelectorContainer");
    
    // üõ°Ô∏è Safe Access
    const l2Select = document.getElementById("l2_manager_select");
    const l2Name = l2Select ? l2Select.value : "";
    const approverName = localStorage.getItem("currentUser");

    // 1. Validation: L2 Selection Check
    if (status === "Approved" && l2Container && l2Container.style.display !== "none" && !l2Name) {
        Swal.fire({
            title: "Routing Required",
            text: "Please select a Department Head (L2 Approver) to route this request.",
            icon: "warning",
            confirmButtonColor: "#f59e0b"
        });
        return;
    }

    try {
        let url = `${API_URL}/leaves/manager/action/${leaveId}?status=${status}&remarks=${encodeURIComponent(remarks)}&approver_name=${encodeURIComponent(approverName)}`;

        if (status === "Approved" && l2Name) {
            url += `&l2_name=${encodeURIComponent(l2Name)}`;
        }

        // Show a subtle loading state
        Swal.fire({
            title: 'Processing Decision...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        const res = await fetchWithAuth(url, { method: "POST" });
        if (!res) return;

        if (res.ok) {
            // üõ°Ô∏è 1. LOCK THIS ID: Prevents opening the modal again
            if (typeof processedActionIds !== 'undefined') {
                processedActionIds.add(leaveId);
            }

            // üöÄ 2. OPTIMISTIC UI: Remove row INSTANTLY using the unique ID
            // This is the specific fix for the "Pending Leave still showing" bug
            const row = document.getElementById(`mgr_row_${leaveId}`);
            if (row) {
                row.style.opacity = "0";
                row.style.transform = "translateX(20px)";
                setTimeout(() => row.remove(), 300); // Remove from DOM after fade
            }

            // --- SMART MESSAGING LOGIC ---
            let modalTitle = "";
            let modalMsg = "";
            let iconType = "success";

            if (status === "Rejected") {
                modalTitle = "Request Rejected";
                modalMsg = "The request has been rejected and closed.";
                iconType = "info"; 
            } else if (l2Name) {
                modalTitle = "Routed for Final Approval";
                modalMsg = `Request routed to <strong>${l2Name}</strong>.`;
            } else {
                modalTitle = "Request Approved";
                modalMsg = "The request has been successfully processed.";
            }

            // Close the Review Modal FIRST
            closeReviewModal();

            // Show Success Message
            await Swal.fire({
                title: modalTitle,
                html: modalMsg,
                icon: iconType,
                confirmButtonColor: '#2563eb',
                confirmButtonText: 'OK',
                allowOutsideClick: false
            });

            // 3. REFRESH DATA (Background Sync)
            console.log("üîÑ Synchronizing queue...");
            await loadManagerRequests(); 
            
            if (typeof refreshManagerBadges === "function") {
                refreshManagerBadges();
            }

        } else {
            const err = await res.json();
            Swal.fire({
                title: "Action Failed",
                text: err.detail || "Could not process request.",
                icon: "error",
                confirmButtonColor: "#ef4444"
            });
        }
    } catch (e) {
        console.error("Decision Submission Error:", e);
        Swal.fire({
            title: "Network Error",
            text: "Could not reach the server.",
            icon: "error",
            confirmButtonColor: "#ef4444"
        });
    }
}

 // üöÄ THE FIX: Unified Cancel Logic (Fixed ReferenceError & Zero-Freeze)
 async function cancelLeave(id, currentStatus) {
    // üõ°Ô∏è SAFETY GUARD: Prevent double-clicking
    if (typeof processedActionIds !== 'undefined' && processedActionIds.has(id)) {
        return; 
    }

    if (currentStatus === "Approved") {
        // üü° Approved Leave: Route to the Reason-Prompt workflow
        if (typeof requestCancelLeave === "function") {
            requestCancelLeave(id);
        } else {
            Swal.fire("UI Error", "Cancellation workflow missing. Please contact Admin.", "error");
        }
    } else {
        // üî¥ Pending Leave: Use the high-stability Red Confirm Modal
        Swal.fire({
            title: 'Delete Request?',
            text: "Are you sure you want to permanently delete this pending request?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444', 
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Yes, Delete'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    Swal.fire({
                        title: 'Deleting...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });

                    // üõ°Ô∏è LOCK ID immediately to prevent race conditions
                    if (typeof processedActionIds !== 'undefined') processedActionIds.add(id);

                    const res = await fetchWithAuth(`${API_URL}/leaves/${id}/cancel`, { 
                        method: "PUT" 
                    });

                    if (!res) return;

                    if (res.ok) {
                        Swal.fire({
                            title: 'Deleted',
                            text: "Request deleted successfully.",
                            icon: 'success',
                            confirmButtonColor: '#2563eb'
                        }).then(() => {
                            // üîÑ REFRESH DATA
                            if (typeof loadHistory === "function") {
                                loadHistory(historyCurrentPage, historyPageSize);
                            }
                            if (typeof prefetchBalances === "function") prefetchBalances();
                        });
                    } else {
                        // If failed, UNLOCK the ID so they can try again
                        if (typeof processedActionIds !== 'undefined') processedActionIds.delete(id);
                        
                        const err = await res.json();
                        Swal.fire("Error", err.detail || "Could not delete request.", "error");
                    }
                } catch(e) {
                    console.error("Cancel Leave Error:", e);
                    // If network error, UNLOCK the ID
                    if (typeof processedActionIds !== 'undefined') processedActionIds.delete(id);
                    Swal.fire("Network Error", "Connection failed.", "error");
                }
            }
        });
    }
}

// üöÄ THE MISSING WORKER: Sends the cancellation reason to the Python Backend
// üöÄ THE MISSING WORKER: Sends the cancellation reason to the Python Backend
/**
 * üöÄ EXECUTION WORKER (Shared by Leave & OT)
 * Sends the cancellation request to the backend.
 */
 async function executeCancellationSubmit(id, source, reason) {
    // üõ°Ô∏è 1. SAFETY CHECK: Stop if we are already processing this ID
    if (typeof processedActionIds !== 'undefined' && processedActionIds.has(id)) {
        return; 
    }

    const endpoint = (source === "OT")
        ? `${API_URL}/overtime/${id}/cancel`
        : `${API_URL}/leaves/${id}/cancel`;

    try {
        // üõ°Ô∏è 2. LOCK THE ID
        if (typeof processedActionIds !== 'undefined') processedActionIds.add(id);

        Swal.fire({ 
            title: 'Submitting Request...', 
            allowOutsideClick: false, 
            didOpen: () => { Swal.showLoading(); } 
        });

        const res = await fetchWithAuth(endpoint, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reason: reason }),
        });

        if (!res) {
            if (typeof processedActionIds !== 'undefined') processedActionIds.delete(id);
            return;
        }

        if (res.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Request Submitted',
                text: 'Your cancellation request has been sent to your Manager.',
                confirmButtonColor: '#2563eb'
            }).then(() => {
                // üîÑ THE REFRESH FIX
                if (typeof loadHistory === "function") {
                    // Safety check: Use global variables if they exist, otherwise default to 1
                    const p = (typeof historyCurrentPage !== 'undefined') ? historyCurrentPage : 1;
                    const s = (typeof historyPageSize !== 'undefined') ? historyPageSize : 10;
                    loadHistory(p, s);
                }
                // Also refresh badges if the function exists
                if (typeof refreshManagerBadges === "function") {
                    refreshManagerBadges();
                }
            });
        } else {
            // üîì UNLOCK ID
            if (typeof processedActionIds !== 'undefined') processedActionIds.delete(id);

            const err = await res.json();
            Swal.fire("Error", err.detail || "Failed to submit request.", "error");
        }
    } catch (e) {
        // üîì UNLOCK ID
        if (typeof processedActionIds !== 'undefined') processedActionIds.delete(id);

        console.error("Cancel Request Error:", e);
        Swal.fire("Network Error", "Please check your connection.", "error");
    }
}

      function logout() {
        // 1. Clear the "Active Tab" memory so the next login starts at Home
        sessionStorage.removeItem("activeTab");

        // 2. Clear authentication data
        localStorage.removeItem("currentUser");
        localStorage.removeItem("userRoles"); // Good to clear roles too for security

        // 3. Redirect
        window.location.href = "login.html";
      }

      // Team Leave Balance
      // FETCH TEAM BALANCES (ENTITLEMENTS)
   // üåé Global Store for Filtering (Optional, but good for performance)

// üöÄ MERGED FUNCTION: Load Team Balances + Filters + Overtime
async function loadTeamEntitlements() {
    const tbody = document.getElementById("mgrEntitlementTableBody");
    const loader = document.getElementById("entitlementLoader");

    if (!tbody) return;

    // Get Inputs
    const searchInput = document.getElementById("mgr_ent_search_name");
    const searchTerm = searchInput ? searchInput.value.trim() : "";
    const isHRView = document.getElementById("viewModeToggle")?.checked;
    const year = new Date().getFullYear();

    // Prepare URL
    let fetchUrl = isHRView 
        ? `${API_URL}/leaves/admin/entitlements` 
        : `${API_URL}/leaves/manager/entitlements`;

    // Show Loader
    tbody.innerHTML = `<tr><td colspan='10' class='text-center'><i class='fas fa-spinner fa-spin'></i> Syncing ${isHRView ? 'Company' : 'Team'} Balances...</td></tr>`;
    if (loader) loader.style.display = "block";

    try {
        const params = new URLSearchParams({
            approver_name: currentUser.full_name || currentUser, 
            year: year,
            user_role: isHRView ? "hr_admin" : "manager",
            include_pending: isHRView ? "true" : "false", 
            name: searchTerm 
        });

        const res = await fetchWithAuth(`${fetchUrl}?${params.toString()}`);
        if (!res) return;

        const data = await res.json();
        
        // SAVE TO GLOBAL CACHE
        teamEntitlementCache = data; 

        // Hide Loader & Render
        if (loader) loader.style.display = "none";
        
        // Initial Render
        applyFiltersAndRender();

    } catch (e) {
        console.error("Entitlement Load Error:", e);
        if (tbody) tbody.innerHTML = `<tr><td colspan='10' class='text-center' style='color:red;'>Failed to load entitlement data.</td></tr>`;
    }
}

// üöÄ 2. SORT FUNCTION (Triggered by Header Clicks)
function sortTeamTable(key) {
    // Toggle Direction
    if (currentSort.key === key) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.key = key;
        currentSort.direction = 'desc'; // Default to Descending (Highest First)
    }

    // Update Icons Visually
    document.querySelectorAll('thead i').forEach(i => {
        i.className = 'fas fa-sort'; // Reset all
        i.style.color = '#cbd5e1';
    });
    const activeIcon = document.getElementById(`sort-icon-${key}`);
    if (activeIcon) {
        activeIcon.className = currentSort.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
        activeIcon.style.color = '#3b82f6'; // Active Blue
    }

    // Perform Sort on Global Cache
    teamEntitlementCache.sort((a, b) => {
        let valA = a[key];
        let valB = b[key];

        // Handle text sorting (Case insensitive)
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();

        // Handle numeric/null sorting
        if (valA === null || valA === undefined) valA = 0;
        if (valB === null || valB === undefined) valB = 0;

        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });

    // Re-Render Table with sorted data
    applyFiltersAndRender();
}

// üöÄ 3. RENDER ENGINE (Draws the HTML)
function applyFiltersAndRender() {
    const tbody = document.getElementById("mgrEntitlementTableBody");
    const statusSelect = document.getElementById("mgr_ent_status_filter");
    const statusFilter = statusSelect ? statusSelect.value : "All";
    const year = new Date().getFullYear();

    if (!tbody) return;

    // Client-Side Status Filter
    const filteredData = teamEntitlementCache.filter(emp => {
        if (statusFilter === "All") return true;
        const empStatus = emp.status || "Active"; 
        return empStatus === statusFilter;
    });

    if (filteredData.length === 0) {
        tbody.innerHTML = `<tr><td colspan='10' class='text-center' style='padding:30px; color:#64748b;'>No records found matching status '${statusFilter}'.</td></tr>`;
        return;
    }

    tbody.innerHTML = "";

    // Generate Rows
    filteredData.forEach(emp => {
        // A. Helper: Beautiful Pills
        const createPill = (rem, total, color) => {
            const pct = total > 0 ? (rem / total) * 100 : 0;
            return `
            <div style="min-width: 100px; margin-bottom: 5px;">
                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 700; color: #475569;">
                    <span>${rem}/${total}</span>
                    <span>${Math.round(pct)}%</span>
                </div>
                <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 2px;">
                    <div style="width: ${pct}%; height: 100%; background: ${color}; transition: width 0.5s ease-in-out;"></div>
                </div>
            </div>`;
        };

        // B. Helper: Status Badge
        const isInactive = emp.status === "Inactive";
        const statusBadge = isInactive 
            ? `<span style="background: #fef2f2; color: #b91c1c; padding: 4px 12px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; border: 1px solid #fecaca; display: inline-flex; align-items: center; gap: 6px;">
                <i class="fas fa-times-circle"></i> Inactive</span>`
            : `<span style="background: #f0fdf4; color: #15803d; padding: 4px 12px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; border: 1px solid #bbf7d0; display: inline-flex; align-items: center; gap: 6px;">
                <i class="fas fa-check-circle"></i> Active</span>`;

        const rowStyle = isInactive ? "opacity: 0.6; background: #fafafa;" : "";

        // C. Helper: Values
        const unpaidDisplay = (emp.unpaid_taken > 0)
             ? `<div style="background: #fef2f2; color: #ef4444; padding: 6px 12px; border-radius: 6px; font-weight: 800; font-size: 0.85rem; border: 1px solid #fecaca; display: inline-block; min-width: 50px; text-align: center;">${emp.unpaid_taken}d</div>`
             : `<span style="color:#cbd5e1;">-</span>`;

        const cfDisplay = (emp.carry_forward_total > 0)
            ? `<div style="background: #f0f9ff; color: #0ea5e9; padding: 6px 12px; border-radius: 6px; font-weight: 800; font-size: 0.85rem; border: 1px solid #bae6fd; display: inline-block; min-width: 50px; text-align: center;">${emp.carry_forward_total}d</div>`
            : `<span style="color:#cbd5e1;">-</span>`;

        const otDisplay = (emp.overtime_bank > 0)
            ? `<div style="background: #fff7ed; color: #c2410c; padding: 6px 12px; border-radius: 6px; font-weight: 800; font-size: 0.85rem; border: 1px solid #fed7aa; display: inline-block; min-width: 50px; text-align: center;">${emp.overtime_bank}h</div>`
            : `<span style="color:#cbd5e1;">-</span>`;

        // D. Build HTML
        tbody.innerHTML += `
        <tr style="${rowStyle} border-bottom: 1px solid #f1f5f9;">
            <td class="col-emp" style="padding: 12px 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 32px; height: 32px; background: #eff6ff; color: #1d4ed8; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 800; border: 1px solid #dbeafe;">
                        ${emp.name.charAt(0)}
                    </div>
                    <div>
                        <strong>${emp.name}</strong><br>
                        <small style="color: #64748b;">CYCLE: ${year}</small>
                    </div>
                </div>
            </td>
            
            <td>${createPill(emp.annual_remaining, emp.annual_entitlement, "#2563eb")}</td>
            <td>${createPill(emp.medical_remaining, emp.medical_entitlement, "#10b981")}</td>
            <td>${createPill(emp.emergency_remaining, emp.emergency_entitlement, "#6366f1")}</td>
            <td>${createPill(emp.compassionate_remaining, emp.compassionate_entitlement, "#8b5cf6")}</td>
            
            <td class="text-center">${otDisplay}</td>
            <td class="text-center">${unpaidDisplay}</td>
            <td class="text-center">${cfDisplay}</td>
            <td class="text-center">${statusBadge}</td>
            
            <td class="text-center">
                <button class="icon-btn" onclick="showBalanceLogs('${emp.name}')" title="View Logs" style="border: 1px solid #e2e8f0;">
                    <i class="fas fa-history" style="color: #64748b;"></i>
                </button>
            </td>
        </tr>`;
    });
}

// üöÄ 4. RESET FUNCTION (Uses new render system)
function resetBalanceFilters() {
    const searchInput = document.getElementById("mgr_ent_search_name");
    const statusSelect = document.getElementById("mgr_ent_status_filter");

    if (searchInput) searchInput.value = "";
    if (statusSelect) statusSelect.value = "All"; 

    // Reset sort state
    currentSort = { key: null, direction: 'asc' };
    document.querySelectorAll('thead i').forEach(i => {
        i.className = 'fas fa-sort';
        i.style.color = '#cbd5e1';
    });

    loadTeamEntitlements(); 
}

async function showBalanceLogs(empName) {
        document.getElementById("logEmployeeName").innerText = empName;
        const modal = document.getElementById("balanceLogsModal");
        const content = document.getElementById("logsModalContent");

        modal.style.display = "flex";
        content.innerHTML =
          "<p class='text-center'><i class='fas fa-spinner fa-spin'></i> Loading audit trail...</p>";

        try {
          // 1. Fetch History Logs (Existing Logic)
          const res = await fetchWithAuth(
            `${API_URL}/leaves/manager/balance-history?name=${encodeURIComponent(
              empName
            )}`
          );

          if (!res) return;

          const data = await res.json();
          const currentYear = new Date().getFullYear();

          const unpaidDisplay = data.unpaid_total || 0;
          const cfDisplay = data.cf_total || 0;

          // üöÄ NEW: Get Overtime from Global Cache (Since balance-history endpoint might not have it yet)
          // We look up the employee in the list we just loaded in the main table
          const cachedEmp = teamEntitlementCache.find(e => e.name === empName);
          const otDisplay = cachedEmp ? (cachedEmp.overtime_bank || 0) : 0;

          // üöÄ GRID LAYOUT: Ensures all boxes are exactly the same size
          let summaryHtml = `
      <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px;">
          <div style="font-size: 0.8rem; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 12px; letter-spacing: 0.5px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px;">
              <i class="fas fa-calendar-check"></i> ${currentYear} Entitlements
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">`;

          // 1. Standard Entitlements
          data.entitlements
            .filter((ent) => !ent.type.toLowerCase().includes("unpaid"))
            .forEach((ent) => {
              const label = ent.type.replace(" Leave", "");
              summaryHtml += `
          <div style="background: white; padding: 10px 15px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
              <span style="color: #64748b; font-weight: 500;">${label}:</span> 
              <strong style="color: #1e293b;">${ent.days}d</strong>
          </div>`;
            });

          // üöÄ 2. NEW: Overtime Box (Orange Style)
          summaryHtml += `
          <div style="background: #fff7ed; padding: 10px 15px; border-radius: 6px; border: 1px solid #fed7aa; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
              <span style="color: #c2410c; font-weight: 500;">Overtime:</span> 
              <strong style="color: #9a3412;">${otDisplay}h</strong>
          </div>`;

          // 3. Unpaid Box (Red Style)
          summaryHtml += `
          <div style="background: #fef2f2; padding: 10px 15px; border-radius: 6px; border: 1px solid #fca5a5; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
              <span style="color: #b91c1c; font-weight: 500;">Unpaid:</span> 
              <strong style="color: #ef4444;">${unpaidDisplay}d</strong>
          </div>`;

          // 4. CF Banked Box (Blue Style)
          summaryHtml += `
          <div style="background: #eff6ff; padding: 10px 15px; border-radius: 6px; border: 1px solid #93c5fd; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
              <span style="color: #1d4ed8; font-weight: 500;">Carry Forward:</span> 
              <strong style="color: #0ea5e9;">${cfDisplay}d</strong>
          </div>`;

          summaryHtml += `</div></div>`;

          // 5. Table Section (Preserved as is)
          let tableHtml = `
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 10;">
                            <tr style="text-align: left; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding:12px;">Date</th>
                                <th style="padding:12px;">Action</th>
                                <th style="padding:12px; text-align:center;">Status</th>
                                <th style="padding:12px; text-align:center;">Days</th>
                            </tr>
                        </thead>
                        <tbody>`;

          // ... (Your Existing Table Logic Below) ...
          if (data.logs.length === 0) {
            tableHtml += `<tr><td colspan="4" class="text-center" style="padding: 20px; color: #94a3b8;">No records found.</td></tr>`;
          } else {
            data.logs.forEach((log) => {
              const statusClass = `status-${log.status
                .toLowerCase()
                .replace(" ", "-")}`;
              let dayDisplay = "0";
              let dayStyle = "color: #64748b;";
              let actionDisplay = `<strong>${log.action}</strong><br><small style="color:#64748b">${log.leave_type}</small>`;

              // üöÄ CARRY FORWARD ROW LOGIC
              if (log.is_cf) {
                actionDisplay = `<strong style="color: #0ea5e9;"><i class="fas fa-piggy-bank"></i> Carry Forward</strong><br><small style="color:#64748b">Annual Leave</small>`;
                if (log.status === "Approved") {
                  dayDisplay = log.days; // Preserved your fix (no + sign)
                  dayStyle = "color: #0ea5e9; font-weight: bold;";
                }
              }
              // üöÄ CANCELLATION ROW LOGIC (Money Back)
              else if (
                log.action === "Cancellation Request" &&
                log.status === "Cancelled"
              ) {
                dayDisplay = "+" + log.days;
                dayStyle = "color: #166534; font-weight: bold;";
              }
              // üöÄ SPENDING ROW LOGIC (Deduction)
              else if (
                log.status === "Approved" ||
                (log.action === "Cancellation Request" &&
                  log.status === "Cancel Rejected")
              ) {
                dayDisplay = "-" + log.days;
                dayStyle = "color: #991b1b; font-weight: bold;";
              }

              tableHtml += `
                      <tr style="border-bottom: 1px solid #f1f5f9;">
                          <td style="padding:12px 10px; color:#64748b;">${log.date}</td>
                          <td style="padding:12px 10px;">${actionDisplay}</td>
                          <td style="padding:12px 10px; text-align:center;">
                              <span class="status-badge ${statusClass}" style="font-size: 0.7rem; padding: 3px 8px;">${log.status}</span>
                          </td>
                          <td style="padding:12px 10px; text-align:center; ${dayStyle} font-size: 1rem;">
                              ${dayDisplay}
                          </td>
                      </tr>`;
            });
          }

          tableHtml += "</tbody></table></div>";
          content.innerHTML = summaryHtml + tableHtml;
        } catch (e) {
          console.error("Audit Trail Load Error:", e);
          content.innerHTML =
            "<p style='color:red; text-align:center;'>Error loading audit trail. Please try again.</p>";
        }
      }

      /* =========================================
         1. LOAD APPROVERS (Populates all 4 lists)
         ========================================= */
      async function loadApproverList() {
        // IDs for: Standard Leave, Overtime, Carry Forward, Registration
        const ids = [
          "dash_approver",
          "dash_approver_ot",
          "dash_approver_cf",
          "reg_manager",
        ];
        const selects = ids
          .map((id) => document.getElementById(id))
          .filter((el) => el);

        if (selects.length === 0) return;

        const placeholderHTML =
          '<option value="" disabled selected hidden>-- Select Manager --</option>';
        const loadingHTML =
          '<option value="" disabled selected>Loading...</option>';

        // Set visual loading state
        selects.forEach((sel) => (sel.innerHTML = loadingHTML));

        try {
          const res = await fetchWithAuth(`${API_URL}/users/all`);
          if (!res || !res.ok) throw new Error("Failed to fetch approvers");

          const allUsers = await res.json();

          // Filter: Active Managers, NOT HR Admins
          const validApprovers = allUsers.filter((u) => {
            if (!u.is_active) return false;
            const isManager =
              u.role === "manager" ||
              (u.roles_list && u.roles_list.includes("manager"));
            const isAdmin =
              u.role === "hr_admin" ||
              (u.roles_list && u.roles_list.includes("hr_admin"));
            return isManager && !isAdmin;
          });

          // Reset and Populate
          selects.forEach((sel) => {
            sel.innerHTML = placeholderHTML;
            validApprovers.forEach((mgr) => {
              sel.add(new Option(mgr.full_name, mgr.full_name));
            });
            // Force value to empty string so 'required' works correctly
            sel.value = "";
          });

          console.log("‚úÖ Approvers loaded into all dropdowns.");
        } catch (e) {
          console.error("Approver Load Error:", e);
        }
      }

      async function resetUserPassword(userId) {
        // 1. Grab the value from the new input field
        const inputField = document.getElementById("admin_reset_pass_input");
        const customPass = inputField.value.trim();

        // 2. Logic: Use custom pass if typed, otherwise default to '123'
        const finalPass = customPass || "password123";

        if (
          !confirm(
            `Are you sure you want to reset this user's password to '${finalPass}'?`
          )
        ) {
          return;
        }

        try {
          // üöÄ THE UPDATE: We now send a JSON body with the password
          const res = await fetchWithAuth(
            `${API_URL}/users/${userId}/reset-password`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ new_password: finalPass }),
            }
          );

          if (!res) return;

          if (res.ok) {
            const data = await res.json();
            alert(`‚úÖ Success: ${data.message}`);

            // 3. Clear the field and reset eye toggle for next time
            inputField.value = "";
            inputField.type = "password";
          } else {
            const err = await res.json();
            alert("‚ùå Error: " + (err.detail || "Could not reset password."));
          }
        } catch (e) {
          console.error("Password reset error:", e);
          alert("‚ùå Network Error: Could not reach the server.");
        }
      }

      async function submitRoleChange() {
        const userId = document.getElementById("edit_user_id").value;

        // 1. Gather all selected roles into an array
        const selectedRoles = ["employee"]; // Employee is always included by default

        if (document.getElementById("role_manager").checked) {
          selectedRoles.push("manager");
        }
        if (document.getElementById("role_hr").checked) {
          selectedRoles.push("hr_admin");
        }

        const formData = new FormData();
        // 2. We send the array as a JSON string so the backend can easily decode it
        formData.append("roles", JSON.stringify(selectedRoles));

        try {
          // üöÄ THE FIX: Change 'fetch' to 'fetchWithAuth'
          // This ensures the X-Session-ID and X-Requester-Name headers are attached
          const res = await fetchWithAuth(
            `${API_URL}/users/${userId}/roles-update`,
            {
              method: "PUT",
              body: formData,
            }
          );

          // fetchWithAuth returns null if the session is invalid/expired
          if (!res) return;

          if (res.ok) {
            alert("‚úÖ Access levels updated successfully!");
            document.getElementById("editUserModal").style.display = "none";
            await loadAllUsers(); // Refresh the HR table
          } else {
            const errData = await res.json();
            alert(`‚ùå Failed: ${errData.detail || "Update error"}`);
          }
        } catch (e) {
          console.error("Role update error:", e);
          alert("‚ùå Network error: Check backend connection.");
        }
      }

      // The Toggle Script for System Admin
      function toggleAdminMenu() {
        const subMenu = document.getElementById("adminSubMenu");
        const chevron = document.getElementById("adminChevron");

        if (subMenu.style.display === "none") {
          subMenu.style.display = "block";
          chevron.style.transform = "rotate(180deg)"; // Rotates arrow up
        } else {
          subMenu.style.display = "none";
          chevron.style.transform = "rotate(0deg)"; // Rotates arrow back down
        }
      }

// üåê Global Cache for Bulletproof Data Passing
window.companyHolidaysCache = [];

// 1. Fetch and Display Holidays for Admin
async function loadAdminHolidays() {
  const tbody = document.getElementById("adminHolidayTableBody");
  if (!tbody) return;

  // Visual Loading State
  tbody.innerHTML = "<tr><td colspan='4' class='text-center' style='padding: 40px; color: #94a3b8;'><i class='fas fa-circle-notch fa-spin'></i> Syncing calendar...</td></tr>";

  try {
    const res = await fetchWithAuth(`${API_URL}/leaves/public-holidays`);
    if (!res || !res.ok) return;

    let holidays = await res.json();
    window.companyHolidaysCache = holidays; // üöÄ Save to global cache
    tbody.innerHTML = "";

    // Sort by Date (Ascending)
    holidays.sort((a, b) => new Date(a.holiday_date) - new Date(b.holiday_date));

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (holidays.length === 0) {
      tbody.innerHTML = "<tr><td colspan='4' class='text-center' style='padding: 40px; color: #94a3b8;'>No holidays found. Add one above!</td></tr>";
      return;
    }

    // Render Rows
    holidays.forEach((h) => {
      // üöÄ Timezone-safe date parsing
      const [y, m, d] = h.holiday_date.split("-");
      const hDate = new Date(y, m - 1, d);

      const isPast = hDate < today;
      const statusBadge = isPast
        ? `<span style="background: #f1f5f9; color: #64748b; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; border: 1px solid #e2e8f0;">COMPLETED</span>`
        : `<span style="background: #ecfccb; color: #166534; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; border: 1px solid #d9f99d;">UPCOMING</span>`;

      const dateStr = hDate.toLocaleDateString("en-GB", {
        weekday: "short", day: "2-digit", month: "short", year: "numeric",
      });

      // üöÄ THE FIX: Pass ONLY the ID instead of the full JSON object
      tbody.innerHTML += `
        <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.1s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
            <td style="padding: 15px 30px;">
                <div style="font-weight: 600; color: #334155; font-family: monospace; font-size: 0.95rem;">${dateStr}</div>
            </td>
            <td style="padding: 15px;">
                <div style="font-weight: 700; color: #1e293b;">${h.name}</div>
                <div style="font-size: 0.7rem; color: #64748b;">All States</div>
            </td>
            <td style="padding: 15px; text-align: center;">
                ${statusBadge}
            </td>
            <td style="padding: 15px; text-align: center;">
                <div style="display: flex; gap: 8px; justify-content: center;">
                    <button class="icon-btn" onclick="openEditHolidayModal(${h.id})" title="Edit" style="color: #3b82f6; border-color: #dbeafe; background: #eff6ff;">
                       <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-btn" onclick="deleteHoliday(${h.id})" title="Delete" style="color: #ef4444; border-color: #fee2e2; background: #fef2f2;">
                       <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </td>
        </tr>`;
    });
  } catch (e) {
    console.error("Holiday Load Error:", e);
    tbody.innerHTML = "<tr><td colspan='4' class='text-center' style='color:red; padding: 20px;'>Failed to load schedule.</td></tr>";
  }
}

// üöÄ THE FIX: Breakout Method & Global Cache
function openEditHolidayModal(id) {
  // Find the data securely from the cache
  const holiday = window.companyHolidaysCache.find(h => h.id === id);
  if (!holiday) return;

  const modal = document.getElementById("editHolidayModal");
  if (!modal) return;

  // Breakout of hidden containers
  document.body.appendChild(modal);
  modal.style.zIndex = "99999";

  document.getElementById("edit_holiday_id").value = holiday.id;
  document.getElementById("edit_holiday_date").value = holiday.holiday_date;
  document.getElementById("edit_holiday_name").value = holiday.name;
  modal.style.display = "flex";
}

function closeEditHolidayModal() {
  document.getElementById("editHolidayModal").style.display = "none";
}

// üöÄ THE FIX: Upgraded Delete button to use SweetAlert instead of the broken generic modal
function deleteHoliday(id) {
  Swal.fire({
    title: 'Delete Holiday?',
    html: "Are you sure you want to remove this holiday?<br>This will immediately affect leave duration calculations.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#cbd5e1',
    confirmButtonText: 'Yes, Delete'
  }).then((result) => {
    if (result.isConfirmed) {
      executeDeleteHoliday(id);
    }
  });
}

// üöÄ THE FIX: Upgraded Execution with Loading Spinners
async function executeDeleteHoliday(id) {
  try {
    Swal.fire({ title: 'Deleting...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    const res = await fetchWithAuth(`${API_URL}/leaves/public-holidays/${id}`, { method: "DELETE" });

    if (!res) return; 

    if (res.ok) {
      Swal.fire("Deleted!", "Holiday removed successfully.", "success");
      
      await loadAdminHolidays();
      if (typeof loadPublicHolidays === "function") {
        await loadPublicHolidays();
      }
    } else {
      const err = await res.json();
      Swal.fire("Error", err.detail || "Failed to delete holiday.", "error");
    }
  } catch (e) {
    console.error("Holiday Delete Error:", e);
    Swal.fire("Network Error", "Check server connection.", "error");
  }
}




      // // Company Calendar
      // // 1. Fetch and Display Holidays for Admin
      // // üöÄ HR ADMIN: High-Fidelity Calendar Management
      // async function loadAdminHolidays() {
      //   const tbody = document.getElementById("adminHolidayTableBody");
      //   if (!tbody) return;

      //   // Visual Loading State
      //   tbody.innerHTML =
      //     "<tr><td colspan='4' class='text-center' style='padding: 40px; color: #94a3b8;'><i class='fas fa-circle-notch fa-spin'></i> Syncing calendar...</td></tr>";

      //   try {
      //     // 1. Fetch Data
      //     const res = await fetchWithAuth(`${API_URL}/leaves/public-holidays`);
      //     if (!res || !res.ok) return;

      //     let holidays = await res.json();
      //     tbody.innerHTML = "";

      //     // 2. Sort by Date (Ascending)
      //     holidays.sort(
      //       (a, b) => new Date(a.holiday_date) - new Date(b.holiday_date)
      //     );

      //     // 3. Get Today for comparison (to decide badge color)
      //     const today = new Date();
      //     today.setHours(0, 0, 0, 0);

      //     if (holidays.length === 0) {
      //       tbody.innerHTML =
      //         "<tr><td colspan='4' class='text-center' style='padding: 40px; color: #94a3b8;'>No holidays found. Add one above!</td></tr>";
      //       return;
      //     }

      //     // 4. Render Rows
      //     holidays.forEach((h) => {
      //       const hDate = new Date(h.holiday_date);
      //       hDate.setHours(0, 0, 0, 0);

      //       // Determine Status (Past or Upcoming)
      //       const isPast = hDate < today;
      //       const statusBadge = isPast
      //         ? `<span style="background: #f1f5f9; color: #64748b; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; border: 1px solid #e2e8f0;">COMPLETED</span>`
      //         : `<span style="background: #ecfccb; color: #166534; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; border: 1px solid #d9f99d;">UPCOMING</span>`;

      //       // Format Date (e.g. "Mon, 01 Jan 2026")
      //       const dateStr = hDate.toLocaleDateString("en-GB", {
      //         weekday: "short",
      //         day: "2-digit",
      //         month: "short",
      //         year: "numeric",
      //       });

      //       const hData = JSON.stringify(h).replace(/'/g, "&apos;");

      //       tbody.innerHTML += `
      //         <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.1s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                  
      //             <td style="padding: 15px 30px;">
      //                 <div style="font-weight: 600; color: #334155; font-family: monospace; font-size: 0.95rem;">${dateStr}</div>
      //             </td>
                  
      //             <td style="padding: 15px;">
      //                 <div style="font-weight: 700; color: #1e293b;">${h.name}</div>
      //                 <div style="font-size: 0.7rem; color: #64748b;">All States</div>
      //             </td>
                  
      //             <td style="padding: 15px; text-align: center;">
      //                 ${statusBadge}
      //             </td>
                  
      //             <td style="padding: 15px; text-align: center;">
      //                 <div style="display: flex; gap: 8px; justify-content: center;">
      //                     <button class="icon-btn" onclick='openEditHolidayModal(${hData})' title="Edit" style="color: #3b82f6; border-color: #dbeafe; background: #eff6ff;">
      //                        <i class="fas fa-edit"></i>
      //                     </button>
      //                     <button class="icon-btn" onclick="deleteHoliday(${h.id})" title="Delete" style="color: #ef4444; border-color: #fee2e2; background: #fef2f2;">
      //                        <i class="fas fa-trash-alt"></i>
      //                     </button>
      //                 </div>
      //             </td>
      //         </tr>`;
      //     });
      //   } catch (e) {
      //     console.error("Holiday Load Error:", e);
      //     tbody.innerHTML =
      //       "<tr><td colspan='4' class='text-center' style='color:red; padding: 20px;'>Failed to load schedule.</td></tr>";
      //   }
      // }

      // 2. Loader for regular Employee Holiday View
      // üöÄ EMPLOYEE VIEW: Professional Holiday Timeline (Merged & Secured)
      async function loadPublicHolidays() {
        const container = document.getElementById("holidayTimelineContainer");
        if (!container) return;

        try {
          // üöÄ SECURE FETCH: Uses your fetchWithAuth logic
          const res = await fetchWithAuth(`${API_URL}/leaves/public-holidays`);

          // Safety check for 401/unauthorized or server errors
          if (!res || !res.ok) throw new Error("Unauthorized or server error");

          let holidays = await res.json();
          container.innerHTML = "";

          if (!holidays || holidays.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#64748b;">No holidays scheduled for this year.</div>`;
            return;
          }

          // 1. üìÖ Sort by Date (Oldest to Newest)
          holidays.sort(
            (a, b) => new Date(a.holiday_date) - new Date(b.holiday_date)
          );

          const today = new Date();
          today.setHours(0, 0, 0, 0);

          let nextHolidayFound = false;

          // 2. üé® Render as Timeline Cards
          container.innerHTML = holidays
            .map((h) => {
              const hDate = new Date(h.holiday_date);
              hDate.setHours(0, 0, 0, 0);

              const isPast = hDate < today;

              // Design Logic: Past holidays are dimmed; the next holiday is highlighted blue
              let borderStyle = "border: 1px solid #e2e8f0;";
              let highlightBadge = "";
              let opacity = "1";

              if (isPast) {
                opacity = "0.5";
              } else if (!nextHolidayFound) {
                nextHolidayFound = true;
                borderStyle =
                  "border: 1.5px solid #0ea5e9; background: #f0f9ff; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.1);";
                highlightBadge = `<span style="background:#0ea5e9; color:white; padding:2px 8px; border-radius:4px; font-size:0.6rem; font-weight:800; margin-left:10px; text-transform:uppercase;">Upcoming Next</span>`;
              }

              const dayNum = hDate.getDate();
              const monthName = hDate
                .toLocaleDateString("en-US", { month: "short" })
                .toUpperCase();
              const weekDay = hDate.toLocaleDateString("en-US", {
                weekday: "long",
              });

              return `
              <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px; opacity: ${opacity}; transition: all 0.2s;">
                  <div style="width: 50px; text-align: center; flex-shrink: 0;">
                      <div style="font-size: 0.65rem; font-weight: 800; color: #94a3b8;">${monthName}</div>
                      <div style="font-size: 1.3rem; font-weight: 800; color: #1e293b; line-height: 1;">${dayNum}</div>
                  </div>

                  <div style="flex: 1; padding: 15px 20px; border-radius: 12px; ${borderStyle} display: flex; justify-content: space-between; align-items: center; background: white;">
                      <div>
                          <div style="font-weight: 700; color: #1e293b; font-size: 0.95rem; display: flex; align-items: center;">
                            ${h.name} ${highlightBadge}
                          </div>
                          <div style="font-size: 0.75rem; color: #64748b; margin-top: 3px;">
                            <i class="far fa-calendar-check" style="margin-right: 5px;"></i> ${weekDay} ‚Ä¢ All States
                          </div>
                      </div>
                      <i class="fas fa-chevron-right" style="color: #cbd5e1; font-size: 0.8rem;"></i>
                  </div>
              </div>`;
            })
            .join("");
        } catch (e) {
          console.error("Holiday UI Error:", e);
          container.innerHTML = `<div style="color:red; text-align:center; padding:20px;">Unable to load holiday schedule.</div>`;
        }
      }

      // 2. Add New Holiday
// 2. Add New Holiday (Upgraded to SweetAlert)
async function addCompanyHoliday(event) {
        // 1. üõ°Ô∏è Official browser refresh block
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        const startDateEl = document.getElementById("new_holiday_date");
        const endDateEl = document.getElementById("new_holiday_end_date");
        const nameEl = document.getElementById("new_holiday_name");

        // Basic validation
        if (!startDateEl.value || !nameEl.value) {
          Swal.fire("Missing Info", "Please provide at least a Start Date and a Holiday Name.", "warning");
          return false;
        }

        // 2. Determine the range of dates to process
        let datesToProcess = [];
        const startStr = startDateEl.value;
        const endStr = endDateEl.value;

        if (!endStr || endStr === startStr) {
          // Only one day provided or Start/End are the same
          datesToProcess.push(startStr);
        } else {
          // Multi-day holiday range
          let current = new Date(startStr);
          let end = new Date(endStr);

          if (end < current) {
            Swal.fire("Invalid Date", "End date cannot be earlier than the start date.", "error");
            return false;
          }

          // Loop to generate all date strings between Start and End
          while (current <= end) {
            datesToProcess.push(current.toISOString().split("T")[0]);
            current.setDate(current.getDate() + 1);
          }
        }

        // 3. User Confirmation for bulk additions
        if (datesToProcess.length > 1) {
          const confirmRes = await Swal.fire({
            title: 'Add Multiple Days?',
            text: `This will add ${datesToProcess.length} individual days for "${nameEl.value}". Proceed?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#2563eb',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Yes, Add Days'
          });
          
          if (!confirmRes.isConfirmed) return false;
        }

        try {
          // Show Loading Spinner
          Swal.fire({ 
            title: 'Adding Holiday...', 
            allowOutsideClick: false, 
            didOpen: () => { Swal.showLoading(); } 
          });

          // 4. Send each date to the backend
          // We use a loop here to ensure the backend receives each day as a separate holiday record
          for (const hDate of datesToProcess) {
            const formData = new FormData();
            formData.append("holiday_date", hDate);
            formData.append("name", nameEl.value);

            const res = await fetchWithAuth(
              `${API_URL}/leaves/public-holidays`,
              {
                method: "POST",
                body: formData,
              }
            );

            if (!res.ok) {
              const errorDetail = await res.json();
              console.error(`Failed to add ${hDate}:`, errorDetail.detail);
            }
          }

          // 5. Success Pop-up!
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: `Successfully added ${datesToProcess.length} day(s) to the calendar.`,
            confirmButtonColor: '#10b981'
          });

          // Reset the fields
          startDateEl.value = "";
          endDateEl.value = "";
          nameEl.value = "";

          // 6. Refresh the table and stay on the section
          await loadAdminHolidays();
          showSection("hr_holidays");
        } catch (e) {
          console.error("System Error:", e);
          Swal.fire("System Error", "Could not reach the server.", "error");
        }

        return false;
      }

 // üöÄ GENERIC CONFIRMATION MODAL HELPER
 function openGenericConfirm(title, message, btnText, btnColor, callback) {
        const modal = document.getElementById("universalModal");
        
        // üöÄ THE FIX: Force this modal to be the absolute top layer on screen
        // 2147483647 is the maximum Z-Index value allowed in browsers.
        modal.style.zIndex = "2147483647"; 
        
        const content = document.getElementById("uModalContent");
        const icon = document.getElementById("uModalIcon");
        const titleEl = document.getElementById("uModalTitle");
        const descEl = document.getElementById("uModalDesc");
        const warnBox = document.getElementById("uModalWarningBox");
        const confirmBtn = document.getElementById("uModalConfirmBtn");

        // 1. Reset & Setup UI
        if (warnBox) warnBox.style.display = "none";
        modal.style.display = "flex";

        // 2. Set Content
        titleEl.innerText = title;
        descEl.innerHTML = message;
        confirmBtn.innerText = btnText;
        confirmBtn.style.backgroundColor = btnColor;

        // 3. Set Color Theme based on action type
        if (btnColor === "#ef4444" || btnColor === "#dc2626") {
          content.style.borderTopColor = "#ef4444";
          icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
          icon.style.color = "#ef4444";
        } else {
          content.style.borderTopColor = btnColor;
          icon.innerHTML = '<i class="fas fa-info-circle"></i>';
          icon.style.color = btnColor;
        }

        // 4. Bind the Callback Action
        confirmBtn.onclick = async () => {
          closeUniversalModal();
          if (typeof callback === "function") {
            await callback();
          }
        };
      }

      /**
       * üìä Audit Analytics Engine
       * Updates the three summary cards at the top of the System Audit Log.
       */
/**
       * üìä Audit Analytics Engine
       * Calculates real-time stats for the Natasha's Command Center.
       */
       function updateAuditAnalytics() {
        if (!masterAuditData || masterAuditData.length === 0) return;

        const today = new Date().toLocaleDateString("en-CA"); // "YYYY-MM-DD"
        const currentMonth = today.substring(0, 7); // Result: "2026-02"

        // üöÄ 1. Update the Month Name Label in the UI
        const monthName = new Date().toLocaleString('default', { month: 'long' });
        document.querySelectorAll(".current-month-name").forEach(el => el.innerText = monthName);

        // ‚úÖ 2. Calculate 'Away Today' (Approved leaves active right now)
        const away = masterAuditData.filter(
          (r) =>
            r.record_source === "LEAVE" && // Ensure we only count leaves, not OT
            r.status === "Approved" &&
            today >= r.start_date &&
            today <= r.end_date
        ).length;

        // ‚úÖ 3. Calculate 'Pending Actions' (All Leave + OT awaiting decision)
        const pending = masterAuditData.filter((r) =>
          r.status.includes("Pending")
        ).length;

        // ‚úÖ 4. Calculate 'Unpaid Days' for the current month
        const unpaidDays = masterAuditData
          .filter(
            (r) =>
              r.leave_type === "Unpaid Leave" &&
              r.status === "Approved" &&
              r.start_date.startsWith(currentMonth)
          )
          .reduce((sum, r) => sum + parseFloat(r.days_taken || 0), 0);

        // üñ•Ô∏è Inject values into the UI
        const awayEl = document.getElementById("stat_away_today");
        const pendingEl = document.getElementById("stat_pending_all");
        const unpaidEl = document.getElementById("stat_monthly_unpaid");

        if (awayEl) awayEl.innerText = away;
        if (pendingEl) pendingEl.innerText = pending;
        if (unpaidEl) {
            // Display with 1 decimal if needed (e.g., 1.5d)
            unpaidEl.innerText = (unpaidDays % 1 === 0) ? unpaidDays + "d" : unpaidDays.toFixed(1) + "d";
        }

        console.log(`üìä Analytics Sync: ${away} Away, ${pending} Pending, ${unpaidDays} Unpaid.`);
      }

      // --- SYSTEM AUDIT LOG ---
      // üöÄ Helper: Auto-generate Year Options (Current Year -> Back 3 Years)
      function populateAuditYearDropdown() {
        const select = document.getElementById("audit_filter_year");
        if (!select) return;

        const currentYear = new Date().getFullYear();
        let optionsHtml = '<option value="">All Time</option>';

        for (let i = 0; i < 4; i++) {
          const year = currentYear - i;
          // Select current year by default
          const selected = i === 0 ? "selected" : "";
          optionsHtml += `<option value="${year}" ${selected}>${year}</option>`;
        }
        select.innerHTML = optionsHtml;
      }

      // üöÄ MAIN FUNCTION: Loads the Audit Interface
 // ==========================================
// 1. GLOBALS & LOAD FUNCTION
// ==========================================

async function loadGlobalAuditLogs() {
    const section = document.getElementById("hr_audit");
    
    // 1. Reset State
    auditCurrentPage = 1; 

    // 2. Generate Year Dropdown
    const currentYear = new Date().getFullYear();
    let yearOptions = '<option value="">All Time</option>';
    for (let i = 0; i < 5; i++) {
        const year = currentYear - i;
        const selected = i === 0 ? "selected" : "";
        yearOptions += `<option value="${year}" ${selected}>${year}</option>`;
    }

    // 3. Inject HTML Structure (Analytics Grid + Existing Table Card)
    section.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px;">
        <div class="card" style="margin: 0; padding: 20px; border-left: 5px solid #3b82f6; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
            <div style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Away Today</div>
            <div id="stat_away_today" style="font-size: 2.2rem; font-weight: 800; color: #1e293b; margin-top: 8px; line-height: 1;">0</div>
            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
                <i class="fas fa-info-circle"></i> Approved active leaves
            </div>
        </div>
        <div class="card" style="margin: 0; padding: 20px; border-left: 5px solid #f59e0b; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
            <div style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Pending Actions</div>
            <div id="stat_pending_all" style="font-size: 2.2rem; font-weight: 800; color: #1e293b; margin-top: 8px; line-height: 1;">0</div>
            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
                <i class="fas fa-clock"></i> Awaiting Manager/L2 review
            </div>
        </div>
        <div class="card" style="margin: 0; padding: 20px; border-left: 5px solid #ef4444; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
            <div style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Monthly Unpaid</div>
            <div id="stat_monthly_unpaid" style="font-size: 2.2rem; font-weight: 800; color: #1e293b; margin-top: 8px; line-height: 1;">0d</div>
            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
                <i class="fas fa-calendar-alt"></i> Unpaid days in <span class="current-month-name">this month</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin:0; border: none; padding-bottom: 0;"><i class="fas fa-clipboard-list"></i> System Audit Log</h2>
            <div style="display: flex; gap: 10px;">
              <button class="btn-secondary" onclick="exportAuditLogCSV()" style="font-size: 0.8rem; height: 38px; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-file-download"></i> Export CSV
              </button>
            </div>
        </div>

        <div class="filter-bar" style="background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 20px; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
            <div class="filter-group">
                <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Search Employee</label>
                <input type="text" id="audit_search_name" placeholder="Name..." oninput="applyAuditFilters()" style="padding: 10px; width: 100%; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box;">
            </div>
            <div class="filter-group">
                <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase;">Type</label>
                <select id="audit_filter_type" onchange="applyAuditFilters()" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="">All Types</option>
                    <option>Annual Leave</option><option>Medical Leave</option><option>Unpaid Leave</option><option value="OT">Overtime</option>
                </select>
            </div>
            <div class="filter-group">
                <label style="font-size: 0.7rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Status</label>
                <select id="audit_filter_status" onchange="applyAuditFilters()" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="">All Status</option>
                    <option>Approved</option><option>Pending</option><option>Rejected</option><option>Cancelled</option><option>Pending Cancel</option><option>Withdrawn</option>
                </select>
            </div>
            <div class="filter-group">
                <label style="font-size: 0.7rem; font-weight: 800; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase;">Year</label>
                <select id="audit_filter_year" onchange="applyAuditFilters()" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    ${yearOptions}
                </select>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn" onclick="event.preventDefault(); loadGlobalAuditLogs();" style="height: 38px; width: 40px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Refresh Data">
                    <i class="fas fa-sync"></i>
                </button>
                <button class="btn-secondary" onclick="resetAuditFilters()" style="height: 38px; background: #64748b; color: white; border: none; padding: 0 15px; font-weight: bold; border-radius: 6px; font-size: 0.8rem;" title="Clear All Filters">
                    CLEAR
                </button>
            </div>
        </div>

        <div class="table-scroll-container" style="max-height: 550px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px 8px 0 0; background: #ffffff; margin-bottom: 0;">
            <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
                <thead style="position: sticky; top: 0; z-index: 10;">
                    <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                        <th onclick="sortAuditTable('id')" style="width: 10%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: left; cursor: pointer; user-select: none;">Ref ID <i id="audit-sort-id" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i></th>
                        <th onclick="sortAuditTable('employee_name')" style="width: 22%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: left; cursor: pointer; user-select: none;">Employee <i id="audit-sort-employee_name" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i></th>
                        <th onclick="sortAuditTable('leave_type')" style="width: 15%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: left; cursor: pointer; user-select: none;">Type <i id="audit-sort-leave_type" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i></th>
                        <th onclick="sortAuditTable('days_taken')" style="width: 8%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: center; cursor: pointer; user-select: none;">Duration <i id="audit-sort-days_taken" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i></th>
                        <th onclick="sortAuditTable('start_date')" style="width: 15%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: center; cursor: pointer; user-select: none;">Dates <i id="audit-sort-start_date" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i></th>
                        <th onclick="sortAuditTable('approver_name')" style="width: 15%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: left; cursor: pointer; user-select: none;">Current Owner <i id="audit-sort-approver_name" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i></th>
                        <th onclick="sortAuditTable('status')" style="width: 10%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: center; cursor: pointer; user-select: none;">Status <i id="audit-sort-status" class="fas fa-sort" style="margin-left: 5px; color: #cbd5e1;"></i></th>
                        <th style="width: 5%; padding: 12px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; text-align: center;">Action</th>
                    </tr>
                </thead>
                <tbody id="globalAuditTableBody">
                    <tr><td colspan="8" class="text-center" style="padding: 50px; color: #94a3b8;"><i class="fas fa-spinner fa-spin"></i> Initializing logs...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; margin-bottom: 20px;">
            <button class="btn-secondary" id="auditPrevBtn" onclick="changeAuditPage(-1)" disabled style="font-size: 0.8rem; padding: 6px 15px; height: 32px;"><i class="fas fa-chevron-left"></i> Previous</button>
            <span id="auditPageInfo" style="font-size: 0.85rem; font-weight: 600; color: #64748b;">Page 1</span>
            <button class="btn-secondary" id="auditNextBtn" onclick="changeAuditPage(1)" style="font-size: 0.8rem; padding: 6px 15px; height: 32px;">Next <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>`;

    // 4. Fetch & Normalize Data
    try {
        const [leaveRes, otRes] = await Promise.all([
          fetchWithAuth(`${API_URL}/leaves/admin/audit-logs`),
          fetchWithAuth(`${API_URL}/overtime/all-requests`),
        ]);

        const leaves = leaveRes && leaveRes.ok ? await leaveRes.json() : [];
        const otsRaw = otRes && otRes.ok ? await otRes.json() : [];

        // Normalize Leaves (Add numeric sort value)
        const normalizedLeaves = leaves.map(l => ({
            ...l,
            record_source: "LEAVE",
            sort_val_duration: parseFloat(l.days_taken || 0)
        }));

        // Normalize Overtime (Add numeric sort value)
        const normalizedOTs = otsRaw.map((o) => ({
          ...o,
          record_source: "OT",
          leave_type: o.ot_type,
          days_taken: `${o.total_value} ${o.ot_unit}`,
          sort_val_duration: parseFloat(o.total_value || 0),
          start_date: o.ot_date,
          end_date: o.ot_date
        }));

        // Combine & Store
        masterAuditData = [...normalizedLeaves, ...normalizedOTs];

        // Initial Analytics & Render
        if (typeof updateAuditAnalytics === "function") updateAuditAnalytics();
        applyAuditFilters();

    } catch (e) {
        console.error("Audit Load Error:", e);
        document.getElementById("globalAuditTableBody").innerHTML = `<tr><td colspan="8" class="text-center text-danger">Failed to load data.</td></tr>`;
    }
}
      /**
       * Generates a professional ID like AL0001 or OT0025
       * @param {number} id - The database primary key
       * @param {string} type - The leave or overtime type string
       */
      /**
       * üÜî Unified ID Generator
       * Converts numeric IDs to professional codes (e.g., AL0001, UL0023)
       */
      function getDisplayID(id, type) {
        if (!id) return "---";
        let prefix = "LV";
        const t = (type || "").toLowerCase();

        if (t.includes("annual")) prefix = "AL";
        else if (t.includes("medical") || t.includes("sick")) prefix = "MC";
        else if (t.includes("emergency")) prefix = "EL";
        else if (t.includes("compassionate")) prefix = "CP";
        // üöÄ 2026 Update: Assign UL prefix for Unpaid Leave
        else if (t.includes("unpaid")) prefix = "UL";
        else if (
          t.includes("overtime") ||
          ["regular", "weekend", "holiday"].includes(t)
        )
          prefix = "OT";

        return `${prefix}${id.toString().padStart(4, "0")}`;
      }

      // ==========================================
      // üöÄ SYSTEM AUDIT LOG LOGIC (The Brain)
      // ==========================================



      // 1. Pagination Switcher
      function changeAuditPage(step) {
        auditCurrentPage += step;
        if (auditCurrentPage < 1) auditCurrentPage = 1;
        applyAuditFilters();
      }

      // 2. The Filter Engine
// ==========================================
// 2. The Filter Engine (Fixed & Verified)
// ==========================================
function applyAuditFilters() {
    // A. Get Filter Inputs (Your original code)
    const nameEl = document.getElementById("audit_search_name");
    const typeEl = document.getElementById("audit_filter_type");
    const yearEl = document.getElementById("audit_filter_year");
    const statusEl = document.getElementById("audit_filter_status");

    // Safe access to values
    const nameQuery = nameEl ? nameEl.value.toLowerCase() : "";
    const typeQuery = typeEl ? typeEl.value : "";
    const yearQuery = yearEl ? yearEl.value : "";
    const statusQuery = statusEl ? statusEl.value : "";

    // B. Filter the full Master Data array
    // üöÄ CRITICAL CHANGE: We assign this to the GLOBAL 'filteredAuditData' 
    // so the Sort function can access it.
    filteredAuditData = masterAuditData.filter((log) => {
        // 1. Name Match
        const matchesName = (log.employee_name || "").toLowerCase().includes(nameQuery);

        // 2. Type Match
        let matchesType = true;
        if (typeQuery === "OT") matchesType = log.record_source === "OT";
        else if (typeQuery) matchesType = log.leave_type === typeQuery;

        // 3. Status Match
        const matchesStatus = !statusQuery || log.status === statusQuery;

        // 4. Year Match (Restored your safer 'startsWith' logic)
        const logDate = log.start_date || "";
        const matchesYear = !yearQuery || logDate.startsWith(yearQuery);

        return matchesName && matchesType && matchesStatus && matchesYear;
    });

    // C. Handover to Render Engine
    // We removed the manual pagination/rendering code from here 
    // because sortAndRenderAudit() handles it after sorting.
    auditCurrentPage = 1;
    sortAndRenderAudit(); 
}

      // 3. The Professional Row Renderer
      // 3. The Professional Row Renderer (with Smart Duration Pills)
      function renderAuditTable(data) {
        const tbody = document.getElementById("globalAuditTableBody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="8" class="text-center" style="padding:50px; color:#94a3b8;">
                <i class="fas fa-search" style="font-size:1.5rem; margin-bottom:10px;"></i><br>No matching logs found.
            </td></tr>`;
          return;
        }

        data.forEach((log) => {
          try {
            // üé® 1. Avatar Initials
            const initials = (log.employee_name || "??")
              .split(" ")
              .map((n) => n[0])
              .slice(0, 2)
              .join("")
              .toUpperCase();

            // üé® 2. Status Pills
            let statusBadge = `<span class="status-badge" style="background:#f1f5f9; color:#475569;">${log.status}</span>`;
            if (log.status === "Approved")
              statusBadge = `<span class="status-badge" style="background:#dcfce7; color:#166534;">Approved</span>`;
            else if (log.status.includes("Pending"))
              statusBadge = `<span class="status-badge" style="background:#fef9c3; color:#854d0e;">${log.status}</span>`;
            else if (log.status === "Rejected")
              statusBadge = `<span class="status-badge" style="background:#fee2e2; color:#991b1b;">Rejected</span>`;
            else if (log.status === "Cancelled")
              statusBadge = `<span class="status-badge" style="background:#f1f5f9; color:#475569; text-decoration:line-through;">Cancelled</span>`;

            // üé® 3. Date Formatting
            const dateDisplay =
              log.start_date === log.end_date
                ? `<span style="font-weight:600; color:#334155;">${log.start_date}</span>`
                : `<div style="display:flex; flex-direction:column; font-size:0.75rem;">
                     <span>${log.start_date}</span>
                     <span style="color:#94a3b8; font-size:0.6rem;">to</span>
                     <span>${log.end_date}</span>
                   </div>`;

            // üé® 4. ID Formatting
            const refID = `#${
              log.record_source === "OT" ? "OT" : "LV"
            }-${String(log.id).padStart(4, "0")}`;
            const clickAction =
              log.record_source === "OT"
                ? `viewOTDetails(${JSON.stringify(log).replace(
                    /'/g,
                    "&apos;"
                  )})`
                : `viewLeaveDetails(${JSON.stringify(log).replace(
                    /'/g,
                    "&apos;"
                  )})`;

            // üé® 5. SMART DURATION LOGIC (The New Feature) üåü
            // We parse the string (e.g. "4.0 hours" -> 4.0)
            let rawVal = parseFloat(log.days_taken);
            // Detect unit based on string content
            let isHours = (log.days_taken + "").toLowerCase().includes("hour");

            let durIcon = isHours ? "fa-clock" : "fa-calendar-day";
            let durUnit = isHours ? "HRS" : "DAYS";
            let durColor = isHours ? "#ea580c" : "#0f172a"; // Orange for hours, Dark for days
            let durBg = isHours ? "#fff7ed" : "#f1f5f9";

            const durationPill = `
                <div style="display:inline-flex; align-items:center; gap:6px; background:${durBg}; border:1px solid #e2e8f0; padding:4px 8px; border-radius:6px;">
                    <i class="fas ${durIcon}" style="font-size:0.7rem; color:#94a3b8;"></i>
                    <span style="font-weight:800; color:${durColor}; font-size:0.85rem;">${rawVal}</span>
                    <span style="font-size:0.65rem; font-weight:700; color:#94a3b8; margin-top:1px;">${durUnit}</span>
                </div>
            `;

            // RENDER ROW
            const row = `
            <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.1s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                
                <td style="padding: 12px 15px; color:#64748b; font-family:monospace; font-weight:700; font-size:0.8rem;">
                    ${refID}
                </td>
                
                <td style="padding: 12px 15px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:30px; height:30px; background:#e0f2fe; color:#0369a1; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.7rem; font-weight:800;">${initials}</div>
                        <span style="font-weight:600; color:#1e293b; font-size:0.85rem;">${
                          log.employee_name
                        }</span>
                    </div>
                </td>

                <td style="padding: 12px 15px; color:#475569; font-size:0.85rem;">${
                  log.leave_type
                }</td>
                
                <td style="padding: 12px 15px; text-align:center;">
                    ${durationPill}
                </td>

                <td style="padding: 12px 15px; text-align:center;">${dateDisplay}</td>
                
                <td style="padding: 12px 15px; color:#64748b; font-size:0.8rem;">
                    <i class="fas fa-user-tie" style="margin-right:5px; color:#cbd5e1;"></i>
                    ${log.approver_name || "‚Äî"}
                </td>

                <td style="padding: 12px 15px; text-align:center;">${statusBadge}</td>

                <td style="padding: 12px 15px; text-align:center;">
                    <button class="icon-btn" onclick='${clickAction}' title="View Details" 
                            style="width:30px; height:30px; padding:0 !important; border:1px solid #e2e8f0; border-radius:6px; display:inline-flex; align-items:center; justify-content:center;">
                        <i class="fas fa-eye" style="color:#2563eb;"></i>
                    </button>
                </td>
            </tr>`;

            tbody.insertAdjacentHTML("beforeend", row);
          } catch (err) {
            console.error("Error rendering audit row:", err);
          }
        });
      }

      function handleDateChange() {
        const startVal = document.getElementById("dash_start").value;
        const isHalf = document.getElementById("dash_half_day").checked;
        document.getElementById("dash_end").min = startVal;
        if (isHalf) {
          document.getElementById("dash_end").value = startVal;
        }
      }

      function formatDateNice(dateStr) {
        if (!dateStr) return "-";
        // Splitting manually prevents timezone "day-back" bugs in some browsers
        const [year, month, day] = dateStr.split("-");
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        return `${day} ${months[parseInt(month) - 1]} ${year}`;
      }

      // function openEditHolidayModal(holiday) {
      //   document.getElementById("edit_holiday_id").value = holiday.id;
      //   document.getElementById("edit_holiday_date").value =
      //     holiday.holiday_date;
      //   document.getElementById("edit_holiday_name").value = holiday.name;
      //   document.getElementById("editHolidayModal").style.display = "flex";
      // }

      // function closeEditHolidayModal() {
      //   document.getElementById("editHolidayModal").style.display = "none";
      // }

// 3. Edit Holiday (Upgraded to SweetAlert)
async function submitHolidayEdit() {
        const id = document.getElementById("edit_holiday_id").value;
        const dateVal = document.getElementById("edit_holiday_date").value;
        const nameVal = document.getElementById("edit_holiday_name").value;

        const formData = new FormData();
        formData.append("holiday_date", dateVal);
        formData.append("name", nameVal);

        try {
          // Show Loading Spinner
          Swal.fire({ 
            title: 'Updating...', 
            allowOutsideClick: false, 
            didOpen: () => { Swal.showLoading(); } 
          });

          const res = await fetchWithAuth(
            `${API_URL}/leaves/public-holidays/${id}`,
            {
              method: "PUT",
              body: formData,
            }
          );

          if (!res) return;

          if (res.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Updated!',
                text: 'Holiday updated successfully.',
                confirmButtonColor: '#10b981'
            });
            closeEditHolidayModal();
            loadAdminHolidays();
            
            // Safety check to ensure the employee calendar refreshes too
            if (typeof loadPublicHolidays === "function") {
                loadPublicHolidays();
            }
          } else {
            const err = await res.json();
            Swal.fire("Update Failed", err.detail || "Server error", "error");
          }
        } catch (e) {
          console.error("Holiday Edit Error:", e);
          Swal.fire("Network Error", "Could not connect to server.", "error");
        }
      }
      // ‚ùå DELETE the second formatDateNice that was here

      function updateMgrCharCount() {
        const textarea = document.getElementById("mgr_review_remarks");
        const countSpan = document.getElementById("mgr_char_count");
        if (!textarea || !countSpan) return;

        const length = textarea.value.length;
        countSpan.innerText = `${length} / 200`;

        if (length >= 180) {
          countSpan.style.color = "#ef4444";
        } else {
          countSpan.style.color = "#94a3b8";
        }
      }

      function restrictDateToCurrentYear() {
        const currentYear = new Date().getFullYear();
        const startInput = document.getElementById("dash_start");
        const endInput = document.getElementById("dash_end");

        if (startInput && endInput) {
          // Sets the clickable range in the calendar to Jan 1st - Dec 31st
          startInput.min = `${currentYear}-01-01`;
          startInput.max = `${currentYear}-12-31`;
          endInput.min = `${currentYear}-01-01`;
          endInput.max = `${currentYear}-12-31`;
        }
      }

      // Execute the restriction immediately
      restrictDateToCurrentYear();

      /* =========================================
         üöÄ HR POLICY: COMMAND CENTER UI (Modern Upgrade)
         ========================================= */

/* =========================================
         üöÄ HR POLICY: COMMAND CENTER UI (Modern Upgrade)
         ========================================= */

         function renderGlobalPolicyUI() {
        const section = document.getElementById("hr_policy");

        // Dynamic Year Options for CF Filter
// Dynamic Year Options for CF Filter
const currentYear = new Date().getFullYear();
        // üöÄ FIX 1: Set "All Years" as the default selected option
        let yearOptions = `<option value="All" selected>All Years</option>`;
        for (let y = currentYear - 1; y <= currentYear + 1; y++) {
          yearOptions += `<option value="${y}">${y}</option>`;
        }

        section.innerHTML = `
        <div class="card" style="border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 16px; overflow: hidden; padding: 0;">
            
            <div style="padding: 30px 30px 20px 30px; background: white; border-bottom: 1px solid #f1f5f9;">
                <h2 style="margin: 0; font-size: 1.5rem; color: #1e293b; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-file-contract" style="color: #6366f1;"></i> Policy & Entitlements
                </h2>
                <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.9rem;">
                    Configure global leave quotas and manage individual employee balances.
                </p>

                <div style="display: inline-flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-top: 25px; border: 1px solid #e2e8f0;">
                    <button id="btnBulk" onclick="togglePolicyMode('bulk')" 
                        style="padding: 8px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.2s;">
                        <i class="fas fa-globe-americas" style="margin-right: 6px;"></i> Company Defaults
                    </button>
                    <button id="btnIndividual" onclick="togglePolicyMode('individual')" 
                        style="padding: 8px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.2s; color: #64748b; background: transparent;">
                        <i class="fas fa-user-cog" style="margin-right: 6px;"></i> Individual Adjustments
                    </button>
                    <button id="btnCFProcessing" onclick="togglePolicyMode('cf_processing')" 
                        style="padding: 8px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.2s; color: #64748b; background: transparent;">
                        <i class="fas fa-history" style="margin-right: 6px;"></i> CF Processing
                    </button>
                </div>
            </div>

            <div style="padding: 30px; background: #fdfdfd; min-height: 400px;">
                
                <div id="policy_bulk_view">
                    <div style="background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 8px; padding: 15px; margin-bottom: 25px; display: flex; align-items: start; gap: 12px;">
                        <i class="fas fa-info-circle" style="color: #4338ca; margin-top: 2px;"></i>
                        <div style="color: #3730a3; font-size: 0.9rem; line-height: 1.5;">
                            <strong>Global Standards:</strong> Updating these numbers will set the <em>default entitlement</em> for new employees. 
                            <br>You can choose to sync these changes to existing employees by clicking "Update & Sync".
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 800px;">
                        
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <label style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; display: block;">Annual Leave</label>
                            <div style="display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 8px; background: white; overflow: hidden;">
                                <div style="padding: 0 15px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-right: 1px solid #e2e8f0; height: 100%;">
                                    <i class="fas fa-umbrella-beach" style="color: #3b82f6; font-size: 1.1rem;"></i>
                                </div>
                                <input type="number" id="policy_annual" placeholder="14" 
                                    style="flex: 1; width: 100%; padding: 12px 15px; font-size: 1.1rem; font-weight: bold; border: none; outline: none; background: transparent; box-sizing: border-box;">
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <label style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; display: block;">Medical Leave</label>
                            <div style="display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 8px; background: white; overflow: hidden;">
                                <div style="padding: 0 15px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-right: 1px solid #e2e8f0; height: 100%;">
                                    <i class="fas fa-clinic-medical" style="color: #10b981; font-size: 1.1rem;"></i>
                                </div>
                                <input type="number" id="policy_medical" placeholder="14" 
                                    style="flex: 1; width: 100%; padding: 12px 15px; font-size: 1.1rem; font-weight: bold; border: none; outline: none; background: transparent; box-sizing: border-box;">
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <label style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; display: block;">Emergency Leave</label>
                            <div style="display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 8px; background: white; overflow: hidden;">
                                <div style="padding: 0 15px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-right: 1px solid #e2e8f0; height: 100%;">
                                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 1.1rem;"></i>
                                </div>
                                <input type="number" id="policy_emergency" placeholder="2" 
                                    style="flex: 1; width: 100%; padding: 12px 15px; font-size: 1.1rem; font-weight: bold; border: none; outline: none; background: transparent; box-sizing: border-box;">
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <label style="font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; display: block;">Compassionate Leave</label>
                            <div style="display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 8px; background: white; overflow: hidden;">
                                <div style="padding: 0 15px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-right: 1px solid #e2e8f0; height: 100%;">
                                    <i class="fas fa-heart-broken" style="color: #8b5cf6; font-size: 1.1rem;"></i>
                                </div>
                                <input type="number" id="policy_compassionate" placeholder="3" 
                                    style="flex: 1; width: 100%; padding: 12px 15px; font-size: 1.1rem; font-weight: bold; border: none; outline: none; background: transparent; box-sizing: border-box;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="saveGlobalPolicy()" style="background: #3b82f6; height: 50px; font-weight: 700; padding: 0 30px; font-size: 1rem; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);">
                            <i class="fas fa-save" style="margin-right: 8px;"></i> Update & Sync All Employees
                        </button>
                    </div>
                </div>

                <div id="policy_individual_view" style="display: none;">
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 30px; align-items: center; max-width: 700px;">
                        <div style="flex: 1; position: relative;">
                            <i class="fas fa-search" style="position: absolute; left: 15px; top: 15px; color: #94a3b8;"></i>
                            <input type="text" id="policy_user_search" placeholder="Type employee name..." 
                                   oninput="handleLiveSearch(this.value)" 
                                   onkeypress="if(event.key === 'Enter') searchEmployeeForAdjustment()"
                                   style="width: 100%; height: 48px; padding-left: 40px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box;"
                                   autocomplete="off">
                            
                            <div id="employee_suggestions_box" class="suggestion-box" style="display: none; top: 55px;"></div>
                        </div>
                        <button class="btn" onclick="searchEmployeeForAdjustment()" style="height: 48px; padding: 0 25px; background: #334155;">Search</button>
                    </div>

                    <div id="adjustment_form_container" style="display: none; background: #fff; padding: 30px; border-radius: 16px; border: 1px solid #e2e8f0; max-width: 800px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9;">
                             <h4 id="adj_emp_name" style="margin: 0; color: #1e293b; font-size: 1.2rem; display:flex; align-items:center; gap:10px;">
                                <div style="width:32px; height:32px; background:#e0f2fe; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#0369a1;"><i class="fas fa-user-edit"></i></div>
                                <span>Adjusting User</span>
                             </h4>
                             <button class="icon-btn" onclick="resetAdjustmentForm()" style="color:#64748b; border:none; background:transparent;"><i class="fas fa-times"></i></button>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div class="form-group">
                                <label style="font-size: 0.7rem; font-weight: 800; color: #64748b;">ANNUAL LEAVE</label>
                                <input type="number" id="adj_annual" class="saas-form-control">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 0.7rem; font-weight: 800; color: #64748b;">MEDICAL LEAVE</label>
                                <input type="number" id="adj_medical" class="saas-form-control">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 0.7rem; font-weight: 800; color: #64748b;">EMERGENCY LEAVE</label>
                                <input type="number" id="adj_emergency" class="saas-form-control">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 0.7rem; font-weight: 800; color: #64748b;">COMPASSIONATE LEAVE</label>
                                <input type="number" id="adj_compassionate" class="saas-form-control">
                            </div>
                        </div>

                        <button class="btn" onclick="saveIndividualAdjustment()" style="background: #10b981; margin-top: 25px; width: 100%; height: 48px; font-weight: 700; font-size: 1rem;">
                            <i class="fas fa-check-circle" style="margin-right: 8px;"></i> Save Adjustments
                        </button>
                    </div>

                    <div id="adj_placeholder" style="text-align: center; padding: 40px; color: #cbd5e1;">
                         <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i>
                         <p>Search for an employee to adjust their specific entitlements.</p>
                    </div>
                </div>

                <div id="policy_cf_view" style="display: none;">
                    
                  <div style="background: white; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; margin-bottom: 5px; display: block;">SEARCH</label>
                            <input type="text" id="cf_filter_name" class="saas-form-control" placeholder="e.g. Neil..." oninput="loadCFProcessingList()" style="height: 42px; box-sizing: border-box; width: 100%;"> 
                        </div>
                        <div style="width: 140px;">
                            <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; margin-bottom: 5px; display: block;">ORIGIN YEAR</label>
                            <select id="cf_filter_year" class="saas-form-control" onchange="loadCFProcessingList()" style="height: 42px; box-sizing: border-box; width: 100%;">
                                ${yearOptions}
                            </select>
                        </div>
                        <div style="width: 140px;">
                            <label style="font-size: 0.7rem; font-weight: 800; color: #64748b; margin-bottom: 5px; display: block;">STATUS</label>
                            <select id="cf_filter_status" class="saas-form-control" onchange="loadCFProcessingList()" style="height: 42px; box-sizing: border-box; width: 100%;">
                                <option value="Pending">Pending</option>
                                <option value="Merged">Merged</option>
                                <option value="All" selected>Show All</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="loadCFProcessingList()" class="btn-secondary" style="height: 42px; width: 42px; padding: 0; display: flex; align-items: center; justify-content: center; box-sizing: border-box;" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                            <button onclick="exportCFData()" class="btn-secondary" style="height: 42px; width: 42px; padding: 0; display: flex; align-items: center; justify-content: center; color: #10b981; border-color: #bbf7d0; background: #f0fdf4; box-sizing: border-box;" title="Export"><i class="fas fa-file-csv"></i></button>
                        </div>
                    </div>

                    <div id="cf_bulk_actions" style="display: none; background: #eff6ff; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bfdbfe; color: #1e40af; align-items: center; justify-content: space-between;">
                        <span style="font-weight: 700; font-size: 0.9rem;">
                            <i class="fas fa-check-square" style="margin-right: 6px;"></i> <span id="cf_selected_count">0</span> items selected
                        </span>
                        <button onclick="executeBulkMerge()" style="background: #2563eb; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(37,99,235,0.2);">
    <i class="fas fa-layer-group" style="margin-right: 8px;"></i> Proceed
</button>
                    </div>

                    <div class="table-container" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow-y: auto; max-height: 500px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);">
                        <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
                            <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 10;">

                              <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e2e8f0; width: 50px;">
    <input type="checkbox" id="cf_select_all" onclick="toggleSelectAllCF(this)" 
           style="cursor: pointer; width: 18px !important; height: 18px !important; display: block; margin: 0 auto;">
</th>
                                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Employee</th>
                                    <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Flow</th>
                                    <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Amount</th>
                                    <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Preview</th>
                                    <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="cf_processing_table">
                                </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>`;

        loadGlobalPolicy();
      }


      function togglePolicyMode(mode) {
        // A. Get Views
        const bulkView = document.getElementById("policy_bulk_view");
        const individualView = document.getElementById(
          "policy_individual_view"
        );
        const cfView = document.getElementById("policy_cf_view");
        const adjPlaceholder = document.getElementById("adj_placeholder");
        const adjForm = document.getElementById("adjustment_form_container");

        // B. Get Buttons
        const btnBulk = document.getElementById("btnBulk");
        const btnIndividual = document.getElementById("btnIndividual");
        const btnCF = document.getElementById("btnCFProcessing");

        // Helper: Reset Styles
        const resetBtn = (btn) => {
          if (!btn) return;
          btn.style.background = "transparent";
          btn.style.color = "#64748b";
          btn.style.boxShadow = "none";
          btn.style.border = "none";
        };

        const activeBtn = (btn) => {
          if (!btn) return;
          btn.style.background = "white";
          btn.style.color = "#1e293b"; // Dark text
          btn.style.boxShadow = "0 1px 3px rgba(0,0,0,0.1)"; // Subtle lift
          btn.style.border = "1px solid #cbd5e1"; // Border to define it against grey background
        };

        // Reset All
        if (bulkView) bulkView.style.display = "none";
        if (individualView) individualView.style.display = "none";
        if (cfView) cfView.style.display = "none";
        resetBtn(btnBulk);
        resetBtn(btnIndividual);
        resetBtn(btnCF);

        // Activate Mode
        if (mode === "bulk") {
          if (bulkView) bulkView.style.display = "block";
          activeBtn(btnBulk);
        } else if (mode === "individual") {
          if (individualView) individualView.style.display = "block";
          activeBtn(btnIndividual);

          // Ensure placeholder is shown if no user selected
          if (adjForm && adjForm.style.display === "none" && adjPlaceholder) {
            adjPlaceholder.style.display = "block";
          }
        } else if (mode === "cf_processing") {
          if (cfView) cfView.style.display = "block";
          activeBtn(btnCF);
          if (typeof loadCFProcessingList === "function")
            loadCFProcessingList();
        }
      }

      async function saveGlobalPolicy() {
        // 1. Collect values from the UI (with fallback to 0 to prevent NaN errors)
        const settings = {
          annual: parseInt(document.getElementById("policy_annual").value) || 0,
          medical: parseInt(document.getElementById("policy_medical").value) || 0,
          emergency: parseInt(document.getElementById("policy_emergency").value) || 0,
          compassionate: parseInt(document.getElementById("policy_compassionate").value) || 0,
        };

        // üöÄ UPGRADE: SweetAlert2 Confirmation Modal
        Swal.fire({
          title: 'Update Company Policy?',
          html: 'This will change the company-wide leave entitlements for all new cycles.<br><br><span style="color:#2563eb; font-weight:bold;">Syncing will update existing employees.</span>',
          icon: 'warning',
          iconColor: '#3b82f6', // Blue theme for policy update
          showCancelButton: true,
          confirmButtonColor: '#3b82f6',
          cancelButtonColor: '#cbd5e1',
          confirmButtonText: 'Yes, Update & Sync',
          cancelButtonText: 'Cancel'
        }).then(async (result) => {
          if (result.isConfirmed) {
            
            // 2. Show Loading State while backend processes the sync
            Swal.fire({
              title: 'Syncing Employees...',
              html: 'Please wait while we update the company policies.',
              allowOutsideClick: false,
              didOpen: () => { Swal.showLoading(); }
            });

            try {
              const res = await fetchWithAuth(`${API_URL}/leaves/admin/policy`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(settings),
              });

              if (!res) return;

              if (res.ok) {
                // üöÄ UPGRADE: SweetAlert Success
                Swal.fire({
                  icon: 'success',
                  title: 'Policy Updated',
                  text: 'The company standards have been updated successfully and are now active.',
                  confirmButtonColor: '#2563eb'
                });
              } else {
                const err = await res.json();
                Swal.fire({
                  icon: 'error',
                  title: 'Update Failed',
                  text: err.detail || "Server error",
                  confirmButtonColor: '#ef4444'
                });
              }
            } catch (e) {
              console.error("Policy Update Error:", e);
              Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Could not connect to the server. Please check your connection.',
                confirmButtonColor: '#ef4444'
              });
            }
          }
        });
      }

      // ==========================================
      // üöÄ CF PROCESSING & BULK ACTIONS LOGIC (NEW)
      // ==========================================

      let currentCFData = []; // Store data locally for export

      async function loadCFProcessingList() {
        // 1. Get Filter Values from the new HTML inputs
        const nameInput = document.getElementById("cf_filter_name");
        const yearInput = document.getElementById("cf_filter_year");
        const statusInput = document.getElementById("cf_filter_status");

        // Safety check in case HTML isn't updated yet
        if (!nameInput || !yearInput || !statusInput) {
          console.warn("CF Filters not found in DOM yet.");
          return;
        }

        const name = nameInput.value;
        const year = yearInput.value;
        const status = statusInput.value;

        // 2. Reset Bulk UI
        const bulkHeader = document.getElementById("cf_bulk_actions");
        if (bulkHeader) bulkHeader.style.display = "none";

        const selectAllBox = document.getElementById("cf_select_all");
        if (selectAllBox) selectAllBox.checked = false;

        const tbody = document.getElementById("cf_processing_table");
        if (!tbody) return;

        // Show Loading Spinner
        tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:30px;"><i class="fas fa-spinner fa-spin"></i> Loading data...</td></tr>`;

        try {
          // 3. Fetch Data with Query Params
          // Note: We use the endpoint we just fixed in leave.py
          const response = await fetchWithAuth(
            `${API_URL}/leaves/cf-processing-list?name=${name}&year=${year}&status=${status}`
          );

          if (!response.ok) throw new Error("Failed to load list");

          const data = await response.json();
          currentCFData = data; // Save for export usage

          tbody.innerHTML = ""; // Clear loader

          if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:40px; color:#94a3b8;">
                    <i class="fas fa-search" style="font-size: 1.5rem; margin-bottom: 10px;"></i><br>
                    No records found matching filters.
                </td></tr>`;
            return;
          }

          // 4. Render Rows
          data.forEach((item) => {
            const isMerged = item.is_merged;

          // üé® Status Badge Logic
            const statusBadge = isMerged
              ? `<span style="background:#dcfce7; color:#166534; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:bold;">Completed</span>`
              : `<span style="background:#fff7ed; color:#c2410c; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:bold;">Pending Merge</span>`;

              const checkbox = isMerged
  ? `<input type="checkbox" disabled style="width: 18px !important; height: 18px !important; opacity:0.5; cursor: not-allowed; display: block; margin: 0 auto;">`
  : `<input type="checkbox" class="cf-row-checkbox" value="${item.id}" onclick="updateBulkState()" 
            style="width: 18px !important; height: 18px !important; cursor: pointer; display: block; margin: 0 auto;">`;

            // Calculate Projected Balance (Current + CF)
            const newTotal = isMerged 
              ? (item.current_balance_target_year || 0) 
              : (item.current_balance_target_year || 0) + item.cf_days;

            const row = `
                    <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;">
                        <td style="padding: 12px; text-align: center;">${checkbox}</td>
                        <td style="padding: 12px;">
                            <div style="font-weight:600; color: #334155;">${item.employee_name}</div>
                            <div style="font-size:0.75rem; color:#94a3b8;">ID: #${item.id}</div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background:#f1f5f9; padding:2px 8px; border-radius:4px; font-size:0.85rem; border: 1px solid #e2e8f0;">
                                ${item.origin_year} &rarr; ${item.target_year}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight:bold; color: #334155;">${item.cf_days}</td>
                        <td style="padding: 12px; text-align: center; color:#2563eb; font-weight:600;">${newTotal}</td>
                        <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                    </tr>
                `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        } catch (error) {
          console.error(error);
          tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:30px; color:#ef4444;">
                <i class="fas fa-exclamation-triangle"></i> Network Error. Check console.
            </td></tr>`;
        }
      }

      // --- BULK ACTION HANDLERS ---

      function toggleSelectAllCF(source) {
        const checkboxes = document.querySelectorAll(".cf-row-checkbox");
        checkboxes.forEach((cb) => (cb.checked = source.checked));
        updateBulkState();
      }

      // ==========================================
      // üöÄ CF PROCESSING & BULK ACTIONS LOGIC (FINAL)
      // ==========================================

      function updateBulkState() {
        // Count how many are checked
        const selected = document.querySelectorAll(
          ".cf-row-checkbox:checked"
        ).length;
        const actionHeader = document.getElementById("cf_bulk_actions");
        const countSpan = document.getElementById("cf_selected_count");

        if (selected > 0) {
          actionHeader.style.display = "flex"; // Show header
          if (countSpan) countSpan.innerText = selected;
        } else {
          actionHeader.style.display = "none"; // Hide header
        }
      }

      async function executeBulkMerge() {
        const checkboxes = document.querySelectorAll(".cf-row-checkbox:checked");
        const ids = Array.from(checkboxes).map((cb) => parseInt(cb.value));

        if (ids.length === 0) return;

        // üöÄ UPGRADE: Pure SweetAlert2 Implementation (Immune to z-index bugs)
        Swal.fire({
          title: 'Confirm Bulk Merge',
          html: `Are you sure you want to merge <strong>${ids.length} requests</strong>?<br><br><span style="font-size:0.9rem; color:#64748b;">This will officially add the days to their respective next-year balances.</span>`,
          icon: 'info',
          iconColor: '#2563eb',
          showCancelButton: true,
          confirmButtonColor: '#2563eb', // Blue theme
          cancelButtonColor: '#cbd5e1',
          confirmButtonText: 'Yes, Merge All'
        }).then(async (result) => {
          
          if (result.isConfirmed) {
            // ‚è≥ Show Loading Spinner
            Swal.fire({
              title: 'Merging Balances...',
              allowOutsideClick: false,
              didOpen: () => { Swal.showLoading(); }
            });

            try {
              const response = await fetchWithAuth(
                `${API_URL}/leaves/cf-merge-bulk`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ leave_ids: ids }),
                }
              );

              const data = await response.json();

              if (response.ok) {
                // ‚úÖ Success Modal
                Swal.fire({
                  icon: 'success',
                  title: 'Merge Complete',
                  text: data.message,
                  confirmButtonColor: '#10b981'
                });
                
                // üîÑ Refresh table and system badges
                loadCFProcessingList();
                if (typeof refreshManagerBadges === "function") {
                  refreshManagerBadges();
                }
              } else {
                // ‚ùå Backend Error Modal
                Swal.fire({
                  icon: 'error',
                  title: 'Merge Failed',
                  text: data.detail || "Bulk merge failed",
                  confirmButtonColor: '#ef4444'
                });
              }
            } catch (error) {
              console.error("Bulk Merge Error:", error);
              // ‚ùå Network Error Modal
              Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Could not connect to the server.',
                confirmButtonColor: '#ef4444'
              });
            }
          }
        });
      }

      // --- EXPORT & RESET ---

      function resetCFFilters() {
        document.getElementById("cf_filter_name").value = "";
        document.getElementById("cf_filter_year").value = "All"; // üöÄ Match new default
        document.getElementById("cf_filter_status").value = "All"; // üöÄ Match new default
        loadCFProcessingList();
      }

      function exportCFData() {
        if (!currentCFData || currentCFData.length === 0) {
          // üöÄ UPGRADE: Use custom warning modal
          showModal(
            "Export Failed",
            "No data is currently visible to export.",
            "warning"
          );
          return;
        }

        // 1. Create CSV Header
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent +=
          "ID,Employee Name,Origin Year,Target Year,CF Days,Is Merged\n";

        // 2. Add Rows
        currentCFData.forEach((row) => {
          const line = `${row.id},${row.employee_name},${row.origin_year},${
            row.target_year
          },${row.cf_days},${row.is_merged ? "Yes" : "No"}`;
          csvContent += line + "\n";
        });

        // 3. Trigger Download
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute(
          "download",
          `CF_Report_${new Date().toISOString().slice(0, 10)}.csv`
        );
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // üöÄ UPGRADED: Single Merge Action (Now uses Blue Modals too!)
      // This replaces your old 'executeMerge' function
      async function executeMerge(id, name, days) {
        // 1. Trigger Confirmation Modal
        openGenericConfirm(
          "Confirm Single Merge",
          `Are you sure you want to merge <strong>${days} days</strong> into <strong>${name}</strong>'s balance?`,
          "Yes, Merge",
          "#16a34a", // Green Theme for positive action
          async () => {
            // 2. Callback execution
            try {
              // Note: We use the bulk endpoint even for single items for consistency
              const response = await fetchWithAuth(
                `${API_URL}/leaves/cf-merge-bulk`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ leave_ids: [id] }),
                }
              );

              const result = await response.json();

              if (response.ok) {
                showModal(
                  "Merge Successful",
                  `‚úÖ ${result.message}`,
                  "success"
                );
                loadCFProcessingList(); // Refresh table
              } else {
                showModal(
                  "Merge Failed",
                  result.detail || "Error processing request",
                  "error"
                );
              }
            } catch (e) {
              console.error(e);
              showModal("Network Error", "Check console for details.", "error");
            }
          }
        );
      }

      async function searchEmployeeForAdjustment() {
        const nameInput = document.getElementById("policy_user_search");
        const name = nameInput.value.trim();
        if (!name) return alert("Please enter a name.");

        // 1. Identify context (Backend requires these to authorize the search)
        const primaryRole = userRoles.includes("hr_admin")
          ? "hr_admin"
          : "manager";
        const currentYear = new Date().getFullYear();

        try {
          // 2. Build the full query string with ALL required parameters
          const params = new URLSearchParams({
            user_role: primaryRole, // MATCHES Python 'user_role'
            approver_name: currentUser, // MATCHES Python 'approver_name'
            name: name, // MATCHES Python 'name'
          });

          const res = await fetchWithAuth(
            `${API_URL}/leaves/manager/entitlements?${params.toString()}`
          );

          if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.detail || "Search failed");
          }

          const data = await res.json();

          // 3. Find the exact user from the returned list
          const user = data.find(
            (u) => u.name.toLowerCase() === name.toLowerCase()
          );

          if (user) {
            document.getElementById("adjustment_form_container").style.display =
              "block";
            document.getElementById(
              "adj_emp_name"
            ).innerText = `Adjusting: ${user.name}`;

            // Fill individual boxes with data from DB
            document.getElementById("adj_annual").value =
              user.annual_entitlement;
            document.getElementById("adj_medical").value =
              user.medical_entitlement;
            document.getElementById("adj_emergency").value =
              user.emergency_entitlement;
            document.getElementById("adj_compassionate").value =
              user.compassionate_entitlement;

            // Store name for the Save button
            window.currentAdjustingUser = user.name;
          } else {
            alert(
              `User "${name}" not found. Please type the full name exactly.`
            );
            document.getElementById("adjustment_form_container").style.display =
              "none";
          }
        } catch (e) {
          console.error("Search error:", e);
          alert(`‚ùå Search failed: ${e.message}`);
        }
      }

      async function loadGlobalPolicy() {
        try {
          // üöÄ THE FIX: Change 'fetch' to 'fetchWithAuth'
          const res = await fetchWithAuth(`${API_URL}/leaves/admin/policy`);

          // fetchWithAuth automatically redirects to login if the session is dead
          if (!res) return;

          if (res.ok) {
            const data = await res.json();

            // Update all 4 fields if they exist in the UI
            if (document.getElementById("policy_annual"))
              document.getElementById("policy_annual").value =
                data.annual || 14;
            if (document.getElementById("policy_medical"))
              document.getElementById("policy_medical").value =
                data.medical || 14;
            if (document.getElementById("policy_emergency"))
              document.getElementById("policy_emergency").value =
                data.emergency || 2;
            if (document.getElementById("policy_compassionate"))
              document.getElementById("policy_compassionate").value =
                data.compassionate || 3;
          }
        } catch (e) {
          console.error("Policy load error:", e);
        }
      }

      async function saveIndividualAdjustment() {
        const empName = window.currentAdjustingUser; // Stored during search
        const year = new Date().getFullYear();

        const adjustmentData = {
          employee_name: empName,
          year: year,
          annual: parseInt(document.getElementById("adj_annual").value) || 0,
          medical: parseInt(document.getElementById("adj_medical").value) || 0,
          emergency: parseInt(document.getElementById("adj_emergency").value) || 0,
          compassionate: parseInt(document.getElementById("adj_compassionate").value) || 0,
        };

        // üöÄ UPGRADE: SweetAlert2 Confirmation Modal
        Swal.fire({
          title: 'Apply Adjustments?',
          html: `Are you sure you want to override the leave entitlements for <strong>${empName}</strong>?<br><br><span style="font-size:0.85rem; color:#64748b;">This action will be logged in the audit trail.</span>`,
          icon: 'warning',
          iconColor: '#10b981', // Green theme for adjustments
          showCancelButton: true,
          confirmButtonColor: '#10b981',
          cancelButtonColor: '#cbd5e1',
          confirmButtonText: 'Yes, Save Changes'
        }).then(async (result) => {
          if (result.isConfirmed) {
            
            // Show loading state
            Swal.fire({
              title: 'Saving...',
              allowOutsideClick: false,
              didOpen: () => { Swal.showLoading(); }
            });

            try {
              const res = await fetchWithAuth(
                `${API_URL}/leaves/admin/adjust-individual`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(adjustmentData),
                }
              );

              if (!res) return;

              if (res.ok) {
                // üöÄ UPGRADE: SweetAlert Success
                Swal.fire({
                  icon: 'success',
                  title: 'Adjustments Saved',
                  html: `Successfully updated all balances for <strong>${empName}</strong>.`,
                  confirmButtonColor: '#2563eb'
                }).then(() => {
                  // 1. Clear the form using our helper
                  if (typeof resetAdjustmentForm === "function") resetAdjustmentForm();
                  // 2. Refresh the individual view state
                  if (typeof showSection === "function") showSection("hr_policy");
                });
              } else {
                const err = await res.json();
                Swal.fire({
                  icon: 'error',
                  title: 'Update Failed',
                  text: err.detail || "Server error",
                  confirmButtonColor: '#ef4444'
                });
              }
            } catch (e) {
              console.error("Adjustment Save Error:", e);
              Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Error connecting to server. Please try again.',
                confirmButtonColor: '#ef4444'
              });
            }
          }
        });
      }

// ==========================================
// 3. The Render Engine (Sort + Paginate + Render)
// ==========================================
function sortAndRenderAudit() {
    const tbody = document.getElementById("globalAuditTableBody");
    if (!tbody) return;

    // A. SORTING (The New Feature) - HARDENED
    filteredAuditData.sort((a, b) => {
        let valA, valB;

        // Handle numeric ID sorting properly
        if (auditSortState.key === 'id') {
            valA = parseInt(a.id) || 0; 
            valB = parseInt(b.id) || 0;
        } 
        // Handle numeric Duration sorting
        else if (auditSortState.key === 'days_taken') {
            valA = parseFloat(a.sort_val_duration) || 0; 
            valB = parseFloat(b.sort_val_duration) || 0;
        } 
        // Handle Date sorting (Safely handle missing dates)
        else if (auditSortState.key === 'start_date') {
            valA = new Date(a.start_date).getTime() || 0; 
            valB = new Date(b.start_date).getTime() || 0;
        } 
        // Default String sorting (Fallback)
        else {
            valA = (a[auditSortState.key] || "").toString().toLowerCase();
            valB = (b[auditSortState.key] || "").toString().toLowerCase();
        }

        if (valA < valB) return auditSortState.direction === 'asc' ? -1 : 1;
        if (valA > valB) return auditSortState.direction === 'asc' ? 1 : -1;
        return 0;
    });

    // B. PAGINATION MATH
    const totalRecords = filteredAuditData.length;
    const totalPages = Math.ceil(totalRecords / auditPageSize) || 1;

    if (auditCurrentPage > totalPages) auditCurrentPage = 1;

    const startIndex = (auditCurrentPage - 1) * auditPageSize;
    const endIndex = startIndex + auditPageSize;
    const paginatedData = filteredAuditData.slice(startIndex, endIndex);

    // C. UPDATE FOOTER UI
    const pageInfo = document.getElementById("auditPageInfo");
    const prevBtn = document.getElementById("auditPrevBtn");
    const nextBtn = document.getElementById("auditNextBtn");

    if (pageInfo) pageInfo.innerText = `Page ${auditCurrentPage} of ${totalPages} (${totalRecords} records)`;
    if (prevBtn) {
        prevBtn.disabled = (auditCurrentPage === 1);
        prevBtn.onclick = () => changeAuditPage(-1); 
    }
    if (nextBtn) {
        nextBtn.disabled = (auditCurrentPage >= totalPages);
        nextBtn.onclick = () => changeAuditPage(1); 
    }

    // D. RENDER THE TABLE
    tbody.innerHTML = "";
    
    if (paginatedData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center" style="padding:50px; color:#94a3b8;">
            <i class="fas fa-search" style="font-size:1.5rem; margin-bottom:10px;"></i><br>No matching logs found.
        </td></tr>`;
        return;
    }

    paginatedData.forEach((log) => {
        try {
            // üé® 1. Avatar Initials
            const initials = (log.employee_name || "??").split(" ").map(n => n[0]).slice(0, 2).join("").toUpperCase();

            // üé® 2. Status Pills
            let statusBadge = `<span class="status-badge" style="background:#f1f5f9; color:#475569;">${log.status}</span>`;
            if (log.status === "Approved") statusBadge = `<span class="status-badge" style="background:#dcfce7; color:#166534;">Approved</span>`;
            else if (log.status.includes("Pending")) statusBadge = `<span class="status-badge" style="background:#fef9c3; color:#854d0e;">${log.status}</span>`;
            else if (log.status === "Rejected") statusBadge = `<span class="status-badge" style="background:#fee2e2; color:#991b1b;">Rejected</span>`;
            else if (log.status === "Cancelled") statusBadge = `<span class="status-badge" style="background:#f1f5f9; color:#475569; text-decoration:line-through;">Cancelled</span>`;

            // üé® 3. Date Formatting
            const dateDisplay = log.start_date === log.end_date
                ? `<span style="font-weight:600; color:#334155;">${log.start_date}</span>`
                : `<div style="display:flex; flex-direction:column; font-size:0.75rem;">
                     <span>${log.start_date}</span>
                     <span style="color:#94a3b8; font-size:0.6rem;">to</span>
                     <span>${log.end_date}</span>
                   </div>`;

            // üé® 4. ID Formatting
            const refID = `#${log.record_source === "OT" ? "OT" : "LV"}-${String(log.id).padStart(4, "0")}`;
            
            const itemData = JSON.stringify(log).replace(/'/g, "&apos;");
            const clickAction = log.record_source === "OT"
                ? `viewOTDetails(${itemData})`
                : `viewLeaveDetails(${itemData})`;

            // üé® 5. Duration Pill
            let rawVal = parseFloat(log.days_taken);
            let isHours = (log.days_taken + "").toLowerCase().includes("hour");
            let durIcon = isHours ? "fa-clock" : "fa-calendar-day";
            let durUnit = isHours ? "HRS" : "DAYS";
            let durColor = isHours ? "#ea580c" : "#0f172a";
            let durBg = isHours ? "#fff7ed" : "#f1f5f9";

            const durationPill = `
                <div style="display:inline-flex; align-items:center; gap:6px; background:${durBg}; border:1px solid #e2e8f0; padding:4px 8px; border-radius:6px;">
                    <i class="fas ${durIcon}" style="font-size:0.7rem; color:#94a3b8;"></i>
                    <span style="font-weight:800; color:${durColor}; font-size:0.85rem;">${rawVal}</span>
                    <span style="font-size:0.65rem; font-weight:700; color:#94a3b8; margin-top:1px;">${durUnit}</span>
                </div>`;

            // ROW HTML
            const row = `
            <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.1s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                <td style="padding: 12px 15px; color:#64748b; font-family:monospace; font-weight:700; font-size:0.8rem;">${refID}</td>
                <td style="padding: 12px 15px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:30px; height:30px; background:#e0f2fe; color:#0369a1; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.7rem; font-weight:800;">${initials}</div>
                        <span style="font-weight:600; color:#1e293b; font-size:0.85rem;">${log.employee_name}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; color:#475569; font-size:0.85rem;">${log.leave_type}</td>
                <td style="padding: 12px 15px; text-align:center;">${durationPill}</td>
                <td style="padding: 12px 15px; text-align:center;">${dateDisplay}</td>
                <td style="padding: 12px 15px; color:#64748b; font-size:0.8rem;">
                    <i class="fas fa-user-tie" style="margin-right:5px; color:#cbd5e1;"></i>
                    ${log.approver_name || "‚Äî"}
                </td>
                <td style="padding: 12px 15px; text-align:center;">${statusBadge}</td>
                <td style="padding: 12px 15px; text-align:center;">
                    <button class="icon-btn" onclick='${clickAction}' title="View Details" 
                            style="width:30px; height:30px; padding:0 !important; border:1px solid #e2e8f0; border-radius:6px; display:inline-flex; align-items:center; justify-content:center;">
                        <i class="fas fa-eye" style="color:#2563eb;"></i>
                    </button>
                </td>
            </tr>`;

            tbody.insertAdjacentHTML("beforeend", row);
        } catch (err) {
            console.error("Error rendering audit row:", err);
        }
    });
}

// 4. Client-Side Pagination Helper
function changeAuditPage(delta) {
    const totalRecords = filteredAuditData.length;
    const totalPages = Math.ceil(totalRecords / auditPageSize) || 1;
    
    const newPage = auditCurrentPage + delta;
    if (newPage < 1 || newPage > totalPages) return;
    
    auditCurrentPage = newPage;
    sortAndRenderAudit();
}

// 5. Sort Trigger
function sortAuditTable(key) {
    if (auditSortState.key === key) {
        auditSortState.direction = auditSortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        auditSortState.key = key;
        auditSortState.direction = 'desc'; 
    }

    // Visual Update
    document.querySelectorAll('thead i[id^="audit-sort-"]').forEach(i => {
        i.className = 'fas fa-sort'; 
        i.style.color = '#cbd5e1';
    });
    const activeIcon = document.getElementById(`audit-sort-${key}`);
    if (activeIcon) {
        activeIcon.className = auditSortState.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
        activeIcon.style.color = '#3b82f6';
    }

    sortAndRenderAudit();
}


      async function loadSystemReporting() {
        const appsEl = document.getElementById("stat_total_apps");
        const pendingEl = document.getElementById("stat_pending");
        const medicalEl = document.getElementById("stat_medical_rate");
        const medicalWrapper = document.getElementById("medical_rate_wrapper"); // Target the wrapper
        const awayList = document.getElementById("reporting_away_list");
        const activityContainer = document.getElementById(
          "reporting_recent_activity"
        );

        try {
          const now = new Date();
          const today = now.toLocaleDateString("en-CA");

          // üöÄ THE FIX: Change both 'fetch' calls to 'fetchWithAuth'

          // 1. Fetch Headcount
          const userRes = await fetchWithAuth(`${API_URL}/users/all`);
          if (!userRes) return; // fetchWithAuth already handled the 401 redirect

          const allUsers = await userRes.json();
          const activeStaffCount =
            allUsers.filter((u) => u.is_active !== false).length || 1;

          // 2. Fetch All Leaves
          const res = await fetchWithAuth(
            `${API_URL}/leaves/manager/all?user_role=hr_admin`
          );
          if (!res) return;

          const data = await res.json();
          const leaves = data.requests || [];
          const approvedLeaves = leaves.filter((l) => l.status === "Approved");

          // ... rest of your UI calculation logic (stays the same) ...

          // 2. ADJUST GRID LAYOUT BASED ON TOGGLE
          // This finds the div holding the 3 top tiles and changes it to 2 columns if Medical is hidden
          const statsGrid = appsEl?.closest(
            'div[style*="grid-template-columns"]'
          );
          if (statsGrid) {
            statsGrid.style.gridTemplateColumns = FEATURES.showMedicalRate
              ? "repeat(3, 1fr)"
              : "repeat(2, 1fr)";
          }

          // 3. UPDATE TOTAL & PENDING
          if (appsEl) appsEl.innerText = leaves.length;
          if (pendingEl)
            pendingEl.innerText = leaves.filter((l) =>
              l.status.includes("Pending")
            ).length;

          // 4. MEDICAL RATE TOGGLE
          if (medicalWrapper) {
            if (FEATURES.showMedicalRate) {
              medicalWrapper.style.display = "block";
              const medicalCount = approvedLeaves.filter(
                (l) => l.leave_type === "Medical Leave"
              ).length;
              const workforceRate = Math.round(
                (medicalCount / activeStaffCount) * 100
              );
              if (medicalEl) medicalEl.innerText = workforceRate + "%";
            } else {
              medicalWrapper.style.display = "none"; // Completely removes it from view
            }
          }

          // 5. SIDEBAR: WHO'S AWAY TODAY TOGGLE
          const awayContainer = awayList?.closest('div[style*="border"]');
          if (awayContainer) {
            awayContainer.style.display = FEATURES.showWhosAwayToday
              ? "block"
              : "none";
            if (FEATURES.showWhosAwayToday) {
              const awayToday = approvedLeaves.filter(
                (l) => today >= l.start_date && today <= l.end_date
              );
              awayList.innerHTML =
                awayToday.length === 0
                  ? "<li style='padding: 10px; color: #94a3b8;'>No one is currently away.</li>"
                  : awayToday
                      .map(
                        (
                          l
                        ) => `<li style="padding: 10px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                                  <span style="font-weight: 600;">${
                                    l.employee_name
                                  }</span>
                                  <span class="status-badge status-approved" style="font-size: 0.7rem;">${l.leave_type.replace(
                                    " Leave",
                                    ""
                                  )}</span>
                              </li>`
                      )
                      .join("");
            }
          }

          // 6. SIDEBAR: RECENT ACTIVITY (Remains as requested)
          if (activityContainer && FEATURES.showRecentActivity) {
            const recent = [...approvedLeaves]
              .sort((a, b) => new Date(b.start_date) - new Date(a.start_date))
              .slice(0, 5);
            activityContainer.innerHTML = recent
              .map(
                (l) => `
                          <div style="background: white; border: 1px solid #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                  <span style="font-weight: 700; color: #1e293b; font-size: 0.8rem;">${
                                    l.employee_name
                                  }</span>
                                  <span style="font-size: 0.65rem; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">${
                                    l.days_taken
                                  }d</span>
                              </div>
                              <div style="font-size: 0.7rem; color: #2563eb; font-weight: 500;">
                                  ${l.leave_type.replace(
                                    " Leave",
                                    ""
                                  )} ‚Ä¢ <span style="color: #94a3b8; font-weight: normal;">${formatDateNice(
                  l.start_date
                )}</span>
                              </div>
                          </div>`
              )
              .join("");
          }
        } catch (e) {
          console.error("Reporting Error:", e);
        }
      }
      function closeLogsModal() {
        document.getElementById("balanceLogsModal").style.display = "none";
      }

      loadHistory();

      async function fetchGlobalSettings() {
        try {
          // Reuse the endpoint we made for the Settings page
          const res = await fetchWithAuth(`${API_URL}/settings/carry-forward`);
          if (res.ok) {
            const data = await res.json();
            ENABLE_CARRY_FORWARD = data.enabled;

            // Update the "Request CF" button visibility immediately
            applyFeatureToggles();
          }
        } catch (e) {
          console.warn("Could not fetch global settings, using default.", e);
        }
      }

      // 1. Set the dashboard to Home first
      function toggleManagerMenu() {
        // --- THESE TWO LINES ARE REQUIRED ---
        const subMenu = document.getElementById("managerSubMenu");
        const chevron = document.getElementById("managerChevron");

        if (subMenu.style.display === "none" || subMenu.style.display === "") {
          subMenu.style.display = "block";
          if (chevron) chevron.style.transform = "rotate(180deg)";
        } else {
          subMenu.style.display = "none";
          if (chevron) chevron.style.transform = "rotate(0deg)";
        }
      }

      function toggleAdminMenu() {
        // --- THESE TWO LINES ARE REQUIRED ---
        const subMenu = document.getElementById("adminSubMenu");
        const chevron = document.getElementById("adminChevron");

        if (subMenu.style.display === "none" || subMenu.style.display === "") {
          subMenu.style.display = "block";
          if (chevron) chevron.style.transform = "rotate(180deg)";
        } else {
          subMenu.style.display = "none";
          if (chevron) chevron.style.transform = "rotate(0deg)";
        }
      }
      function closeLogsModal() {
        document.getElementById("balanceLogsModal").style.display = "none";
      }

 /**
 * üöÄ Updated Registration Modal Opener
 * Ensures managers, IDs, and the "Proceed" button are fully loaded and formatted.
 */
async function openRegisterModal() {
    const modal = document.getElementById("registerUserModal");
    if (!modal) return;

    // 1. Reset UI State
    const suggestionBox = document.getElementById("reg_manager_suggestions");
    if (suggestionBox) suggestionBox.style.display = "none";

    // 2. üöÄ THE CRITICAL SYNC: Wait for managers to load
    await loadApproverList();

    // 3. Reset Modal Header & Button to "Registration Mode"
    modal.querySelector("h3").innerHTML = `<i class="fas fa-user-plus"></i> Register New Employee`;
    
    // üöÄ THE UPGRADE: Target the new ID, use "Proceed", and force it back to Green
    const submitBtn = document.getElementById("reg_main_submit_btn");
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Proceed';
        submitBtn.onclick = (e) => submitNewUser(e);
        
        // Visual Polish: Ensure it snaps back to Green (in case it was Blue from an Edit session)
        submitBtn.style.background = "#10b981";
        submitBtn.onmouseover = () => submitBtn.style.background = '#059669';
        submitBtn.onmouseout = () => submitBtn.style.background = '#10b981';
    }

    // 4. Auto-generate the next available ID
    await generateNextEmpID();

    // 5. Restore Credential Fields 
    const usernameField = document.getElementById("reg_username");
    if (usernameField) {
        usernameField.disabled = false;
        usernameField.style.background = "white";
        usernameField.value = "";
    }

    // Restore the ENTIRE password block 
    const passField = document.getElementById("reg_password");
    if (passField && passField.parentElement) {
        const passContainer = passField.parentElement.parentElement;
        if (passContainer) passContainer.style.display = "block";
        
        passField.value = "password123"; // Reset to default
        
        // Reset the eye icon back to hidden dots
        const eyeIcon = document.getElementById("eye_reg_password");
        if (eyeIcon) {
            eyeIcon.className = "fas fa-eye";
            passField.type = "password";
        }
    }

    // Ensure Reset Button is visible for New Registrations
    const resetBtn = document.getElementById("reg_reset_btn");
    if (resetBtn) resetBtn.style.display = "flex";

    // 6. Clear ALL inputs AND selects (excluding Auto-ID and Username)
    document.querySelectorAll("#registerUserModal input, #registerUserModal select").forEach((element) => {
        if (element.id !== "reg_password" && element.id !== "reg_emp_id" && element.id !== "reg_username") {
            element.value = "";
        }
    });

    // 7. Show Modal
    modal.style.display = "flex";
}

// ==========================================
// üöÄ NEW: DEDICATED REGISTRATION FORM RESET
// ==========================================
function resetRegistrationForm() {
    console.log("üõ†Ô∏è Reset button clicked! Starting wipe...");
    const modal = document.getElementById("registerUserModal");
    const form = modal.querySelector("form");
    
    if (!modal || !form) {
        console.error("‚ùå Modal or Form not found!");
        return;
    }

    // 1. Save the generated ID so we don't wipe it
    const empIdField = document.getElementById("reg_emp_id");
    const currentId = empIdField ? empIdField.value : "";

    // 2. Wipe all inputs in the form
    form.reset();

    // 3. Restore the generated ID & Default Password
    if (empIdField) empIdField.value = currentId;
    const passField = document.getElementById("reg_password");
    if (passField) {
        passField.value = "password123";
        passField.type = "password"; // Hide dots
        const eyeIcon = document.getElementById("eye_reg_password");
        if (eyeIcon) eyeIcon.className = "fas fa-eye";
    }

    // 4. Purge ALL visual error states & Borders using your existing clearError function
    const errorSlots = [
        "name_error", "user_error", "pass_error", 
        "email_error", "mobile_error", "date_error", "manager_error"
    ];

    errorSlots.forEach(id => {
        if (typeof clearError === "function") {
            clearError(id);
        }
    });

    // 5. Purge the real-time Username API Feedback
    const usernameFeedback = document.getElementById("username_feedback");
    if (usernameFeedback) {
        usernameFeedback.style.display = "none";
        usernameFeedback.innerHTML = "";
    }
    
    // Reset Auto-Gen tracking
    const usernameInput = document.getElementById("reg_username");
    if (usernameInput) usernameInput.dataset.autoGenerated = "false";

    console.log("‚úÖ Form wipe complete!");
}


      /**
       * üîç Manager Suggestion Logic
       * Fetches matching names from the database as the user types.
       */
      async function handleManagerSuggest(query, boxId) {
        const suggestionBox = document.getElementById(boxId);

        // Don't search if the user has typed less than 2 characters
        if (query.trim().length < 2) {
          suggestionBox.style.display = "none";
          return;
        }

        try {
          // We reuse your existing search endpoint
          const res = await fetchWithAuth(
            `${API_URL}/users/all?search=${encodeURIComponent(query)}`
          );
          if (!res) return;

          const users = await res.json();

          if (users.length > 0) {
            // Create the clickable list of names
            suggestionBox.innerHTML = users
              .map(
                (u) => `
                <div class="suggestion-item" onclick="selectManager('${u.full_name}', '${boxId}')">
                    <i class="fas fa-user-tie" style="color: #64748b; margin-right: 10px;"></i>
                    <span>${u.full_name}</span>
                </div>
            `
              )
              .join("");
            suggestionBox.style.display = "block";
          } else {
            suggestionBox.style.display = "none";
          }
        } catch (e) {
          console.error("Manager search error:", e);
        }
      }

      /**
       * üéØ Selection Helper
       * Fills the Line Manager input and hides the suggestion box.
       */
      function selectManager(name, boxId) {
        // 1. Identify which input to fill based on the boxId
        // If boxId is 'reg_manager_suggestions', target 'reg_line_manager'
        const targetInputId =
          boxId === "reg_manager_suggestions"
            ? "reg_line_manager"
            : "edit_line_manager";

        const input = document.getElementById(targetInputId);

        if (input) {
          input.value = name;
        }

        // 2. Hide the suggestion box
        const suggestionBox = document.getElementById(boxId);
        if (suggestionBox) {
          suggestionBox.style.display = "none";
        }
      }

      /**
       * üßπ Global UI Cleanup
       * Closes any open suggestion boxes if Natasha clicks elsewhere on the page.
       */
      document.addEventListener("click", function (e) {
        // A list of all potential suggestion box IDs we've created
        const suggestionBoxes = [
          "reg_manager_suggestions",
          "employee_suggestions_box",
        ];

        suggestionBoxes.forEach((id) => {
          const box = document.getElementById(id);
          const input =
            id === "reg_manager_suggestions"
              ? document.getElementById("reg_line_manager")
              : document.getElementById("policy_user_search");

          // Logic: If the box is visible AND the click was NOT on the input AND NOT inside the box...
          if (box && box.style.display !== "none") {
            if (e.target !== input && !box.contains(e.target)) {
              box.style.display = "none";
            }
          }
        });
      });

// 2. Close the Registration Modal
function closeRegisterModal() {
    const modal = document.getElementById("registerUserModal");
    const form = modal.querySelector("form");

    // 1. Clear all data
    if (form) form.reset();

    // üöÄ THE FIX FOR ISSUE #2: Clear all visual error states
    const errorFields = [
        { inputId: "reg_full_name", errorId: "name_error" },
        { inputId: "reg_username", errorId: "user_error" },
        { inputId: "reg_password", errorId: "pass_error" },
        { inputId: "reg_email", errorId: "email_error" }, // üöÄ FIXED: Was incorrectly pointing to user_error
        { inputId: "reg_mobile", errorId: "mobile_error" },
        { inputId: "reg_joined", errorId: "date_error" },
        { inputId: "reg_manager", errorId: "manager_error" }
    ];

    errorFields.forEach(field => {
        // Clear Error Message
        const errorEl = document.getElementById(field.errorId);
        if (errorEl) {
            errorEl.style.display = "none";
            errorEl.innerText = "";
        }
        
        // Clear Red Border & Background Tint
        const inputEl = document.getElementById(field.inputId);
        if (inputEl) {
            inputEl.style.setProperty("border-color", "#cbd5e1", "important"); 
            inputEl.style.setProperty("background-color", "#ffffff", "important"); 
        }
    });

    // üöÄ THE FIX FOR THE GHOST USERNAME FEEDBACK
    const usernameFeedback = document.getElementById("username_feedback");
    if (usernameFeedback) {
        usernameFeedback.style.display = "none";
        usernameFeedback.innerHTML = "";
    }

   // 2. Reset UI back to "Register" Mode
   modal.querySelector("h3").innerHTML = `<i class="fas fa-user-plus"></i> Register New Employee`;

// üöÄ THE UPDATE: Target the new specific ID and use the shorter "Proceed" name
const submitBtn = document.getElementById("reg_main_submit_btn");
if (submitBtn) {
    submitBtn.innerHTML = '<i class="fas fa-check"></i> Proceed';
    submitBtn.onclick = (e) => submitNewUser(e);
    
    // Ensure the button snaps back to standard Green after an Edit session
    submitBtn.style.background = "#10b981";
    submitBtn.onmouseover = () => submitBtn.style.background = '#059669';
    submitBtn.onmouseout = () => submitBtn.style.background = '#10b981';
}

    // 3. Restore hidden/disabled fields
    const userField = document.getElementById("reg_username");
    if (userField) {
        userField.disabled = false;
        userField.style.background = "white";
        userField.dataset.autoGenerated = "false"; // Reset auto-gen tracking
    }

    const passField = document.getElementById("reg_password");
    if (passField && passField.parentElement) {
        passField.parentElement.style.display = "block"; 
        passField.value = "password123"; 

        // üöÄ BONUS: Reset the password visibility eye icon if it was left open
        const eyeIcon = document.getElementById("eye_reg_password");
        if (eyeIcon) {
            eyeIcon.className = "fas fa-eye";
            passField.type = "password";
        }
    }

    // 4. Hide modal
    modal.style.display = "none";
}
      /**
       * üÜî System ID Generator
       * Fetches the next available Employee ID from the server and locks the field.
       */
       async function generateNextEmpID() {
    const idInput = document.getElementById("reg_emp_id");
    if (!idInput) return;

    // 1. Visual Loading State
    idInput.value = "Generating...";
    idInput.disabled = true;
    idInput.style.background = "#f1f5f9";

    try {
        // üöÄ THE CRITICAL FIX: Ensure we use 'fetchWithAuth' to send headers
        // And use the full API_URL constant
        const res = await fetchWithAuth(`${API_URL}/users/next-id`);
        
        if (res && res.ok) {
            const data = await res.json();
            // üéØ Ensure we grab the exact key 'next_id' returned by your Python code
            idInput.value = data.next_id;
            console.log("‚úÖ Employee ID Generated:", data.next_id);
        } else {
            // Fallback for 401/403 or server errors
            const status = res ? res.status : "No Response";
            console.error(`‚ùå ID Generation Failed. Status: ${status}`);
            idInput.value = `EMP-${new Date().getFullYear()}-TEMP`;
        }
    } catch (e) {
        console.error("‚ùå Network Error during ID generation:", e);
        idInput.value = "OFFLINE";
    }
}
      // 3. Submit the New User to the Python Backend
      /**
       * üöÄ Automated User Registration & Onboarding
       * Phase 1: Create the system identity.
       * Phase 2: Provision leave days automatically via Global Policy sync.
       */
       async function submitNewUser(event) {
        // 1. Safety check to prevent page reload
        if (event && typeof event.preventDefault === "function") {
          event.preventDefault();
        }

        // --- üöÄ FIX 1: USE THE ROBUST CLEAR HELPER ---
        // Clean all visual errors before re-validating
        const errorSlots = [
          "name_error",
          "user_error",
          "pass_error",
          "email_error",   
          "mobile_error",
          "date_error",
          "manager_error"  
        ];
        
        errorSlots.forEach((id) => {
          if (typeof clearError === "function") {
            clearError(id);
          }
        });

        // 2. Capture Values
        const empId = document.getElementById("reg_emp_id").value.trim();
        const fullName = document.getElementById("reg_full_name").value.trim();
        const username = document.getElementById("reg_username").value.trim();
        const password = document.getElementById("reg_password").value;
        const email = document.getElementById("reg_email").value.trim(); 
        const mobile = document.getElementById("reg_mobile").value.trim();
        const lineManager = document.getElementById("reg_manager").value; 
        const joinedDate = document.getElementById("reg_joined").value;
        const feedback = document.getElementById("username_feedback");

        let hasError = false;

        // --- üöÄ FIX 2: SYNCHRONIZED INLINE MANDATORY CHECKS ---
        if (!fullName) { showInlineError("name_error", "Full Name is required"); hasError = true; }
        if (!username) { showInlineError("user_error", "Username is required"); hasError = true; }
        if (!password) { showInlineError("pass_error", "Initial Password is required"); hasError = true; }
        if (!email) { showInlineError("email_error", "Business Email is required"); hasError = true; } 
        if (!mobile) { showInlineError("mobile_error", "Mobile number is mandatory"); hasError = true; }
        if (!lineManager) { showInlineError("manager_error", "Please select a Line Manager"); hasError = true; } 
        if (!joinedDate) { showInlineError("date_error", "Joined Date is mandatory"); hasError = true; }

        // GUARD: Username Duplication Check 
        if (feedback && (feedback.innerText.toLowerCase().includes("taken") || feedback.innerText.toLowerCase().includes("already"))) {
          showInlineError("user_error", "This username is already taken");
          hasError = true;
        }

        // --- üöÄ FIX 3: UPGRADE SYSTEM ALERTS TO SWEETALERT ---
        // GUARD: Employee ID Readiness
        if (!empId || empId === "Generating..." || empId === "Error Generating ID") {
          Swal.fire({
            icon: 'info',
            title: 'Processing',
            text: 'Please wait for the Employee ID to finish generating.',
            confirmButtonColor: '#3b82f6'
          });
          return;
        }

        // üõë Stop execution if ANY inline validation failed
        if (hasError) return;

        // 3. Collect All Fields into FormData
        const formData = new FormData();
        formData.append("employee_id", empId);
        formData.append("full_name", fullName);
        formData.append("username", username.toLowerCase());
        formData.append("password", password);
        formData.append("gender", document.getElementById("reg_gender").value);
        formData.append("marital_status", document.getElementById("reg_marital").value);
        formData.append("email", email.toLowerCase()); 
        formData.append("mobile", mobile);
        formData.append("job_title", document.getElementById("reg_job_title").value.trim());
        formData.append("business_unit", document.getElementById("reg_unit").value.trim());
        formData.append("department", document.getElementById("reg_dept").value.trim());
        formData.append("line_manager", lineManager); 
        formData.append("joined_date", joinedDate);

        try {
          // üöÄ STEP 1: Create the User Account
          // Show loading state to prevent double-clicking
          Swal.fire({
              title: 'Creating Account...',
              allowOutsideClick: false,
              didOpen: () => { Swal.showLoading(); }
          });

          const res = await fetchWithAuth(`${API_URL}/users/register`, {
            method: "POST",
            body: formData,
          });

          if (!res) return;

          if (res.ok) {
            console.log("Account Created. Starting entitlement initialization...");
            
            // üöÄ STEP 2: Sync Leave Balances
            const syncRes = await fetchWithAuth(
              `${API_URL}/leaves/admin/sync-new-user?full_name=${encodeURIComponent(fullName.trim())}`,
              { method: "POST" }
            );

            if (syncRes && syncRes.ok) {
              Swal.fire({
                icon: 'success',
                title: 'Registration Complete',
                html: `<strong>${fullName}</strong> has been registered.<br>Leave balances initialized.`,
                confirmButtonColor: '#10b981',
                confirmButtonText: 'Done'
              });
            } else {
              Swal.fire({
                icon: 'warning',
                title: 'Partial Success',
                html: `Account created for <strong>${fullName}</strong>, but leave balances could not be auto-synced.`,
                confirmButtonColor: '#f59e0b',
                confirmButtonText: 'Acknowledge'
              });
            }

            // üöÄ THE TWEAK: Ensure form is wiped before closing
            if (typeof resetRegistrationForm === "function") {
                resetRegistrationForm();
            }
            closeRegisterModal();
            await loadAllUsers();
            
          } else {
            // --- üöÄ FIX 4: UPGRADE BACKEND ERRORS TO SWEETALERT ---
            const err = await res.json();
            
            // Format FastAPI Pydantic errors into a readable list
            let detailMsg = "Check input data.";
            if (Array.isArray(err.detail)) {
              detailMsg = err.detail.map((e) => `‚Ä¢ ${e.loc[e.loc.length - 1]}: ${e.msg}`).join("<br>");
            } else if (err.detail) {
              detailMsg = err.detail;
            }

            Swal.fire({
              icon: 'error',
              title: 'Registration Failed',
              html: detailMsg,
              confirmButtonColor: '#ef4444'
            });
          }
        } catch (e) {
          console.error("Submission Error:", e);
          Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'Could not connect to the server. Please check your connection.',
            confirmButtonColor: '#ef4444'
          });
        }
      }

      function showInlineError(elementId, message) {
  const el = document.getElementById(elementId);
  if (el) {
    el.innerText = "‚ö†Ô∏è " + message;
    el.style.display = "block";
    
    // üöÄ THE FIX: Safely find the wrapper and look for BOTH input and select
    const container = el.closest("div");
    const input = container ? container.querySelector("input, select") : null;
    
    if (input) {
      input.style.setProperty("border-color", "#ef4444", "important");
      input.style.setProperty("background-color", "#fff1f2", "important"); // Subtle red tint
    }
  }
}

function clearError(elementId) {
  const el = document.getElementById(elementId);
  if (el) {
    // 1. Hide the red error text
    el.style.display = "none";

    // 2. Safely find the wrapper and look for BOTH input and select
    const container = el.closest("div");
    const input = container ? container.querySelector("input, select") : null;

    if (input) {
      // 3. Reset to standard slate-gray border and white background
      input.style.setProperty("border-color", "#cbd5e1", "important");
      input.style.setProperty("background-color", "#ffffff", "important");
    }
  }
}

      // üöÄ Global debounce timer (Used by both functions to stay in sync)
      let usernameDebounceTimer = null;

      /**
       * ü™Ñ Smart Username & Email Suggestion Engine
       */
      function suggestUsername(fullName) {
        const usernameInput = document.getElementById("reg_username");
        const emailInput = document.getElementById("reg_email");

        if (!usernameInput || usernameInput.disabled) return;

        // Guard: Don't overwrite if Natasha manually typed something custom
        if (
          usernameInput.value !== "" &&
          usernameInput.dataset.autoGenerated !== "true"
        ) {
          if (fullName.trim() === "") usernameInput.value = "";
          return;
        }

        const nameParts = fullName.trim().split(/\s+/);
        let suggestion = "";

        if (nameParts.length >= 2) {
          const firstName = nameParts[0].toLowerCase();
          const lastName = nameParts[nameParts.length - 1].toLowerCase();
          suggestion = (firstName.charAt(0) + lastName).replace(
            /[^a-z0-9]/g,
            ""
          );
        } else if (nameParts.length === 1 && nameParts[0] !== "") {
          suggestion = nameParts[0].toLowerCase().replace(/[^a-z0-9]/g, "");
        }

        if (suggestion) {
          usernameInput.value = suggestion;
          usernameInput.dataset.autoGenerated = "true";

          // üìß AUTO-EMAIL LOGIC
          // Only auto-fill email if it's empty OR was previously auto-generated
          if (
            emailInput &&
            (!emailInput.value || emailInput.dataset.autoGenerated === "true")
          ) {
            emailInput.value = suggestion + "@company.com";
            emailInput.dataset.autoGenerated = "true";
          }

          // üöÄ Trigger the check immediately (it will handle its own debounce)
          checkUsernameAvailability();
        } else {
          usernameInput.value = "";
          if (emailInput && emailInput.dataset.autoGenerated === "true")
            emailInput.value = "";
          const feedback = document.getElementById("username_feedback");
          if (feedback) feedback.style.display = "none";
          usernameInput.style.borderColor = "#cbd5e1";
        }
      }

      /**
       * üîç Consolidated Availability Check (Corrected API Path & Debounce)
       */
      async function checkUsernameAvailability() {
        const usernameInput = document.getElementById("reg_username");
        const feedback = document.getElementById("username_feedback");

        if (!usernameInput) return;

        // 1. Sanitize
        let username = usernameInput.value
          .replace(/[^a-zA-Z0-9]/g, "")
          .toLowerCase();
        usernameInput.value = username;

        clearTimeout(usernameDebounceTimer);

        if (username.length < 3) {
          if (feedback) feedback.style.display = "none";
          usernameInput.style.borderColor = "#cbd5e1";
          return;
        }

        usernameDebounceTimer = setTimeout(async () => {
          const currentCheck = usernameInput.value.trim().toLowerCase();

          try {
            feedback.style.display = "block";
            feedback.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Verifying...`;
            feedback.style.color = "#64748b";

            // üöÄ THE VERIFIED URL (Matching your user.py prefix)
            const res = await fetchWithAuth(
              `${API_URL}/users/check-username?username=${encodeURIComponent(
                currentCheck
              )}`
            );

            // LOG FOR DEBUGGING - Press F12 in your browser to see this!
            console.log("Check Username Response Status:", res.status);

            if (res && res.ok) {
              const data = await res.json();
              if (data.available === true) {
                feedback.innerHTML = `<i class="fas fa-check-circle"></i> This username is available`;
                feedback.style.color = "#10b981";
                usernameInput.style.borderColor = "#10b981";
              } else {
                feedback.innerHTML = `<i class="fas fa-exclamation-circle"></i> This username is already taken`;
                feedback.style.color = "#ef4444";
                usernameInput.style.borderColor = "#ef4444";
              }
            } else {
              // This is where you are getting stuck.
              // It means the server said 404 (Not Found) or 401 (Unauthorized)
              feedback.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Verification service unavailable (Error ${res.status})`;
              feedback.style.color = "#f59e0b";
            }
          } catch (e) {
            feedback.innerHTML = `<i class="fas fa-wifi-slash"></i> Connection Error`;
            feedback.style.color = "#ef4444";
          }
        }, 500);
      }

// 1. TRIGGER: Opens the Orange Confirmation Modal with the Name
function toggleUserStatus(userId, fullName) {
    // üõ°Ô∏è Fallback if name is missing for some reason
    const displayName = fullName || "this user"; 

    openGenericConfirm(
        "Change Account Status?",
        `Are you sure you want to toggle access for <strong>${displayName}</strong>?<br>Inactive users cannot log in.`,
        "Confirm Change",
        "#f59e0b", // Orange Color for Warning
        () => executeUserStatusToggle(userId) // Callback
    );
}

 // 2. EXECUTION: The actual API Call
 async function executeUserStatusToggle(userId) {
        try {
          // Show a subtle loading state so Natasha knows the server is thinking
          Swal.fire({
            title: 'Updating status...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
          });

          const res = await fetchWithAuth(
            `${API_URL}/users/${userId}/toggle-status`,
            { method: "PUT" }
          );

          if (!res) return;

          if (res.ok) {
            const data = await res.json();
            
            // üöÄ UPGRADE: Standardized Success Modal
            await Swal.fire({
                icon: 'success',
                title: 'Status Updated',
                text: data.message,
                confirmButtonColor: '#10b981',
                confirmButtonText: 'OK'
            });

            // Refresh UI Table
            await loadAllUsers();

            // üõ°Ô∏è Logic Preservation: Stay on the same section so the user sees the update
            const hrSection = document.getElementById("hr_users");
            if (hrSection && !hrSection.classList.contains("active")) {
              showSection("hr_users");
            }
          } else {
            const err = await res.json();
            // üöÄ UPGRADE: Standardized Error Modal
            Swal.fire({
              icon: 'error',
              title: 'Action Failed',
              text: err.detail || "Could not update status.",
              confirmButtonColor: '#ef4444'
            });
          }
        } catch (e) {
          console.error("Status toggle error:", e);
          Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: "Error connecting to server. Please check your connection.",
            confirmButtonColor: '#ef4444'
          });
        }
      }

      function updateCurrentYearLabels() {
        const year = new Date().getFullYear();
        document.querySelectorAll(".current-year-display").forEach((el) => {
          el.innerText = year;
        });
      }

      async function submitPasswordChange() {
    const slots = ["p1_error", "p2_error", "p3_error"];
    slots.forEach((id) => clearError(id));
    
    const currentPass = document.getElementById("p1").value;
    const newPass = document.getElementById("p2").value;
    const confirmPass = document.getElementById("p3").value;
    let hasError = false;

    if (!currentPass) { showInlineError("p1_error", "Current password is required"); hasError = true; }
    if (!newPass) { showInlineError("p2_error", "New password is required"); hasError = true; }
    else if (newPass.length < 6) { showInlineError("p2_error", "Password must be at least 6 characters"); hasError = true; }
    if (newPass !== confirmPass) { showInlineError("p3_error", "Confirm password does not match"); hasError = true; }

    if (hasError) return;

    try {
        // üöÄ THE FIX: Pull the unique 'username' (e.g., natasha) stored during login
        const storedUsername = localStorage.getItem("username"); 

        if (!storedUsername) {
            showInlineError("p1_error", "User session error. Please re-login.");
            return;
        }

        // üîó Hit the backend using the Username as the identifier
        const res = await fetchWithAuth(`${API_URL}/users/${encodeURIComponent(storedUsername)}/change-password`, { 
            method: "PUT", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ 
                current_password: currentPass, 
                new_password: newPass 
            }), 
        });

        if (!res) return;

        if (res.ok) {
            showModal("Success!", "Your password has been changed successfully.", "success");
            document.getElementById("changePasswordForm").reset();
            slots.forEach((id) => clearError(id));
        } else {
            const err = await res.json();
            // If 404, the username in the URL didn't match the database record
            if (res.status === 404) {
                showInlineError("p1_error", "User profile synchronization error. Please re-login.");
            } else {
                showInlineError("p1_error", err.detail || "Update failed. Check current password.");
            }
        }
    } catch (e) {
        console.error("Password Change Error:", e);
        showModal("Connection Error", "Unable to reach server.", "error");
    }
}

      // --- üü¢ CHANGE PASSWORD SUCCESS MODAL FUNCTIONS ---

      function showSuccess(message) {
        const modal = document.getElementById("successModal");
        const msg = document.getElementById("successMessage");

        if (modal && msg) {
          msg.innerText = message;
          modal.style.display = "flex"; // Show the modal
        }
      }

      function closeSuccessModal() {
        const modal = document.getElementById("successModal");
        if (modal) {
          modal.style.display = "none";
        }
      }

      // --- üñ±Ô∏è GLOBAL CLICK LISTENER ---
      window.onclick = function (event) {
        const successModal = document.getElementById("successModal");
        const errorModal = document.getElementById("errorModal");
        const leaveModal = document.getElementById("leaveDetailModal");
        const reviewModal = document.getElementById("reviewModal");
        const balanceModal = document.getElementById("balanceLogsModal");

        if (event.target == successModal) successModal.style.display = "none";
        if (event.target == errorModal) errorModal.style.display = "none";
        if (event.target == leaveModal) leaveModal.style.display = "none";
        if (event.target == reviewModal) reviewModal.style.display = "none";
        if (event.target == balanceModal) balanceModal.style.display = "none";
      };

      // --- üî¥ ERROR MODAL FUNCTIONS ---

      function showError(message) {
        const modal = document.getElementById("errorModal");
        const msg = document.getElementById("errorMessage");

        if (modal && msg) {
          msg.innerText = message;
          modal.style.display = "flex"; // Show the modal
        }
      }

      function closeErrorModal() {
        const modal = document.getElementById("errorModal");
        if (modal) {
          modal.style.display = "none";
        }
      }

      /**
       * üëÅÔ∏è Password Visibility Toggle
       * Switches between 'password' and 'text' types and updates the FontAwesome icon.
       */
      function togglePass(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling; // Selects the <i> tag immediately following the input

        if (input.type === "password") {
          input.type = "text";
          icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
          input.type = "password";
          icon.classList.replace("fa-eye-slash", "fa-eye");
        }
      }

      function updateCharCountGeneric(textareaId, spanId) {
        const textarea = document.getElementById(textareaId);
        const countSpan = document.getElementById(spanId);

        if (!textarea || !countSpan) return;

        const currentLength = textarea.value.length;
        countSpan.innerText = `${currentLength} / 200`;

        // Visual feedback: Turn red if near the limit (180+)
        if (currentLength >= 180) {
          countSpan.style.color = "#ef4444"; // Red
        } else {
          countSpan.style.color = "#94a3b8"; // Slate gray
        }
      }

      function resetAuditFilters() {
        // 1. Reset the text search
        const nameInput = document.getElementById("audit_search_name");
        if (nameInput) nameInput.value = "";

        // 2. Reset the dropdowns to the first option ("")
        const typeFilter = document.getElementById("audit_filter_type");
        if (typeFilter) typeFilter.selectedIndex = 0;

        const statusFilter = document.getElementById("audit_filter_status");
        if (statusFilter) statusFilter.selectedIndex = 0;

        // 3. Reset the Year filter to the current year
        const yearFilter = document.getElementById("audit_filter_year");
        if (yearFilter) {
          yearFilter.value = new Date().getFullYear().toString();
        }

        // 4. Trigger the filter logic to refresh the table with all records
        if (typeof applyAuditFilters === "function") {
          applyAuditFilters();
        }
      }

      // // 3. Delete Holiday
      // // 1. TRIGGER: Opens the Red Confirmation Modal
      // function deleteHoliday(id) {
      //   openGenericConfirm(
      //     "Delete Holiday?",
      //     "Are you sure you want to remove this holiday?<br>This will immediately affect leave duration calculations.",
      //     "Yes, Delete",
      //     "#ef4444", // Red Color for the button
      //     () => executeDeleteHoliday(id) // Pass the ID to the execution logic
      //   );
      // }

      // // 2. EXECUTION: The actual API Call (Runs only after clicking "Yes")
      // async function executeDeleteHoliday(id) {
      //   try {
      //     const res = await fetchWithAuth(
      //       `${API_URL}/leaves/public-holidays/${id}`,
      //       { method: "DELETE" }
      //     );

      //     if (!res) return; // Session expired handled by fetchWithAuth

      //     if (res.ok) {
      //       // ‚úÖ Success: Use the nice modal instead of alert()
      //       showModal("Success", "Holiday removed successfully.", "success");

      //       // Refresh the data tables
      //       await loadAdminHolidays();
      //       if (typeof loadPublicHolidays === "function") {
      //         await loadPublicHolidays();
      //       }
      //     } else {
      //       const err = await res.json();
      //       showModal(
      //         "Error",
      //         err.detail || "Failed to delete holiday.",
      //         "error"
      //       );
      //     }
      //   } catch (e) {
      //     console.error("Holiday Delete Error:", e);
      //     showModal("Network Error", "Check server connection.", "error");
      //   }
      // }

      // --- EXPORT SYSTEM AUDIT LOG TO CSV ---

      function exportAuditLogCSV() {
        // 1. Guard: Check if data exists
        if (!masterAuditData || masterAuditData.length === 0) {
          alert("No data available to export.");
          return;
        }

        // 2. Define Headers
        const headers = [
          "Record ID",
          "Employee Name",
          "Type",
          "Duration",
          "Unit",
          "Start Date",
          "End Date",
          "Approver",
          "Current Status",
        ];

        // 3. Map Data
        const csvRows = masterAuditData.map((log) => {
          // A. Handle ID
          const isOT = log.record_source === "OT";
          const prefix = isOT ? "OT" : "LV";
          const refID = `${prefix}-${String(log.id).padStart(4, "0")}`;

          // B. Handle Dates
          let start = log.start_date || log.ot_date || "-";
          let end = log.end_date || log.ot_date || "-";

          // C. Handle Duration & Unit (Capitalized)
          let duration = log.days_taken;
          let unit = "DAYS"; // Default for Leaves

          if (isOT) {
            // üöÄ FIX: Force uppercase (hours -> HOURS)
            unit = (log.ot_unit || "HOURS").toUpperCase();

            if (log.total_value) {
              duration = log.total_value;
            } else {
              duration = parseFloat(log.days_taken) || 0;
            }
          }

          let approver = log.approver_name || "System/Admin";

          // D. Sanitize
          const clean = (text) =>
            `"${String(text || "")
              .replace(/"/g, '""')
              .replace(/\n/g, " ")}"`;

          return [
            clean(refID),
            clean(log.employee_name),
            clean(log.leave_type || log.ot_type),
            clean(duration),
            clean(unit),
            clean(start),
            clean(end),
            clean(approver),
            clean(log.status),
          ].join(",");
        });

        // 4. Download
        const csvString = [headers.join(","), ...csvRows].join("\n");
        const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        const dateStamp = new Date().toISOString().split("T")[0];

        link.href = url;
        link.setAttribute("download", `HR_Audit_Report_${dateStamp}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // üìä Export Balances to CSV
      async function exportEntitlementsCSV() {
    const name = document.getElementById("mgr_ent_search_name")?.value || "";
    const year = new Date().getFullYear();
    const primaryRole = userRoles.includes("hr_admin") ? "hr_admin" : "manager";

    // Feedback to user (Visual Loading State)
    const btn = document.querySelector("button[onclick='exportEntitlementsCSV()']");
    const originalText = btn ? btn.innerHTML : "Export CSV";
    if (btn) {
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Downloading...`;
        btn.disabled = true;
    }

    try {
        // 1. Fetch Data (Reusing existing endpoint for consistency)
        const params = new URLSearchParams({
            user_role: primaryRole,
            approver_name: currentUser,
            name: name,
            year: year,
        });

        const res = await fetchWithAuth(`${API_URL}/leaves/manager/entitlements?${params.toString()}`);

        if (!res || !res.ok) {
            alert("‚ùå Failed to fetch data for export.");
            return;
        }

        const data = await res.json();

        if (!data || data.length === 0) {
            alert("‚ö†Ô∏è No records found to export.");
            return;
        }

        // 2. Define CSV Headers (Aligned with your requested order)
        let csvContent = "Employee,Annual Rem,Annual Total,Medical Rem,Medical Total,Emergency Rem,Emergency Total,Compassionate Rem,Compassionate Total,Overtime (Hrs),Unpaid Taken,Carry Forward,Status\n";

        // 3. Map Data to Rows
        data.forEach((emp) => {
            const row = [
                `"${emp.name}"`,                          // Employee
                emp.annual_remaining,                    // Annual Rem
                emp.annual_entitlement,                  // Annual Total
                emp.medical_remaining,                   // Medical Rem
                emp.medical_entitlement,                 // Medical Total
                emp.emergency_remaining,                 // Emergency Rem
                emp.emergency_entitlement,               // Emergency Total
                emp.compassionate_remaining,             // Compassionate Rem
                emp.compassionate_entitlement,           // Compassionate Total
                emp.overtime_bank || 0,                  // Overtime (Hrs)
                emp.unpaid_taken || 0,                   // Unpaid
                emp.carry_forward_total || 0,            // Carry Fwd
                `"${emp.status || 'Active'}"`            // Status
            ].join(",");
            csvContent += row + "\n";
        });

        // 4. Trigger File Download
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const dateStamp = new Date().toISOString().split("T")[0];

        link.setAttribute("href", url);
        link.setAttribute("download", `Team_Balances_Report_${year}_${dateStamp}.csv`);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (e) {
        console.error("Export Error:", e);
        alert("‚ùå An error occurred during export.");
    } finally {
        // Restore button state
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
}

      // 1. New function to handle real-time suggestions
      // 1. Live Search: Fetches suggestions as HR types
      async function handleLiveSearch(query) {
        const suggestionBox = document.getElementById(
          "employee_suggestions_box"
        );

        // Requirement: Only search if 2 or more characters typed
        if (query.trim().length < 2) {
          suggestionBox.innerHTML = "";
          suggestionBox.style.display = "none";
          return;
        }

        try {
          // Fetch all users to ensure we have the full list
          const res = await fetchWithAuth(`${API_URL}/users/all`);
          if (!res) return;

          const allUsers = await res.json();

          // üöÄ THE FIX: Filter the results based on the input (Tailoring)
          const filtered = allUsers
            .filter(
              (u) =>
                u.full_name.toLowerCase().includes(query.toLowerCase()) ||
                u.username.toLowerCase().includes(query.toLowerCase())
            )
            .slice(0, 8); // Top 8 results for a clean UI

          if (filtered.length > 0) {
            suggestionBox.innerHTML = filtered
              .map(
                (u) => `
                <div class="suggestion-item" 
                     style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px;"
                     onclick="selectUserForAdjustment('${u.full_name.replace(
                       /'/g,
                       "\\'"
                     )}')">
                    <i class="fas fa-user" style="color: #94a3b8;"></i>
                    <div>
                        <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">${
                          u.full_name
                        }</div>
                        <small style="color: #94a3b8; font-family: monospace;">@${
                          u.username
                        }</small>
                    </div>
                </div>
              `
              )
              .join("");
            suggestionBox.style.display = "block";
          } else {
            // No results found
            suggestionBox.innerHTML = `<div style="padding: 15px; color: #94a3b8; font-size: 0.85rem;">No matches found for "${query}"</div>`;
            suggestionBox.style.display = "block";
          }

          // Exact Match handling (Case insensitive)
          const exactMatch = filtered.find(
            (u) => u.full_name.toLowerCase() === query.trim().toLowerCase()
          );

          if (exactMatch) {
            suggestionBox.style.display = "none";
            document.getElementById("policy_user_search").value =
              exactMatch.full_name;
            searchEmployeeForAdjustment();
          }
        } catch (e) {
          console.error("Live search error:", e);
        }
      }

      /**
       * üéØ Selection Helper
       * This function "catches" the name when Natasha clicks a suggestion.
       */
      function selectUserForAdjustment(name) {
        // 1. Fill the search input with the name she clicked
        const input = document.getElementById("policy_user_search");
        if (input) input.value = name;

        // 2. Hide the suggestion box immediately so it's not in the way
        const box = document.getElementById("employee_suggestions_box");
        if (box) box.style.display = "none";

        // 3. üöÄ AUTO-LOAD: This calls your existing function to fetch the
        // leave balances from the database and open the green form.
        if (typeof searchEmployeeForAdjustment === "function") {
          searchEmployeeForAdjustment();
        } else {
          console.error("Function searchEmployeeForAdjustment not found!");
        }
      }

      // 2. Reset Function: Clears search, hides form, and RESTORES placeholder
      function resetAdjustmentForm() {
        // Clear search input
        const searchInput = document.getElementById("policy_user_search");
        if (searchInput) searchInput.value = "";

        // Hide suggestions box
        const suggestionBox = document.getElementById(
          "employee_suggestions_box"
        );
        if (suggestionBox) {
          suggestionBox.innerHTML = "";
          suggestionBox.style.display = "none";
        }

        // üöÄ THE FIX: Hide the adjustment form AND show the placeholder graphic
        const adjForm = document.getElementById("adjustment_form_container");
        const placeholder = document.getElementById("adj_placeholder");

        if (adjForm) adjForm.style.display = "none";
        if (placeholder) placeholder.style.display = "block"; // This makes the "x" work

        document.getElementById("adj_emp_name").innerText = "";

        // Clear the global reference
        window.currentAdjustingUser = null;
      }

// 3. Helper to load the form data (Intelligent Dashboard Engine)
// 3. Helper to load the form data (Intelligent Dashboard Engine)
// 3. Helper to load the form data (Intelligent Dashboard Engine)
async function loadHomeLeadershipInsights() {
    // 1. Setup Role Access
    const isHR = userRoles.includes("hr_admin");
    const isManager = userRoles.includes("manager");
    const isBoss = isHR || isManager;

    // 2. Get DOM Elements
    const panel = document.getElementById("leadership_panel");
    const miniStats = document.getElementById("leadership_mini_stats");
    const actionCenter = document.getElementById("manager_action_center");
    
    const listEl = document.getElementById("home_away_list");
    const leaveInbox = document.getElementById("tile_leave_inbox");
    const otInbox = document.getElementById("tile_ot_inbox");

    // 3. Toggle Visibility based on Role
    if (panel) panel.style.display = "block";
    if (miniStats) miniStats.style.display = isBoss ? "flex" : "none";
    if (actionCenter) actionCenter.style.display = isBoss ? "block" : "none";

    try {
        // üöÄ TIMEZONE FIX: Ensure we use Local System Time (KL)
        const now = new Date();
        const offset = now.getTimezoneOffset();
        const todayStr = new Date(now.getTime() - (offset * 60 * 1000)).toISOString().split('T')[0];
        const year = now.getFullYear();

        // 4. CONCURRENT FETCHING
        const fetchPromises = [
            fetchWithAuth(`${API_URL}/leaves/public-holidays`),
            fetchWithAuth(`${API_URL}/leaves/public-calendar`),
            fetchWithAuth(`${API_URL}/leaves/history?employee_name=${encodeURIComponent(currentUser)}&page_size=100`)
        ];

        if (isBoss) {
            const roleParam = isHR ? "hr_admin" : "manager";
            fetchPromises.push(fetchWithAuth(`${API_URL}/leaves/manager/all?user_role=${roleParam}&approver_name=${encodeURIComponent(currentUser)}`));
            fetchPromises.push(fetchWithAuth(`${API_URL}/overtime/manager-requests?approver_name=${encodeURIComponent(currentUser)}`));
        }

        const responses = await Promise.all(fetchPromises);

        const holidays = responses[0]?.ok ? await responses[0].json() : [];
        const publicLeaves = responses[1]?.ok ? await responses[1].json() : [];
        const myHistoryData = responses[2]?.ok ? await responses[2].json() : { leaves: [] };
        const myLeaves = myHistoryData.leaves || [];
        
        const mgrData = isBoss && responses[3]?.ok ? await responses[3].json() : { requests: [] };
        const mgrLeaves = mgrData.requests || [];
        const otData = isBoss && responses[4]?.ok ? await responses[4].json() : [];
        
        const pendingOT = (Array.isArray(otData) ? otData : []).filter(r => r.status.includes("Pending"));
        const pendingLeaves = mgrLeaves.filter(l => l.status === "Pending" || l.status === "Pending Cancel");

        // --- üóìÔ∏è 1. NEXT HOLIDAY ---
        const nextHoliday = holidays.filter(h => h.holiday_date >= todayStr).sort((a, b) => a.holiday_date.localeCompare(b.holiday_date))[0];
        const holidayEl = document.getElementById("home_next_holiday");
        if (holidayEl) {
            if (nextHoliday) {
                const hDate = new Date(nextHoliday.holiday_date);
                const diffDays = Math.ceil((hDate - new Date(todayStr)) / (1000 * 60 * 60 * 24));
                holidayEl.innerHTML = `
                    <div style="font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 4px;">Next Holiday</div>
                    <div style="font-weight: 700; color: #1e293b; font-size: 0.95rem; line-height: 1.2;">${nextHoliday.name}</div>
                    <small style="color: #0369a1; font-weight: 600; font-size: 0.75rem;">${diffDays === 0 ? 'TODAY' : 'In '+diffDays+' days'} (${formatDateNice(nextHoliday.holiday_date)})</small>`;
            } else {
                holidayEl.innerHTML = `<div style="font-weight: 500; color: #94a3b8; font-size: 0.85rem;">No upcoming holidays.</div>`;
            }
        }

        // --- ‚úàÔ∏è 2. MY UPCOMING LEAVE ---
        const holidayLimit = new Date(year, now.getMonth(), now.getDate() + 30);
        const holidayLimitStr = holidayLimit.toISOString().split('T')[0];
        const personalUpcoming = myLeaves
            .filter(l => (l.status || "").toLowerCase() === "approved" && l.start_date > todayStr && l.start_date <= holidayLimitStr)
            .sort((a, b) => a.start_date.localeCompare(b.start_date))[0];

        const leaveEl = document.getElementById("home_my_next_leave");
        if (leaveEl) {
            if (personalUpcoming) {
                const lDate = new Date(personalUpcoming.start_date);
                const diffDays = Math.ceil((lDate - new Date(todayStr)) / (1000 * 60 * 60 * 24));
                leaveEl.innerHTML = `
                    <div style="font-size: 0.7rem; font-weight: 700; color: #ef4444; text-transform: uppercase; margin-bottom: 4px;">Starting Soon</div>
                    <div style="font-weight: 700; color: #1e293b; font-size: 0.95rem; line-height: 1.2;">${formatDateNice(personalUpcoming.start_date)}</div>
                    <small style="color: #15803d; font-weight: 600; font-size: 0.75rem;">In ${diffDays} days ‚Ä¢ ${personalUpcoming.days_taken} Day(s)</small>`;
            } else {
                leaveEl.innerHTML = `<div style="font-weight: 500; color: #94a3b8; font-size: 0.85rem;">No approved leave soon.</div>`;
            }
        }

        // --- üîµ 3. PENDING LEAVE (TOP 3 + VIEW MORE) ---
        if (document.getElementById("home_leave_count")) document.getElementById("home_leave_count").innerText = pendingLeaves.length;
        if (leaveInbox) {
            // Logic: Show Top 3. If remaining > 0, show link.
            const visibleItems = pendingLeaves.slice(0, 3);
            const hiddenCount = pendingLeaves.length - 3;
            
            leaveInbox.innerHTML = pendingLeaves.length > 0 
                ? visibleItems.map(l => `
                    <div class="pulse-row" style="background:rgba(255,255,255,0.6); border-left: 3px solid #f59e0b; padding: 6px 8px; margin-bottom: 4px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;" onclick="showSection('manager_requests')">
                        <div style="display:flex; flex-direction:column;">
                            <span class="pulse-name" style="font-size:0.75rem; font-weight:700;">${l.employee_name.split(' ')[0]}</span>
                            <span style="font-size:0.6rem; color:#64748b;">${l.days_taken}d Leave</span>
                        </div>
                        <span class="pulse-label" style="background:#fff7ed; color:#f59e0b; font-size:0.55rem; padding: 2px 4px; font-weight:800;">REVIEW</span>
                    </div>`).join("") + (hiddenCount > 0 ? `<div style="text-align:center; font-size:0.7rem; color:#2563eb; font-weight:600; padding-top:4px; cursor:pointer;" onclick="showSection('manager_requests')">+ ${hiddenCount} more requests...</div>` : "")
                : `<div style="font-size:0.65rem; opacity:0.5; font-style:italic;">All clear!</div>`;
        }

        // --- üü† 4. PENDING OT (TOP 3 + VIEW MORE) ---
        if (document.getElementById("home_ot_count")) document.getElementById("home_ot_count").innerText = pendingOT.length;
        if (otInbox) {
            // Logic: Show Top 3. If remaining > 0, show link.
            const visibleItems = pendingOT.slice(0, 3);
            const hiddenCount = pendingOT.length - 3;

            otInbox.innerHTML = pendingOT.length > 0 
                ? visibleItems.map(o => `
                    <div class="pulse-row" style="background:rgba(255,255,255,0.6); border-left: 3px solid #3b82f6; padding: 6px 8px; margin-bottom: 4px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;" onclick="showSection('manager_ot_requests')">
                        <div style="display:flex; flex-direction:column;">
                            <span class="pulse-name" style="font-size:0.75rem; font-weight:700;">${o.employee_name.split(' ')[0]}</span>
                            <span style="font-size:0.6rem; color:#64748b;">${o.total_value}${o.ot_unit[0]} Claim</span>
                        </div>
                        <span class="pulse-label" style="background:#eff6ff; color:#3b82f6; font-size:0.55rem; padding: 2px 4px; font-weight:800;">OT</span>
                    </div>`).join("") + (hiddenCount > 0 ? `<div style="text-align:center; font-size:0.7rem; color:#2563eb; font-weight:600; padding-top:4px; cursor:pointer;" onclick="showSection('manager_ot_requests')">+ ${hiddenCount} more requests...</div>` : "")
                : `<div style="font-size:0.65rem; opacity:0.5; font-style:italic;">All clear!</div>`;
        }

        // --- üü¢ 5. WHO'S AWAY TODAY (Full List) ---
        // This will trigger the CSS scrollbar you committed earlier if the list is long.
        if (listEl) {
            const awayToday = publicLeaves.filter(l => todayStr >= l.start_date && todayStr <= l.end_date);
            if (document.getElementById("away_today_title")) {
                document.getElementById("away_today_title").innerText = `Who's Away Today (${awayToday.length})`;
            }
            listEl.innerHTML = awayToday.length === 0 
                ? `<div style="font-size:0.75rem; color:#94a3b8; padding:10px 0; font-style:italic;">Everyone is present.</div>`
                : awayToday.map(l => `
                    <div class="pulse-row" style="background:#f8fafc; border-left: 3px solid #e57d70; padding: 8px 10px; margin-bottom: 6px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f5f9;">
                        <div style="display:flex; flex-direction:column;">
                            <span class="pulse-name" style="font-size:0.85rem; font-weight:700; color:#1e293b;">${l.employee_name}</span>
                            <span style="font-size:0.65rem; color:#64748b;">Until ${formatDateNice(l.end_date)}</span>
                        </div>
                        <span class="pulse-label" style="background:#fef2f2; color:#e57d70; font-size:0.6rem; padding: 2px 6px; border-radius: 4px; font-weight:800; text-transform: uppercase;">
                            ${l.leave_type.split(' ')[0]}
                        </span>
                    </div>`).join("");
        }

        // --- üìä 6. MINI STATS ---
        if (isBoss && miniStats) {
            const approved = mgrLeaves.filter(l => (l.status || "").toLowerCase() === "approved");
            const medical = approved.filter(l => l.leave_type === "Medical Leave").length;
            document.getElementById("home_stat_total").innerText = mgrLeaves.length;
            document.getElementById("home_stat_approved").innerText = approved.length;
            
            const userRes = await fetchWithAuth(`${API_URL}/users/all`);
            const allUsers = userRes && userRes.ok ? await userRes.json() : [];
            const activeCount = allUsers.filter(u => u.is_active !== false).length || 1;
            document.getElementById("home_stat_medical").innerText = Math.round((medical / activeCount) * 100) + "%";
        }

    } catch (err) {
        console.error("Dashboard Refresh Error:", err);
    }
}

 // üöÄ MY PROFILE: Modern Digital Dossier (Zero-Bug Version)
 async function loadUserProfile() {
        try {
          // Fetch user data
          const res = await fetchWithAuth(
            `${API_URL}/users/all?search=${encodeURIComponent(currentUser)}`
          );
          if (!res) return;
          const users = await res.json();

          // Find the record matching the logged-in user safely
          const me = users.find(
            (u) =>
              (u.username && u.username.toLowerCase() === currentUser.toLowerCase()) ||
              u.full_name === currentUser
          );

          if (me) {
            // üöÄ CRITICAL 1: Sync L2 Power (Explicit String for boolean safety)
            localStorage.setItem("is_senior_manager", me.is_senior_manager === true ? "true" : "false");
            console.log("üëë Senior Manager Status Sync:", me.is_senior_manager);

            // üöÄ CRITICAL 2: THE FIX - Sync Global Roles dynamically!
            // This ensures if HR changes their role while they are logged in, the system adapts instantly.
            let freshRoles = me.roles_list || ["employee"];
            if (me.role && !freshRoles.includes(me.role)) freshRoles.push(me.role); // Legacy fallback
            
            localStorage.setItem("userRoles", JSON.stringify(freshRoles));
            USER_ROLES = freshRoles;
            userRoles = freshRoles;

            // üöÄ CRITICAL 3: Immediately update sidebar menus based on fresh roles
            if (typeof initializeAccess === "function") initializeAccess();

            // 1. Generate Avatar Initials
            const initials = (me.full_name || "??")
              .split(" ")
              .map((n) => n[0])
              .slice(0, 2)
              .join("")
              .toUpperCase();
            const avatarEl = document.getElementById("prof_avatar");
            if (avatarEl) avatarEl.innerText = initials;

            // 2. Generate Role Badge
            const roleEl = document.getElementById("prof_role_badge");
            let roleHtml = `<span style="background:#f1f5f9; color:#475569; padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:700; border:1px solid #cbd5e1;">EMPLOYEE</span>`;

            if (freshRoles.includes("hr_admin")) {
              roleHtml = `<span style="background:#faf5ff; color:#7e22ce; padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:700; border:1px solid #e9d5ff;">HR ADMIN</span>`;
            } else if (freshRoles.includes("manager")) {
              roleHtml = `<span style="background:#fff7ed; color:#c2410c; padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:700; border:1px solid #fed7aa;">MANAGER</span>`;
            }

            // Append L2 Power Badge if applicable
            if (me.is_senior_manager) {
              roleHtml += `<span style="margin-left:8px; background:#eff6ff; color:#1d4ed8; padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:700; border:1px solid #bfdbfe;">L2 POWER</span>`;
            }

            if (roleEl) roleEl.innerHTML = roleHtml;

            // 3. Map Fields to HTML
            const mapping = {
              profileName: me.full_name,
              prof_username: "@" + me.username,
              prof_id: me.employee_id,
              prof_gender: me.gender,
              prof_marital: me.marital_status,
              prof_email: me.email,
              prof_mobile: me.mobile,
              prof_job: me.job_title,
              prof_unit: me.business_unit,
              prof_dept: me.department,
              prof_manager: me.line_manager,
              prof_joined: me.joined_date
                ? new Date(me.joined_date).toLocaleDateString("en-GB", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                  })
                : "---",
            };

            for (let [id, val] of Object.entries(mapping)) {
              const el = document.getElementById(id);
              if (el) el.innerText = val || "---";
            }
          }
        } catch (e) {
          console.error("Profile Load Error:", e);
        }
      }


      async function applySystemBranding() {
    try {
        const res = await fetchWithAuth(`${API_URL}/settings/branding`);
        if (res && res.ok) {
            const data = await res.json();
            
            // 1. Update Sidebar Text
            const sideName = document.getElementById("sidebar_company_name");
            if (sideName) sideName.innerText = data.company_name || "IdeaMakr";

            const sideSub = document.getElementById("sidebar_sub_info");
            if (sideSub) sideSub.innerText = data.company_sub_info || "Software Studio";
            
            // 2. üöÄ THE FIX: Update Sidebar logo with Absolute Path
            const sideLogo = document.getElementById("sidebar_logo_img");
            const defaultIcon = document.getElementById("sidebar_default_icon");
            
            if (data.company_logo && data.company_logo.trim() !== "") {
                if (sideLogo) {
                    // Check if it's already a full URL, if not, prepend API_URL
                    const finalLogoUrl = data.company_logo.startsWith('http') 
                        ? data.company_logo 
                        : `${API_URL}${data.company_logo}`;
                    
                    sideLogo.src = finalLogoUrl;
                    sideLogo.style.display = "block";
                }
                if (defaultIcon) defaultIcon.style.display = "none";
            } else {
                if (sideLogo) sideLogo.style.display = "none";
                if (defaultIcon) defaultIcon.style.display = "inline-block";
            }
            
            // 3. Pre-fill the settings inputs
            const inputName = document.getElementById("config_company_name");
            const inputSub = document.getElementById("config_sub_info");
            const inputLogo = document.getElementById("config_company_logo");
            
            if (inputName) inputName.value = data.company_name || "";
            if (inputSub) inputSub.value = data.company_sub_info || "";
            
            if (inputLogo) {
                inputLogo.value = data.company_logo || "";
                // Pass the full URL to the preview function too!
                if (typeof updateBrandingPreview === "function") {
                    const previewUrl = data.company_logo.startsWith('http') 
                        ? data.company_logo 
                        : `${API_URL}${data.company_logo}`;
                    updateBrandingPreview(previewUrl);
                }
            }
        }
    } catch (e) {
        console.error("Branding apply error:", e);
    }
}


    async function submitProfileUpdate(event, userId) {
    if (event) event.preventDefault();

    // 1. --- RESET PHASE (Solves Issue #2) ---
    // Clear all red borders and hide messages before re-validating
    const errorSlots = ["name_error", "user_error", "mobile_error", "date_error", "manager_error"];
    errorSlots.forEach(id => clearError(id));

    // 2. --- DATA GATHERING ---
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : "";
    };

    const fullName = getVal("reg_full_name");
    const email = getVal("reg_email");
    const mobile = getVal("reg_mobile");
    const joinedDate = getVal("reg_joined");
    const lineManager = getVal("reg_manager"); // üöÄ Gathered for validation

    // 3. --- FRONTEND VALIDATION (Solves Issue #1) ---
    let hasError = false;

    if (!fullName) { 
        showInlineError("name_error", "Full Name is required"); 
        hasError = true; 
    }
    if (!email) { 
        showInlineError("user_error", "Business Email is required"); 
        hasError = true; 
    }
    if (!mobile) { 
        showInlineError("mobile_error", "Mobile number is required"); 
        hasError = true; 
    }
    if (!joinedDate) { 
        showInlineError("date_error", "Joined Date is required"); 
        hasError = true; 
    }
    // üöÄ NEW: Validate Line Manager Selection
    if (!lineManager) {
        showInlineError("manager_error", "Please select a Line Manager");
        hasError = true;
    }

    if (hasError) return; // Stop if any inline errors exist

    // 4. --- PREPARE PAYLOAD ---
    const formData = new FormData();
    formData.append("full_name", fullName);
    formData.append("employee_id", getVal("reg_emp_id"));
    formData.append("gender", getVal("reg_gender"));
    formData.append("marital_status", getVal("reg_marital"));
    formData.append("email", email.toLowerCase()); 
    formData.append("mobile", mobile);
    formData.append("job_title", getVal("reg_job_title"));
    formData.append("business_unit", getVal("reg_unit"));
    formData.append("department", getVal("reg_dept"));
    formData.append("line_manager", lineManager);
    formData.append("joined_date", joinedDate);

    try {
        // Show loading state for better UX
        Swal.fire({
            title: 'Updating Profile...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        const res = await fetchWithAuth(
            `${API_URL}/users/${userId}/profile-update`,
            {
                method: "PUT",
                body: formData,
            }
        );

        if (!res) return;

        if (res.ok) {
            // üöÄ SUCCESS (Issue #3 Upgrade)
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Profile updated successfully.',
                timer: 2000,
                showConfirmButton: false
            });
            closeRegisterModal();
            await loadAllUsers();
        } else {
            const err = await res.json();
            // Handle backend validation errors inline
            if (err.detail && Array.isArray(err.detail)) {
                err.detail.forEach(e => {
                    const field = e.loc[e.loc.length - 1];
                    if (field === "full_name") showInlineError("name_error", e.msg);
                    if (field === "email") showInlineError("user_error", e.msg);
                    if (field === "mobile") showInlineError("mobile_error", e.msg);
                });
                Swal.close(); // Close loading if showing inline errors
            } else {
                Swal.fire('Update Failed', err.detail || 'Check all fields', 'error');
            }
        }
    } catch (e) {
        console.error("Profile Update Error:", e);
        Swal.fire('System Error', 'Could not reach server. Please check your connection.', 'error');
    }
}

      // 2. The proper way to handle the initial screen load
      // üöÄ Your existing load logic - updated to include the back prevention call
      // üöÄ THE FIX: Orchestrated Startup (The 401 & Empty Tile Killer)
      // üöÄ FINAL ROBUST STARTUP SEQUENCE
      window.onload = async () => {
    console.log("üöÄ System Startup Initiated...");

    // 1. Initialize browser history protection
    if (typeof initBackPrevention === "function") initBackPrevention();

    // 2. FORCE SYNC: Move session data from slow storage to fast RAM immediately
    // üöÄ FIX: We ensure 'currentUser' and 'userRoles' are updated in the global scope
    if (!SESSION_ID || SESSION_ID === "null" || !CURRENT_USER) {
        SESSION_ID = localStorage.getItem("sessionId");
        CURRENT_USER = localStorage.getItem("currentUser");
        
        // Update the aliases used by fetchWithAuth and other functions
        currentUser = CURRENT_USER; 
        
        try {
            USER_ROLES = JSON.parse(
                localStorage.getItem("userRoles") || '["employee"]'
            );
            userRoles = USER_ROLES;
        } catch (e) {
            USER_ROLES = ["employee"];
            userRoles = USER_ROLES;
        }
    }

    // üö® 3. Security Hard Stop: If no session exists, kick to login
    if (!SESSION_ID || !currentUser || SESSION_ID === "null") {
        console.warn("‚ö†Ô∏è Security Guard: No session found. Redirecting...");
        window.location.replace("login.html");
        return;
    }

    // ==========================================================
    // üöÄ NEW: SUPERUSER AUTO-REDIRECT LOGIC
    // ==========================================================
    let savedTab = sessionStorage.getItem("activeTab") || "home";
    const isAdminAccount = (localStorage.getItem("username") === "superuser" || currentUser === "System Administrator");
    
    // If the Superuser logs in or hits refresh on the empty Home screen, divert them!
    if (isAdminAccount && savedTab === "home") {
        savedTab = "hr_audit"; 
    }
    // ==========================================================

    console.log(`üîê Session Verified. User: ${currentUser} | Tab: ${savedTab}`);

    // 4. üü¢ UI PREP (Non-blocking)
    try {
        if (typeof populateTimeDropdowns === "function") populateTimeDropdowns();
    } catch (e) { console.error("UI Prep Error:", e); }
    
    try {
        // This ensures the L2 Filter in the Manager Dashboard is synced with the DB setting
        if (typeof syncL2ToggleState === "function") syncL2ToggleState();
    } catch (e) { console.error("L2 Sync Error:", e); }

    // 5. üü¢ RUN SETUP ROUTINES (Profile, Settings, Approvers, Balances)
    // This MUST happen before showing the section to ensure balances are ready
    if (typeof initializeDashboard === "function") {
        try {
            await initializeDashboard();
        } catch (err) {
            console.error("‚ö†Ô∏è Dashboard Setup Warning:", err);
        }
    }

    // 6. üü¢ LAUNCH THE UI (Crucial Step: Populates Tables)
    try {
        await showSection(savedTab);

        // üöÄ SUB-TAB PERSISTENCE
        // Ensures if they were on OT or Carry Forward, they stay there after refresh
        if (savedTab === 'apply') {
            const savedMode = localStorage.getItem("current_apply_mode") || "leave";
            console.log("üîÑ Restoring Apply Sub-Tab Mode:", savedMode);
            
            if (typeof switchApplyMode === "function") {
                switchApplyMode(savedMode);
            }
        }
    } catch (err) {
        console.error("‚ùå UI Launch Error:", err);
        // Emergency fallback: If the saved tab fails, go to home
        if (savedTab !== "home") showSection("home");
    }

    // üöÄ 7. START DRAFT WATCHERS (Auto-save typing)
    try {
        if (typeof initLeaveDraftListeners === "function") initLeaveDraftListeners();
        if (typeof initOTDraftListeners === "function") initOTDraftListeners();
    } catch (e) { console.error("Draft Listener Error:", e); }
    
    console.log("‚úÖ Dashboard Fully Synchronized.");
};

// ... keep your initLeaveDraftListeners function exactly as you wrote it ...
function initLeaveDraftListeners() {
    const fields = [
        "dash_leave_type", 
        "dash_start", 
        "dash_end", 
        "dash_reason", 
        "dash_approver", 
        "dash_half_day",
        // üöÄ ADDED CARRY FORWARD FIELDS
        "cf_days_input",
        "dash_approver_cf",
        "cf_reason" // üëà CRITICAL: Added this so CF typing is detected
    ];

    fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            // Remove first to prevent double-stacking listeners on re-initialization
            // Note: We use window.saveLeaveDraft to reference the global function
            el.removeEventListener("input", window.saveLeaveDraft);
            el.removeEventListener("change", window.saveLeaveDraft);
            
            el.addEventListener("input", window.saveLeaveDraft);
            el.addEventListener("change", window.saveLeaveDraft);
        } else {
            // We use console.log instead of warn because CF fields 
            // might not exist for all users (non-managers/non-HR)
            console.log(`‚ÑπÔ∏è Listener note: ${id} not present in current view.`);
        }
    });
    console.log("üìù Unified Leave & CF Draft Listeners Activated.");
}
async function renderCalendar() {
        const modal = document.getElementById("calendarModal");
        const isModalOpen = modal && (modal.style.display === "flex" || modal.style.display === "block");

        const calendar = isModalOpen
          ? document.getElementById("modal_calendar_grid")
          : document.getElementById("team_calendar");

        const monthYearLabel = isModalOpen
          ? document.getElementById("modal_month_year")
          : document.getElementById("calendar_month_year");

        // Safety break if elements are missing
        if (!calendar || !monthYearLabel) return;

        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        const todayStr = new Date().toLocaleDateString("en-CA");

        monthYearLabel.innerText = new Intl.DateTimeFormat("en-US", {
          month: "long",
          year: "numeric",
        }).format(currentCalDate);

        try {
          // Fetch Leaves and Holidays
          const [res, holidayRes] = await Promise.all([
            fetchWithAuth(`${API_URL}/leaves/public-calendar`),
            fetchWithAuth(`${API_URL}/leaves/public-holidays`),
          ]);

          if (!res || !holidayRes) return;

          const rawData = await res.json();
          const holidays = await holidayRes.json();

          const approvedLeaves = Array.isArray(rawData) ? rawData : rawData.requests || [];

          // üöÄ HIGH-PERFORMANCE STRING BUILDER
          let finalHTML = "";
          const firstDayIndex = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          let cellsInjected = 0;

          // 1. Previous month padding (Updated to fixed height)
          for (let i = 0; i < firstDayIndex; i++) {
            finalHTML += `<div style="background: #f8fafc; border: 1px solid #f1f5f9; height: 110px;"></div>`;
            cellsInjected++;
          }

          // 2. Generate Actual Days
          for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
            const isToday = dateStr === todayStr;

            const holidayToday = holidays.find((h) => h.holiday_date === dateStr);

            const leavesToday = approvedLeaves.filter((l) => {
              const inRange = dateStr >= l.start_date && dateStr <= l.end_date;
              if (!inRange) return false;

              const currentDay = new Date(dateStr).getDay();
              const isWeekend = currentDay === 0 || currentDay === 6;

              if (isWeekend) {
                const type = (l.leave_type || "").toLowerCase();
                return type.includes("overtime") || l.record_source === "OT" || ["regular", "weekend", "holiday"].includes(type);
              }
              return true;
            });

            const dayBg = holidayToday ? "background-color: #f1f5f9;" : "";

            // üöÄ THE FIX: Fixed height of 110px, overflow hidden, flex column
            let dayHtml = `
              <div class="calendar-day ${isToday ? "today" : ""}" style="${dayBg} height: 110px; overflow: hidden; display: flex; flex-direction: column;">
                  <div style="font-weight: 800; font-size: 0.75rem; color: ${isToday ? "#b45309" : "#64748b"}; margin-bottom: 4px; flex-shrink: 0;">
                    ${day}
                  </div>
                  
                  <div style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; padding-right: 2px;">`;

            if (holidayToday) {
              dayHtml += `
                <div class="leave-pill" title="Public Holiday: ${holidayToday.name}"
                     style="background: #e2e8f0; color: #475569; border-left: 3px solid #94a3b8; font-style: italic; margin-bottom: 0; flex-shrink: 0;">
                    <i class="fas fa-umbrella-beach" style="font-size: 0.6rem;"></i> ${holidayToday.name}
                </div>`;
            }

            leavesToday.forEach((l) => {
              let pillColor = "#e0e7ff";
              let textColor = "#4338ca";
              if (l.leave_type === "Medical Leave") {
                pillColor = "#dcfce7"; textColor = "#166534";
              } else if (l.leave_type === "Emergency Leave") {
                pillColor = "#fee2e2"; textColor = "#991b1b";
              } else if (l.leave_type === "Compassionate Leave") {
                pillColor = "#fef3c7"; textColor = "#92400e";
              }

              // Added flex-shrink: 0 to prevent the pills from shrinking when many exist
              dayHtml += `
                <div class="leave-pill" title="${l.employee_name}: ${l.leave_type}"
                     style="background: ${pillColor}; color: ${textColor}; border-left: 3px solid ${textColor}; margin-bottom: 0; flex-shrink: 0;">
                    ${l.employee_name.split(" ")[0]}
                </div>`;
            });

            dayHtml += `
                  </div> </div> `;
              
            finalHTML += dayHtml;
            cellsInjected++;
          }

          // 3. Fill remaining cells (Updated to fixed height)
          while (cellsInjected < 42) {
            finalHTML += `<div style="background: #f8fafc; border: 1px solid #f1f5f9; height: 110px; opacity: 0.4;"></div>`;
            cellsInjected++;
          }

          // üöÄ Inject into the DOM exactly ONCE
          calendar.innerHTML = finalHTML;

          // Today Button UI Polish
          const realToday = new Date();
          const isCurrentMonth =
            currentCalDate.getMonth() === realToday.getMonth() &&
            currentCalDate.getFullYear() === realToday.getFullYear();
          const todayBtn = document.querySelector("button[onclick='resetToToday()']");

          if (todayBtn) {
            todayBtn.style.opacity = isCurrentMonth ? "0.5" : "1";
            todayBtn.style.cursor = isCurrentMonth ? "default" : "pointer";
            todayBtn.disabled = isCurrentMonth;
          }
        } catch (e) {
          console.error("Calendar Load Error:", e);
          calendar.innerHTML = "<p style='grid-column: span 7; text-align:center; padding:20px; color:#ef4444;'>Error loading team schedule.</p>";
        }
      }
  
  // ==========================================
// üìù FULL PROFILE EDIT MODAL
// ==========================================
async function openFullProfileEditModal(userJsonRaw) {
    try {
        const user = typeof userJsonRaw === 'string' ? JSON.parse(userJsonRaw) : userJsonRaw;
        const modal = document.getElementById("registerUserModal");
        if (!modal) return;

        // Ensure managers are loaded before setting the value
        await loadApproverList();

        // 1. Switch UI to "Edit Mode"
        modal.querySelector("h3").innerHTML = `<i class="fas fa-user-edit"></i> Edit Profile: ${user.full_name}`;

        // 2. üöÄ THE UPGRADE: Target the new standardized Submit Button
        const submitBtn = document.getElementById("reg_main_submit_btn");
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes'; 
            submitBtn.onclick = (e) => submitProfileUpdate(e, user.id);
            
            // Visual Polish: Switch to Blue for Edit Mode
            submitBtn.style.background = "#2563eb"; 
            submitBtn.onmouseover = () => submitBtn.style.background = '#1e40af';
            submitBtn.onmouseout = () => submitBtn.style.background = '#2563eb';
        }

        // 3. Hide Reset Button (Prevents accidental data wiping)
        const resetBtn = document.getElementById("reg_reset_btn");
        if (resetBtn) resetBtn.style.display = "none";

        // 4. Pre-fill all modal inputs
        document.getElementById("reg_full_name").value = user.full_name || "";
        document.getElementById("reg_emp_id").value = user.employee_id || "";
        
        // Security Lock: Disable username editing completely
        const userField = document.getElementById("reg_username");
        if (userField) {
            userField.value = user.username || "";
            userField.disabled = true;
            userField.style.background = "#f1f5f9";
            userField.style.cursor = "not-allowed"; 
        }

        // Hide the ENTIRE password block (Label, Input, and Subtext)
        const passField = document.getElementById("reg_password");
        if (passField) {
            const passContainer = passField.parentElement.parentElement;
            if (passContainer) passContainer.style.display = "none";
        }

        // Fill dropdowns and text fields
        document.getElementById("reg_gender").value = user.gender || "Male";
        document.getElementById("reg_marital").value = user.marital_status || "Single";
        document.getElementById("reg_email").value = user.email || "";
        document.getElementById("reg_mobile").value = user.mobile || "";
        document.getElementById("reg_job_title").value = user.job_title || "";
        document.getElementById("reg_unit").value = user.business_unit || "";
        document.getElementById("reg_dept").value = user.department || "";

        // Select the correct manager
        document.getElementById("reg_manager").value = user.line_manager || "";
        document.getElementById("reg_joined").value = user.joined_date || "";

        // Show the Modal
        modal.style.display = "flex";
    } catch (err) {
        console.error("Edit load error:", err);
        Swal.fire({
            icon: 'error',
            title: 'Load Error',
            text: 'Could not load user data for editing.',
            confirmButtonColor: '#ef4444'
        });
    }
}

/**
 * üîç Helper: Finds a user by their DB ID and opens the edit modal
 */
function openFullProfileEditModalById(userId) {
    const user = window.allUsersList.find((u) => u.id === userId);

    if (user) {
        openFullProfileEditModal(JSON.stringify(user));
    } else {
        // üöÄ UPGRADE: Removed generic alert(), implemented SweetAlert
        Swal.fire({
            icon: 'error',
            title: 'Data Not Found',
            text: 'Could not locate user data. Please refresh the page.',
            confirmButtonColor: '#ef4444'
        });
    }
}


function syncManagerCheckboxes() {
    const managerCb = document.getElementById("edit_role_manager");
    const seniorCb = document.getElementById("edit_is_senior");

    if (!managerCb || !seniorCb) return;

    if (!managerCb.checked) {
        // If "Manager" is unchecked, force L2 to be unchecked and disabled
        seniorCb.checked = false;
        seniorCb.disabled = true;
        seniorCb.parentElement.style.opacity = "0.5";
        seniorCb.parentElement.style.cursor = "not-allowed";
    } else {
        // If "Manager" is checked, allow changes to L2
        seniorCb.disabled = false;
        seniorCb.parentElement.style.opacity = "1";
        seniorCb.parentElement.style.cursor = "pointer";
    }
}

      // üöÄ CHANGE 1: Added 'isSenior' as the 4th parameter
// üöÄ CHANGE 1: Added 'isSenior' as the 4th parameter
function openUserEditModal(userId, fullName, currentRoles, isSenior) {
    // 1. Store the ID globally
    window.editingUserId = userId;

    // 2. Update the Modal Header
    const titleEl = document.getElementById("userEditModalTitle");
    if (titleEl) {
        titleEl.innerText = `Manage Permissions: ${fullName}`;
    }

    // 3. Reset UI Visuals
    const updateBtn = document.getElementById("btnUpdatePermissions"); 
    const msgEl = document.getElementById("noChangeMsg"); 
    
    if (updateBtn) updateBtn.classList.remove("shake-animation");
    if (msgEl) msgEl.style.display = "none";

    // 4. Get the checkboxes
    const managerCb = document.getElementById("edit_role_manager");
    const hrCb = document.getElementById("edit_role_hr");
    const seniorCb = document.getElementById("edit_is_senior");

    // 5. Set Checkbox States
    if (managerCb) managerCb.checked = currentRoles.includes("manager");
    if (hrCb) hrCb.checked = currentRoles.includes("hr_admin");
    
    const seniorStatus = (isSenior === true || isSenior === 1);
    if (seniorCb) seniorCb.checked = seniorStatus;

    // 6. üì∏ SNAPSHOT: Save the initial state
    initialPermissionState = {
        manager: managerCb ? managerCb.checked : false,
        hr: hrCb ? hrCb.checked : false,
        senior: seniorCb ? seniorCb.checked : false
    };

    // üöÄ THE MISSING PIECE: GUARD INTEGRATION
    if (managerCb) {
        // This makes the L2 box react EVERY time Natasha clicks
        managerCb.onclick = syncManagerCheckboxes;
        
        // This runs once now to ensure the L2 box starts greyed out if needed
        syncManagerCheckboxes();
    }

    // 7. Finally, show the modal
    const modal = document.getElementById("userEditModal");
    if (modal) {
        modal.style.display = "flex";
    }
}

      /**
       * üßπ Resets all filters in the User Management section
       */
      function resetUserFilters() {
        // 1. Reset the text input
        const searchInput = document.getElementById("hr_user_search");
        if (searchInput) searchInput.value = "";

        // 2. Reset the dropdown filters to "All"
        const roleFilter = document.getElementById("hr_role_filter");
        if (roleFilter) roleFilter.selectedIndex = 0;

        const statusFilter = document.getElementById("hr_status_filter");
        if (statusFilter) statusFilter.selectedIndex = 0;

        // 3. Silent Refresh: Reload the table with no filters applied
        loadAllUsers();
      }

      // Helper to close this specific modal
      function closeUserEditModal() {
        document.getElementById("userEditModal").style.display = "none";
      }

      function switchApplyMode(mode) {
    // 1. Get Containers & Tabs
    const leaveContainer = document.getElementById("form_leave_container");
    const otContainer = document.getElementById("form_ot_container");
    const leaveTab = document.getElementById("tab_leave");
    const otTab = document.getElementById("tab_ot");
    const unpaidTab = document.getElementById("tab_unpaid");

    // Shared Element that causes the "leak"
    const reasonField = document.getElementById("dash_reason");

    // üöÄ NEW: WIPE SHARED FIELDS BEFORE SWITCHING
    // This stops the CF reason from "bleeding" into the Standard reason
    if (reasonField) reasonField.value = "";

    // 2. Save Mode to Memory
    localStorage.setItem("current_apply_mode", mode);

    // 3. Reset Visual State
    [leaveTab, otTab, unpaidTab].forEach((tab) => {
        if (tab) tab.classList.remove("active");
    });
    if (leaveContainer) leaveContainer.style.display = "none";
    if (otContainer) otContainer.style.display = "none";

    // 4. Mode Switching Logic
    if (mode === "ot") {
        if (otTab) otTab.classList.add("active");
        if (otContainer) otContainer.style.display = "block";
        const title = document.getElementById("apply_form_title");
        if (title) title.innerHTML = '<i class="fas fa-clock" style="color:#2563eb;"></i> Apply Overtime';

        // üöÄ Restore OT specifically
        if (typeof restoreOTDraft === "function") restoreOTDraft();

    } else if (mode === "unpaid") {
        if (unpaidTab) unpaidTab.classList.add("active");
        if (leaveContainer) leaveContainer.style.display = "block";

        const cfUI = document.getElementById("carry_forward_ui");
        const stdUI = document.getElementById("standard_leave_ui");
        if (cfUI) cfUI.style.display = "block";
        if (stdUI) stdUI.style.display = "none";

        const title = document.getElementById("apply_form_title");
        if (title) title.innerHTML = '<i class="fas fa-exchange-alt" style="color:#2563eb;"></i> Request Carry Forward';

        if (typeof updateCarryForwardMath === "function") updateCarryForwardMath();

        // üöÄ Restore CF specifically (This will fill dash_reason with CF data only)
        if (typeof restoreLeaveDraft === "function") restoreLeaveDraft();

    } else {
        if (leaveTab) leaveTab.classList.add("active");
        if (leaveContainer) leaveContainer.style.display = "block";

        const cfUI = document.getElementById("carry_forward_ui");
        const stdUI = document.getElementById("standard_leave_ui");
        if (cfUI) cfUI.style.display = "none";
        if (stdUI) stdUI.style.display = "block";

        const title = document.getElementById("apply_form_title");
        if (title) title.innerHTML = '<i class="fas fa-calendar-plus" style="color:#2563eb;"></i> New Leave Request';

        if (typeof showEntitlementInfo === "function") showEntitlementInfo();
        if (typeof updateLiveSummary === "function") updateLiveSummary();

        // üöÄ Restore Standard specifically (This will fill dash_reason with Standard data only)
        if (typeof restoreLeaveDraft === "function") restoreLeaveDraft();
    }
}

      // Dynamic Time Fields (updateOTFields)

      function updateOTFields() {
        const unit = document.getElementById("ot_unit").value;
        const timeFields = document.getElementById("ot_time_fields");
        const summaryBox = document.getElementById("ot_summary_box");

        if (unit === "days") {
          timeFields.style.display = "none";
          if (summaryBox) summaryBox.style.display = "none";
        } else {
          timeFields.style.display = "grid";
          // Recalculate to see if box should show now
          calculateOTDuration();
        }
      }

      function calculateOTDuration() {
        const start = document.getElementById("ot_start").value;
        const end = document.getElementById("ot_end").value;
        const display = document.getElementById("ot_duration_display");
        const summaryBox = document.getElementById("ot_summary_box");

        // 1. If one or both are empty, hide the box
        if (!start || !end) {
          if (summaryBox) summaryBox.style.display = "none";
          return;
        }

        // 2. Parse the hours and minutes
        const [sH, sM] = start.split(":").map(Number);
        const [eH, eM] = end.split(":").map(Number);

        const startTotal = sH * 60 + sM;
        const endTotal = eH * 60 + eM;
        let diff = (endTotal - startTotal) / 60;

        // 3. Handle overnight logic (e.g. 10 PM to 2 AM)
        if (diff <= 0) diff += 24;

        // üöÄ THE CRITICAL PART: Show the box using 'flex'
        if (summaryBox) {
          summaryBox.style.display = "flex"; // This matches your inline 'justify-content'
        }

        if (display) {
          display.innerText = diff.toFixed(1);
        }
      }
 

      // 1. ENTRY POINT: Triggered when clicking the toggle
// 1. ENTRY POINT: Triggered when clicking the toggle
function handleL2Toggle() {
        console.log("üñ±Ô∏è L2 Toggle Clicked!"); // Debugging check
        const toggle = document.getElementById("l2_workflow_toggle");
        if (!toggle) return;

        const isTurningOn = toggle.checked;

        // üõë VISUAL STOP: Immediately revert the toggle switch.
        // We only want it to flip visually IF the user clicks "Confirm" in the modal.
        toggle.checked = !isTurningOn;

        // üöÄ UPGRADE: Use SweetAlert instead of HTML Modals
        if (isTurningOn) {
            Swal.fire({
                title: 'Enable L2 Approval?',
                html: "‚Ä¢ Future requests will require <strong>two approvals</strong> (Manager + Dept Head).<br>‚Ä¢ Senior Managers retain one-step approval.",
                icon: 'info',
                iconColor: '#22c55e',
                showCancelButton: true,
                confirmButtonColor: '#22c55e',
                cancelButtonColor: '#cbd5e1',
                confirmButtonText: 'Yes, Enable It'
            }).then((result) => {
                // If they click Yes, proceed to step 2
                if (result.isConfirmed) finalizeL2Toggle(true);
            });
        } else {
            Swal.fire({
                title: 'Disable L2 Approval?',
                html: "‚Ä¢ Workflow will return to <strong>Line Manager only</strong>.<br>‚Ä¢ We will check for any 'Stuck' requests first.",
                icon: 'warning',
                iconColor: '#ef4444',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#cbd5e1',
                confirmButtonText: 'Disable Workflow'
            }).then((result) => {
                // If they click Yes, proceed to step 2
                if (result.isConfirmed) finalizeL2Toggle(false);
            });
        }
      }

//  -- deleted the openL2DecisionModal

// 3. EXECUTE ACTION (Runs after SweetAlert confirmation)
async function finalizeL2Toggle(enable) {
        const toggle = document.getElementById("l2_workflow_toggle");
        
        if (enable) {
            // Turning ON: Safe to flip visually and save
            if (toggle) toggle.checked = true; 
            await updateL2Policy(true);
        } else {
            // Turning OFF: Don't flip visually yet. Run the safety check first!
            await checkPendingL2Requests();
        }
      }

  // üîç Helper: Checks if any requests are stuck in L2 Limbo
  async function checkPendingL2Requests() {
        const toggle = document.getElementById("l2_workflow_toggle");
        try {
            // 1. Show a professional loading state while checking the DB
            Swal.fire({ 
                title: 'Checking System Status...', 
                html: 'Verifying if any requests are currently in L2 approval stage.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); } 
            });
            
            const response = await fetchWithAuth(`${API_URL}/leaves/admin/l2-check`);
            if (!response) return;

            const pending = await response.json();

            if (pending.length > 0) {
                // üõë BLOCKED: Revert toggle visually
                if (toggle) toggle.checked = true; 

                // 2. Build a clean list of the "Stuck" requests
                let listHtml = `<div style="text-align:left; background:#fef2f2; padding:15px; border-radius:10px; border:1px solid #fecaca; margin-top:15px;">
                                <p style="margin-top:0; font-weight:bold; color:#991b1b; font-size:0.9rem;">The following requests must be cleared first:</p>
                                <ul style="list-style:none; padding:0; margin:0; max-height:150px; overflow-y:auto; font-size:0.85rem;">`;
                
                pending.forEach(p => {
                    listHtml += `<li style="padding:6px 0; border-bottom:1px solid rgba(153,27,27,0.1); display:flex; justify-content:space-between;">
                        <strong>${p.employee_name}</strong> 
                        <span style="color:#b91c1c;">${p.leave_type} (${p.start_date})</span>
                    </li>`;
                });
                listHtml += `</ul></div>`;

                // 3. Show the Blocked Modal
                Swal.fire({
                    icon: 'error',
                    title: 'Action Blocked',
                    html: `You cannot disable the level 2 workflow while request are awaiting Level 2 approval.<br>${listHtml}`,
                    confirmButtonColor: '#334155',
                    confirmButtonText: 'I will clear these first'
                });
            } else {
                // ‚úÖ SAFE: No pending items
                if (toggle) toggle.checked = false; 
                await updateL2Policy(false);
            }
        } catch (err) {
            console.error("L2 Check Error:", err);
            Swal.fire("System Error", "Could not verify pending L2 requests. Please try again.", "error");
            if (toggle) toggle.checked = true; 
        }
      }

  

// üíæ FINAL EXECUTION: Saves the L2 setting to the database
async function updateL2Policy(isEnabled) {
        try {
          // 1. Show a loading state while communicating with the server
          Swal.fire({
            title: 'Saving Settings...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
          });

          const response = await fetchWithAuth(
            `${API_URL}/leaves/admin/policy`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ l2_enabled: isEnabled }),
            }
          );

          if (response && response.ok) {
            // 2. üöÄ SUCCESS: Show a premium Toast notification (Top-Right)
            Swal.fire({
                icon: 'success',
                title: isEnabled ? 'L2 Workflow Activated' : 'L2 Workflow Deactivated',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            
            console.log(`Global L2 Workflow is now: ${isEnabled ? "ENABLED" : "DISABLED"}`);
            
            // Re-sync UI elements (like manager filters)
            if (typeof syncL2ToggleState === "function") syncL2ToggleState();

          } else {
            throw new Error("Failed to update policy");
          }
        } catch (err) {
          console.error("Policy Update Error:", err);
          
          // 3. ERROR HANDLING: Revert the switch and tell the user
          Swal.fire({
            icon: 'error',
            title: 'Sync Failed',
            text: 'Failed to update settings on the server. Please check your connection.',
            confirmButtonColor: '#ef4444'
          });

          // üöÄ REVERT: Ensure the toggle switch matches the server's real state
          const toggle = document.getElementById("l2_workflow_toggle");
          if (toggle) {
            toggle.checked = !isEnabled; 
          }
        }
      }

      // 2. CONFIGURE & OPEN MODAL
      function openL2DecisionModal(isTurningOn) {
        const modal = document.getElementById("universalModal");
        const content = document.getElementById("uModalContent");
        const icon = document.getElementById("uModalIcon");
        const title = document.getElementById("uModalTitle");
        const desc = document.getElementById("uModalDesc");
        const warnBox = document.getElementById("uModalWarningBox");
        const btn = document.getElementById("uModalConfirmBtn");

        // Reset to default state
        if (warnBox) warnBox.style.display = "none";
        modal.style.display = "flex";

        if (isTurningOn) {
          // üü¢ ENABLE STYLE
          content.style.borderTopColor = "#22c55e"; // Green Border
          icon.innerHTML = '<i class="fas fa-rocket"></i>';
          icon.style.color = "#22c55e";
          title.innerText = "Enable L2 Approval?";

          desc.innerHTML =
            "<strong>Action:</strong> Activating Level 2 Workflow.<br><br>" +
            "‚Ä¢ Future requests will require <strong>two approvals</strong> (Manager + Dept Head).<br>" +
            "‚Ä¢ Senior Managers will still have one-step approval power.";

          btn.style.backgroundColor = "#22c55e";
          btn.innerText = "Yes, Enable It";
          // Bind the Confirm Button to the finalize function
          btn.onclick = () => finalizeL2Toggle(true);
        } else {
          // üî¥ DISABLE STYLE
          content.style.borderTopColor = "#ef4444"; // Red Border
          icon.innerHTML = '<i class="fas fa-power-off"></i>';
          icon.style.color = "#ef4444";
          title.innerText = "Disable Level 2 Approval workflow?";

          desc.innerHTML =
            "<strong>Action:</strong> Reverting to Single Level Approval.<br><br>" +
            "‚Ä¢ Workflow will return to <strong>Line Manager only</strong>.<br>" +
            "‚Ä¢ Request already pending level 2 approval will need manual review..";

          btn.style.backgroundColor = "#ef4444";
          btn.innerText = "Disable Workflow";
          // Bind the Confirm Button to the finalize function
          btn.onclick = () => finalizeL2Toggle(false);
        }
      }

      /**
       * 4. INITIAL STATE SYNC
       * Call this when the page loads so the toggle reflects the REAL database state
       */


      function autoSelectOTType() {
        const dateVal = document.getElementById("ot_date").value;
        if (!dateVal) return;

        const date = new Date(dateVal);
        const day = date.getDay(); // 0 = Sunday, 6 = Saturday
        const typeSelector = document.getElementById("ot_type_selector");

        // 1. Check if it's a Weekend (Saturday or Sunday)
        if (day === 0 || day === 6) {
          typeSelector.value = "Weekend";
        } else {
          // 2. Default to Regular for weekdays
          // Note: The user can still manually change this to 'Holiday'
          // if they know it's a public holiday.
          typeSelector.value = "Regular";
        }
      }

      // 1. Unified Employee-side View Details (Robust Mapper)
      function viewOTDetails(ot) {
        // üõ°Ô∏è Data Sanitization: Hunt for the date and amount
        // This checks multiple fields because History table and Manager table use different keys
        const safeDate =
          ot.ot_date || ot.start_date || ot.display_start || "N/A";
        const safeAmount =
          ot.total_value ||
          (ot.display_amount ? ot.display_amount.split(" ")[0] : "0");
        const safeUnit =
          ot.ot_unit ||
          (ot.display_amount ? ot.display_amount.split(" ")[1] : "hours");

        // Maps History field names to OT Modal field names
        const mappedOT = {
          ...ot,
          total_value: safeAmount,
          ot_unit: safeUnit,
          ot_date: safeDate, // üëà This fixes the "undefined" date at the top
          ot_type: ot.ot_type || ot.leave_type || "Overtime",
        };

        viewOTDetailsModal(mappedOT);
      }

      function viewOTDetailsModal(ot) {
    const modal = document.getElementById("leaveDetailModal");
    const content = document.getElementById("modalContent");

    // Header
    const headerTitle = modal.querySelector("h3");
    if (headerTitle) {
        headerTitle.innerHTML = `<i class="fas fa-stopwatch"></i> Overtime Details`;
    }

    // Status Colors
    let statusColor = "#854d0e";
    if (ot.status === "Approved") statusColor = "#166534";
    if (ot.status === "Rejected") statusColor = "#991b1b";
    if (ot.status === "Withdrawn" || ot.status === "Cancelled")
        statusColor = "#475569";

    // Clean Reason
    let cleanReason = ot.reason || "No reason provided.";
    cleanReason = cleanReason.split("| Manager Note:")[0].trim();

    // ============================================================
    // üöÄ ATTACHMENT FIX (SUPABASE COMPATIBLE)
    // ============================================================
    let attachmentHtml = "";
    if (ot.attachment_path) {
        // 1. Get the raw path (Backend now sends full Supabase URL)
        const rawPath = ot.attachment_path;
        let fileUrl = rawPath;

        // 2. Logic: If it doesn't start with http, it's a legacy local file
        if (!rawPath.startsWith("http")) {
            fileUrl = `${API_URL}/uploads/${rawPath.split("/").pop()}`;
        }

        // 3. Display Name (Just the filename part)
        const fileName = rawPath.split("/").pop();

        attachmentHtml = `
        <div style="margin-top: 10px; padding: 12px; background: #f0f9ff; border: 1px dashed #0ea5e9; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-file-alt" style="color: #0ea5e9; font-size: 1.2rem;"></i>
            <div style="flex: 1;">
                <label style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: bold; display: block;">Your Attached Document</label>
                <a href="${fileUrl}" target="_blank" style="color: #2563eb; font-weight: 600; text-decoration: none; font-size: 0.85rem;">
                    <i class="fas fa-external-link-alt"></i> View Attachment
                </a>
            </div>
        </div>`;
    }
    // ============================================================

    // üöÄ HISTORY LOGIC
    let rawHistory = ot.status_history || "Pending";

    // Fix: If status is Withdrawn/Cancelled but history doesn't show it, patch it in
    if ((ot.status === "Withdrawn" || ot.status === "Cancelled") &&
        !rawHistory.includes("Withdrawn") &&
        !rawHistory.includes("Cancelled")) {
        
        let actionTime = "Date N/A";
        // Use updated_at if available
        if (ot.updated_at) {
            try {
                const d = new Date(ot.updated_at);
                actionTime = d.getFullYear() + "-" +
                    String(d.getMonth() + 1).padStart(2, "0") + "-" +
                    String(d.getDate()).padStart(2, "0") + " " +
                    String(d.getHours()).padStart(2, "0") + ":" +
                    String(d.getMinutes()).padStart(2, "0");
            } catch (e) {
                console.error("Date parse error", e);
            }
        }
        // Use the actual status logic instead of hardcoding "Withdrawn"
        rawHistory += ` > ${ot.status} (${actionTime})`;
    }

    const historySteps = rawHistory.split(" > ");
    let timelineHtml = `<div style="position: relative; padding-left: 20px; border-left: 2px solid #e2e8f0; margin-left: 8px; margin-top: 10px;">`;

    historySteps.forEach((step, index) => {
        const isLast = index === historySteps.length - 1;
        const isFirst = index === 0;

        // A. STRICT DATE FINDER
        const dateRegex = /\((\d{4}-\d{2}-\d{2} \d{2}:\d{2})\)/;
        const timeMatch = step.match(dateRegex);

        let timeText = "N/A";
        if (timeMatch) {
            timeText = timeMatch[1];
        } else if (isFirst) {
            timeText = ot.ot_date || "N/A";
        }

        // B. üöÄ CLEAN TITLE LOGIC & REMARK EXTRACTION
        let statusLabel = step.replace(dateRegex, "").trim();
        let stepRemark = "";

        if (isFirst) {
            stepRemark = cleanReason; 
        } else if (statusLabel.includes("| Note:")) {
            const splitParts = statusLabel.split("| Note:");
            statusLabel = splitParts[0].trim();
            stepRemark = splitParts[1].trim();
        } else {
            const noteMatch = statusLabel.match(/\{Note:\s*(.*?)\}/i);
            if (noteMatch) {
                stepRemark = noteMatch[1];
                statusLabel = statusLabel.replace(noteMatch[0], "").trim();
            } else {
                const reasonMatch = statusLabel.match(/\(Reason:\s*(.*?)\)/i);
                if (reasonMatch) {
                    stepRemark = reasonMatch[1];
                    statusLabel = statusLabel.replace(reasonMatch[0], "").trim();
                }
            }
        }

        // Clean up any trailing empty parenthesis
        statusLabel = statusLabel.replace(/\(\s*\)/g, "").trim();

        // C. Dot Color Logic
        let dotColor = "#cbd5e1";
        if (statusLabel.includes("Approved")) dotColor = "#10b981";
        else if (statusLabel.includes("Rejected")) dotColor = "#ef4444";
        else if (statusLabel.includes("Cancelled") || statusLabel.includes("Withdrawn")) dotColor = "#64748b";
        else if (isLast && ot.status.includes("Pending")) dotColor = "#f59e0b";

        // D. Render Step
        timelineHtml += `
        <div style="margin-bottom: 20px; position: relative;">
            <div style="position: absolute; left: -27px; top: 5px; width: 12px; height: 12px; background: white; border: 3px solid ${dotColor}; border-radius: 50%;"></div>
            <div style="font-weight: 600; font-size: 0.9rem; color: #1e293b;">${statusLabel}</div>
            <div style="font-size: 0.75rem; color: #94a3b8;">${timeText}</div>
            ${stepRemark ? `<div style="margin-top:4px; font-size:0.85rem; color:#475569; background:#f1f5f9; padding:6px 10px; border-radius:6px; border-left:3px solid ${dotColor};"><i class="fas fa-comment-dots" style="opacity:0.5; margin-right:4px;"></i> ${stepRemark}</div>` : ""}
        </div>`;
    });
    timelineHtml += `</div>`;

    // Render Content
    content.innerHTML = `
        <div style="margin-bottom: 20px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 12px;">
            <div style="background: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <i class="fas fa-user-clock" style="color: var(--primary); font-size: 0.9rem;"></i>
            </div>
            <div>
                <label style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; display: block;">Employee Name</label>
                <strong style="font-size: 1.05rem; color: #1e293b;">${ot.employee_name}</strong>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Duration</label><br>
                <strong style="font-size: 1rem;">${ot.total_value} ${ot.ot_unit}</strong>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Status</label><br>
                <strong style="font-size: 1rem; color: ${statusColor};">${ot.status}</strong>
            </div>
            <div style="grid-column: span 2;">
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Work Description</label><br>
                <span style="font-size: 0.95rem; color: #334155; display: block; padding: 4px 0;">${cleanReason}</span>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">OT Date</label><br>
                <span>${formatDateNice(ot.ot_date)}</span>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">OT Type</label><br>
                <span>${ot.ot_type}</span>
            </div>
        </div>

        <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Assigned Approver</label><br>
            <span style="color: #2563eb; font-weight: 600;">
                <i class="fas fa-user-tie"></i> ${ot.approver_name || "Not Assigned"}
            </span>
        </div>

        ${attachmentHtml ? `<div style="margin-bottom: 20px;">${attachmentHtml}</div>` : ""}

        <div style="margin-top: 10px; border-top: 2px solid #f1f5f9; padding-top: 15px;">
            <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; display: block;">Activity Log</label>
            ${timelineHtml}
        </div>
    `;

    modal.style.display = "flex";
}

      // line 8216

      // üîÑ Trigger this refresh every 30 seconds or when Manager clicks a menu
      setInterval(refreshManagerBadges, 30000);

      function otChangePage(step) {
        otCurrentPage += step;
        // Safety: never let the page go below 1
        if (otCurrentPage < 1) otCurrentPage = 1;

        loadManagerOTRequests();
      }

 // üöÄ Global State for OT
// üöÄ 1. Global State for OT - Set default to DESCENDING (Newest First)
// üöÄ 1. Global State for OT - Set default to DESCENDING (Newest First)


async function loadManagerOTRequests() {
    const tbody = document.getElementById("managerOTTableBody");
    const pageInfo = document.getElementById("otPageInfo");
    const refreshIcon = document.getElementById("mgrOTRefreshIcon");
    if (!tbody) return;

    // Start Spin Animation
    if (refreshIcon) refreshIcon.classList.add("fa-spin");

    // Capture Filter Values safely
    const nameFilter = document.getElementById("mgr_ot_filter_name")?.value.toLowerCase() || "";
    const typeFilter = document.getElementById("mgr_ot_filter_type")?.value || "";
    const dateFilter = document.getElementById("mgr_ot_filter_date")?.value || "";
    const durFilter = document.getElementById("mgr_ot_filter_duration")?.value || "";
    const statusFilter = document.getElementById("mgr_ot_filter_status")?.value || "";

    // Visual Loading State
    tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:40px; color:#94a3b8;">
        <i class="fas fa-circle-notch fa-spin" style="font-size:1.5rem; margin-bottom:10px;"></i><br>Syncing claims...
    </td></tr>`;

    try {
        const params = new URLSearchParams({
            approver_name: currentUser,
            page: 1, // Fetching larger batch for client-side filtering efficiency
            page_size: 1000, 
        });

        const res = await fetchWithAuth(`${API_URL}/overtime/manager-requests?${params.toString()}`);
        if (!res) return;

        const data = await res.json();
        let requests = Array.isArray(data) ? data : data.requests || [];

        // üîç CLIENT-SIDE FILTERING (Matches Leave History Format)
        requests = requests.filter(ot => {
            const matchesName = !nameFilter || (ot.employee_name || "").toLowerCase().includes(nameFilter);
            const matchesType = !typeFilter || ot.ot_type === typeFilter;
            const matchesDate = !dateFilter || ot.ot_date === dateFilter;
            const matchesDur = !durFilter || parseFloat(ot.total_value) == parseFloat(durFilter);
            const matchesStatus = !statusFilter || ot.status === statusFilter;
            
            return matchesName && matchesType && matchesDate && matchesDur && matchesStatus;
        });

        // Store for sorting/rendering
        window.currentManagerOTRequests = requests;

        // Update Pagination Info safely
        const totalFound = requests.length;
        if (pageInfo) pageInfo.innerText = `Records Found: ${totalFound}`;
        
        const prevBtn = document.getElementById("otPrevBtn");
        const nextBtn = document.getElementById("otNextBtn");
        
        // Safety check to ensure pagination variables exist globally
        if (prevBtn) prevBtn.disabled = typeof otCurrentPage !== 'undefined' && otCurrentPage === 1;
        if (nextBtn) nextBtn.disabled = typeof otCurrentPage !== 'undefined' && typeof otPageSize !== 'undefined' && (otCurrentPage * otPageSize >= totalFound);

        // üöÄ THE VISUAL SYNC: Force the UI arrow to match our 'desc' state automatically
        const dateIcon = document.getElementById("mgr-ot-sort-ot_date");
        if (dateIcon) {
            dateIcon.className = 'fas fa-sort-down';
            dateIcon.style.color = '#3b82f6';
        }

        // üöÄ Hand over to the Render Engine
        renderManagerOTTable();

    } catch (e) {
        console.error("OT Load Error:", e);
        tbody.innerHTML = "<tr><td colspan='6' style='color:#ef4444; text-align:center; padding:20px;'>Connection error. Please retry.</td></tr>";
    } finally {
        // Stop Spin Animation after small delay for visual polish
        if (refreshIcon) setTimeout(() => refreshIcon.classList.remove("fa-spin"), 600);
    }
}

// üöÄ 2. RENDER ENGINE (Standardized for 100% Bug-Free Sorting & Rendering)
function renderManagerOTTable() {
    const tbody = document.getElementById("managerOTTableBody");
    if (!tbody || !window.currentManagerOTRequests) return;

    // 1. Apply Sort to the data
    const data = [...window.currentManagerOTRequests];
    data.sort((a, b) => {
        let valA, valB;

        // üß† TIE-BREAKER LOGIC: Prevents "jumping" rows for same-day claims
        if (mgrOTSortState.key === 'ot_date') {
            // Null safety fallback to 1970
            const dateA = a.ot_date || "1970-01-01";
            const dateB = b.ot_date || "1970-01-01";
            const idA = String(a.id || 0).padStart(10, '0');
            const idB = String(b.id || 0).padStart(10, '0');
            
            valA = dateA + idA;
            valB = dateB + idB;
        } 
        else if (mgrOTSortState.key === 'total_value') {
            valA = parseFloat(a.total_value) || 0;
            valB = parseFloat(b.total_value) || 0;
        } 
        else {
            valA = (a[mgrOTSortState.key] || "").toString().toLowerCase();
            valB = (b[mgrOTSortState.key] || "").toString().toLowerCase();
        }

        if (valA < valB) return mgrOTSortState.direction === 'asc' ? -1 : 1;
        if (valA > valB) return mgrOTSortState.direction === 'asc' ? 1 : -1;
        return 0;
    });

    // 2. Clear and Render
    tbody.innerHTML = "";
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center" style="padding:40px; color:#64748b;">No overtime claims found.</td></tr>`;
        return;
    }

// D. Render Rows (Inside renderManagerOTTable)
data.forEach((ot) => {
        // üõ°Ô∏è DATA SANITIZATION
        const otJson = JSON.stringify(ot).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
        const initials = (ot.employee_name || "??").split(" ").map(n => n[0]).slice(0, 2).join("").toUpperCase();
        
        const rawStatus = ot.status || "Pending";
        const statusClass = `status-${rawStatus.toLowerCase().replace(/\s+/g, "-")}`;
        let statusLabel = rawStatus;
        if (rawStatus === "Pending L2 Approval") statusLabel = "Wait L2";

        // üé® THE PREMIUM TYPE BADGE (Blue Theme)
        const typeBadge = `<span style="background: rgba(37, 99, 235, 0.1); color: #2563eb; border: 1px solid rgba(37, 99, 235, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px;">Overtime</span>`;

        let catColor = "#475569"; let catBg = "#f1f5f9";
        const safeType = ot.ot_type || "Overtime";
        if (safeType.includes("Weekend")) { catColor = "#9333ea"; catBg = "#f3e8ff"; }
        if (safeType.includes("Holiday")) { catColor = "#dc2626"; catBg = "#fef2f2"; }

        const durationPill = `
            <div style="display:inline-flex; align-items:center; gap:6px; background:#fff7ed; border:1px solid #ffedd5; padding:4px 10px; border-radius:6px;">
                <i class="fas fa-clock" style="font-size:0.7rem; color:#ea580c; opacity:0.8;"></i>
                <span style="font-weight:800; color:#9a3412; font-size:0.85rem;">${ot.total_value || 0}</span>
                <span style="font-size:0.65rem; font-weight:700; color:#ea580c; opacity:0.8; margin-top:1px; text-transform:uppercase;">${ot.ot_unit || "HRS"}</span>
            </div>
        `;

        tbody.innerHTML += `
          <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.15s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
              <td style="padding: 12px 15px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:36px; height:36px; background:#e0f2fe; color:#0369a1; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:800; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                        ${initials}
                    </div>
                    <div>
                        <div style="font-weight:700; color:#1e293b; font-size:0.9rem;">${ot.employee_name || "Unknown"}</div>
                        <div style="margin-top: 4px; display: flex; align-items: center; gap: 6px;">
                            ${typeBadge}
                            <span style="font-size:0.7rem; color:#64748b; font-weight: 600;">#OT-${String(ot.id || 0).padStart(4, "0")}</span>
                        </div>
                    </div>
                </div>
              </td>
              <td style="padding: 12px 15px; vertical-align:middle;">
                <span style="background:${catBg}; color:${catColor}; font-weight:700; font-size:0.7rem; padding:2px 8px; border-radius:4px;">${safeType}</span>
              </td>
              <td style="padding: 12px 15px; vertical-align:middle; font-weight:600; color:#334155;">${formatDateNice(ot.ot_date || "N/A")}</td>
              <td style="padding: 12px 15px; text-align:center; vertical-align:middle;">${durationPill}</td>
              <td class="text-center" style="padding: 12px 15px; vertical-align:middle;">
                  <span class="status-badge ${statusClass}" style="font-size:0.75rem; padding:4px 10px;">${statusLabel}</span>
              </td>
              <td class="text-center" style="padding: 12px 15px; vertical-align:middle;">
                  <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                      <button class="icon-btn" onclick='viewOTDetailsModal(${otJson})' title="View Details" style="border:1px solid #cbd5e1; width:34px; height:34px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:white;">
                          <i class="fas fa-eye" style="color:#475569;"></i>
                      </button>
                      <button class="icon-btn" onclick="submitOTDecision(${ot.id}, 'Approved', '${ot.ot_date}', '${safeType}', '${rawStatus}')" title="Approve" style="border:1px solid #bbf7d0; width:34px; height:34px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:#f0fdf4;">
                          <i class="fas fa-check" style="color:#16a34a;"></i>
                      </button>
                      <button class="icon-btn" onclick="submitOTDecision(${ot.id}, 'Rejected', '${ot.ot_date}', '${safeType}', '${rawStatus}')" title="Reject" style="border:1px solid #fecaca; width:34px; height:34px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:#fef2f2;">
                          <i class="fas fa-times" style="color:#dc2626;"></i>
                      </button>
                  </div>
              </td>
          </tr>`;
    });
}

// üöÄ RESET FILTERS FUNCTION
function resetManagerOTFilters() {
    const inputs = ["mgr_ot_filter_name", "mgr_ot_filter_date", "mgr_ot_filter_duration"];
    const selects = ["mgr_ot_filter_type", "mgr_ot_filter_status"];

    inputs.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ""; });
    selects.forEach(id => { if(document.getElementById(id)) document.getElementById(id).selectedIndex = 0; });

    console.log("üßπ OT Filters reset.");
    otCurrentPage = 1;
    loadManagerOTRequests();
}

// üöÄ SORT TRIGGER (Updates icons and calls render)
function sortManagerOTQueue(key) {
    if (mgrOTSortState.key === key) {
        mgrOTSortState.direction = mgrOTSortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        mgrOTSortState.key = key;
        mgrOTSortState.direction = 'desc';
    }

    // Update Icons Visually
    document.querySelectorAll('thead i[id^="mgr-ot-sort-"]').forEach(i => {
        i.className = 'fas fa-sort'; 
        i.style.color = '#cbd5e1';
    });
    const activeIcon = document.getElementById(`mgr-ot-sort-${key}`);
    if (activeIcon) {
        activeIcon.className = mgrOTSortState.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
        activeIcon.style.color = '#3b82f6';
    }

    renderManagerOTTable();
}

/**
 * üöÄ OVERTIME REVIEW: Opens the modal for Manager Decision
 * üé® REVAMPED: Full Pretty Timeline with parsed remarks & Keyword Color Triggers.
 */
 async function submitOTDecision(otId, actionType, otDate, otType, currentStatus) {
    const modal = document.getElementById("reviewModal");
    const l2Container = document.getElementById("l2SelectorContainer");
    const l2Select = document.getElementById("l2_manager_select");
    const approveBtn = document.getElementById("modalApproveBtn");
    const rejectBtn = document.getElementById("modalRejectBtn");
    const errorId = "l2_validation_error"; 

    if (!modal) return;

    // --- 1. Reset UI Inputs ---
    document.getElementById("mgr_review_remarks").value = "";
    const mgrCount = document.getElementById("mgr_char_count");
    if (mgrCount) { mgrCount.innerText = "0/200"; mgrCount.style.color = "#94a3b8"; }

    const existingErr = document.getElementById(errorId);
    if (existingErr) existingErr.remove(); 

    if (l2Container) l2Container.style.display = "none";
    if (l2Select) {
        l2Select.value = "";
        l2Select.style.borderColor = "#e2e8f0";
        l2Select.onchange = () => {
            if (l2Select.value) {
                const err = document.getElementById(errorId);
                if (err) err.remove();
                l2Select.style.borderColor = "#e2e8f0";
            }
        };
    }

    // --- 2. Smart L2 Logic ---
    const isSenior = localStorage.getItem("is_senior_manager") === "true";
    const isFirstStage = currentStatus === "Pending"; 

    if (actionType === "Approved" && isFirstStage && !isSenior) {
        try {
            const res = await fetchWithAuth(`${API_URL}/users/policy/current`);
            if (res && res.ok) {
                const policy = await res.json();
                if (policy.l2_approval_enabled && l2Container) {
                    l2Container.style.display = "block";
                    l2Container.style.background = "#f8fafc"; 
                    l2Container.style.border = "1px solid #e2e8f0"; 
                    l2Container.style.borderRadius = "8px";
                    l2Container.style.padding = "15px";
                    l2Container.style.marginTop = "20px";
                    await populateL2ManagerDropdown();
                }
            }
        } catch (e) { console.error("L2 Policy check failed:", e); }
    }

    // --- 3. FETCH DETAILS & IDENTITY ---
    const otRecord = (window.currentManagerOTRequests || []).find(r => r.id === otId);
    const employeeName = otRecord ? otRecord.employee_name : "Staff Member";
    
    let reasonText = otRecord ? (otRecord.reason || "No description provided.") : "N/A";
    reasonText = reasonText.split("| Manager Note:")[0].trim(); 

    let attachmentHtml = "";
    if (otRecord && otRecord.attachment_path) {
        const fileName = otRecord.attachment_path.split("/").pop();
        const fileUrl = `${API_URL}/uploads/${fileName}`;
        attachmentHtml = `
            <div style="margin-top: 10px; padding: 12px; background: #f0f9ff; border: 1px dashed #0ea5e9; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-file-alt" style="color: #0ea5e9; font-size: 1.2rem;"></i>
                <div style="flex: 1;">
                    <label style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: bold; display: block;">Attached Document</label>
                    <a href="${fileUrl}" target="_blank" style="color: #2563eb; font-weight: 600; text-decoration: none; font-size: 0.85rem;">
                        View Attachment
                    </a>
                </div>
            </div>`;
    }

    // --- 4. üöÄ THE REVAMPED HISTORY TIMELINE ---
    let timelineHtml = "";
    if (otRecord && otRecord.status_history) {
        const historySteps = otRecord.status_history.split(" > ");
        
        timelineHtml = `
            <div style="margin-top: 25px; border-top: 2px solid #f1f5f9; padding-top: 15px;">
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 15px;">Decision History Log</label>
                <div style="position: relative; padding-left: 20px; border-left: 2px solid #e2e8f0; margin-left: 8px;">`;

        historySteps.forEach((step, index) => {
            const isLast = index === historySteps.length - 1;
            const isFirst = index === 0;

            // Extract Timestamp (YYYY-MM-DD HH:MM)
            const dateRegex = /\((\d{4}-\d{2}-\d{2} \d{2}:\d{2})\)/;
            const timeMatch = step.match(dateRegex);
            let timeText = timeMatch ? timeMatch[1] : (isFirst ? otDate : "N/A");
            
            // üöÄ PARSING LOGIC: Separate Status Label from Remark
            let statusLabel = step.replace(dateRegex, "").trim();
            let stepRemark = "";
            
            if (isFirst) { 
                stepRemark = reasonText; 
            } else if (statusLabel.includes("| Note:")) {
                const splitParts = statusLabel.split("| Note:");
                statusLabel = splitParts[0].trim();
                stepRemark = splitParts[1].trim();
            } else {
                // Check for different note/reason patterns
                const noteMatch = statusLabel.match(/\{Note:\s*(.*?)\}/i);
                const reasonMatch = statusLabel.match(/\(Reason:\s*(.*?)\)/i);
                
                if (noteMatch) {
                    stepRemark = noteMatch[1];
                    statusLabel = statusLabel.replace(noteMatch[0], "").trim();
                } else if (reasonMatch) {
                    stepRemark = reasonMatch[1];
                    statusLabel = statusLabel.replace(reasonMatch[0], "").trim();
                }
            }
            statusLabel = statusLabel.replace(/\(\s*\)/g, "").trim();

            // üé® COLOR TRIGGER LOGIC
            let dotColor = "#cbd5e1"; // ‚ö™ Default (Light Grey)
            const labelLower = statusLabel.toLowerCase();

            if (labelLower.includes("approved")) {
                dotColor = "#10b981"; // üü¢ Success (Green)
            } else if (labelLower.includes("rejected")) {
                dotColor = "#ef4444"; // üî¥ Rejection (Red)
            } else if (labelLower.includes("cancelled") || labelLower.includes("withdrawn")) {
                dotColor = "#64748b"; // ‚ö´ Stopped (Dark Grey)
            } else if (isLast && currentStatus.includes("Pending")) {
                dotColor = "#f59e0b"; // üü† Active (Orange)
            }

            timelineHtml += `
                <div style="margin-bottom: 20px; position: relative;">
                    <div style="position: absolute; left: -27px; top: 5px; width: 12px; height: 12px; background: white; border: 3px solid ${dotColor}; border-radius: 50%;"></div>
                    
                    <div style="font-weight: 600; font-size: 0.9rem; color: #1e293b;">${statusLabel}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8;">${timeText}</div>
                    
                    ${stepRemark ? `
                        <div style="margin-top:4px; font-size:0.85rem; color:#475569; background:#f1f5f9; padding:6px 10px; border-radius:6px; border-left:3px solid ${dotColor};">
                            <i class="fas fa-comment-dots" style="opacity:0.5; margin-right:4px;"></i> ${stepRemark}
                        </div>` : ""}
                </div>`;
        });
        timelineHtml += `</div></div>`;
    }

    // --- 5. RENDER SUMMARY (Modern Aligned UI) ---
    let statusBadgeColor = "#f59e0b"; 
    if (currentStatus === "Approved") statusBadgeColor = "#10b981";
    if (currentStatus === "Rejected") statusBadgeColor = "#ef4444";

    document.getElementById("reviewSummary").innerHTML = `
        <div style="margin-bottom: 20px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 12px;">
            <div style="background: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <i class="fas fa-user-clock" style="color: var(--primary); font-size: 0.9rem;"></i>
            </div>
            <div>
                <label style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: bold; display: block;">Employee Name</label>
                <strong style="font-size: 1.05rem; color: #1e293b;">${employeeName}</strong>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Duration</label><br>
                <strong style="font-size: 1rem; color: #1e293b;">${otRecord ? otRecord.total_value : "0"} ${otRecord ? otRecord.ot_unit : "hours"}</strong>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Status</label><br>
                <strong style="font-size: 1rem; color: ${statusBadgeColor};">${currentStatus}</strong>
            </div>
            <div style="grid-column: span 2;">
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Work Description</label><br>
                <span style="font-size: 0.95rem; color: #334155; font-style: italic;">"${reasonText}"</span>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">OT Date</label><br>
                <span>${formatDateNice(otDate)}</span>
            </div>
            <div>
                <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">OT Type</label><br>
                <span>${otType} OT</span>
            </div>
        </div>

        <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: bold;">Assigned Approver</label><br>
            <span style="color: #2563eb; font-weight: 600;"><i class="fas fa-user-tie"></i> ${otRecord ? otRecord.approver_name : "Line Manager"}</span>
        </div>

        ${attachmentHtml}
        ${timelineHtml}
    `;

    // --- 6. BUTTON LOGIC (Preserved Lock-and-Key) ---
    [approveBtn, rejectBtn].forEach(btn => {
        btn.style.display = "inline-flex"; btn.style.alignItems = "center";
        btn.style.justifyContent = "center"; btn.style.gap = "8px"; btn.className = "btn";
    });

    if (actionType === "Approved") {
        approveBtn.style.background = "#10b981"; approveBtn.style.color = "white";
        approveBtn.style.borderColor = "#10b981";
        
        if (currentStatus === "Pending Cancel") {
            approveBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Cancel';
        } else {
            approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
        }

        rejectBtn.style.background = "white"; rejectBtn.style.color = "#64748b";
        rejectBtn.style.border = "1px solid #cbd5e1"; rejectBtn.innerHTML = 'Go Back';

        approveBtn.onclick = () => {
            if (l2Container && l2Container.style.display !== "none" && !l2Select.value) {
                let err = document.getElementById(errorId);
                if (!err) {
                    err = document.createElement("div"); err.id = errorId;
                    err.style.color = "#dc2626"; err.style.fontSize = "0.75rem";
                    err.style.marginTop = "8px"; err.style.fontWeight = "600";
                    err.innerText = "Level 2 Approver is required."; l2Container.appendChild(err);
                }
                l2Select.style.borderColor = "#dc2626";
                return; 
            }
            executeOTFinalDecision(otId, "Approved");
        };
        rejectBtn.onclick = () => closeReviewModal(); 

    } else {
        // REJECT MODE
        rejectBtn.style.background = "#ef4444"; rejectBtn.style.color = "white";
        rejectBtn.style.borderColor = "#ef4444";
        
        if (currentStatus === "Pending Cancel") {
            rejectBtn.innerHTML = '<i class="fas fa-times-circle"></i> Deny Request';
        } else {
            rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
        }

        approveBtn.style.background = "white"; approveBtn.style.color = "#64748b";
        approveBtn.style.border = "1px solid #cbd5e1"; approveBtn.innerHTML = 'Go Back';

        rejectBtn.onclick = () => executeOTFinalDecision(otId, "Rejected");
        approveBtn.onclick = () => closeReviewModal(); 
    }

    modal.style.display = "flex";
}

 // ‚úÖ 0-BUG VERSION: Overtime Execution with Phantom Data Guard
async function executeOTFinalDecision(otId, status) {
    const remarks = document.getElementById("mgr_review_remarks").value;
    const l2Container = document.getElementById("l2SelectorContainer");
    let l2Name = document.getElementById("l2_manager_select").value;
    const approverName = localStorage.getItem("currentUser");

    // üõ°Ô∏è SECURITY GUARD: If L2 container is hidden, strip the value so we never route by accident
    if (l2Container && l2Container.style.display === "none") {
        l2Name = "";
    }

    let url = `${API_URL}/overtime/manager-action/${otId}?status=${status}&remarks=${encodeURIComponent(
      remarks
    )}&approver_name=${encodeURIComponent(approverName)}`;

    if (status === "Approved" && l2Name) {
      url += `&l2_name=${encodeURIComponent(l2Name)}`;
    }

    try {
        // 1. Show Loading State (Prevents double-submitting while the server works)
        Swal.fire({
            title: 'Processing OT Claim...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        const res = await fetchWithAuth(url, { method: "POST" });
        if (!res) return;

        if (res.ok) {
            // --- üöÄ SMART MESSAGING LOGIC ---
            let modalTitle = "";
            let modalMsg = "";
            let iconType = "success";

            if (status === "Rejected") {
                modalTitle = "Claim Rejected";
                modalMsg = "The overtime claim has been rejected.";
                iconType = "info"; // Professional blue for records
            } else if (l2Name) {
                modalTitle = "Routed for Final Approval";
                modalMsg = `L1 Check complete. OT Claim routed to <strong>${l2Name}</strong> for final Approval.`;
            } else {
                modalTitle = "Claim Approved";
                modalMsg = "The overtime claim has been fully approved.";
            }

            // 2. Close the Input Modal immediately
            closeReviewModal();

            // üöÄ THE CRITICAL SYNC FIX: Await the success popup
            // Tony (or the manager) must click OK before the code proceeds to refresh the list
            await Swal.fire({
                title: modalTitle,
                html: modalMsg,
                icon: iconType,
                confirmButtonColor: '#2563eb',
                confirmButtonText: 'OK',
                allowOutsideClick: false
            });

            // 3. REFRESH DATA (Row is guaranteed to vanish now)
            console.log("üîÑ Synchronizing OT queue and badges...");
            await loadManagerOTRequests();
            
            if (typeof refreshManagerBadges === "function") {
                refreshManagerBadges();
            }
        } else {
            const err = await res.json();
            Swal.fire({
                icon: 'error',
                title: 'Action Failed',
                text: err.detail || "Could not process request.",
                confirmButtonColor: '#ef4444'
            });
        }
    } catch (e) {
        console.error("OT Decision Error:", e);
        Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: "Connection lost. Please try again.",
            confirmButtonColor: '#ef4444'
        });
    }
}



      function populateTimeDropdowns() {
        const startSelect = document.getElementById("ot_start");
        const endSelect = document.getElementById("ot_end");
        if (!startSelect || !endSelect) return;

        startSelect.innerHTML = '<option value="">Select...</option>';
        endSelect.innerHTML = '<option value="">Select...</option>';

        for (let hour = 0; hour < 24; hour++) {
          for (let min of ["00", "30"]) {
            const timeVal = `${hour.toString().padStart(2, "0")}:${min}`;
            const ampm = hour >= 12 ? "PM" : "AM";
            const displayHour = hour % 12 || 12;
            const displayTime = `${displayHour}:${min} ${ampm}`;

            startSelect.innerHTML += `<option value="${timeVal}">${displayTime}</option>`;
            endSelect.innerHTML += `<option value="${timeVal}">${displayTime}</option>`;
          }
        }
      }

      // Overtime logic Ends here

      // Attach file
      function validateFileSize(input) {
        const maxSizeBytes = 2 * 1024 * 1024; // 2MB Limit

        // üöÄ UPDATED: Logic to find the correct error span based on the new ID
        let errorSpanId = "";
        
        if (input.id === "leave_attachment") {
          // üü¢ CHANGE HERE: Must match the new HTML ID "leave_file_error"
          errorSpanId = "leave_file_error"; 
        } else if (input.id === "ot_attachment") {
          errorSpanId = "ot_file_error";
        }

        const errorSpan = document.getElementById(errorSpanId);

        if (input.files && input.files[0]) {
          const fileSize = input.files[0].size;

          if (fileSize > maxSizeBytes) {
            if (errorSpan) {
              errorSpan.style.display = "block";
              errorSpan.innerText = "‚ùå File too large! Max 2MB allowed.";
            }
            input.value = ""; // Clear the file
          } else {
            if (errorSpan) {
              errorSpan.style.display = "none";
            }
          }
        }
    }

      // Escape function
      // üöÄ NEW: Close Modal with ESC Key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          const leaveModal = document.getElementById("leaveDetailModal");

          // Check if the modal is currently visible before trying to close it
          if (leaveModal && leaveModal.style.display === "flex") {
            closeLeaveModal();
          }
        }
      });

      window.onclick = function (event) {
        const modal = document.getElementById("leaveDetailModal");
        // If the thing the user clicked is the dark background (the modal div itself)
        // and not the white content box inside it, then close.
        if (event.target === modal) {
          closeLeaveModal();
        }
      };

      // üöÄ PREVENT BACK BUTTON (Safe Version - Doesn't overwrite onload)
      function initBackPrevention() {
        const _hash = "!";
        if (window.location.hash !== _hash) {
          window.location.hash = _hash;
        }
        window.onhashchange = function () {
          if (window.location.hash !== _hash) {
            window.location.hash = _hash;
          }
        };
      }

      // Call it once immediately
      initBackPrevention();

      // Control function for the arrows
      function changeMonth(step) {
        currentCalDate.setMonth(currentCalDate.getMonth() + step);
        renderCalendar();
      }

      // ‚öôÔ∏è SYSTEM FEATURE TOGGLES
      const FEATURES = {
        showMedicalRate: false,
        showWhosAwayToday: false,
        showRecentActivity: true,
      };

      // üèÅ THE 401 KILLER: Triggers when the browser is ready [TO BE DELETED]
      // document.addEventListener("DOMContentLoaded", initializeDashboard);

 // üîÑ 2026 Background Sync Heartbeat (Every 1 Minute)
 setInterval(async () => {
        // üõë NEW SAFETY CHECK 1: Is the user actively typing or selecting?
        const activeEl = document.activeElement;
        const isInteracting = activeEl && (
            activeEl.tagName === 'INPUT' || 
            activeEl.tagName === 'TEXTAREA' || 
            activeEl.tagName === 'SELECT'
        );

        // üõë NEW SAFETY CHECK 2: Is the user on the Apply Leave screen?
        const applySection = document.getElementById("apply");
        const isOnApplyScreen = applySection && applySection.classList.contains("active");

        const modal = document.getElementById("globalModal");
        const reviewModal = document.getElementById("reviewModal");
        const successModal = document.getElementById("successModal");

        // üõë HARD STOP: Skip sync if user is busy or on a sensitive screen
        if (
          (modal && modal.classList.contains("show")) ||
          (reviewModal && reviewModal.style.display !== "none") ||
          (successModal && successModal.style.display !== "none") ||
          isInteracting || 
          isOnApplyScreen
        ) {
          console.log("‚è∏Ô∏è Heartbeat paused: User is busy with an input, modal, or application form.");
          return;
        }

        console.log("üíì Heartbeat: Syncing dashboard data safely...");

        // 1. Refresh Badges
        if (typeof refreshManagerBadges === "function") {
          await refreshManagerBadges();
        }

        // 2. Refresh Audit Log (Only if visible and not searching)
        const auditSection = document.getElementById("hr_audit");
        const auditSearch = document.getElementById("audit_search_name");

        if (auditSection && auditSection.classList.contains("active")) {
          const isSearching = auditSearch && auditSearch.value.trim() !== "";
          if (!isSearching) {
            console.log("üîÑ Background Sync: Refreshing Audit Logs...");
            if (typeof loadGlobalAuditLogs === "function") {
              await loadGlobalAuditLogs();
            }
          }
        }
      }, 60000);

      // üñ±Ô∏è Global Click Listener: Closes the suggestion box when clicking outside
      document.addEventListener("click", function (e) {
        const box = document.getElementById("employee_suggestions_box");
        const input = document.getElementById("policy_user_search");

        // If the box is open, and the click was NOT on the input and NOT inside the box
        if (box && box.style.display !== "none") {
          if (e.target !== input && !box.contains(e.target)) {
            console.log("üßπ Cleaning up: Closing suggestion box");
            box.style.display = "none";
          }
        }
      });

      function getStatusBadge(isActive) {
        if (isActive) {
          return `<span style="background: #f0fdf4; color: #15803d; padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: bold; border: 1px solid #bbf7d0;">
              <i class="fas fa-check-circle"></i> Active
            </span>`;
        } else {
          return `<span style="background: #fef2f2; color: #b91c1c; padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: bold; border: 1px solid #fecaca;">
              <i class="fas fa-times-circle"></i> Inactive
            </span>`;
        }
      }

      function getLeaveTypeBadge(type) {
        const config = {
          "Annual Leave": {
            bg: "#eff6ff",
            color: "#1e40af",
            icon: "fa-calendar",
          },
          "Medical Leave": {
            bg: "#fef2f2",
            color: "#b91c1c",
            icon: "fa-notes-medical",
          },
          "Emergency Leave": {
            bg: "#fff7ed",
            color: "#c2410c",
            icon: "fa-bolt",
          },
          "Compassionate Leave": {
            bg: "#faf5ff",
            color: "#7e22ce",
            icon: "fa-heart",
          },
          "Unpaid Leave": {
            bg: "#f9fafb",
            color: "#374151",
            icon: "fa-user-clock",
          },
        };
        const s = config[type] || {
          bg: "#f1f5f9",
          color: "#475569",
          icon: "fa-info-circle",
        };
        return `<span style="background: ${s.bg}; color: ${s.color}; padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; display: inline-flex; align-items: center; gap: 5px;">
            <i class="fas ${s.icon}"></i> ${type}
          </span>`;
      }


      // üì± Mobile Menu Toggle Logic
function toggleMobileMenu() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('mobile-overlay');

    if (sidebar.classList.contains('mobile-open')) {
        // Close it
        sidebar.classList.remove('mobile-open');
        overlay.style.opacity = '0';
        setTimeout(() => overlay.style.display = 'none', 300);
    } else {
        // Open it
        sidebar.classList.add('mobile-open');
        overlay.style.display = 'block';
        // Tiny delay to allow display:block to apply before animating opacity
        setTimeout(() => overlay.style.opacity = '1', 10);
    }
}

// üì± Auto-close mobile menu when a menu item is clicked
document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            toggleMobileMenu();
        }
    });
});


/* ============================================================
   üëë SUPERUSER COMMAND CENTER (Developer Only)
   ============================================================ */

// // 1. Broadcast Engine
// async function openBroadcastModal() { ... }
// async function sendSystemBroadcast() { ... }

// // 2. Bulk Operations
// function downloadUserTemplate() { ... }
// async function handleBulkUpload(file) { ... }

// // 3. System Kill-Switches (Moved from HR Admin later)
// async function masterToggleWorkflow(type, state) { ... }

// // 4. Admin Quota Safeguard
// async function updateAdminQuota(newLimit) { ... }


// --- üîÑ SETTINGS TAB SWITCHER ---
function toggleSettingsMode(mode) {
    const workflowView = document.getElementById("settings_workflow_view");
    const brandingView = document.getElementById("settings_branding_view");
    const btnWorkflow = document.getElementById("btnSettingsWorkflow");
    const btnBranding = document.getElementById("btnSettingsBranding");

    if (!workflowView || !brandingView) return;

    const resetBtn = (btn) => {
        btn.style.background = "transparent";
        btn.style.color = "#64748b";
        btn.style.boxShadow = "none";
        btn.style.border = "none";
    };

    const activeBtn = (btn) => {
        btn.style.background = "white";
        btn.style.color = "#1e293b";
        btn.style.boxShadow = "0 1px 3px rgba(0,0,0,0.1)";
        btn.style.border = "1px solid #cbd5e1";
    };

    if (mode === "workflow") {
        workflowView.style.display = "block";
        brandingView.style.display = "none";
        activeBtn(btnWorkflow);
        resetBtn(btnBranding);
    } else {
        workflowView.style.display = "none";
        brandingView.style.display = "block";
        activeBtn(btnBranding);
        resetBtn(btnWorkflow);
    }
}

// --- üé® BRANDING & IDENTITY ENGINE ---
async function saveBrandingConfig() {
    // 1. Grab all three inputs
    const name = document.getElementById("config_company_name").value.trim();
    const subInfo = document.getElementById("config_sub_info") ? document.getElementById("config_sub_info").value.trim() : "";
    const logo = document.getElementById("config_company_logo").value.trim();

    // 2. Simple Validation
    if (!name) {
        Swal.fire({ icon: 'warning', title: 'Name Required', text: 'Please enter a Company Display Name.' });
        return;
    }

    const result = await Swal.fire({
        title: 'Apply Branding?',
        text: "This will update the company identity for all employees.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3b82f6',
        confirmButtonText: 'Yes, Update Identity'
    });

    if (result.isConfirmed) {
        Swal.fire({ title: 'Updating...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

        try {
            const res = await fetchWithAuth(`${API_URL}/settings/branding`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    company_name: name, 
                    company_sub_info: subInfo, // üöÄ Matches Python Pydantic model
                    company_logo: logo 
                }),
            });

            if (res && res.ok) {
                await Swal.fire({
                    icon: 'success',
                    title: 'System Rebranded',
                    text: 'Changes applied successfully.', // üöÄ Cleaned text
                    timer: 1500,
                    showConfirmButton: false
                });

                // üöÄ THE FIX: Dynamically refresh the UI components without reloading the page
                // This keeps you on the Branding tab!
                if (typeof applySystemBranding === "function") {
                    await applySystemBranding(); 
                }

            } else {
                const errorData = await res.json();
                Swal.fire('Error', errorData.detail || 'Failed to save branding settings.', 'error');
            }
        } catch (e) {
            console.error("Branding Error:", e);
            Swal.fire('Network Error', 'Could not reach the configuration server.', 'error');
        }
    }
}

function updateCounter(id, input, max) {
    const el = document.getElementById(id);
    if (!el) return;
    const len = input.value.length;
    el.innerText = len;
    el.style.color = len >= max ? "#ef4444" : "#94a3b8";
}

// --- üöÄ LOGO UPLOAD ENGINE (WITH SAFETY GUARDRAILS) ---
async function handleLogoUpload(input) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];
    const status = document.getElementById("upload_status");
    
    // üõ°Ô∏è VALIDATION 1: File Type (Only Images)
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        Swal.fire('Invalid Format', 'Please upload a PNG, JPG, or SVG.', 'error');
        input.value = ""; 
        return;
    }

    // üõ°Ô∏è VALIDATION 2: File Size (2MB Limit)
    if (file.size > 2 * 1024 * 1024) {
        Swal.fire('File Too Large', 'The logo must be smaller than 2MB.', 'warning');
        input.value = "";
        return;
    }

    const formData = new FormData();
    formData.append("file", file);

    // Visual feedback
    if (status) {
        status.style.display = "inline";
        status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        status.style.color = "#6366f1";
    }

    try {
        const res = await fetch(`${API_URL}/settings/upload-logo`, {
            method: "POST",
            body: formData, // No headers needed: browser sets multipart/form-data automatically
        });

        if (res.ok) {
            const data = await res.json();
            
            // ‚úÖ Success: Fill the text box with the new server-generated URL
            const logoInput = document.getElementById("config_company_logo");
            if (logoInput) {
                logoInput.value = data.logo_url;
                // Trigger preview update
                if (typeof updateBrandingPreview === "function") {
                    updateBrandingPreview(data.logo_url);
                }
            }
            
            if (status) {
                status.innerHTML = '<i class="fas fa-check"></i> Uploaded!';
                status.style.color = "#10b981";
            }
        } else {
            throw new Error("Upload failed");
        }
    } catch (e) {
        console.error("Upload error:", e);
        if (status) {
            status.innerHTML = '<i class="fas fa-times"></i> Failed';
            status.style.color = "#ef4444";
        }
        Swal.fire("Error", "Server could not process upload. Check main.py imports.", "error");
    }
}

// --- üñºÔ∏è BRANDING PREVIEW ENGINE ---
function updateBrandingPreview(url) {
    const preview = document.getElementById("branding_preview");
    if (!preview) return;

    if (url && url.trim() !== "") {
        
        // üöÄ THE FIX: Attach the FastAPI backend URL if it's a local upload
        const fullUrl = url.startsWith("/uploads") ? `${API_URL}${url}` : url;

        // üöÄ FIX: We use &quot; for internal attributes so the browser 
        // doesn't trip over the 'fas' identifier during an error.
        preview.innerHTML = `<img src="${fullUrl}" style="width:100%; height:100%; object-fit:contain;" 
            onerror="this.parentElement.innerHTML='<i class=&quot;fas fa-exclamation-triangle&quot; style=&quot;color:#ef4444;&quot;></i>'">`;
    } else {
        preview.innerHTML = '<i class="fas fa-image" style="color: #cbd5e1;"></i>';
    }
}
// --- üóëÔ∏è CLEAR LOGO LOGIC ---
async function clearBrandingLogo() {
    const result = await Swal.fire({
        title: 'Remove Logo?',
        text: "This will revert the sidebar to the default system icon.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'Yes, Remove It'
    });

    if (result.isConfirmed) {
        // 1. Clear the hidden logo path input
        const logoInput = document.getElementById("config_company_logo");
        if (logoInput) logoInput.value = "";

        // 2. Clear the upload status text
        const status = document.getElementById("upload_status");
        if (status) status.style.display = "none";

        // 3. Clear the preview box
        if (typeof updateBrandingPreview === "function") {
            updateBrandingPreview("");
        }

        // 4. Automatically save the "Empty Logo" state to the DB
        // This ensures the sidebar updates immediately
        saveBrandingConfig(); 
    }
}

// ============================================================
// üì¢ SYSTEM BROADCAST & MAINTENANCE LOGIC (ULTIMATE FINAL)
// ============================================================
async function loadBroadcastSettings() {
    const versionDisplay = document.getElementById('app_version_display'); // Grab this first

    try {
        const res = await fetchWithAuth(`${API_URL}/settings/branding?t=${new Date().getTime()}`);
        
        // 1. If the server is reachable but sends an error (e.g., 500 error)
        if (!res || !res.ok) {
            if (versionDisplay) {
                versionDisplay.innerText = "Offline";
                versionDisplay.style.color = "#ef4444";
            }
            return;
        }

        const data = await res.json();

        // 2. Success Path
        if (versionDisplay && data.system_version) {
            versionDisplay.innerText = data.system_version;
            versionDisplay.style.color = ""; // Reset to original color
        }
        
        // Sync Admin UI if the user is an Admin
        const toggle = document.getElementById("broadcast_workflow_toggle");
        if (toggle) {
            document.getElementById("bc_message").value = data.broadcast_message || "";
            updateCounter('bc_count', document.getElementById("bc_message"), 150);
            document.getElementById("bc_maintenance_mode").checked = data.maintenance_mode || false;
            document.getElementById("bc_start").value = data.broadcast_start || "";
            document.getElementById("bc_end").value = data.broadcast_end || "";
            toggleBroadcastPanelVisually(data.broadcast_enabled); 
        }
        
        checkAndDisplayGlobalBanner(data);

    } catch (e) {
        // 3. Connection Path (Server is completely STOPPED)
        console.warn("‚ö†Ô∏è Broadcast Sync Failed:", e);
        if (versionDisplay) {
            versionDisplay.innerText = "Offline";
            versionDisplay.style.color = "#ef4444";
        }
    }
}

// 2. The Global Banner Engine (Works for EVERYONE - With Anti-Flicker)
function checkAndDisplayGlobalBanner(data) {
    const bannerId = "system_global_banner";
    const existingBanner = document.getElementById(bannerId);
    
    // Safety check
    if (!data || !data.broadcast_enabled || !data.broadcast_start || !data.broadcast_end || !data.broadcast_message) {
        if (existingBanner) existingBanner.remove();
        return;
    }

    // Force Local Time Parsing
    const now = new Date();
    const start = new Date(data.broadcast_start.replace(/-/g, "/").replace("T", " "));
    const end = new Date(data.broadcast_end.replace(/-/g, "/").replace("T", " "));
    const isLockMode = data.maintenance_mode === true;

    // Logic: Show if we are inside the time window
    if (now >= start && now <= end) {
        
        // üîí SECURITY: Kick out anyone who isn't the Superuser if Lock is active
        const masterRole = localStorage.getItem("userMasterRole") || "";
        const loggedInUser = localStorage.getItem("username") || "";
        const currentUserStr = typeof currentUser !== 'undefined' ? currentUser : "";
        const isSuperuser = (masterRole === "superuser" || loggedInUser === "superuser" || currentUserStr === "System Administrator");

        if (isLockMode && !isSuperuser) {
            console.warn("üõë Maintenance Lock Active: Forcing logout.");
            
            // Blur the background to hide the dashboard flicker
            const mainContent = document.querySelector(".main");
            const sidebar = document.querySelector(".sidebar");
            if (mainContent) mainContent.style.filter = "blur(8px)";
            if (sidebar) sidebar.style.filter = "blur(8px)";
            document.body.style.pointerEvents = "none"; // Disable clicking

            // Show a beautiful SweetAlert explaining the lock
            Swal.fire({
                icon: 'warning',
                title: 'System Locked',
                html: `<b>Maintenance in Progress</b><br><br><span style="color:#64748b;">${data.broadcast_message}</span>`,
                confirmButtonColor: '#f59e0b',
                confirmButtonText: 'Return to Login',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    document.body.style.pointerEvents = "auto";
                }
            }).then(() => {
                if (typeof logout === "function") logout();
            });

            return; // üõë Stop the rest of the script from rendering the banner
        }

        // üé® Create Banner
        if (!existingBanner) {
            const banner = document.createElement("div");
            banner.id = bannerId;
            const bgColor = isLockMode ? "#f59e0b" : "#3b82f6"; // Amber for Maintenance, Blue for standard
            
            banner.style = `
                background: ${bgColor}; color: white; padding: 12px 20px;
                text-align: center; font-weight: 700; font-size: 0.9rem;
                position: sticky; top: 0; z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                width: 100%; box-sizing: border-box;
            `;
            
            const icon = isLockMode ? "fa-tools" : "fa-bullhorn";
            const timeStr = end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            banner.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${data.broadcast_message}</span>
                <small style="opacity: 0.8; font-weight: normal; margin-left: 10px;">
                    (Until: ${timeStr})
                </small>
            `;
            
            const mainContent = document.querySelector(".main");
            if (mainContent) mainContent.prepend(banner);
        }
    } else {
        if (existingBanner) existingBanner.remove();
    }
}

// 3. Save Settings to Backend (Active Update)
async function saveBroadcastConfig() {
    const isEnabled = document.getElementById("broadcast_workflow_toggle").checked;
    const message = document.getElementById("bc_message").value.trim();
    const isMaintenance = document.getElementById("bc_maintenance_mode").checked;
    const startTime = document.getElementById("bc_start").value;
    const endTime = document.getElementById("bc_end").value;

    if (isEnabled) {
        if (!message) { Swal.fire("Input Required", "Please enter a message.", "warning"); return; }
        if (!startTime || !endTime) { Swal.fire("Dates Required", "Please select times.", "warning"); return; }
    }

    try {
        Swal.fire({ title: 'Updating System Policy...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
        const logoPath = document.getElementById("config_company_logo")?.value || "";

        const payload = {
            company_name: document.getElementById("sidebar_company_name").innerText,
            company_sub_info: document.getElementById("sidebar_sub_info").innerText,
            company_logo: logoPath, 
            broadcast_enabled: isEnabled,
            broadcast_message: message,
            broadcast_start: startTime,
            broadcast_end: endTime,
            maintenance_mode: isMaintenance
        };

        const res = await fetchWithAuth(`${API_URL}/settings/branding`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });

        if (res && res.ok) {
            await Swal.fire({ icon: 'success', title: 'Settings Applied', text: 'Broadcast rules updated.', timer: 1500, showConfirmButton: false });
            checkAndDisplayGlobalBanner(payload); 
        } else {
            const err = await res.json();
            Swal.fire("Error", err.detail || "Failed to save settings.", "error");
        }
    } catch (e) {
        Swal.fire("Network Error", "Could not connect to the server.", "error");
    }
}

// 4. Smart Toggle Logic (Asks before turning off)
function handleBroadcastToggle() {
    const toggle = document.getElementById("broadcast_workflow_toggle");
    const isTurningOn = toggle.checked;

    if (isTurningOn) {
        // Open the panel so they can set dates/messages
        toggleBroadcastPanelVisually(true);
    } else {
        // Revert the toggle visually pending confirmation
        toggle.checked = true; 
        
        Swal.fire({
            title: 'Terminate Broadcast?',
            text: "This will instantly remove the banner and lift any system locks.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#cbd5e1',
            confirmButtonText: 'Yes, Terminate',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                terminateBroadcast();
            }
        });
    }
}

// 5. Terminate Function (Kills the broadcast in the DB)
async function terminateBroadcast() {
    Swal.fire({ title: 'Terminating...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    const logoPath = document.getElementById("config_company_logo")?.value || "";
    const payload = {
        company_name: document.getElementById("sidebar_company_name").innerText,
        company_sub_info: document.getElementById("sidebar_sub_info").innerText,
        company_logo: logoPath, 
        broadcast_enabled: false,  // üî¥ FORCE OFF
        maintenance_mode: false,   // üî¥ FORCE OFF
        broadcast_message: document.getElementById("bc_message")?.value || "",
        broadcast_start: document.getElementById("bc_start")?.value || "",
        broadcast_end: document.getElementById("bc_end")?.value || ""
    };

    try {
        const res = await fetchWithAuth(`${API_URL}/settings/branding`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });

        if (res && res.ok) {
            Swal.fire({ icon: 'success', title: 'Terminated', text: 'Broadcast and locks disabled.', timer: 1500, showConfirmButton: false });
            
            // Close the UI panel and uncheck everything
            toggleBroadcastPanelVisually(false);
            document.getElementById("bc_maintenance_mode").checked = false;

            // Instantly remove banner locally
            const banner = document.getElementById("system_global_banner");
            if (banner) banner.remove();
        }
    } catch (e) {
        Swal.fire("Network Error", "Could not connect to the server.", "error");
    }
}

// 6. Visual UI Helper
function toggleBroadcastPanelVisually(isON) {
    const toggle = document.getElementById("broadcast_workflow_toggle");
    const panel = document.getElementById("broadcast_config_panel");
    const bg = document.getElementById("bcToggleBg");
    const circle = document.getElementById("bcToggleCircle");

    if (toggle) toggle.checked = isON;

    if (panel && bg && circle) {
        if (isON) {
            panel.style.display = "block";
            bg.style.backgroundColor = "#f59e0b"; // Amber
            circle.style.transform = "translateX(30px)";
        } else {
            panel.style.display = "none";
            bg.style.backgroundColor = "#cbd5e1"; // Grey
            circle.style.transform = "translateX(0px)";
        }
    }
}

    </script>
  </body>
</html>
